<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="GeekCodeParadise">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="GeekCodeParadise">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="LiJyu Gao">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>GeekCodeParadise</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">GeekCodeParadise</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/27/practices-of-refactoring-to-patterns/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/27/practices-of-refactoring-to-patterns/" class="post-title-link" itemprop="url">Practices of Refactoring To Patterns</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-27 00:00:08" itemprop="dateCreated datePublished" datetime="2023-03-27T00:00:08+08:00">2023-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-24 21:50:21" itemprop="dateModified" datetime="2023-11-24T21:50:21+08:00">2023-11-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="https://geekcodeparadise.com/wp-content/uploads/2023/03/kaleidico-3V8xo5Gbusk-unsplash-1024x683.jpg" alt="refactoring"></p>
<p>(Photo from Upsplash: <a target="_blank" rel="noopener" href="https://unsplash.com/photos/3V8xo5Gbusk">https://unsplash.com/photos/3V8xo5Gbusk</a><a target="_blank" rel="noopener" href="https://pixabay.com/illustrations/moving-boxes-mover-moving-truck-3671446/">)</a></p>
<h1 id="Refactoring-To-Patterns"><a href="#Refactoring-To-Patterns" class="headerlink" title="Refactoring To Patterns"></a>Refactoring To Patterns</h1><p>My practices of the book Refactoring To Patterns.</p>
<p>Joshua Kerievsky’s book <a target="_blank" rel="noopener" href="https://amzn.to/3FNMrhJ">Refactoring to Patterns</a>.</p>
<p>The code samples are placed in my <a target="_blank" rel="noopener" href="https://github.com/u8989332/RefactoringToPatterns_Practice">Github</a>.</p>
<p>The content of the book is listed from chapter 6 to chapter 11 and maps to my Github subfolders:</p>
<h2 id="Chapter-6-Creation"><a href="#Chapter-6-Creation" class="headerlink" title="Chapter 6 Creation"></a>Chapter 6 Creation</h2>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2023/03/27/practices-of-refactoring-to-patterns/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/09/refactoring-chapter-10-simplifying-conditional-logic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/09/refactoring-chapter-10-simplifying-conditional-logic/" class="post-title-link" itemprop="url">Simplifying Conditional Logic</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-09 14:30:09" itemprop="dateCreated datePublished" datetime="2022-04-09T14:30:09+08:00">2022-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-04 01:01:53" itemprop="dateModified" datetime="2024-11-04T01:01:53+08:00">2024-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This article references the chapter 10 “ Simplifying Conditional Logic “ of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. Author had highlighted many important refactorings in this chapter.</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/09/refactoring-chapter-10-simplifying-conditional-logic/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/26/refactoring-chapter-9-organizing-data/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/26/refactoring-chapter-9-organizing-data/" class="post-title-link" itemprop="url">Organizing Data</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-26 15:54:47" itemprop="dateCreated datePublished" datetime="2022-03-26T15:54:47+08:00">2022-03-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:26" itemprop="dateModified" datetime="2023-11-19T15:47:26+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This article references the chapter 9 “ Organizing Data “ of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. Author had highlighted many important refactorings in this chapter.</p>
<p>I use .NET C# to practice with these refactorings and upload to Github.</p>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2022/03/cabinet-3283536_960_720.jpg" alt="organizing data"></p>
<p>(Photo from Pixabay: <a target="_blank" rel="noopener" href="https://pixabay.com/photos/cabinet-drawer-wood-catalogue-3283536/">https://pixabay.com/photos/cabinet-drawer-wood-catalogue-3283536/</a><a target="_blank" rel="noopener" href="https://pixabay.com/illustrations/moving-boxes-mover-moving-truck-3671446/">)</a></p>
<hr>
<h4 id="Split-Variable"><a href="#Split-Variable" class="headerlink" title="Split Variable"></a>Split Variable</h4><h5 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Loop variable and collecting variable are special. They are assigned value many times.</li>
<li>Other variable is responsible for one thing. It should be assigned value one time.</li>
<li>If some variable is assigned many times, we should split it into different variables.</li>
</ul>
<h5 id="Examples"><a href="#Examples" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>A simple example</li>
<li>Assigning to an Input Parameter</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch9.Organizing%20Data/Split%20Variable">Github</a></p>
<hr>
<h4 id="Rename-Field"><a href="#Rename-Field" class="headerlink" title="Rename Field"></a>Rename Field</h4><h5 id="Tips-1"><a href="#Tips-1" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>A field with good naming makes the developer clever about what the code does.</li>
<li>Field and accessors (getter&#x2F;setter) namings are important.</li>
<li>If a record is still not encapsulated, use <strong>Encapsulate Record</strong>.</li>
</ul>
<h5 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>A simple example</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch9.Organizing%20Data/Rename%20Field">Github</a></p>
<hr>
<h4 id="Replace-Derived-Variable-with-Query"><a href="#Replace-Derived-Variable-with-Query" class="headerlink" title="Replace Derived Variable with Query"></a>Replace Derived Variable with Query</h4><h5 id="Tips-2"><a href="#Tips-2" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>We should minimize the scope of mutable data at much as possible.</li>
<li>Use this skill to avoid “We update the source data but we forget to update the derived variable”</li>
</ul>
<h5 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>A simple example</li>
<li>More Than One Source</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch9.Organizing%20Data/Replace%20Derived%20Variable%20with%20Query">Github</a></p>
<hr>
<h4 id="Change-Reference-to-Value"><a href="#Change-Reference-to-Value" class="headerlink" title="Change Reference to Value"></a>Change Reference to Value</h4><h5 id="Tips-3"><a href="#Tips-3" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>A <a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/ValueObject.html">value object</a> is immutable. We can transfer this object into other logic without caring about modifying the object’s data.</li>
<li>If an object can be shared between many objects and they can see its modification, it should be a reference object.</li>
<li>Value object usually implements <strong>equals</strong> function.</li>
</ul>
<h5 id="Examples-3"><a href="#Examples-3" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>A simple example</li>
<li>More Than One Source</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch9.Organizing%20Data/Change%20Reference%20to%20Value">Github</a></p>
<hr>
<h4 id="Change-Reference-to-Value-1"><a href="#Change-Reference-to-Value-1" class="headerlink" title="Change Reference to Value"></a>Change Reference to Value</h4><h5 id="Tips-4"><a href="#Tips-4" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If a shared Value Object data needs update, we need to find all data copies and update them. Change it to Reference Object and the object’s update reflects on all clients.</li>
<li>Build a <a target="_blank" rel="noopener" href="https://martinfowler.com/eaaCatalog/repository.html">Repository</a> to manage the reference object. All clients find the reference objects by the repository.</li>
</ul>
<h5 id="Examples-4"><a href="#Examples-4" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>A simple example</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch9.Organizing%20Data/Change%20Value%20to%20Reference">Github</a></p>
<hr>
<h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h4><p>This chapter introduces me how to organize data. In ASP.NET MVC development, I have used Service&#x2F;Repository pattern to manage my data source. And I used the LINQ to perform <strong>Replace Derived Variable with Query</strong>. I have grown up to write better code when I study this refactoring chapter. If you want to learn detailed motivation and mechanics, study the chapter 9 “ Organizing Data “ of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. and it improves our programmer’s ability.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/10/refactoring-chapter-8-moving-features/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/10/refactoring-chapter-8-moving-features/" class="post-title-link" itemprop="url">Moving Features</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-10 00:09:11" itemprop="dateCreated datePublished" datetime="2022-03-10T00:09:11+08:00">2022-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:26" itemprop="dateModified" datetime="2023-11-19T15:47:26+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This article references the chapter 8 “ Moving Features “ of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. Author had highlighted many important refactorings in this chapter.</p>
<p>I use .NET C# to practice with these refactorings and upload to Github.</p>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2022/03/moving-3671446_1920-1024x757.png" alt="Moving Features"></p>
<p>(Photo from Pixabay: <a target="_blank" rel="noopener" href="https://pixabay.com/illustrations/moving-boxes-mover-moving-truck-3671446/">https://pixabay.com/illustrations/plumber-repair-tools-pipe-plunger-4427401/https://pixabay.com/illustrations/moving-boxes-mover-moving-truck-3671446/ )</a></p>
<h4 id="Move-Function"><a href="#Move-Function" class="headerlink" title="Move Function"></a>Move Function</h4><h5 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If a nested function of a outer function may be used for other situations, move this nested function to a general scope.</li>
<li>If a function of a class is better for other class, move this function into the target class.</li>
</ul>
<h5 id="Examples"><a href="#Examples" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Moving a Nested Function to Top Level</li>
<li>Moving between Classes</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch8.Moving%20Features/Move%20Function">Github</a></p>
<h4 id="Move-Field"><a href="#Move-Field" class="headerlink" title="Move Field"></a>Move Field</h4><h5 id="Tips-1"><a href="#Tips-1" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If other structures are modified after one field is modified, we should move this field into a central structure.</li>
<li>Field should be encapsulated, it means that we add get&#x2F;set accessors to encapsulate fields to avoid “Bare” record.</li>
</ul>
<h5 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>A simple example</li>
<li>Moving to a Shared Object</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch8.Moving%20Features/Move%20Field">Github</a></p>
<h4 id="Move-Statements-into-Function"><a href="#Move-Statements-into-Function" class="headerlink" title="Move Statements into Function"></a>Move Statements into Function</h4><h5 id="Tips-2"><a href="#Tips-2" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If some statement repeatably works on many places, we should move it into a function.</li>
</ul>
<h5 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>A simple example</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch8.Moving%20Features/Move%20Statements%20into%20Function">Github</a></p>
<h4 id="Move-Statements-into-Callers"><a href="#Move-Statements-into-Callers" class="headerlink" title="Move Statements into Callers"></a>Move Statements into Callers</h4><h5 id="Tips-3"><a href="#Tips-3" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If some statement are changed by callers in a function, we should extract it to each caller.</li>
</ul>
<h5 id="Examples-3"><a href="#Examples-3" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Just use the <strong>Move Statements into</strong> <strong>Function</strong> example from end to start</li>
</ul>
<h4 id="Replace-Inline-Code-with-Function-Call"><a href="#Replace-Inline-Code-with-Function-Call" class="headerlink" title="Replace Inline Code with Function Call"></a>Replace Inline Code with Function Call</h4><h5 id="Tips-4"><a href="#Tips-4" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If some inline code has been implements in some function, replace it with the function.</li>
<li>A good naming function shows what the inline code outputs without understanding the implementation</li>
</ul>
<h5 id="Examples-4"><a href="#Examples-4" class="headerlink" title="Examples:"></a>Examples:</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before refactoring</span></span><br><span class="line"><span class="built_in">bool</span> hasMyFavoriteFruit = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">var</span> fruit <span class="keyword">in</span> basket)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(fruit == <span class="string">&quot;Apple&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        hasMyFavoriteFruit  = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// after refactoring</span></span><br><span class="line"><span class="built_in">bool</span> hasMyFavoriteFruit = basket.Contains(<span class="string">&quot;Apple&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Slide-Statements"><a href="#Slide-Statements" class="headerlink" title="Slide Statements"></a>Slide Statements</h4><h5 id="Tips-5"><a href="#Tips-5" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Some variable declarations are placed together on the top of scope, but author recommends that he declares variable when only first time he uses it.</li>
<li>Some statement has side-effect. If we slide it without test, it may cause the error.</li>
<li>We can implement the statement (function) by using C<a target="_blank" rel="noopener" href="https://amzn.to/3ng73c5">ommand&#x2F;Query separation pattern</a> to avoid the side-effect.</li>
<li>This refactoring focuses on the change of the state. When we slide statement, <strong>Split Variable</strong> is a good method.</li>
</ul>
<h5 id="Examples-5"><a href="#Examples-5" class="headerlink" title="Examples:"></a>Examples:</h5><p>Sliding with Conditionals</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before refactoring</span></span><br><span class="line">Response result = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(connection.Status == Status.OK)</span><br><span class="line">&#123;</span><br><span class="line">    result = CreateSuccessMessage();</span><br><span class="line">    connectionResponses.Add(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    result = CreateFailsMessage();</span><br><span class="line">    connectionResponses.Add(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line"><span class="comment">// after refactoring</span></span><br><span class="line">Response result = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(connection.Status == Status.OK)</span><br><span class="line">&#123;</span><br><span class="line">    result = CreateSuccessMessage();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    result = CreateFailsMessage();</span><br><span class="line">&#125;</span><br><span class="line">connectionResponses.Add(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>

<h4 id="Split-Loop"><a href="#Split-Loop" class="headerlink" title="Split Loop"></a>Split Loop</h4><h5 id="Tips-6"><a href="#Tips-6" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If a loop contains many independent works, split them into their own loop scope.</li>
<li>We use <strong>Move Statement</strong> to move related variable declaration near by the new loop.</li>
<li>Split loop can be extracted as a function.</li>
<li><strong>Replace Loop with Pipeline</strong> is a better implementation.</li>
</ul>
<h5 id="Examples-6"><a href="#Examples-6" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>A simple example</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch8.Moving%20Features/Split%20Loop">Github</a></p>
<h4 id="Replace-Loop-with-Pipeline"><a href="#Replace-Loop-with-Pipeline" class="headerlink" title="Replace Loop with Pipeline"></a>Replace Loop with Pipeline</h4><h5 id="Tips-7"><a href="#Tips-7" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Collection Pipeline is a modern pattern. A pipeline receives a collection and process it with some operations and outputs a new collection.</li>
<li>JavaScript has map&#x2F;filter&#x2F;… pipeline functions, C# has LINQ (select&#x2F;where…).</li>
<li>Pipeline increases the code readability.</li>
</ul>
<h5 id="Examples-7"><a href="#Examples-7" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>A simple example</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch8.Moving%20Features/Replace%20Loop%20with%20Pipeline">Github</a></p>
<h4 id="Remove-Dead-Code"><a href="#Remove-Dead-Code" class="headerlink" title="Remove Dead Code"></a>Remove Dead Code</h4><h5 id="Tips-8"><a href="#Tips-8" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If some code is not used ever, remove it to avoid confusing you&#x2F;your team members.</li>
<li>Version control can manage all code history. Make the good use of it.</li>
</ul>
<h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h4><p>This chapter introduces me how to move the code logic greatly. In my early coding job, I used to write long logic function. And this function was gradually hard maintainable. I learned some like Moving Features skills to enhance the code but it still was not completed. I have grown up to write better code when I study this refactoring chapter. If you want to learn detailed motivation and mechanics, study the chapter 8 “ Moving Features “ of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. and it improves our programmer’s ability.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/13/refactoring-chapter-7-encapsulation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/13/refactoring-chapter-7-encapsulation/" class="post-title-link" itemprop="url">Encapsulation</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-13 19:21:49" itemprop="dateCreated datePublished" datetime="2022-02-13T19:21:49+08:00">2022-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:26" itemprop="dateModified" datetime="2023-11-19T15:47:26+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This article references the chapter 7 “ Encapsulation “ of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. Author had highlighted many important refactorings in this chapter.</p>
<p>I use .NET C# to practice with these refactorings and upload to Github.</p>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/wp-content/uploads/2022/02/archive-1850170_1920-1024x683.jpg"><img src="https://geekcodeparadise.com/wp-content/uploads/2022/02/archive-1850170_1920-1024x683.jpg" alt="Encapsulation"></a></p>
<p>(Photo from Pixabay: <a target="_blank" rel="noopener" href="https://pixabay.com/photos/archive-boxes-shelf-folders-1850170/">https://pixabay.com/illustrations/plumber-repair-tools-pipe-plunger-4427401/ )</a></p>
<h4 id="Encapsulate-Record"><a href="#Encapsulate-Record" class="headerlink" title="Encapsulate Record"></a>Encapsulate Record</h4><h5 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>For mutable data, use Class object instead of Record.</li>
<li>If some record has nested data (list&#x2F;hash&#x2F;….), encapsulating this nested data is better.</li>
<li>Usually use a class to encapsulate the record and create the access methods in the class.</li>
<li>For nested data, we first focus on “Update Method”, then “Read Method” can return the copy &#x2F; readonly proxy of the data.</li>
<li>If a record’s field is also a complex structure, consider to use <strong><em>Encapsulate Record</em></strong> or <strong><em>Encapsulate Collection</em></strong>.</li>
</ul>
<h5 id="Examples"><a href="#Examples" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Simple Encapsulation</li>
<li>Encapsulating a Nested Record</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch7.Encapsulation/Encapsulate%20Record">Github</a></p>
<h4 id="Encapsulate-Collection"><a href="#Encapsulate-Collection" class="headerlink" title="Encapsulate Collection"></a>Encapsulate Collection</h4><h5 id="Tips-1"><a href="#Tips-1" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Usually add “Add” and “Remove” functions for accessing the collection</li>
<li>Create a function that returns the copy of the collection. This avoids changing the original collection</li>
<li>If we want set the collection, use the copy of parameter collection to set.</li>
</ul>
<h5 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Simple Encapsulation</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch7.Encapsulation/Encapsulate%20Collection">Github</a></p>
<h4 id="Replace-Primitive-with-Object"><a href="#Replace-Primitive-with-Object" class="headerlink" title="Replace Primitive with Object"></a>Replace Primitive with Object</h4><h5 id="Tips-2"><a href="#Tips-2" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Some simple number&#x2F;string instances will has complex logic, we should encapsulate them into classes. These classes are <strong>value classes.</strong></li>
<li>Consider <strong><em>Change Reference to Value</em></strong> or <strong><em>Change Value to Reference</em></strong> for the created object.</li>
</ul>
<h5 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Simple Replacement</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch7.Encapsulation/Replace%20Primitive%20with%20Object">Github</a></p>
<h4 id="Replace-Temp-with-Query"><a href="#Replace-Temp-with-Query" class="headerlink" title="Replace Temp with Query"></a>Replace Temp with Query</h4><h5 id="Tips-3"><a href="#Tips-3" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>This skill is used for the temp variable that is calculated once.</li>
<li>Some temp variable is calculated many times, we also extract its calculation logic into query function.</li>
</ul>
<h5 id="Examples-3"><a href="#Examples-3" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Simple Replacement</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch7.Encapsulation/Replace%20Temp%20with%20Query">Github</a></p>
<h4 id="Extract-Class"><a href="#Extract-Class" class="headerlink" title="Extract Class"></a>Extract Class</h4><h5 id="Tips-4"><a href="#Tips-4" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If one class’s responsibility is too huge, we consider that the class is split into main class and sub class. Sub class has the closed activities of functions&#x2F;data.</li>
</ul>
<h5 id="Examples-4"><a href="#Examples-4" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Simple Extraction</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch7.Encapsulation/Extract%20Class">Github</a></p>
<h4 id="Inline-Class"><a href="#Inline-Class" class="headerlink" title="Inline Class"></a>Inline Class</h4><h5 id="Tips-5"><a href="#Tips-5" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If one class’s responsibility has no reason to exist by its single class, move this class’s member into another class.</li>
</ul>
<h5 id="Examples-5"><a href="#Examples-5" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Simple Inline</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch7.Encapsulation/Inline%20Class">Github</a></p>
<h4 id="Hide-Delegate"><a href="#Hide-Delegate" class="headerlink" title="Hide Delegate"></a>Hide Delegate</h4><h5 id="Tips-6"><a href="#Tips-6" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Create the delegate function to hide the inner relationship between the called object and the caller. If the called object changes, the caller still uses the delegate function without knowing the change.</li>
</ul>
<h5 id="Examples-6"><a href="#Examples-6" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Simple Hiding</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch7.Encapsulation/Hide%20Delegate">Github</a></p>
<h4 id="Remove-Middle-Man"><a href="#Remove-Middle-Man" class="headerlink" title="Remove Middle Man"></a>Remove Middle Man</h4><h5 id="Tips-7"><a href="#Tips-7" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If the delegate functions are too many, adjust caller to directly call the target object.</li>
</ul>
<h5 id="Examples-7"><a href="#Examples-7" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Just use the <strong>Hide Delegate</strong> example from end to start</li>
</ul>
<h4 id="Substitute-Algorithm"><a href="#Substitute-Algorithm" class="headerlink" title="Substitute Algorithm"></a>Substitute Algorithm</h4><h5 id="Tips-8"><a href="#Tips-8" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If the new algorithm is easy to maintain, we consider that the old algorithm is replaced by the new one.</li>
</ul>
<h5 id="Examples-8"><a href="#Examples-8" class="headerlink" title="Examples:"></a>Examples:</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">string</span> <span class="title">FindPerson</span>(<span class="params"><span class="built_in">string</span>[] people</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; people.Length; i++) </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (people[i] == <span class="string">&quot;Don&quot;</span>) </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Don&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (people[i] == <span class="string">&quot;John&quot;</span>) </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;John&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (people[i] == <span class="string">&quot;Kent&quot;</span>) </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Kent&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// after</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">string</span> <span class="title">FindPerson</span>(<span class="params"><span class="built_in">string</span>[] people</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">string</span>[] candidates = <span class="keyword">new</span> <span class="built_in">string</span>[]&#123;<span class="string">&quot;Don&quot;</span>, <span class="string">&quot;John&quot;</span>, <span class="string">&quot;Kent&quot;</span>&#125;;</span><br><span class="line"><span class="keyword">return</span> people.FirstOrDefault(x =&gt; candidates.Contains(x)) ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h4><p>This chapter introduces me to the concept of complete encapsulation! If you want to learn detailed motivation and mechanics, study the chapter 7 “ Encapsulation “ of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. and it improves our programmer’s ability.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/30/refactoring-chapter-6-a-first-set-of-refactorings/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/30/refactoring-chapter-6-a-first-set-of-refactorings/" class="post-title-link" itemprop="url">A First Set of Refactorings</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-30 18:51:21" itemprop="dateCreated datePublished" datetime="2022-01-30T18:51:21+08:00">2022-01-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:26" itemprop="dateModified" datetime="2023-11-19T15:47:26+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This article references the chapter 6 “ A First Set of Refactorings “ of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. Author had highlighted many important refactorings in this chapter.</p>
<p>I use .NET C# to practice with these refactorings and upload to Github.</p>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/wp-content/uploads/2022/01/plumber-4427401_1920-1024x620.jpg"><img src="https://geekcodeparadise.com/wp-content/uploads/2022/01/plumber-4427401_1920-1024x620.jpg" alt="A first set of refactorings"></a></p>
<p>(Photo from Pixabay: <a target="_blank" rel="noopener" href="https://pixabay.com/illustrations/plumber-repair-tools-pipe-plunger-4427401/">https://pixabay.com/illustrations/plumber-repair-tools-pipe-plunger-4427401/ )</a></p>
<h4 id="Extract-Function"><a href="#Extract-Function" class="headerlink" title="Extract Function"></a>Extract Function</h4><h5 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Redundant logics should be extracted as a function</li>
<li>A function is best when developers see its naming and understand what it does without looking at its implementation.</li>
<li>A function usually has few lines of code.</li>
<li>Sometimes a extracted function is not proper, then transfer it into inline lines.</li>
</ul>
<h5 id="Examples"><a href="#Examples" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>No Variables Out of Scope</li>
<li>Using Local Variables</li>
<li>Reassigning a Local Variable</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Extract%20Function">Github</a></p>
<h4 id="Inline-Function"><a href="#Inline-Function" class="headerlink" title="Inline Function"></a>Inline Function</h4><h5 id="Tips-1"><a href="#Tips-1" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If the indirect call of this function is not required, make it as inline function</li>
<li>This function has no polymorphism. It means that if this function belongs to a class and subclass uses it, inline function doesn’t work.</li>
</ul>
<h5 id="Examples-1"><a href="#Examples-1" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Rating</li>
<li>Report Lines</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Inline%20Function">Github</a></p>
<h4 id="Extract-Variable"><a href="#Extract-Variable" class="headerlink" title="Extract Variable"></a>Extract Variable</h4><h5 id="Tips-2"><a href="#Tips-2" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Some expressions are complex, so use Extract Variable to improve readability.</li>
<li>Check the target expression has no side-effect before extract it</li>
</ul>
<h5 id="Examples-2"><a href="#Examples-2" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Static Function</li>
<li>In a Class</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Extract%20Variable">Github</a></p>
<h4 id="Inline-Variable"><a href="#Inline-Variable" class="headerlink" title="Inline Variable"></a>Inline Variable</h4><h5 id="Tips-3"><a href="#Tips-3" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If this variable hinders the nearby refactoring, this variable should be removed.</li>
<li>Check the right side of the assignment to the variable has no side-effect.</li>
</ul>
<h5 id="Examples-3"><a href="#Examples-3" class="headerlink" title="Examples:"></a>Examples:</h5><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> grade = student.Grade;</span><br><span class="line"><span class="keyword">return</span> (grade &gt;= <span class="number">60</span>);</span><br><span class="line"><span class="comment">// after Inline Variable</span></span><br><span class="line"><span class="keyword">return</span> student.Grade &gt;= <span class="number">60</span>;</span><br></pre></td></tr></table></figure>

<h4 id="Change-Function-Declaration"><a href="#Change-Function-Declaration" class="headerlink" title="Change Function Declaration"></a>Change Function Declaration</h4><h5 id="Tips-4"><a href="#Tips-4" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>A good function name increases readability.</li>
<li>Changing parameters of a function decouple between the modules.</li>
<li>If an published API should be refactored, then use [deprecated] for the original function. After a period, migrate the old function to the new one and remove the old one.</li>
</ul>
<h5 id="Examples-4"><a href="#Examples-4" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Renaming a Function (Simple Mechanics)</li>
<li>Renaming a Function (Migration Mechanics)</li>
<li>Adding a Paramete</li>
<li>Changing a Parameter to One of Its Properties</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Change%20Function%20Declaration">Github</a></p>
<h4 id="Encapsulate-Variable"><a href="#Encapsulate-Variable" class="headerlink" title="Encapsulate Variable"></a>Encapsulate Variable</h4><h5 id="Tips-5"><a href="#Tips-5" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Usually use function to encapsulate access of variables</li>
<li>For mutable data, if its scope exceeds one function, we encapsulate it.</li>
<li>If the variable’s value is a record, we can use <strong><em>Encapsulate Record</em></strong></li>
</ul>
<h5 id="Examples-5"><a href="#Examples-5" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Simple</li>
<li>Encapsulating the Value</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Encapsulate%20Variable">Github</a></p>
<h4 id="Rename-Variable"><a href="#Rename-Variable" class="headerlink" title="Rename Variable"></a>Rename Variable</h4><h5 id="Tips-6"><a href="#Tips-6" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Good naming increases readability</li>
<li>If the variable is widely used, we can use <strong><em>Encapsulate Variable</em></strong></li>
<li>If this variable is a published variable, we can’t use this refactoring</li>
</ul>
<h5 id="Examples-6"><a href="#Examples-6" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Encapsulating Variable</li>
<li>Renaming a Constant</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Rename%20Variable">Github</a></p>
<h4 id="Introduce-Parameter-Object"><a href="#Introduce-Parameter-Object" class="headerlink" title="Introduce Parameter Object"></a>Introduce Parameter Object</h4><h5 id="Tips-7"><a href="#Tips-7" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Use a class to packs the parameters of a function</li>
<li>Keep these classes as Value Objects (DDD)</li>
<li>Use <strong><em>Change Function Declaration</em></strong> to create the new class parameter</li>
</ul>
<h5 id="Examples-7"><a href="#Examples-7" class="headerlink" title="Examples:"></a>Examples:</h5><ul>
<li>Change Function Declaration</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Introduce%20Parameter%20Object">Github</a></p>
<h4 id="Combine-Functions-into-Class"><a href="#Combine-Functions-into-Class" class="headerlink" title="Combine Functions into Class"></a>Combine Functions into Class</h4><h5 id="Tips-8"><a href="#Tips-8" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If some parameter exists in multiple functions, creating a class is a good choice. Move the parameter to class field and reduce parameter of function.</li>
<li><strong><em>Combine Functions into Transform</em></strong> is another choice depending on the context</li>
<li>Use <strong><em>Encapsulate Record</em></strong> for the previously mentioned parameters. Then use <strong><em>Move Function</em></strong> for those function into a new class.</li>
<li>We can use <strong><em>Extract Function</em></strong> for the logic processing the record data into the new class.</li>
</ul>
<h5 id="Examples-8"><a href="#Examples-8" class="headerlink" title="Examples:"></a>Examples:</h5><p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Combine%20Functions%20into%20Class">Github</a></p>
<h4 id="Combine-Functions-into-Transform"><a href="#Combine-Functions-into-Transform" class="headerlink" title="Combine Functions into Transform"></a>Combine Functions into Transform</h4><h5 id="Tips-9"><a href="#Tips-9" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>Transform function loads the original data, then use some functions to get new data and set it the fields of <strong>derivation</strong> data.</li>
<li>Comparing with <strong><em>Combine Functions into Class,</em></strong> if some code logic updates the original data, <strong><em>Combine Functions into Class</em></strong> is better.</li>
<li>In a transform function, first <strong>deep copy</strong> the loaded original data into result(derivation) data. Finally return this result data.</li>
<li>If the structure of the result is the same as the original, the transform function uses “Enrich” as prefix naming. If the structure changes, then use “Transform” as prefix naming.</li>
<li>It’s not recommended for JavaScript to use this refactoring instead of using <strong><em>Combine Functions into Class</em></strong> because of <strong>Immutable data</strong></li>
</ul>
<h5 id="Examples-9"><a href="#Examples-9" class="headerlink" title="Examples:"></a>Examples:</h5><p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Combine%20Functions%20into%20Transform">Github</a></p>
<h4 id="Split-Phase"><a href="#Split-Phase" class="headerlink" title="Split Phase"></a>Split Phase</h4><h5 id="Tips-10"><a href="#Tips-10" class="headerlink" title="Tips"></a>Tips</h5><ul>
<li>If some logic concurrently processes 2 different things, then separate it into 2 independent modules.</li>
<li>Extract the second phase code as a new function. And create an intermediate data structure as the parameter of the new function.</li>
<li>If some parameters in second phase are used by first phase, then move these parameters into the intermediate data structure.</li>
<li>Extract the first phase as a function and this function returns the intermediate data structure.</li>
</ul>
<h5 id="Examples-10"><a href="#Examples-10" class="headerlink" title="Examples:"></a>Examples:</h5><p><a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd/tree/master/Ch6.A%20First%20Set%20of%20Refactorings/Split%20Phase">Github</a></p>
<h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h4><p>This chapter introduces me to a whole clever coding environment! I think I ever did some similar refactorings in my previous projects without so detailed guidelines. If you want to learn detailed motivation and mechanics, study the chapter 6 “ A First Set of Refactorings “ of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. and it improves our programmer’s ability.</p>
<p>A First Set of Refactorings</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/09/refactoring-2nd-chapter-1-example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/09/refactoring-2nd-chapter-1-example/" class="post-title-link" itemprop="url">Refactoring Example - RPG Game Hunting Mission</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-09 23:11:21" itemprop="dateCreated datePublished" datetime="2022-01-09T23:11:21+08:00">2022-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:26" itemprop="dateModified" datetime="2023-11-19T15:47:26+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Welcome-to-Refactoring-World"><a href="#Welcome-to-Refactoring-World" class="headerlink" title="Welcome to Refactoring World!"></a>Welcome to Refactoring World!</h1><h4 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h4><p>I will write a series of refactoring article based on Martin Fowler’s <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. This book introduced many useful refactoring techniques. So I want to share what I learned from this book by explaining some refactoring examples and noting important concepts&#x2F;tips. The first one refactoring example in this article!</p>
<p>In the chapter 1 of the book, it introduced a case about the bill calculation of performing theatrical plays. The case first was an ugly function code to generate a bill. After some refactoring skills, the code looked CLEAR. How beautiful the code is!</p>
<p>According to this case, I will mock a similar function code to show how the refactoring skill works in this example. The following code is written by C# &amp; .NET 5.</p>
<h4 id="2-RPG-Game-Hunting-Mission"><a href="#2-RPG-Game-Hunting-Mission" class="headerlink" title="2. RPG Game Hunting Mission"></a>2. RPG Game Hunting Mission</h4><p>This scenario is a RPG Game. In a RPG Game, a player can take hunting mission to earn bonus and experience. If player completes the mission, then mission manager will give you the bonus&#x2F;experience. The type and level of monster killed by player determines the amount of bonus and experience.</p>
<p><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/122222.jpg" alt="refactoring example rpg game"></p>
<p>Bless Unleashed (Picture Source: <a target="_blank" rel="noopener" href="https://draft.blogger.com/blog/post/edit/760085690055515370/8483927943229049666?hl=zh-TW#">https://www.mmorpg.com/news/bless-unleashed-gm-battlefield-event-for-june-19-2000122222</a>)</p>
<h5 id="2-1-Monsters-and-Mission"><a href="#2-1-Monsters-and-Mission" class="headerlink" title="2.1 Monsters and Mission"></a>2.1 Monsters and Mission</h5><p>Mission manager have a monster list that shows the id, name and type. As the following Figure 1 shows:</p>
<p><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/ch1_monsters.png"></p>
<p>Figure 1. Monster List (Monster picture source: <a target="_blank" rel="noopener" href="https://draft.blogger.com/blog/post/edit/760085690055515370/8483927943229049666?hl=zh-TW#">https://opengameart.org/content/dungeon-crawl-selected-upscale</a>)</p>
<p>One hunting mission includes these monsters as the following Figure 2 shows:</p>
<p><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/ch1_mission.png"></p>
<p>Figure 2. Mission Detail</p>
<p>I create some classes representing the structure of these monster list and mission.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HuntingMission</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;HuntingTarget&gt; Targets &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingMission</span>(<span class="params"><span class="built_in">string</span> name, List&lt;HuntingTarget&gt; targets</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Name = name;</span><br><span class="line">Targets = targets;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HuntingTarget</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MonsterId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Level &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTarget</span>(<span class="params"><span class="built_in">string</span> monsterId, <span class="built_in">int</span> level</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">MonsterId = monsterId;</span><br><span class="line">Level = level;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Monster</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Type &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Monster</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Name = name;</span><br><span class="line">Type = type;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then create instances representing the above monster list and mission:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, Monster&gt;();</span><br><span class="line">monsters.Add(<span class="string">&quot;fire_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Fire Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;stone_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Stone Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;bone_dragon&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Bone Dragon&quot;</span>, <span class="string">&quot;dragon&quot;</span>));</span><br><span class="line">HuntingMission mission = <span class="keyword">new</span> HuntingMission(<span class="string">&quot;Giant &amp; Dragon Hunting&quot;</span>, <span class="keyword">new</span> List&lt;HuntingTarget&gt;(<span class="keyword">new</span>[]</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;fire_giant&quot;</span>, <span class="number">55</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;bone_dragon&quot;</span>, <span class="number">40</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;stone_giant&quot;</span>, <span class="number">61</span>)</span><br><span class="line">&#125;));</span><br><span class="line">List&lt;HuntingMission&gt; missions = <span class="keyword">new</span> List&lt;HuntingMission&gt;(<span class="keyword">new</span>[] &#123; mission &#125;);</span><br></pre></td></tr></table></figure>

<h5 id="2-2-First-version-of-Calculation-of-Bonus-Experience"><a href="#2-2-First-version-of-Calculation-of-Bonus-Experience" class="headerlink" title="2.2 First version of Calculation of Bonus&#x2F;Experience"></a>2.2 First version of Calculation of Bonus&#x2F;Experience</h5><p>Create a mission manager class and a function Statement. Pass the monster list and mission to this Statement function and it returns a calculated bonus&#x2F;experience string.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> monster = monsters[missionTarget.MonsterId];</span><br><span class="line"><span class="built_in">int</span> thisBonus = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">thisBonus = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">thisBonus += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">thisBonus = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">thisBonus += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">thisBonus += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monster.Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-The-Problem-of-This-Function"><a href="#2-3-The-Problem-of-This-Function" class="headerlink" title="2.3 The Problem of This Function"></a>2.3 The Problem of This Function</h5><ol>
<li>It’s not clear</li>
<li>If the returned string need HTML format, adding this feature to this code is not maintainable.</li>
<li>If the type of monster is increased, adding this feature is also hard.</li>
</ol>
<p>The tip at book’s page 4 describes:</p>
<blockquote>
<p><em><strong>When you have to add a feature to a program but the code is not structured in a convenient way, first refactor the program to make it easy to add the feature, then add the feature.</strong></em></p>
</blockquote>
<p>As this tip’s guide, let’s refactor the code!</p>
<h5 id="2-4-The-First-Step-in-Refactoring"><a href="#2-4-The-First-Step-in-Refactoring" class="headerlink" title="2.4 The First Step in Refactoring"></a>2.4 The First Step in Refactoring</h5><p>The tip at book’s page 5 describes:</p>
<blockquote>
<p><strong><em>Before you start refactoring, make sure you have a solid suite of tests. These tests must be self-checking.</em></strong></p>
</blockquote>
<p>I have created a unit testing project to check current’s function is correct.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MIssionManagerTests</span></span><br><span class="line">&#123;</span><br><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Given_Mission_Monsters_Should_Return_Correct_Statement</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// arrange</span></span><br><span class="line">Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, Monster&gt;();</span><br><span class="line">monsters.Add(<span class="string">&quot;fire_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Fire Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;stone_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Stone Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;bone_dragon&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Bone Dragon&quot;</span>, <span class="string">&quot;dragon&quot;</span>));</span><br><span class="line">HuntingMission mission = <span class="keyword">new</span> HuntingMission(<span class="string">&quot;Giant &amp; Dragon Hunting&quot;</span>, <span class="keyword">new</span> List&lt;HuntingTarget&gt;(<span class="keyword">new</span>[]</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;fire_giant&quot;</span>, <span class="number">55</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;bone_dragon&quot;</span>, <span class="number">40</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;stone_giant&quot;</span>, <span class="number">61</span>)</span><br><span class="line">&#125;));</span><br><span class="line">List&lt;HuntingMission&gt; missions = <span class="keyword">new</span> List&lt;HuntingMission&gt;(<span class="keyword">new</span>[] &#123; mission &#125;);</span><br><span class="line"><span class="comment">// act</span></span><br><span class="line"><span class="built_in">string</span> result = <span class="keyword">new</span> MissionManager().Statement(missions.First(), monsters);</span><br><span class="line"><span class="comment">// assert</span></span><br><span class="line">Assert.AreEqual(</span><br><span class="line"><span class="string">&quot;Statement for Giant &amp; Dragon Hunting\nFire Giant: $750.00 (55 levels)\nBone Dragon: $950.00 (40 levels)\nStone Giant: $780.00 (61 levels)\nBonus was $2,480.00\nYou got 49 experiences\n&quot;</span>, </span><br><span class="line">result);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After call the Statement function with the above monster list and mission, the returned string is:</p>
<p>Statement for Giant &amp; Dragon Hunting<br>Fire Giant: $750.00 (55 levels)<br>Bone Dragon: $950.00 (40 levels)<br>Stone Giant: $780.00 (61 levels)<br>Bonus was $2,480.00<br>You got 49 experiences  </p>
<p>So the assertion is used to check the returned result is equal to the above string.I will change some code and use the unit testing to check again that my code keeps original solution. Testings are very important!</p>
<h5 id="2-5-Decomposing-the-Statement-Function"><a href="#2-5-Decomposing-the-Statement-Function" class="headerlink" title="2.5 Decomposing the Statement Function"></a>2.5 Decomposing the Statement Function</h5><p>The middle of the code has a <strong>switch</strong> statement that calculates the current bonus amount based on monster type. Let’s do the <em>Extract Function</em>: the switch statement is extracted to an amountFor  delegate function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> thisBonus = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">thisBonus = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">thisBonus += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">thisBonus = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">thisBonus += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">thisBonus += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> thisBonus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> monster = monsters[missionTarget.MonsterId];</span><br><span class="line"><span class="built_in">int</span> thisBonus = amountFor(missionTarget, monster);</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monster.Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This amountFor delegate function is simulating the code block like book’s JavaScript logic. If you are using C# 7.0 or higher version, it can be converted into <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/local-functions">local function</a>.</p>
<p>After run the unit testing, this code keeps original solution. The missionTarget and monster parameters are not modified in switch statement, so they can be passed to a function. </p>
<p>The tip at book’s page 8 describes:</p>
<blockquote>
<p><em><strong>Refactoring changes the programs in small steps, so if you make a mistake, it is easy to find where the bug is.</strong></em></p>
</blockquote>
<p>In the amountFor delegate function, the <em>thisBonus</em> variable naming is not clear, so <em>change</em> it to result naming:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>The <em>result</em> naming represents its responsibility and increases readability.</p>
<p>The tip at book’s page 10 describes:</p>
<blockquote>
<p>Any fool can write code that a computer can understand. Good programmers write code that humans can understand.</p>
</blockquote>
<p>What a ABSOLUTE TRUE!</p>
<h6 id="2-5-1-Removing-the-monster-Variable"><a href="#2-5-1-Removing-the-monster-Variable" class="headerlink" title="2.5.1 Removing the monster Variable"></a>2.5.1 Removing the monster Variable</h6><p>Let’s check the amountFor function, missionTarget variable is set a new value by every for loop, but monster variable is calculated by missionTarget. So monster variable is not required to be passed as a parameter.<br>Use a refactoring method <em>Replace Temp with Query</em>: extracting the right-hand site of the assignment into a function.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span>(HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> monster = monsterFor(missionTarget);</span><br><span class="line"><span class="built_in">int</span> thisBonus = amountFor(missionTarget, monster);</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monster.Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then use <em>Inline Variable.</em></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span>(HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> thisBonus = amountFor(missionTarget, monsterFor(missionTarget));</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then use <em>Change Function Declaration</em> to amountFor to remove the monster variable_._ There are 2 steps, in first step I change it to use monsterFor:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. In second step I remove the monster parameter of amountFor function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span>(HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> thisBonus = amountFor(missionTarget);</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. I feel concerned that monsterFor is called 4 times and is more than the first version (called 1 time). It seems a bit performance problem but it’s not a serious situation. Martin said he will discuss in later chapters.</p>
<p>Let’s use <em>Inline Variable</em> again_._ thisBonus variable is assigned and not modified so use amountFor to replace it:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span>(HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;(amountFor(missionTarget) / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works.</p>
<h6 id="2-5-2-Extracting-Total-Experience"><a href="#2-5-2-Extracting-Total-Experience" class="headerlink" title="2.5.2 Extracting Total Experience"></a>2.5.2 Extracting Total Experience</h6><p>totalExperience is updated in the for loop. Let’s extract the a function that calculates the new experience value and returns it to totalExperience:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> experience = <span class="number">0</span>;</span><br><span class="line">experience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">experience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> experience;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;(amountFor(missionTarget) / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. I also rename the experience variable to result:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works.</p>
<h6 id="2-5-3-Removing-the-localFormat-variable"><a href="#2-5-3-Removing-the-localFormat-variable" class="headerlink" title="2.5.3 Removing the localFormat variable"></a>2.5.3 Removing the localFormat variable</h6><p>Temporary variables are underlying problems. It’s suggested to transfer them into functions. Let’s create a declared function to replace localFormat:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; format = <span class="built_in">delegate</span>(<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> aNumber.ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;format(amountFor(missionTarget) / <span class="number">100</span>)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;format(totalBonus / <span class="number">100</span>)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. The function naming format is not clear that doesn’t explain its responsibility. Let’s use <em>Change Function Declaration</em> skill:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span>(<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> (aNumber / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Good function naming means that you can read the functionality without reading its underlying inner struct. Naming talks you what they do.</p>
<h6 id="2-5-4-Removing-the-totalExperience-variable"><a href="#2-5-4-Removing-the-totalExperience-variable" class="headerlink" title="2.5.4 Removing the totalExperience variable"></a>2.5.4 Removing the totalExperience variable</h6><p>This totalExperience variable is accumulated in a for loop. Let’s use <strong><em>Split Loop</em></strong> to separate it: </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then use <strong>Slide Statements</strong> to put the declaration of the variable close to the loop:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then use <em><strong>Extract Function</strong></em> to the totalExperience variable:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span>(<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> (aNumber / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> totalExperience;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">int</span> totalExperience = totalExperiences();</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next is <em>Inline Variable</em> to the totalExperience variable:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. </p>
<p>For totalBonus variable, I refactor it with the same refactoring skill done with totalExperience variable. First I use <em><strong>Extract Function</strong></em> to the totalBonus variable:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span>(<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> (aNumber / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> totalExperience;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> totalBonus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">int</span> totalBonus = totalBonuses();</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next is <em>Inline Variable</em> to the totalBonus variable:</p>
<p>public string Statement(HuntingMission mission, Dictionary&lt;string, Monster&gt; monsters)<br>{<br>string result &#x3D; $”Statement for {mission.Name}\n”;<br>foreach (var missionTarget in mission.Targets)<br>{<br>result +&#x3D;<br>$”{monsterFor(missionTarget).Name}: {usd(amountFor(missionTarget))} ({missionTarget.Level} levels)\n”;<br>}</p>
<p>result +&#x3D; $”Bonus was {usd(totalBonuses())}\n”;<br>result +&#x3D; $”You got {totalExperiences()} experiences\n”;</p>
<p>return result;<br>}</p>
<p>After compilation and testing, this refactoring example works. </p>
<p>Let’s rename the calculated variables to result:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">result += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2-6-Splitting-the-Phases-of-Calculation-and-Formatting"><a href="#2-6-Splitting-the-Phases-of-Calculation-and-Formatting" class="headerlink" title="2.6 Splitting the Phases of Calculation and Formatting"></a>2.6 Splitting the Phases of Calculation and Formatting</h4><p>The above Statement function can return the bonus&#x2F;experience by the monster list and the hunting mission. But the bonus&#x2F;experience format is a kind of version. If the format is extended into HTML version, how should I refactor it?Let’s use <strong><em>Split Phase</em></strong> to split the function into the logic of two phases: calculating the data structure of bonus&#x2F;experience and rendering the format(pure string or HTML) by the data structure.<em><strong>Extract Function</strong></em> is applied to the second phase that is rendering the format. The whole Statement’s content is transferred into another function RenderPlainText:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(mission, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then create a object that is transferred between the two phases:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, mission, monsters);&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Current SatatementData class has no any property. After compilation and testing, this refactoring example works.<br>Make RenderPlainText to use required parameter in StatementData instance. First step move mission name to this statementData:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, mission, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//all delegate functions are hidden</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then also move Targets to statementData and delete the mission variable:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, mission, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">result += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;HuntingTarget&gt; Targets &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. The StatementData’s Targets variable then is set as an immutable data by enrichTarget delegate function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, HuntingTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">HuntingTarget result = target;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Use <em><strong>Move Function</strong></em> skill to Statement and monsterFor functions, then all original references to monsterFor are replaced with data instance. Before I move them, I create another class <strong>CalculatedTarget.</strong> Its properties are the same as the class HuntingTarget and it has extra property Monster. CalculatedTarget’s instances are replaced with HuntingMission’s Targets. Then RenderPlainText’s referenced delegate functions are updated to use CalculatedTarget:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = monsterFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (missionTarget.Monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (missionTarget.Monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;missionTarget.Monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;CalculatedTarget&gt; Targets &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">CalculatedTarget</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MonsterId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Level &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CalculatedTarget</span>(<span class="params"><span class="built_in">string</span> monsterId, <span class="built_in">int</span> level</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">MonsterId = monsterId;</span><br><span class="line">Level = level;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then use the same <em><strong>Move Function</strong></em> skill to Statement and amountFor functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (missionTarget.Monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;missionTarget.Monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = monsterFor(result);</span><br><span class="line">result.Amount = amountFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Amount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>: <span class="subst">&#123;usd(missionTarget.Amount)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">CalculatedTarget</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MonsterId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Level &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Amount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CalculatedTarget</span>(<span class="params"><span class="built_in">string</span> monsterId, <span class="built_in">int</span> level</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">MonsterId = monsterId;</span><br><span class="line">Level = level;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then use the same <em><strong>Move Function</strong></em> skill to Statement and experienceFor functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (missionTarget.Monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = monsterFor(result);</span><br><span class="line">result.Amount = amountFor(result);</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">result += missionTarget.Experience;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>: <span class="subst">&#123;usd(missionTarget.Amount)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">CalculatedTarget</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MonsterId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Level &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Amount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Experience &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CalculatedTarget</span>(<span class="params"><span class="built_in">string</span> monsterId, <span class="built_in">int</span> level</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">MonsterId = monsterId;</span><br><span class="line">Level = level;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Finally,  use <em><strong>Move Function</strong></em> skill to Statement, totalExperiences and totalBonuses functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">result += missionTarget.Experience;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Amount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>: <span class="subst">&#123;usd(missionTarget.Amount)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(data.TotalBonuses)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;data.TotalExperiences&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;CalculatedTarget&gt; Targets &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> TotalBonuses &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> TotalExperiences &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Some functions are refactored with Replace Loop with Pipeline:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> data.Targets.Sum(x =&gt; x.Experience);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> data.Targets.Sum(x =&gt; x.Amount);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Extract the code into a independent function in the first phase (Statement Function) and  remove the monsters argument of RenderPlainText function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(CreateStatementData(mission, monsters));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then extract this CreateStatementData function into another class StatementDataManager: </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(<span class="keyword">new</span> StatementDataManager().CreateStatementData(mission, monsters));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. It’s easy to create a rendering HTML format function and create a new unit testing function to test it. For usd function, it’s transferred to top function because of common use:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">HtmlStatement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> RenderHtml(<span class="keyword">new</span> StatementDataManager().CreateStatementData(mission, monsters));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderHtml</span>(<span class="params">StatementData data</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;&lt;h1&gt;Statement for <span class="subst">&#123;data.MissionName&#125;</span>&lt;/h1&gt;\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;table&gt;\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;tr&gt;&lt;th&gt;Monster Name&lt;/th&gt;&lt;th&gt;Bonus&lt;/th&gt;&lt;th&gt;Level&lt;/th&gt;&lt;/tr&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;&lt;tr&gt;&lt;td&gt;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>&lt;/td&gt;&lt;td&gt;<span class="subst">&#123;Usd(missionTarget.Amount)&#125;</span>&lt;/td&gt;&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;td&gt;<span class="subst">&#123;missionTarget.Level&#125;</span>&lt;/td&gt;&lt;/tr&gt;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;&lt;/table&gt;\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;p&gt;Bonus was &lt;em&gt;<span class="subst">&#123;Usd(data.TotalBonuses)&#125;</span>&lt;/em&gt;&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;p&gt;You got &lt;em&gt;<span class="subst">&#123;data.TotalExperiences&#125;</span>&lt;/em&gt; experiences&lt;/p&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">Usd</span>(<span class="params"><span class="built_in">int</span> aNumber</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> (aNumber / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MIssionManagerTests</span></span><br><span class="line">&#123;</span><br><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Given_Mission_Monsters_Should_Return_Correct_Statement</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Given_Mission_Monsters_Should_Return_Correct_HtmlStatement</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// arrange</span></span><br><span class="line">Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, Monster&gt;();</span><br><span class="line">monsters.Add(<span class="string">&quot;fire_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Fire Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;stone_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Stone Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;bone_dragon&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Bone Dragon&quot;</span>, <span class="string">&quot;dragon&quot;</span>));</span><br><span class="line">HuntingMission mission = <span class="keyword">new</span> HuntingMission(<span class="string">&quot;Giant &amp; Dragon Hunting&quot;</span>, <span class="keyword">new</span> List&lt;HuntingTarget&gt;(<span class="keyword">new</span>[]</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;fire_giant&quot;</span>, <span class="number">55</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;bone_dragon&quot;</span>, <span class="number">40</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;stone_giant&quot;</span>, <span class="number">61</span>)</span><br><span class="line">&#125;));</span><br><span class="line">List&lt;HuntingMission&gt; missions = <span class="keyword">new</span> List&lt;HuntingMission&gt;(<span class="keyword">new</span>[] &#123; mission &#125;);</span><br><span class="line"><span class="comment">// act</span></span><br><span class="line"><span class="built_in">string</span> result = <span class="keyword">new</span> MissionManager().HtmlStatement(missions.First(), monsters);</span><br><span class="line"><span class="comment">// assert</span></span><br><span class="line">Assert.AreEqual(</span><br><span class="line"><span class="string">&quot;&lt;h1&gt;Statement for Giant &amp; Dragon Hunting&lt;/h1&gt;\n&lt;table&gt;\n&lt;tr&gt;&lt;th&gt;Monster Name&lt;/th&gt;&lt;th&gt;Bonus&lt;/th&gt;&lt;th&gt;Level&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Fire Giant&lt;/td&gt;&lt;td&gt;$750.00&lt;/td&gt;&lt;td&gt;55&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Bone Dragon&lt;/td&gt;&lt;td&gt;$950.00&lt;/td&gt;&lt;td&gt;40&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Stone Giant&lt;/td&gt;&lt;td&gt;$780.00&lt;/td&gt;&lt;td&gt;61&lt;/td&gt;&lt;/tr&gt;\n&lt;/table&gt;\n&lt;p&gt;Bonus was &lt;em&gt;$2,480.00&lt;/em&gt;&lt;/p&gt;\n&lt;p&gt;You got &lt;em&gt;49&lt;/em&gt; experiences&lt;/p&gt;\n&quot;</span>,</span><br><span class="line">result);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works.</p>
<h5 id="2-7-Status-Separated-into-Two-Files-and-Phases"><a href="#2-7-Status-Separated-into-Two-Files-and-Phases" class="headerlink" title="2.7 Status: Separated into Two Files (and Phases)"></a>2.7 Status: Separated into Two Files (and Phases)</h5><p>Current files are separated into MissionManager and StatementDataManager 2 files. Although these code lines has increased, refactoring makes the code more readability. This separation of logic (calculation &amp; rendering) enhances the modular design and no redundant calculation logic.</p>
<p>The tip at book’s page 34 describes:</p>
<blockquote>
<p>When programming, follow the camping rule: Always leave the code base healthier than when you found it.</p>
</blockquote>
<p>Make the code healthier again!</p>
<h5 id="2-8-Reorganizing-the-Calculations-by-Type"><a href="#2-8-Reorganizing-the-Calculations-by-Type" class="headerlink" title="2.8 Reorganizing the Calculations by Type"></a>2.8 Reorganizing the Calculations by Type</h5><p>In this example, amountFor and experienceFor functions determines their result based on the monster type. Current type has dragon and giant. But in the future the type possibly increases, and using if&#x2F;else if to extend the feature is not a good choice. <em>Replace Conditional with Polymorphism</em> is a better skill to refactor it. Before use polymorphism, should create a class and it contains amountFor and experienceFor functions.In StatementDataManager’s enrichTarget function, it calls amountFor and experienceFor, So I create a class HuntingTargetCalculator and use this class to call the 2 functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target);</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = monsterFor(result);</span><br><span class="line">result.Amount = amountFor(result);</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">_target = target;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s create first property Monster in HuntingTargetCalculator. This property is passed by <strong><em>Change Function Declaration</em></strong> skill to mosterFor function. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = amountFor(result);</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">_target = target;</span><br><span class="line">Monster = monster;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works. Next function is amountFor. Use _<strong>Move Function</strong>_to move its function body to HuntingTargetCalculator:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> HuntingTargetCalculator(missionTarget, monsterFor(missionTarget)).Amount;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = amountFor(target);</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Amount</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (Monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (_target.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (_target.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (_target.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (_target.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * _target.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;Monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">_target = target;</span><br><span class="line">Monster = monster;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works. Then use Inline Function skill to directly call the Amount get property and remove amountFor function of CreateStatementData:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = calculator.Amount;</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works. I use the same skills to experienceFor function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = calculator.Amount;</span><br><span class="line">result.Experience = calculator.Experience;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Amount</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Experience</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(_target.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (Monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += _target.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works.</p>
<h6 id="2-8-1-Making-the-HuntingTarget-Calculator-Polymorphic"><a href="#2-8-1-Making-the-HuntingTarget-Calculator-Polymorphic" class="headerlink" title="2.8.1 Making the HuntingTarget Calculator Polymorphic"></a>2.8.1 Making the HuntingTarget Calculator Polymorphic</h6><p>Use <strong><em>Replace Type Code with Subclasses</em></strong> to apply the polymorphism. Create a factory method CreateHuntingTargetCalculator to create a super class. It determine which subclass of HuntingTargetCalculator to be generated by monster type:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = CreateHuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = calculator.Amount;</span><br><span class="line">result.Experience = calculator.Experience;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> HuntingTargetCalculator <span class="title">CreateHuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> GiantTargetCalculator(target, monster);</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> DragonTargetCalculator(target, monster);</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I modify the HuntingTargetCalculator as an abstract class and this class updates the Amount &amp; Experience as virtual functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">int</span> Amount &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">int</span> Experience</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(_target.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">_target = target;</span><br><span class="line">Monster = monster;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GiantTargetCalculator and DragonTargetCalculator inherit HuntingTargetCalculator. Let’s use Replace Conditional with Polymorphism skill to implement Amount&#x2F;Experience in those subclass:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">DragonTargetCalculator</span> : <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DragonTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>) : <span class="title">base</span>(<span class="params">target, monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> Amount</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (_target.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (_target.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * _target.Level;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> Experience</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">base</span>.Experience + _target.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">GiantTargetCalculator</span> : <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GiantTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>) : <span class="title">base</span>(<span class="params">target, monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> Amount</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (_target.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (_target.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works.</p>
<h4 id="3-Conclusions"><a href="#3-Conclusions" class="headerlink" title="3. Conclusions"></a>3. Conclusions</h4><p>I can’t believe that the original one function is changed into complex but very maintainable and readable functions&#x2F;structures. Following the chapter 1 of the book to get this result is very impressive!Let’s see that this example has three major evolution: </p>
<ol>
<li>Splitting a function into nested functions,</li>
<li>Split phase to separate the calculation and rendering code</li>
<li>Use polymorphism to process calculation</li>
</ol>
<p>The tip at book’s page 43 describes:</p>
<blockquote>
<p><em><strong>The true test of good code is how easy it is to change it</strong>.</em></p>
</blockquote>
<p>It’s also a ABSOLUTE TRUTH! I have learned classic 23 design patterns and applied them in some projects. Although these patterns were helpful to extend features, but I lacked some skills to decide when&#x2F;how I should refactor these patterns.This book provides many concepts to refactor those legacy codes. I think it should be read by every developer!<br>This example can be download in my <a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd.git">Github repository</a></p>
<h4 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h4><p><a target="_blank" rel="noopener" href="https://draft.blogger.com/blog/post/edit/760085690055515370/8483927943229049666?hl=zh-TW#">Refactoring: Improving the Design of Existing Code (2nd Edition)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/09/home/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/09/home/" class="post-title-link" itemprop="url">Home</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-09 22:16:36" itemprop="dateCreated datePublished" datetime="2022-01-09T22:16:36+08:00">2022-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/26/professional-javascript-for-web-developers-chapter-5-basic-reference-types/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/26/professional-javascript-for-web-developers-chapter-5-basic-reference-types/" class="post-title-link" itemprop="url">JavaScript Basic Reference Type</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-26 16:22:00" itemprop="dateCreated datePublished" datetime="2021-12-26T16:22:00+08:00">2021-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:26" itemprop="dateModified" datetime="2023-11-19T15:47:26+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/" itemprop="url" rel="index"><span itemprop="name">讀書筆記</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本篇為 Professional JavaScript for Web Developers 第5章 Basic Reference Type 的讀書筆記</p>
<h4 id="1-1-Date-Type"><a href="#1-1-Date-Type" class="headerlink" title="1.1 Date Type"></a>1.1 Date Type</h4><ul>
<li>Date儲存從1970年1月1日 UTC 前後經過的毫秒.</li>
<li>new Date()可得到local的現在時間</li>
<li>Date的constructor可代入毫秒做初始化為別的時間</li>
<li>Date.parse()和Date.UTC()可回傳1970&#x2F;1&#x2F;1 UTC的經過毫秒時間</li>
<li>Date.parse()可解析多種日期字串, 且會受地區影響</li>
<li>在Date() constructor代入日期字串, 其背後也是Date.parse()</li>
<li>Date.UTC()以UTC時間為基準</li>
<li>但在Date() constructor代入和UTC的參數方式, 是得到local time</li>
<li>一段程式碼運行的時間差可以用2筆Date.now()相減, 取得執行前後的毫秒差</li>
</ul>
<p>&#x2F;&#x2F; 假如現在是台灣 GMT+8 的 2020&#x2F;6&#x2F;13 下午2點<br>let d1 &#x3D; new Date();<br>console.log(d1.getUTCHours()); &#x2F;&#x2F; 輸出 UTC的 早上6點</p>
<p>let d2 &#x3D; new Date(Date.parse(“2020&#x2F;6&#x2F;13 14:00:00”));<br>console.log(d2.getUTCHours()); &#x2F;&#x2F; 輸出 UTC的 早上6點</p>
<p>let d3 &#x3D; new Date(Date.UTC(2020, 5, 13, 14, 0, 0));<br>console.log(d3.getUTCHours()); &#x2F;&#x2F; 輸出 UTC的 下午2點</p>
<p>let d4 &#x3D; new Date(2020, 5, 13, 14, 0, 0);<br>console.log(d4.getUTCHours()); &#x2F;&#x2F; 輸出 UTC的 早上6點</p>
<p>let startD &#x3D; Date.now();<br>console.log(‘do something’);<br>let endD &#x3D; Date.now();<br>let diff &#x3D; endD - startD;<br>console.log(diff); &#x2F;&#x2F; 輸出 毫秒差</p>
<h5 id="1-1-1-Inherited-Methods"><a href="#1-1-1-Inherited-Methods" class="headerlink" title="1.1.1 Inherited Methods"></a>1.1.1 Inherited Methods</h5><ul>
<li>toLocaleString()和toString()每個瀏覽器輸出的格式稍微不同, 只能用在Debug</li>
<li>valueOf()會用在比較的operator等, 做時間前後的比較運算, 實際邏輯是取出毫秒值做大小比對</li>
</ul>
<h5 id="1-1-2-Date-Formatting-Methods"><a href="#1-1-2-Date-Formatting-Methods" class="headerlink" title="1.1.2 Date-Formatting Methods"></a>1.1.2 Date-Formatting Methods</h5><ul>
<li>有toDateString(), toTimeString(), toLocaleDateString(), toLocalseTimeString(), toUTCString(), 都和toString()一樣, 每個瀏覽器的輸出各有稍微不同</li>
<li>還有個toGMTString(), 和toUTCString()結果一樣, 所以建議用toUTCString()</li>
</ul>
<h5 id="1-1-3-Date-Time-Component-Methods"><a href="#1-1-3-Date-Time-Component-Methods" class="headerlink" title="1.1.3 Date&#x2F;Time Component Methods"></a>1.1.3 Date&#x2F;Time Component Methods</h5><ul>
<li>剩下的Date方法有取特定日期&#x2F;時間格式、設置特定日期&#x2F;格式, 以getXXXX()或setXXXX()命名.</li>
<li>其中getTime()和valueOf()一樣, 都是取UTC為準的毫秒差.</li>
</ul>
<h4 id="1-2-RexExp-Type"><a href="#1-2-RexExp-Type" class="headerlink" title="1.2 RexExp Type"></a>1.2 RexExp Type</h4><ul>
<li>用這type支援regular expression的匹配</li>
<li>格式為 let expression &#x3D; &#x2F;pattern&#x2F;flags</li>
<li>pattern為任意的regular expression, 而flags可以是1個或多個</li>
<li>flag有6種</li>
</ul>
<ol>
<li>g : 代表global模式, 應用所有字串, 而不是只有前面字串有match就停止</li>
<li>i: 不區分大小寫</li>
<li>m: 多行模式, 遇到結尾符號仍繼續往下找</li>
<li>y: sticky模式, pattern從lastIndex開始找</li>
<li>u: unicode模式</li>
<li>s: (這本書還未提到) ES2018出現的新模式, 允許 . 字元 match跳行, 可參考<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/dotAll">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects&#x2F;RegExp&#x2F;dotAll</a></li>
</ol>
<p>let pattern1 &#x3D; &#x2F;ad&#x2F;g; &#x2F;&#x2F; match字串中有ad的子字串</p>
<p>let pattern2 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; match第1個有bad或sad的子字串, 且不分大小寫</p>
<p>let pattern3 &#x3D; &#x2F;.ad&#x2F;gi; &#x2F;&#x2F; match以ad結尾, 且不區分大小寫</p>
<ul>
<li>Regular expression有些特殊的字元, 其有特殊的意義, 想把特殊字元當作比對的字, 加上 \ 符號</li>
<li>( { [ ^ $ ) ] } ? * + .</li>
</ul>
<p> </p>
<p>let pattern1 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; match第1個有bad或sad的子字串, 且不分大小寫</p>
<p>let pattern2 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; match第1個有[bs]ad的子字串, 且不分大小寫</p>
<p>let pattern3 &#x3D; &#x2F;.ad&#x2F;gi; &#x2F;&#x2F; match以ad結尾, 且不區分大小寫</p>
<p>let pattern4 &#x3D; &#x2F;.ad&#x2F;gi; &#x2F;&#x2F; match字串有.ad的子字串, 且不區分大小寫</p>
<ul>
<li>使用RegExp構造函數和一般expression的是同一個Type</li>
<li>RegExp代入的字串pattern, 要再經過轉換才能用</li>
</ul>
<p>let pattern1 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; match第1個有bad或sad的子字串, 且不分大小寫</p>
<p>let pattern2 &#x3D; new RegExp(“[bs]ad”, “i”); &#x2F;&#x2F; 和pattern1一樣</p>
<p>let pattern3 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; match第1個有[bs]ad的子字串, 且不分大小寫</p>
<p>let pattern4 &#x3D; new RegExp(“\[bs\]ad”, “i”); &#x2F;&#x2F; 和pattern3一樣</p>
<p>let pattern5 &#x3D; &#x2F;.ad&#x2F;gi; &#x2F;&#x2F; match字串有.ad的子字串, 且不區分大小寫</p>
<p>let pattern6 &#x3D; new RegExp(“\.ad&#x2F;gi”, “i”); &#x2F;&#x2F; 和pattern5一樣</p>
<ul>
<li>用RegExp的test, 可測試是否某字串有match此pattern</li>
<li>但RegExp只要做比對的功能, 內部的比對index不會重置, 所以會有需要重新初始化的功能</li>
</ul>
<p>let pattern1 &#x3D; &#x2F;[bs]ad&#x2F;g; &#x2F;&#x2F; match有bad或sad的子字串</p>
<p>console.log(pattern1.test(‘sad_man’)); &#x2F;&#x2F; 輸出true</p>
<p>console.log(pattern1.test(‘sad_man’)); &#x2F;&#x2F; 因為前面比對過而index往後沒再match, 輸出false</p>
<h5 id="1-2-1-RegExp-Instance-Properties"><a href="#1-2-1-RegExp-Instance-Properties" class="headerlink" title="1.2.1 RegExp Instance Properties"></a>1.2.1 RegExp Instance Properties</h5><ul>
<li>global: boolean, 是否有設定g flag</li>
<li>ignoreCase: boolean, 是否有設置i flag</li>
<li>unicode: boolean, 是否有設置u flag</li>
<li>sticky: boolean, 是否有設置y flag</li>
<li>lastIndex: integer, 下次匹配開始的位置, 位置是從0開始</li>
<li>multiline: boolean, 是否有設置m flag</li>
<li>source: expression pattern字串</li>
<li>flags: expression flag字串</li>
<li>dotAll: (這本書尚未提到) boolean, 是否有設置s flag</li>
</ul>
<p>let pattern1 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; match第1個有[bs]ad的子字串, 且不分大小寫</p>
<p>console.log(pattern1.global); &#x2F;&#x2F; false<br>console.log(pattern1.ignoreCase); &#x2F;&#x2F; true<br>console.log(pattern1.multiline); &#x2F;&#x2F; false<br>console.log(pattern1.dotAll); &#x2F;&#x2F; false<br>console.log(pattern1.lastIndex); &#x2F;&#x2F; 0<br>console.log(pattern1.source); &#x2F;&#x2F; “[bs]ad”<br>console.log(pattern1.flags); &#x2F;&#x2F; “i”</p>
<p>let pattern2 &#x3D; new RegExp(“\[bs\]ad”, “i”); &#x2F;&#x2F; 和pattern1一樣<br>console.log(pattern2.global); &#x2F;&#x2F; false<br>console.log(pattern2.ignoreCase); &#x2F;&#x2F; true<br>console.log(pattern2.multiline); &#x2F;&#x2F; false<br>console.log(pattern2.dotAll); &#x2F;&#x2F; false<br>console.log(pattern2.lastIndex); &#x2F;&#x2F; 0<br>console.log(pattern2.source); &#x2F;&#x2F; “[bs]ad”<br>console.log(pattern2.flags); &#x2F;&#x2F; “i”</p>
<h5 id="1-2-2-RegExp-Instance-Methods"><a href="#1-2-2-RegExp-Instance-Methods" class="headerlink" title="1.2.2 RegExp Instance Methods"></a>1.2.2 RegExp Instance Methods</h5><ul>
<li>exec()是主要做match的函式, 回傳的物件是Array和一些額外屬性: index和input</li>
<li>index代表目前match到的字串起始位置, 而input是被比對的字串</li>
<li>假如沒有任何match, 回傳的物件是Null, 否則Array的第1筆資料是有比對到的字串, 第2筆以後是有用 () 分組的capturing group</li>
<li>RegExp物件會更新lastIndex的值, 代表下次要match的起始位置</li>
<li>RegExp的valueOf()是回傳本身RegExp物件</li>
</ul>
<p>let text &#x3D; ‘hello my mom my dad’;<br>let pattern &#x3D; &#x2F;hello( my mom( my dad)?)?&#x2F;gi;</p>
<p>let arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; 比對到的起始位置是 0<br>console.log(arr.input); &#x2F;&#x2F; 比對的原始字串 ‘hello my mom my dad’<br>console.log(arr[0]); &#x2F;&#x2F; 比對到的結果 ‘hello my mom my dad’<br>console.log(arr[1]); &#x2F;&#x2F; 最外層分組 ‘ my mom my dad’<br>console.log(arr[2]); &#x2F;&#x2F; 第2層分組 ‘ my dad’</p>
<p>&#x2F;&#x2F; 假如沒有用 g flag, pattern只會從第1個開始<br>let text &#x3D; ‘sad, bad, cad, dad’;<br>let pattern &#x3D; &#x2F;.ad&#x2F;; &#x2F;&#x2F; 前面有任意字元, 接著用ad</p>
<p>let arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; 比對到的起始位置是 0<br>console.log(arr[0]); &#x2F;&#x2F; 比對到的結果 ‘sad’<br>console.log(pattern.lastIndex); &#x2F;&#x2F; 下次比對仍從位置 0 開始</p>
<p>arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; 比對到的起始位置還是 0<br>console.log(arr[0]); &#x2F;&#x2F; 比對到的結果 ‘sad’<br>console.log(pattern.lastIndex); &#x2F;&#x2F; 下次比對仍從位置 0 開始</p>
<p>&#x2F;&#x2F; 假如有用 g flag, pattern不只比對到第1個字就停, 下次繼續往後面搜尋<br>let text &#x3D; ‘sad, bad, cad, dad’;<br>let pattern &#x3D; &#x2F;.ad&#x2F;g; &#x2F;&#x2F; 前面有任意字元, 接著用ad</p>
<p>let arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; 比對到的起始位置是 0<br>console.log(arr[0]); &#x2F;&#x2F; 比對到的結果 ‘sad’<br>console.log(pattern.lastIndex); &#x2F;&#x2F; 下次比對從位置 3 開始</p>
<p>arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; 比對到的起始位置是 5<br>console.log(arr[0]); &#x2F;&#x2F; 比對到的結果 ‘bad’<br>console.log(pattern.lastIndex); &#x2F;&#x2F; 下次比對從位置 8 開始</p>
<h5 id="1-2-3-RegExp-Constructor-Properties"><a href="#1-2-3-RegExp-Constructor-Properties" class="headerlink" title="1.2.3 RegExp Constructor Properties"></a>1.2.3 RegExp Constructor Properties</h5><ul>
<li>RegExp有些屬性是當前scope共通的屬性, 每個RegExp 物件會共用這些屬性</li>
<li>Constructor Properties並非所有瀏覽器有實作</li>
<li>常見的Constructor屬性有完整名字和短名字</li>
</ul>
<ol>
<li>input, 短名字為 $_ , 代表最近被比對的字串</li>
<li>lastMatch, 短名字為 $&amp;, 代表最近比對成功的字串</li>
<li>lastParen, 短名字為 $+, 代表最近比對的capturing group</li>
<li>leftContext, 短名字為 $`, 於input的lastMatch之前的字串</li>
<li>rightContext, 短名字為 $’, 於input的lastMatch之後的字串 </li>
<li>用$1、$2…到$9, 也能顯示最近比對的capturing group, 最多能取9個</li>
</ol>
<p>let text &#x3D; ‘choose character: captain teemo on duty’;<br>let pattern &#x3D; &#x2F;(.)aptain&#x2F;g;</p>
<p>if(pattern.test(text)){<br>   console.log(RegExp.input); &#x2F;&#x2F; 輸出 ‘choose character: captain teemo on duty’<br>   console.log(RegExp.$_); &#x2F;&#x2F; 輸出 ‘choose character: captain teemo on duty’</p>
<p>   console.log(RegExp.leftContext); &#x2F;&#x2F; 輸出 ‘choose character: ‘<br>   console.log(RegExp[“$`“]); &#x2F;&#x2F; 輸出 ‘choose character: ‘</p>
<p>   console.log(RegExp.rightContext); &#x2F;&#x2F; 輸出 ‘ teemo on duty’<br>   console.log(RegExp[“$’”]); &#x2F;&#x2F; 輸出 ‘ teemo on duty’</p>
<p>   console.log(RegExp.lastMatch); &#x2F;&#x2F; 輸出 ‘captain’<br>   console.log(RegExp[“$&amp;”]); &#x2F;&#x2F; 輸出 ‘captain’</p>
<p>   console.log(RegExp.lastParen); &#x2F;&#x2F; 輸出 ‘c’<br>   console.log(RegExp[“$+”]); &#x2F;&#x2F; 輸出 ‘c’<br>   console.log(RegExp.$1); &#x2F;&#x2F; 輸出 ‘c’<br>}</p>
<h5 id="1-2-4-Pattern-Limitations"><a href="#1-2-4-Pattern-Limitations" class="headerlink" title="1.2.4 Pattern Limitations"></a>1.2.4 Pattern Limitations</h5><ul>
<li>ECMAScript並非完整支援Regular Expression</li>
<li>不支援的功能有</li>
</ul>
<ol>
<li>開始和結尾A和Z anchor</li>
<li>往後尋找 lookbehind</li>
<li>union 和 intersection 類</li>
<li>atomic grouping</li>
<li>unicode</li>
<li>有命名的capturing group</li>
<li>單行s 和 無間隔x 的match 模式</li>
<li>條件式</li>
<li>comments</li>
</ol>
<h4 id="1-3-Primitive-Wrapper-Types"><a href="#1-3-Primitive-Wrapper-Types" class="headerlink" title="1.3 Primitive Wrapper Types"></a>1.3 Primitive Wrapper Types</h4><ul>
<li>有String, Boolean和Number, 可以用 new 的方式建立object包裝的物件</li>
<li>只要讀取這3種Primitive, JS背後會自動建立Wrapper Object, 讓我們能呼叫一些方法</li>
<li>使用自動Wrapper Object, 被動態指定的屬性都會立即銷毀</li>
</ul>
<p>let text &#x3D; ‘hello world’;<br>let text2 &#x3D; text.substring(3); &#x2F;&#x2F; 這背後使用Wrapper Object, 才能讓我們有函式可用</p>
<p>text.myWord &#x3D; ‘not work’;<br>console.log(text.myWord); &#x2F;&#x2F; 已經被銷毀, 所以輸出 undefined</p>
<h5 id="1-3-1-Boolean-Type"><a href="#1-3-1-Boolean-Type" class="headerlink" title="1.3.1 Boolean Type"></a>1.3.1 Boolean Type</h5><ul>
<li>建議不要用new Boolean物件, 容易有誤解</li>
</ul>
<p>let v1 &#x3D; new Boolean(false);<br>let result &#x3D; v1 &amp;&amp; true;<br>console.log(result); &#x2F;&#x2F; 輸出true, 因為v1 是 object, 並非Boolean值</p>
<h5 id="1-3-2-Number-Type"><a href="#1-3-2-Number-Type" class="headerlink" title="1.3.2 Number Type"></a>1.3.2 Number Type</h5><ul>
<li>常見數字格式化的方法 toFixed(數字)、toExponential(數字)、toPrecision(數字), 有些瀏覽器實作的範圍不一樣</li>
<li>和Boolean一樣, 也不建議用new Number物件</li>
<li>在ES6導入Number.isInteger()方法判斷是否整數、Number.isSafeInteger()判斷是否為整數且在Number.MAX_SAFE_INTEGER與 Number.MIN_SAFE_INTEGER範圍之間</li>
</ul>
<p> </p>
<h5 id="1-3-3-String-Type"><a href="#1-3-3-String-Type" class="headerlink" title="1.3.3 String Type"></a>1.3.3 String Type</h5><h6 id="1-3-3-1-The-JavaScript-Character"><a href="#1-3-3-1-The-JavaScript-Character" class="headerlink" title="1.3.3.1 The JavaScript Character"></a>1.3.3.1 The JavaScript Character</h6><ul>
<li>每個字元使用16bit儲存</li>
<li>JS的字串會判斷2種Unicode編碼: UCS-2 和 UTF-16 , 都是16bit</li>
<li>可用charCodeAt(位置)顯示該字元的編碼整數</li>
<li>可用fromCharCode(編碼整數1, 編碼整數2, ….)組成UTF-16表示的字串, 編碼範圍是從U+0000 到 U+FFFF, 也稱之為 Basic Multilingual Plane 涵蓋範圍 </li>
<li>有的特殊符號超過U+FFFF範圍, 會變成佔2個16bit, length和charAt等會取到異位的值, </li>
<li>在U+10000到U+1FFFD範圍稱之 Supplementary Multilingual Plane,</li>
</ul>
<p>let text1 &#x3D; ‘大家好’;<br>console.log(text1.charCodeAt(1)); &#x2F;&#x2F; 輸出 23478</p>
<p>let text2 &#x3D; String.fromCharCode(0x7a0b, 0x5f0f, 0x8a2d, 0x8a08);<br>console.log(text2); &#x2F;&#x2F; 輸出 程式設計</p>
<p>let text3 &#x3D; ‘😭’; &#x2F;&#x2F; 用哭臉符號作範例, 它用UTF-16為 0xD83D 0xDE2D<br>console.log(text3.length); &#x2F;&#x2F; 佔了2個16 bit, 所以length為2<br>console.log(text3.charAt(0)); &#x2F;&#x2F; 輸出無法識別的編碼 �<br>console.log(text3.charAt(1)); &#x2F;&#x2F; 輸出無法識別的編碼 �</p>
<p>console.log(text3.charCodeAt(0)); &#x2F;&#x2F; 輸出第1個16bit 55357 &#x3D; 0xD83D<br>console.log(text3.charCodeAt(1)); &#x2F;&#x2F; 輸出第2個16bit 36877 &#x3D; 0xDE2D</p>
<h6 id="1-3-3-2-The-normalize-method"><a href="#1-3-3-2-The-normalize-method" class="headerlink" title="1.3.3.2 The normalize() method"></a>1.3.3.2 The normalize() method</h6><ul>
<li>Unicode有些字是同樣的, 但出現在不同的編碼, 而不同編碼的字用 &#x3D;&#x3D; 比對必為false</li>
<li>依照<a target="_blank" rel="noopener" href="http://www.unicode.org/reports/tr15/">http://www.unicode.org/reports/tr15/</a> , 共區分4種Normalization Form: C、D、KC、KD</li>
<li>normalization的規則, 很像象形符號的組合</li>
</ul>
<p>&#x2F;&#x2F; 符號 ḉ 的原始Unicode-16 是0x1E09, 也能從另外2種編碼取得</p>
<p>let c1 &#x3D; String.fromCharCode(0x1E09),<br> c2 &#x3D; String.fromCharCode(0x00E7, 0x0301),<br>c3 &#x3D; String.fromCharCode(0x0063, 0x0327, 0x0301);<br>console.log(c1); &#x2F;&#x2F; 輸出 ḉ<br>console.log(c2); &#x2F;&#x2F; 輸出 ḉ<br>console.log(c3); &#x2F;&#x2F; 輸出 ḉ</p>
<p>console.log(c1 &#x3D;&#x3D;&#x3D; c2); &#x2F;&#x2F; 輸出 false<br>console.log(c2 &#x3D;&#x3D;&#x3D; c3); &#x2F;&#x2F; 輸出 false<br>console.log(c3 &#x3D;&#x3D;&#x3D; c1); &#x2F;&#x2F; 輸出 false</p>
<p>&#x2F;&#x2F; U+1E09 已經是 0x00E7&#x2F;0x0301 的 NFC&#x2F;NFKC的normalization, 所以比對仍相等<br>console.log(c1 &#x3D;&#x3D;&#x3D; c1.normalize(“NFD”)); &#x2F;&#x2F; false<br>console.log(c1 &#x3D;&#x3D;&#x3D; c1.normalize(“NFC”)); &#x2F;&#x2F; true<br>console.log(c1 &#x3D;&#x3D;&#x3D; c1.normalize(“NFKD”)); &#x2F;&#x2F; false<br>console.log(c1 &#x3D;&#x3D;&#x3D; c1.normalize(“NFKC”)); &#x2F;&#x2F; true</p>
<p>&#x2F;&#x2F; U+00E7&#x2F;U+0301 尚未normalization, 所以比對都不相等<br>console.log(c2 &#x3D;&#x3D;&#x3D; c2.normalize(“NFD”)); &#x2F;&#x2F; false<br>console.log(c2 &#x3D;&#x3D;&#x3D; c2.normalize(“NFC”)); &#x2F;&#x2F; false<br>console.log(c2 &#x3D;&#x3D;&#x3D; c2.normalize(“NFKD”)); &#x2F;&#x2F; false<br>console.log(c2 &#x3D;&#x3D;&#x3D; c2.normalize(“NFKC”)); &#x2F;&#x2F; false</p>
<p>&#x2F;&#x2F; U+0063&#x2F;U+0327&#x2F;U+0301 已經是 0x00E7&#x2F;0x0301 的 NFD&#x2F;NFKD的normalization, 所以比對仍相等<br>console.log(c3 &#x3D;&#x3D;&#x3D; c3.normalize(“NFD”)); &#x2F;&#x2F; true<br>console.log(c3 &#x3D;&#x3D;&#x3D; c3.normalize(“NFC”)); &#x2F;&#x2F; false<br>console.log(c3 &#x3D;&#x3D;&#x3D; c3.normalize(“NFKD”)); &#x2F;&#x2F; true<br>console.log(c3 &#x3D;&#x3D;&#x3D; c3.normalize(“NFKC”)); &#x2F;&#x2F; false</p>
<h6 id="1-3-3-3-String-Manipulation-Methods"><a href="#1-3-3-3-String-Manipulation-Methods" class="headerlink" title="1.3.3.3 String-Manipulation Methods"></a>1.3.3.3 String-Manipulation Methods</h6><ul>
<li>concat可串接多個字串, 但常用 + 運算符號</li>
<li>slice(), substring()和 substr()都可以回傳子字串, 但用法有些不同, 可參考<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/substring">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects&#x2F;String&#x2F;substring</a></li>
</ul>
<h6 id="1-3-3-4-String-Location-Methods"><a href="#1-3-3-4-String-Location-Methods" class="headerlink" title="1.3.3.4 String Location Methods"></a>1.3.3.4 String Location Methods</h6><ul>
<li>indexOf()和lastIndexOf()可找字串的起始位置, 前者從前面找, 後者從後面找, 沒找到回傳-1</li>
<li>都可以代第2個參數, 開始尋找的位置.</li>
</ul>
<h6 id="1-3-3-5-String-Inclusion-Methods"><a href="#1-3-3-5-String-Inclusion-Methods" class="headerlink" title="1.3.3.5 String Inclusion Methods"></a>1.3.3.5 String Inclusion Methods</h6><ul>
<li>ES6導入的功能, 分別是startWith(), endWith(), includes(), 代表從開頭、結尾和中間是否有存在某字串, 若符合回傳true, 否則為false.</li>
<li>startWith()和includes()可以代第2個參數, 開始尋找的位置.</li>
</ul>
<h6 id="1-3-3-6-The-trim-Method"><a href="#1-3-3-6-The-trim-Method" class="headerlink" title="1.3.3.6 The trim() Method"></a>1.3.3.6 The trim() Method</h6><ul>
<li>trim()會刪除前後有空白的字串</li>
<li>trimLeft()和trimRight()則只刪除最前&#x2F;最後的空白字串</li>
</ul>
<h6 id="1-3-3-7-The-repeat-Method"><a href="#1-3-3-7-The-repeat-Method" class="headerlink" title="1.3.3.7 The repeat() Method"></a>1.3.3.7 The repeat() Method</h6><ul>
<li>可代入數字, 代表要重複字串的次數</li>
</ul>
<h6 id="1-3-3-8-The-padStart-and-padEnd-Method"><a href="#1-3-3-8-The-padStart-and-padEnd-Method" class="headerlink" title="1.3.3.8 The padStart() and padEnd() Method"></a>1.3.3.8 The padStart() and padEnd() Method</h6><ul>
<li>有2個參數, 若只代第1個參數數字, 代表要擴充成長度為n的字串, 預設補上空白</li>
<li>第2個參數是要擴充的字串</li>
</ul>
<h6 id="1-3-3-9-String-Iterators-and-Destructuring"><a href="#1-3-3-9-String-Iterators-and-Destructuring" class="headerlink" title="1.3.3.9 String Iterators and Destructuring"></a>1.3.3.9 String Iterators and Destructuring</h6><ul>
<li>string有iterator, 可以歷遍每個字元</li>
<li>基於iterator, 可以用for … of的方式取每個字元</li>
<li>用[…某字串]可以拆成字元陣列(Destructuring)</li>
</ul>
<p>let text1 &#x3D; ‘hello’;<br>let stringIterator &#x3D; text1[Symbol.iterator]();<br>console.log(stringIterator.next()); &#x2F;&#x2F; 輸出 {value: ‘h’, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; 輸出 {value: ‘e’, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; 輸出 {value: ‘l’, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; 輸出 {value: ‘l’, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; 輸出 {value: ‘o’, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; 輸出 {value: undefined, done: true}</p>
<p>for(const c of text1){<br>console.log(c); &#x2F;&#x2F; 依序輸出 h e l l o<br>}</p>
<p>console.log([…text1]); &#x2F;&#x2F; 輸出 [‘h’, ‘e’, ‘l’, ‘l’, ‘o’]</p>
<h6 id="1-3-3-10-String-Case-Methods"><a href="#1-3-3-10-String-Case-Methods" class="headerlink" title="1.3.3.10 String Case Methods"></a>1.3.3.10 String Case Methods</h6><ul>
<li>除了toLowerCase(), toUpperCase()轉換大小寫, 還有toLocaleLowerCase(), toLocaleUpperCase()能指定特定地區的大小寫, 比如土耳其語.</li>
<li>不確定要執行的環境, 直接用locale的方法做大小寫轉換</li>
</ul>
<h6 id="1-3-3-11-String-Pattern-Matching-Methods"><a href="#1-3-3-11-String-Pattern-Matching-Methods" class="headerlink" title="1.3.3.11 String Pattern-Matching Methods"></a>1.3.3.11 String Pattern-Matching Methods</h6><ul>
<li>這些pattern方法都支援RegExp物件</li>
<li>用字串的match(pattern)等同RegExp的exec(pattern)</li>
<li>search(pattern)是從字串的頭往後搜尋有比對到pattern第1個出現位置, 若沒比對到則回傳-1. 和indexOf差異是能用RegExp</li>
<li>replace(pattern, 要替換的單字)能找到pattern符合的字並替換掉. 其中要替換的單字能用特殊的字串, 比如用$1可以把captured group回填</li>
<li>replace(pattern, someFunction), 可以用某個function來做替換的邏輯</li>
</ul>
<p>let text &#x3D; ‘sad, bad, cad, dad’;<br>let result &#x3D; text.replace(&#x2F;(.ad)&#x2F;g, ‘myWord ($1)’);<br>console.log(result); &#x2F;&#x2F; 輸出 myWord (sad), myWord (bad), myWord (cad), myWord (dad)</p>
<p>let text2 &#x3D; ‘I am a boy, my dog is tall. So what is your name?’;<br>function replaceArticle(text){<br>return text.replace(&#x2F;[,.?]&#x2F;g, function(match, pos, originalText){<br> switch(match){<br> case ‘,’:<br> return ‘!’;<br> case ‘.’:<br> return ‘*‘;<br> case ‘?’:<br> return ‘#’;<br> }<br> });<br>}<br>console.log(replaceArticle(text2)); &#x2F;&#x2F; 輸出 I am a boy! my dog is tall* So what is your name#</p>
<ul>
<li>split也能支援RegExp pattern做切割字串成陣列, 第2個參數是切割後陣列的最大Size</li>
</ul>
<h6 id="1-3-3-12-The-localeCompare-Method"><a href="#1-3-3-12-The-localeCompare-Method" class="headerlink" title="1.3.3.12 The localeCompare() Method"></a>1.3.3.12 The localeCompare() Method</h6><ul>
<li>做字串的字典排序比對, 小的回傳 -1、相等回傳0、大的回傳1</li>
<li>支援locale代表大小寫有差異</li>
</ul>
<h6 id="1-3-3-13-HTML-Methods"><a href="#1-3-3-13-HTML-Methods" class="headerlink" title="1.3.3.13 HTML Methods"></a>1.3.3.13 HTML Methods</h6><ul>
<li>字串有HTML相關的方法, 產生HTML字串, 比如anchor, big, link等</li>
</ul>
<p>let text &#x3D; ‘Hello World’;<br>console.log(text.anchor(‘test’)); &#x2F;&#x2F; 輸出 <a name="test">Hello World</a><br>console.log(text.big()); &#x2F;&#x2F; 輸出 <big>Hello World</big><br>console.log(text.link(‘<a target="_blank" rel="noopener" href="http://www.example.com/">http://www.example.com</a>‘)); &#x2F;&#x2F; 輸出 <a target="_blank" rel="noopener" href="http://www.example.com">Hello World</a></p>
<h4 id="1-4-Singleton-Built-in-Objects"><a href="#1-4-Singleton-Built-in-Objects" class="headerlink" title="1.4 Singleton Built-in Objects"></a>1.4 Singleton Built-in Objects</h4><ul>
<li>不依賴host environment的物件, 且在JS程式執行前已初始化.</li>
<li>包含Global和Math 2種.</li>
</ul>
<h5 id="1-4-1-The-Global-Object"><a href="#1-4-1-The-Global-Object" class="headerlink" title="1.4.1 The Global Object"></a>1.4.1 The Global Object</h5><ul>
<li>不屬於特定物件的屬性和方法, 那就會是Global的屬性和方法.</li>
<li>比如parseInt(), isNaN()等, 都是Global的方法</li>
</ul>
<h6 id="1-4-1-1-URI-Encoding-Methods"><a href="#1-4-1-1-URI-Encoding-Methods" class="headerlink" title="1.4.1.1 URI-Encoding Methods"></a>1.4.1.1 URI-Encoding Methods</h6><ul>
<li>encodeURI()和encodeURIComponent()可對URI做編碼, 將一些不符合URI的字元做UTF-8編碼</li>
<li>encodeURI只對部分字元編碼、encodeURIComponent()全部字元都編碼</li>
<li>實務上常用encodeURIComponent對query string做編碼</li>
</ul>
<p>let text &#x3D; ‘<a target="_blank" rel="noopener" href="https://www.example.com/special%20and%20words/#mobile-devices">https://www.example.com/special%20and%20words/#mobile-devices</a>‘;<br>console.log(encodeURI(text)); &#x2F;&#x2F; 輸出 <a target="_blank" rel="noopener" href="https://www.example.com/special%2520and%2520words/#mobile-devices">https://www.example.com/special%2520and%2520words/#mobile-devices</a><br>console.log(encodeURIComponent(text)); &#x2F;&#x2F; 輸出 https%3A%2F%2F<a href="http://www.example.com%2Fspecial%2520and%2520words%2F%23mobile-devices">www.example.com%2Fspecial%2520and%2520words%2F%23mobile-devices</a></p>
<ul>
<li>對應解碼的方法為decodeURI()和decodeURIComponent()</li>
<li>encodeURI&#x2F;decodeURI等已取代舊版的escape&#x2F;unescape</li>
</ul>
<h6 id="1-4-1-2-The-eval-Method"><a href="#1-4-1-2-The-eval-Method" class="headerlink" title="1.4.1.2 The eval() Method"></a>1.4.1.2 The eval() Method</h6><ul>
<li>eval()可以將ES語法做直譯, 並且裡面的變數、函式等都可是同個Scope</li>
</ul>
<p>eval(“console.log(‘hello’)”); &#x2F;&#x2F; 輸出hello</p>
<p>let myWord &#x3D; ‘Testing’;<br>eval(“console.log(myWord)”); &#x2F;&#x2F; 輸出myWord</p>
<p>eval(“function sayHi() { console.log(‘hiiii’); }”);<br>sayHi(); &#x2F;&#x2F; 輸出 hiiii</p>
<ul>
<li>在strict mode環境, 在eval宣告的變數、函式都不能被外部用, 且eval不能被指定為變數</li>
<li>小心使用eval(), 以免 XSS 攻擊</li>
</ul>
<h6 id="1-4-1-3-Global-Object-Properties"><a href="#1-4-1-3-Global-Object-Properties" class="headerlink" title="1.4.1.3 Global Object Properties"></a>1.4.1.3 Global Object Properties</h6><ul>
<li>目前有這些properties:</li>
</ul>
<ol>
<li>undefined</li>
<li>NaN</li>
<li>Infinity</li>
<li>Object</li>
<li>Array</li>
<li>Function</li>
<li>Boolean</li>
<li>String</li>
<li>Number</li>
<li>Date</li>
<li>RegExp</li>
<li>Symbol</li>
<li>Error</li>
<li>EvalError</li>
<li>RangeError</li>
<li>ReferenceError</li>
<li>SyntaxError</li>
<li>TypeError</li>
<li>URIError</li>
</ol>
<h6 id="1-4-1-4-The-Window-Object"><a href="#1-4-1-4-The-Window-Object" class="headerlink" title="1.4.1.4 The Window Object"></a>1.4.1.4 The Window Object</h6><ul>
<li>ES無規範如何直接存取Global Object, 但Web的全域變數和方法, 都可存取window物件取得.</li>
<li>可用return this取得Global object</li>
</ul>
<p>var text &#x3D; ‘Hello World’; &#x2F;&#x2F; 要用var, 才會指定到window物件</p>
<p>function sayHello(){<br>console.log(window.text); &#x2F;&#x2F; text已在window物件<br>}</p>
<p>window.sayHello(); &#x2F;&#x2F; sayHello已在window物件, 輸出 Hello World</p>
<p>&#x2F;&#x2F; this能代表global, 在debug console能看見global變數有許多瀏覽器相關的變數和函數<br>let global &#x3D; function(){<br>return this;<br>}();</p>
<h5 id="1-4-2-The-Math-Object"><a href="#1-4-2-The-Math-Object" class="headerlink" title="1.4.2 The Math Object"></a>1.4.2 The Math Object</h5><ul>
<li>提供計算相關的常數和函式</li>
<li>Math提供的函式會比自己寫的函式還要有效率, 但因瀏覽器、作業系統等環境, 精準度會有差異</li>
</ul>
<h6 id="1-4-2-1-Math-Object-Properties"><a href="#1-4-2-1-Math-Object-Properties" class="headerlink" title="1.4.2.1 Math Object Properties"></a>1.4.2.1 Math Object Properties</h6><ul>
<li>常見的常數</li>
<li>Math.E</li>
<li>Math.LN10</li>
<li>Math.LN2</li>
<li>Math.LOG2E</li>
<li>Math.LOG10E</li>
<li>Math.PI</li>
<li>Math.SQRT1_2</li>
<li>Math.SQRT2</li>
</ul>
<h6 id="1-4-2-2-The-min-and-max-Methods"><a href="#1-4-2-2-The-min-and-max-Methods" class="headerlink" title="1.4.2.2 The min() and max() Methods"></a>1.4.2.2 The min() and max() Methods</h6><ul>
<li>回傳一組數字裡最小&#x2F;最大值</li>
<li>如果是array, 要用apply, 第1個參數代入Math, 第2個參數帶入陣列</li>
</ul>
<p>console.log(Math.min(1, 2, 3)); &#x2F;&#x2F; 輸出 1<br>console.log(Math.max.apply(Math, [4, 5, 6])); &#x2F;&#x2F; 輸出 6</p>
<h6 id="1-4-2-3-Rounding-Methods"><a href="#1-4-2-3-Rounding-Methods" class="headerlink" title="1.4.2.3 Rounding Methods"></a>1.4.2.3 Rounding Methods</h6><ul>
<li>Rounding的中文是捨入, Math有4種捨入函式</li>
</ul>
<ol>
<li>Math.ceil(): 回傳ceiling function的整數結果</li>
<li>Math.floor(): 回傳floor function的整數結果</li>
<li>Math.round(): 四捨五入的函式, 小數點 &gt;&#x3D; 0.5 則進位</li>
<li>Math.fround(): 將浮點數轉換成最接近的single precision 32 bit表示. 可以參考此網站做驗證 <a target="_blank" rel="noopener" href="https://www.exploringbinary.com/floating-point-converter/">https://www.exploringbinary.com/floating-point-converter/</a></li>
</ol>
<p>console.log(Math.ceil(11.6)); &#x2F;&#x2F; 輸出 12<br>console.log(Math.ceil(11.1)); &#x2F;&#x2F; 輸出 12</p>
<p>console.log(Math.floor(11.6)); &#x2F;&#x2F; 輸出 11<br>console.log(Math.floor(11.1)); &#x2F;&#x2F; 輸出 11</p>
<p>console.log(Math.round(11.6)); &#x2F;&#x2F; 輸出 12<br>console.log(Math.round(11.1)); &#x2F;&#x2F; 輸出 11</p>
<p>console.log(Math.fround(0.4)); &#x2F;&#x2F; JS的浮點數都是64-bit, 實際上0.4是0.40000000000000002220446049250313080847263336181640625, 轉成32-bit是 0.4000000059604644775390625<br>console.log(Math.fround(0.5)); &#x2F;&#x2F; 輸出 0.5</p>
<h6 id="1-4-2-4-The-random-Method"><a href="#1-4-2-4-The-random-Method" class="headerlink" title="1.4.2.4 The random() Method"></a>1.4.2.4 The random() Method</h6><ul>
<li>Math.random()會回傳 0~1之間的數字, 但不包含0與1</li>
<li>實用的方式是可以從某lowerValue ~ upperValue裡隨機挑1個整數, 延伸的用法是隨機挑選陣列裡的值</li>
<li>密碼學產生隨機數字建議用window.crypto.getRandomValues()</li>
</ul>
<p>function selectFrom(lowerValue, upperValue){<br>let choices &#x3D; upperValue - lowerValue + 1;<br> return Math.floor(Math.random() * choices + lowerValue);<br>}</p>
<p>let num &#x3D; selectFrom(3, 6); &#x2F;&#x2F; 從3 4 5 6 的4個數字挑1個<br>console.log(num);</p>
<p>let words &#x3D; [‘hello’, ‘sky’, ‘snow’, ‘happy’];<br>console.log(words[selectFrom(0, words.length - 1)]); </p>
<h6 id="1-4-2-5-Other-Methods"><a href="#1-4-2-5-Other-Methods" class="headerlink" title="1.4.2.5 Other Methods"></a>1.4.2.5 Other Methods</h6><ul>
<li>其它的方法請參考 MDN <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects&#x2F;Math</a></li>
</ul>
<h4 id="2-參考資料"><a href="#2-參考資料" class="headerlink" title="2. 參考資料"></a>2. 參考資料</h4><ol>
<li><a target="_blank" rel="noopener" href="https://www.amazon.com/-/zh_TW/Matt-Frisbie/dp/1119366445?crid=2IKRLQD88C73Q&keywords=javascript&qid=1640523661&sprefix=javascrip,aps,272&sr=8-24&linkCode=ll1&tag=glj89893320b-20&linkId=0a4b475800517718840fceead024db61&language=zh_TW&ref_=as_li_ss_tl">Professional JavaScript for Web Developers 4th Edition, Chapter 5 : Basic Reference Types, Matt Frisbie.</a></li>
</ol>
<p>Javascript Basic Reference Type</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/05/threading-in-csharp-part-3-using-threads/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/05/threading-in-csharp-part-3-using-threads/" class="post-title-link" itemprop="url">Threading in C# - USING THREADS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-05 15:45:00" itemprop="dateCreated datePublished" datetime="2021-12-05T15:45:00+08:00">2021-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Thread/" itemprop="url" rel="index"><span itemprop="name">Thread</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/" itemprop="url" rel="index"><span itemprop="name">讀書筆記</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Threading-in-C-PART-3-USING-THREADS"><a href="#Threading-in-C-PART-3-USING-THREADS" class="headerlink" title="Threading in C# - PART 3: USING THREADS"></a>Threading in C# - PART 3: USING THREADS</h3><p>這篇文章為閱讀 Threading in C# 系列的Part 3筆記.</p>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2021/12/NewThread.png" alt="Multi-Threading"></p>
<p>Multi-Threading in C# (Picture source: <a target="_blank" rel="noopener" href="http://www.albahari.com/threading/">Threading in C#<br>Joseph Albahari</a>)</p>
<h3 id="Threading-Pattern-The-Event-Based-Asynchronous-Pattern"><a href="#Threading-Pattern-The-Event-Based-Asynchronous-Pattern" class="headerlink" title="Threading Pattern - The Event-Based Asynchronous Pattern"></a>Threading Pattern - The Event-Based Asynchronous Pattern</h3><ul>
<li>EAP可啟用多執行緒且不需要Consumer主動或管理thread, 有以下特徵</li>
</ul>
<ol>
<li>合作式取消模型</li>
<li>當Worker thread完成工作, 可安全更新WFP&#x2F;Winform的UI元件</li>
<li>在完成的事件傳遞Exception</li>
</ol>
<ul>
<li>EAP只是個Pattern, 實作上最常見的有BackgroundWorker, WebClient等</li>
<li>這些Class包含有*Async的方法, 通常就是EAP. 呼叫*Async的方法, 將任務交給其他thread執行, 而任務完成後, 會觸發Completed事件</li>
<li>*Completed事件的參數包含這些:</li>
</ul>
<ol>
<li>有個flag標示該任務是否有被取消</li>
<li>有exception拋出時, 包裝在Error物件</li>
<li>call function代入的userToken</li>
</ol>
<ul>
<li>使用EAP的設計, 如果有遵循APM的規則, 可以節省Thread</li>
<li>之後的Task實作和EAP很相似, 讓EAP的魅力大減</li>
</ul>
<h3 id="BackgroundWorker"><a href="#BackgroundWorker" class="headerlink" title="BackgroundWorker"></a>BackgroundWorker</h3><ul>
<li>BackgroundWorker是在System.ComponentModel, 符合EAP設計, 並有以下特徵:</li>
</ul>
<ol>
<li>合作的取消模型</li>
<li>當Worker完成, 可以安全更新WPF&#x2F;Winform的Control</li>
<li>把Exception傳遞到完成事件</li>
<li>有個進度回報的protocol</li>
<li>實作IComponent, 在Design time(Ex: Visual Studio Designer)可以被託管</li>
</ol>
<h4 id="Using-BackgroundWorker"><a href="#Using-BackgroundWorker" class="headerlink" title="Using BackgroundWorker"></a>Using BackgroundWorker</h4><ul>
<li>建立BackgroundWorker的最小步驟: 建立BackgroundWorker並處理DoWork事件, 再呼叫RunWorkerAsync函式, 此函式也能代入參數. 在DoWork委託的函式, 從DoWorkEventArgs取出Argument, 代表有代入的參數.</li>
<li>以下是基本的範例</li>
</ul>
<p>using System;<br>using System.ComponentModel;</p>
<p>namespace BackgroundWorkerTest<br>{<br>    class Program<br>    {<br>        static BackgroundWorker _bw &#x3D; new BackgroundWorker();<br>        static void Main(string[] args)<br>        {<br>            _bw.DoWork +&#x3D; MyDoWork;<br>            _bw.RunWorkerAsync(123456);<br>            Console.ReadLine();<br>        }</p>
<pre><code>    private static void MyDoWork(object sender, DoWorkEventArgs e)
    &#123;
        Console.WriteLine(e.Argument);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>BackgroundWorker有個RunWorkerCompleted事件, 當DoWork的事件完成將會觸發, 而在RunWorkerCompleted裡查詢有DoWork拋出的Exception、也能對UI Control做更新</li>
<li>如果要增加progress reporting, 要以下步驟:</li>
</ul>
<ol>
<li>設置WorkerReportsProgress屬性為true</li>
<li>定期在DoWork的委託事件呼叫ReportProgress, 代入目前完成的進度值, 也可選代入user-state</li>
<li>新增ProgressChanged事件處理, 查詢前面代入的進度值, 用ProgressPercentage參數查</li>
<li>在ProgressChanged也能更新UI Control</li>
</ol>
<ul>
<li>如果要增加Cancellation的功能:</li>
</ul>
<ol>
<li>設置WorkerSupportsCancellation屬性為true</li>
<li>定期在DoWork的委託事件內檢查CancellationPending這個boolean值, 如果它是true, 則可以設置DoWorkEventArgs的Cancel為true並做return. 如果DoWork的工作太困難而不能繼續執行, 也可以不理會CancellationPending的狀態而直接設Cancel為true</li>
<li>呼叫CancelAsync來請求取消任務</li>
</ol>
<ul>
<li>以下是progress reporting和cancellation的範例, 每經過1秒會回報累加的進度(每次增加20). 如果在5秒內按下任何鍵, 會送出cancel請求並停止DoWork. 否則超過5秒後, 在DoWorkEventArgs的Result可以設值, 並在RunWorkerCompleted的RunWorkerCompletedEventArgs的Result取值.</li>
</ul>
<p>using System;<br>using System.ComponentModel;<br>using System.Threading;</p>
<p>namespace BackgroundWorkerProgressCancel<br>{<br>    class Program<br>    {<br>        static BackgroundWorker _bw;<br>        static void Main(string[] args)<br>        {<br>            _bw &#x3D; new BackgroundWorker<br>            {<br>                WorkerReportsProgress &#x3D; true,<br>                WorkerSupportsCancellation &#x3D; true<br>            };<br>            _bw.DoWork +&#x3D; bw_DoWork;<br>            _bw.ProgressChanged +&#x3D; bw_ProgressChanged;<br>            _bw.RunWorkerCompleted +&#x3D; bw_RunWorkerCompleted;</p>
<pre><code>        \_bw.RunWorkerAsync(&quot;Run worker now&quot;);

        Console.WriteLine(&quot;Press Enter in the next 5 seconds to cancel&quot;);
        Console.ReadLine();
        if (\_bw.IsBusy)
        &#123;
            \_bw.CancelAsync();
        &#125;

        Console.ReadLine();
    &#125;

    private static void bw\_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
    &#123;
        if (e.Cancelled)
        &#123;
            Console.WriteLine(&quot;You canceled&quot;);
        &#125;
        else if(e.Error != null)
        &#123;
            Console.WriteLine(&quot;Worker exception: &quot; + e.Error.ToString());
        &#125;
        else
        &#123;
            Console.WriteLine(&quot;Completed: &quot; + e.Result);
        &#125;
    &#125;

    private static void bw\_ProgressChanged(object sender, ProgressChangedEventArgs e)
    &#123;
        Console.WriteLine(&quot;Reached &quot; + e.ProgressPercentage + &quot;%&quot;);
    &#125;

    private static void bw\_DoWork(object sender, DoWorkEventArgs e)
    &#123;
        for(int i = 0; i &lt;= 100; i+= 20)
        &#123;
            if (\_bw.CancellationPending)
            &#123;
                e.Cancel = true;
                return;
            &#125;

            \_bw.ReportProgress(i);
            Thread.Sleep(1000);
        &#125;

        e.Result = 123456;
    &#125;
&#125;
</code></pre>
<p>}</p>
<h4 id="Subclassing-BackgroundWorker"><a href="#Subclassing-BackgroundWorker" class="headerlink" title="Subclassing BackgroundWorker"></a>Subclassing BackgroundWorker</h4><ul>
<li>可以繼承BackgroundWorker來實作EAP</li>
<li>以下範例是整合前面BackgroundWorker的範例, 再搭配原作者未完整的繼承案例, 功能是每一秒會累加財務的金額和信用點數, 增加的值是建構物件時給的參數. 經過5秒後把累加的結果放在Dictionary</li>
</ul>
<p>using System;<br>using System.Collections.Generic;<br>using System.ComponentModel;<br>using System.Threading;</p>
<p>namespace BackgroundWorkerSubClass<br>{<br>    class Program<br>    {<br>        static FinancialWorker _bw;<br>        static void Main(string[] args)<br>        {<br>            _bw &#x3D; new Client().GetFinancialTotalsBackground(10, 50);<br>            _bw.ProgressChanged +&#x3D; bw_ProgressChanged;<br>            _bw.RunWorkerCompleted +&#x3D; bw_RunWorkerCompleted;</p>
<pre><code>        \_bw.RunWorkerAsync(&quot;Hello to worker&quot;);
        Console.WriteLine(&quot;Press Enter in the next 5 seconds to cancel&quot;);
        Console.ReadLine();
        if (\_bw.IsBusy) \_bw.CancelAsync();
        Console.ReadLine();
    &#125;

    static void bw\_RunWorkerCompleted(object sender,
                                 RunWorkerCompletedEventArgs e)
    &#123;
        if (e.Cancelled)
            Console.WriteLine(&quot;You canceled!&quot;);
        else if (e.Error != null)
            Console.WriteLine(&quot;Worker exception: &quot; + e.Error.ToString());
        else
        &#123;
            Dictionary&lt;string, int&gt; result = e.Result as Dictionary&lt;string, int&gt;;
            Console.WriteLine(&quot;Complete: &quot;);      // from DoWork
            foreach (var item in result)
            &#123;
                Console.WriteLine($&quot;Key &#123;item.Key&#125; Value &#123;item.Value&#125;&quot;);
            &#125;
        &#125;

    &#125;

    static void bw\_ProgressChanged(object sender,
                                    ProgressChangedEventArgs e)
    &#123;
        Console.WriteLine(&quot;Reached &quot; + e.ProgressPercentage + &quot;%&quot;);
    &#125;
&#125;

public class Client
&#123;
    public FinancialWorker GetFinancialTotalsBackground(int moneyIncreaseBase, int creditPointIncreaseBase)
    &#123;
        return new FinancialWorker(moneyIncreaseBase, creditPointIncreaseBase);
    &#125;
&#125;

public class FinancialWorker : BackgroundWorker
&#123;
    public Dictionary&lt;string, int&gt; Result;   // You can add typed fields.
    public readonly int MoneyIncreaseBase, CreditPointIncreaseBase;

    public FinancialWorker()
    &#123;
        WorkerReportsProgress = true;
        WorkerSupportsCancellation = true;
    &#125;

    public FinancialWorker(int moneyIncreaseBase, int creditPointIncreaseBase) : this()
    &#123;
        this.MoneyIncreaseBase = moneyIncreaseBase;
        this.CreditPointIncreaseBase = creditPointIncreaseBase;
    &#125;

    protected override void OnDoWork(DoWorkEventArgs e)
    &#123;
        Result = new Dictionary&lt;string, int&gt;();
        Result.Add(&quot;Money&quot;, 0);
        Result.Add(&quot;CreditPoint&quot;, 0);

        int percentCompleteCalc = 0;
        while (percentCompleteCalc &lt;= 80)
        &#123;
            if (CancellationPending)
            &#123;
                e.Cancel = true;
                return;
            &#125;
            ReportProgress(percentCompleteCalc, &quot;Monet &amp; Credit Point is increasing!&quot;);
            percentCompleteCalc += 20;
            Result\[&quot;Money&quot;\] += MoneyIncreaseBase;
            Result\[&quot;CreditPoint&quot;\] += CreditPointIncreaseBase;
            Thread.Sleep(1000);
        &#125;
        ReportProgress(100, &quot;Done!&quot;);
        e.Result = Result;
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>這種繼承寫法, 可以讓Caller不用指定DoWork委託, 在呼叫RunWorkerAsync時執行有override的OnDoWork.</li>
<li>主要是把progress report, cancellation和comleted(可以更新UI之類、取運算結果)要負責的功能給caller指定, 而DoWork的邏輯交給該BackgroundWorker子類別負責.</li>
</ul>
<h3 id="Threading-的-停止-Interrupt-and-Abort"><a href="#Threading-的-停止-Interrupt-and-Abort" class="headerlink" title="Threading 的[停止]: Interrupt and Abort"></a>Threading 的[停止]: Interrupt and Abort</h3><ul>
<li>Interrupt和Abort能停止Blocked的thread</li>
<li>Abort也能停止非block的thread, 比如一直在無限迴圈執行的thread, 所以Abort會在特定場合使用, 但Interrupt很少用到</li>
</ul>
<h4 id="Interrupt"><a href="#Interrupt" class="headerlink" title="Interrupt"></a>Interrupt</h4><ul>
<li>Interrupt能強制使blocked thread釋放, 並拋出ThreadInterruptedException.</li>
<li>除非沒有handle ThreadInterruptedException(Catch抓到它), 否則該thread在interrupt後不會結束.</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace InterruptBasic<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            Thread t &#x3D; new Thread(() &#x3D;&gt;<br>            {<br>                try<br>                {<br>                    Thread.Sleep(Timeout.Infinite);<br>                }<br>                catch (ThreadInterruptedException)<br>                {<br>                    Console.WriteLine(“Forcibly”);<br>                }<br>                Console.WriteLine(“Woken!”);<br>            });</p>
<pre><code>        t.Start();
        t.Interrupt();
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>如果對一個non-blocked的thread使用interrupt, 它仍會持續進行, 直到它blocked, 就會拋出ThreadInterruptedException. 以下範例呈現此功能, Main thread對worker thread做interrupt, 而worker執行完一個稍微久的迴圈再做Blocked(Sleep)就會拋exception</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace ThreadInterruptNonblocking<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            Thread t &#x3D; new Thread(() &#x3D;&gt;<br>            {<br>                try<br>                {<br>                    long count &#x3D; 0;<br>                    while (count &lt; 1000000000)<br>                    {<br>                        count++;<br>                    }<br>                    Console.WriteLine(“Sleep”);<br>                    Thread.Sleep(1000);<br>                    Console.WriteLine(“I am done”);<br>                }<br>                catch(ThreadInterruptedException ex)<br>                {<br>                    Console.WriteLine(“Catch interrupt!”);<br>                }<br>            });</p>
<pre><code>        t.Start();
        Console.WriteLine(&quot;Call interrupt&quot;);
        t.Interrupt();

        Console.ReadLine();
    &#125;
&#125;
</code></pre>
<p>} </p>
<ul>
<li>先確認thread的狀態再呼叫interrupt, 可以避免此問題, 但這方法不是thread-safe, 因為if 和 interrupt 會有機率發生搶占</li>
</ul>
<p>if ((worker.ThreadState &amp; ThreadState.WaitSleepJoin) &gt; 0)<br>  worker.Interrupt();</p>
<ul>
<li>只要有thread在lock或synchronized的時候發生blocked, 則有對它interrupt的指令蜂擁而上. 如果該thread沒有處理好發生interrupt後的後續(比如在finally要釋放資源), 將導致資源不正確釋放、物件狀態未知化.</li>
<li>因此, interrupt是不必要的, 要強制對blocked thread做釋放, 安全的方式是用cancellation token. 如果是要unblock thread, Abort相較是比較有用的.</li>
</ul>
<h4 id="Abort-Net-Core不支援"><a href="#Abort-Net-Core不支援" class="headerlink" title="Abort (Net Core不支援)"></a>Abort (Net Core不支援)</h4><ul>
<li>Abort也是強制釋放blocked thread, 且會拋出ThreadAbortException. 但是在catch結尾會再重拋一次該exception</li>
<li>如果有在catch呼叫Thread.ResetAbort, 就不會發生重拋</li>
<li>在呼叫Abort後的時間內, 該thread的ThreadState是AbortRequested</li>
<li>尚未handle的ThreadAbortException 並不會造成程式shutdown</li>
<li>Abort和Interrupt的最大差異在於被呼叫的non-blocked thread會發生什麼事. Interrupt會等到該thread block才運作, 而Abort會立即拋出exceptio(unmanaged code除外)</li>
<li>Managed code不是abort-safe, 比如有個FileStream在建構讀檔的過程被Abort, 而unmanaged的file handler沒被中止, 導致檔案一直open, 直到該程式的AppDomain結束才會釋放.</li>
<li>有2個案例是可以安全做Abort:</li>
</ul>
<ol>
<li>在abort該thread後, 連它的AppDomain也要中止. 比如Unit testing</li>
<li>對自身Thread做Abort, 比如ASP.NET的Redirect機制是這樣做</li>
</ol>
<ul>
<li>作者的LINQPad工具, 當取消某個查詢時, 對它的thread abort. abort結束後, 會拆解並重新建立新的application domain, 避免發生潛在受汙染狀態</li>
</ul>
<h3 id="Safe-Cancellation"><a href="#Safe-Cancellation" class="headerlink" title="Safe Cancellation"></a>Safe Cancellation</h3><ul>
<li>Abort在大部分的情境, 是個很危險的功能</li>
<li>建議替代的方式是實作cooperative pattern, 也就是worker會定期檢查某個flag, 如果該flag被設立, 則自己做abort(比如BackgroundWorker)</li>
<li>Caller對該flag設置, Worker會定期檢查到.</li>
<li>這種pattern的缺點是worker的method必須顯式支援cancellation</li>
<li>這種是少數安全的cancellation pattern</li>
<li>以下是自定義封裝的cancellation flag class:</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace CancellationCustom<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            var canceler &#x3D; new RulyCanceler();<br>            new Thread(()&#x3D;&gt;{<br>                try{<br>                    Work(canceler);<br>                }<br>                catch(OperationCanceledException){<br>                    Console.WriteLine(“Canceled”);<br>                }<br>            }).Start();</p>
<pre><code>        Thread.Sleep(1000);
        canceler.Cancel();
    &#125;

    private static void Work(RulyCanceler canceler)
    &#123;
        while(true)
        &#123;
            canceler.ThrowIfCancellationRequested();
            try
            &#123;
                // other method
                OtherMethod(canceler);
            &#125;
            finally
            &#123;
                // any required cleanup
            &#125;
        &#125;
    &#125;

    private static void OtherMethod(RulyCanceler canceler)
    &#123;
        // do stuff...
        for(int i = 0 ; i &lt; 1000000;++i)
        &#123;
        &#125;
        Console.WriteLine(&quot;I am doing work&quot;);


        canceler.ThrowIfCancellationRequested();
    &#125;
&#125;

class RulyCanceler
&#123;
    object \_cancelLocker = new object();
    bool \_cancelRequest;
    public bool IsCancellationRequested
    &#123;
        get
        &#123;
            lock(\_cancelLocker)
            &#123;
                return \_cancelRequest;
            &#125;
        &#125;
    &#125;

    public void Cancel()
    &#123;
        lock(\_cancelLocker)
        &#123;
            \_cancelRequest = true;
        &#125;
    &#125;

    public void ThrowIfCancellationRequested()
    &#123;
        if(IsCancellationRequested)
        &#123;
            throw new OperationCanceledException();
        &#125;
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>上述寫法是安全的cancellation pattern, 但是Work method本身不需要RulyCanceler物件, 因此NET Framework提供Cancellation Token, 讓設置</li>
</ul>
<h4 id="Cancellation-Tokens"><a href="#Cancellation-Tokens" class="headerlink" title="Cancellation Tokens"></a>Cancellation Tokens</h4><ul>
<li>Net Framework 4.0提供cooperative cancellation pattern的CancellationTokenSource和CancellationToken, 使用方式為:</li>
</ul>
<ol>
<li>CancellationTokenSource提供Cancel方法</li>
<li>CancellationToken有IsCancellationRequested屬性和ThrowIfCancellationRequested方法</li>
</ol>
<ul>
<li>這個類別是更前面範例更複雜, 拆出2個類別作分開的功能(Cancel和檢查flag)</li>
<li>使用CancellationTokenSource範例如下:</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace CancellationTokenCustom<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            var cancelSource &#x3D; new CancellationTokenSource();<br>            new Thread(() &#x3D;&gt; {<br>                try<br>                {<br>                    Work(cancelSource.Token);<br>                }<br>                catch (OperationCanceledException)<br>                {<br>                    Console.WriteLine(“Canceled”);<br>                }<br>            }).Start();</p>
<pre><code>        Thread.Sleep(1000);
        cancelSource.Cancel();
        Console.ReadLine();
    &#125;

    private static void Work(CancellationToken cancelToken)
    &#123;
        while (true)
        &#123;
            cancelToken.ThrowIfCancellationRequested();
            try
            &#123;
                // other method
                OtherMethod(cancelToken);
            &#125;
            finally
            &#123;
                // any required cleanup
            &#125;
        &#125;
    &#125;

    private static void OtherMethod(CancellationToken cancelToken)
    &#123;
        // do stuff...
        for (int i = 0; i &lt; 1000000; ++i)
        &#123;
        &#125;
        Console.WriteLine(&quot;I am doing work&quot;);


        cancelToken.ThrowIfCancellationRequested();
    &#125;

&#125;
</code></pre>
<p>}</p>
<ul>
<li>主要流程為</li>
</ul>
<ol>
<li>先建立CancellationTokenSource物件</li>
<li>將CancellationTokenSource的CancellationToken代入可支援取消的函式</li>
<li>在支援取消的函式, 不斷用CancellationToken物件檢查IsCancellationRequested或者透過ThrowIfCancellationRequested來中止程式</li>
<li>對CancellationTokenSource物件呼叫Cancel方法</li>
</ol>
<ul>
<li>CancellationToken是struct, 意味這如果有隱式copy給其他的token, 則都是參考同一個CancellationTokenSource</li>
<li>CancellationToken的WaitHandle屬性會回傳取消的訊號, 而Register方法可以註冊一個委託事件, 當cancel被呼叫時可以觸發該委託.</li>
<li>Cancellation tokens在Net Framework常用的類別如下:</li>
</ul>
<ol>
<li>ManualResetEventSlim and SemaphoreSlim</li>
<li>CountdownEvent</li>
<li>Barrier</li>
<li>BlockingCollection</li>
<li>PLINQ and Task Parallel Library</li>
</ol>
<ul>
<li>這些類別通常有Wait的函式, 如果有呼叫Wait後再用CancellationToken做cancel, 將取消那Wait的功能. 比起Interrupt更清楚、安全.</li>
</ul>
<h3 id="Lazy-Initialization"><a href="#Lazy-Initialization" class="headerlink" title="Lazy Initialization"></a>Lazy Initialization</h3><ul>
<li>類別的Field, 有些在Construct需要花費較多的資源, 比如下方的程式:</li>
</ul>
<p>class Foo<br>{<br>public readonly Expensive Expensive &#x3D; new Expensive();<br>}</p>
<p>class Expensive<br>{<br>&#x2F;&#x2F; suppose this is expensive to construct<br>}</p>
<ul>
<li>可以改成一開始是null, 直到存取時才做初始化, 也就是lazily initialize, 比如下方程式:</li>
</ul>
<p>class Foo<br>{<br>Expensive _expensive;<br>public Expensive Expensive<br>{<br>get<br>{<br>if(_expensive &#x3D;&#x3D; null)<br>{<br>_expensive &#x3D; new Expensive();<br>}</p>
<p>return _expensive;<br>}<br>}<br>}</p>
<p>class Expensive<br>{<br>&#x2F;&#x2F; suppose this is expensive to construct<br>}</p>
<ul>
<li>但是在多執行緒的狀況下, 取Expensive property可能會有重複做new Expensive()的機率, 並非thread-safe. 要達到Thread-safe, 可以加上lock:</li>
</ul>
<p>class Foo<br>{<br>Expensive _expensive;<br>readonly object _expensiveLock &#x3D; new object();<br>public Expensive Expensive<br>{<br>get<br>{<br>lock(_expensiveLock)<br>{<br>if(_expensive &#x3D;&#x3D; null)<br>{<br>_expensive &#x3D; new Expensive();<br>}</p>
<p>return _expensive;<br>}<br>}<br>}<br>}</p>
<p>class Expensive<br>{<br>&#x2F;&#x2F; suppose this is expensive to construct<br>}</p>
<h4 id="Lazy"><a href="#Lazy" class="headerlink" title="Lazy"></a>Lazy<T></h4><ul>
<li>.NET Framework 4.0提供Lazy<T>的類別, 能做lazy initialization的功能. Constructor有1個參數isThreadSafe, 設為true時, 代表能支援thread-safe, 若為false, 只能用在single-thread的情境.</li>
<li>Lazy在支援thread-safe的實作, 採用Double-checked locking, 更有效率檢查初始化</li>
<li>改成用Lazy且是factory的寫法:</li>
</ul>
<p>class Foo<br>{<br>Lazy<Expensive> _expensive &#x3D; new Lazy<Expensive>(() &#x3D;&gt; new Expensive(), true);<br>readonly object _expensiveLock &#x3D; new object();<br>public Expensive Expensive<br>{<br>get<br>{<br>return _expensive.Value;<br>}<br>}<br>}</p>
<h4 id="LazyInitializer"><a href="#LazyInitializer" class="headerlink" title="LazyInitializer"></a>LazyInitializer</h4><ul>
<li>LazyInitializer是static類別, 和Lazy<T>差異在</li>
</ul>
<ol>
<li>它的static method可以直接對想做lazy initialization的field, 可以效能優化</li>
<li>有提供其他的初始化模式, 會有多個執行緒競爭</li>
</ol>
<ul>
<li>以下是LazyInitializer使用EnsureInitialized的初始化field的範例:</li>
</ul>
<p>class Foo<br>{<br>Expensive _expensive;<br>public Expensive Expensive<br>{<br>get<br>{<br>LazyInitializer.EnsureInitialized(ref _expensive, () &#x3D;&gt; new Expensive());<br>return _expensive;<br>}<br>}<br>}</p>
<ul>
<li>可以傳另一個參數做thread race的初始化, 最終只會有1個thread取得1個物件. 這種作法好處是比起Double-checked locking還要快, 因為它不需要lock.</li>
<li>但thread race的初始化很少會用到, 且它有一些缺點:</li>
</ul>
<ol>
<li>如果有多個thread競爭, 數量比CPU core還多, 會比較慢</li>
<li>潛在得浪費CPU資源做重複的初始化</li>
<li>初始化的邏輯必須是thread-safe, 比如前述Expensive的Constructor, 有static變數要寫入的話, 就可能是thread-unsafe</li>
<li>initializer對物件的初始化需要dispose時, 而沒有額外的邏輯就無法對浪費的物件做dispose</li>
</ol>
<ul>
<li>double-checked locking的參考寫法:</li>
</ul>
<p>volatile Expensive _expensive;<br>public Expensive Expensive<br>{<br>  get<br>  {<br>    if (_expensive &#x3D;&#x3D; null)             &#x2F;&#x2F; First check (outside lock)<br>      lock (_expenseLock)<br>        if (_expensive &#x3D;&#x3D; null)         &#x2F;&#x2F; Second check (inside lock)<br>          _expensive &#x3D; new Expensive();<br>    return _expensive;<br>  }<br>}</p>
<ul>
<li>race-to-initialize的參考寫法:</li>
</ul>
<p>volatile Expensive _expensive;<br>public Expensive Expensive<br>{<br>  get<br>  {<br>    if (_expensive &#x3D;&#x3D; null)<br>    {<br>      var instance &#x3D; new Expensive();<br>      Interlocked.CompareExchange (ref _expensive, instance, null);<br>    }<br>    return _expensive;<br>  }<br>}</p>
<h3 id="Thread-Local-Storage"><a href="#Thread-Local-Storage" class="headerlink" title="Thread-Local Storage"></a>Thread-Local Storage</h3><ul>
<li>Thread擁有自己獨立的資料, 別的Thread無法存取</li>
<li>有3種thread-local storage的實作</li>
</ul>
<h4 id="ThreadStatic"><a href="#ThreadStatic" class="headerlink" title="[ThreadStatic]"></a>[ThreadStatic]</h4><ul>
<li>對1個static的field加上ThreadStatic屬性, 因此每個thread存取該變數都是獨立的</li>
<li>缺點是不能用在instance的變數, 且它只有在第1個thread存取它時才初始化值一次, 因此其他thread一開始都拿到預設值.</li>
<li>以下範例是另外建2個thread對ThreadStatic變數_x各自修改值並輸出. Static constructor在程式剛啟動以Main Thread執行, 因此初始化的值5只有給Main Thread, 而t1和t2的_x值是0. 在Sleep 2秒後, Main thread的_x值仍是 5 .</li>
</ul>
<p>using System;<br>using System.Threading;<br>namespace ThreadStaticTest<br>{<br>    class Program<br>    {<br>        [ThreadStatic] static int _x;<br>        static Program()<br>        {<br>            _x &#x3D; 5;<br>        }<br>        static void Main(string[] args)<br>        {<br>            Thread t1 &#x3D; new Thread(() &#x3D;&gt; {<br>                Console.WriteLine(“t1 before: “ + _x);<br>                _x &#x3D; 666;<br>                Console.WriteLine(“t1 after: “ + _x);<br>            });</p>
<pre><code>        Thread t2 = new Thread(() =&gt; &#123;
            Console.WriteLine(&quot;t2 before: &quot; + \_x);
            \_x = 777;
            Console.WriteLine(&quot;t2 after: &quot; + \_x);
        &#125;);

        t1.Start();
        t2.Start();
        Thread.Sleep(2000);
        Console.WriteLine(\_x);
        Console.ReadLine();
    &#125;
&#125;
</code></pre>
<p>}</p>
<h4 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal<T></h4><ul>
<li>在Net Framework 4.0推出, 能對static 和 instance的field指定預設值</li>
<li>用ThreadLocal建立的值, 要存取時使用它的Value property</li>
<li>ThreadLocal有使用Lazy存取, 因此每個Thread再存取時會做Lazy的計算</li>
<li>如下面範例, 每個Thread的_x初始值都是3</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace ThreadLocalTest<br>{<br>    class Program<br>    {<br>        static ThreadLocal<int> _x &#x3D; new ThreadLocal<int> (() &#x3D;&gt; 3);<br>        static void Main(string[] args)<br>        {<br>            Console.WriteLine(“Hello World!”);</p>
<pre><code>        Thread t1 = new Thread(() =&gt; &#123;
            Console.WriteLine(&quot;t1 before: &quot; + \_x);
            \_x.Value = 666;
            Console.WriteLine(&quot;t1 after: &quot; + \_x);
        &#125;);

        Thread t2 = new Thread(() =&gt; &#123;
            Console.WriteLine(&quot;t2 before: &quot; + \_x);
            \_x.Value = 777;
            Console.WriteLine(&quot;t2 after: &quot; + \_x);
        &#125;);

        t1.Start();
        t2.Start();
        Thread.Sleep(2000);
        Console.WriteLine(\_x);
        Console.ReadLine();
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>如果是建立instance field, 用Random作為範例, Random類別是thread-unsafe, 因此在multi-thread的環境使用lock之外, 可以用ThreadLocal建立屬於各thread的獨立物件, 如下範例:</li>
</ul>
<p>var localRandom &#x3D; new ThreadLocal<Random>(() &#x3D;&gt; new Random());<br>Console.WriteLine (localRandom.Value.Next());</p>
<ul>
<li>前面Random本身有小缺陷, 如果multi-thread在相差10ms之間都對Random取值, 可能會取到相同的值, 因此可以改良帶入一些隨機參數做初始化:</li>
</ul>
<p>var localRandom &#x3D; new ThreadLocal<Random><br> ( () &#x3D;&gt; new Random (Guid.NewGuid().GetHashCode()) );</p>
<h4 id="GetData-and-SetData"><a href="#GetData-and-SetData" class="headerlink" title="GetData and SetData"></a>GetData and SetData</h4><ul>
<li>把資料存在LocalDataStoreSlot, 而這slot可以設定名稱或者不命名</li>
<li>由Thread的GetNamedDataSlot方法設定有名稱的slot, 而AllocateDataSlot方法取得不命名的slot</li>
<li>Thread的FreeNamedDataSlot方法會釋放有特定名稱的slot與所有thread的關聯, 但原本的slot物件仍可以存取該資料</li>
<li>以下範例是建立名稱為Name的slot和不命名的slot, 分別是存字串MyName和整數值MyNum. Main Thread和另外建立的t1 t2 thread, 對MyName與MyNum都是獨立的值. 最後在呼叫FreeNamedDataSlot之前, 從Name取slot的值仍是”Main name”, 但呼叫FreeNamedDataSlot後, 從Name取slot的值變成null.</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace TestLocalDataStoreSlot<br>{<br>    class Program<br>    {<br>        static LocalDataStoreSlot _nameSlot &#x3D; Thread.GetNamedDataSlot(“Name”);<br>        static LocalDataStoreSlot _numSlot &#x3D; Thread.AllocateDataSlot();</p>
<pre><code>    static string MyName
    &#123;
        get
        &#123;
            object data = Thread.GetData(\_nameSlot);
            return data == null ? string.Empty : (string)data;
        &#125;

        set
        &#123;
            Thread.SetData(\_nameSlot, value);
        &#125;
    &#125;

    static int MyNum
    &#123;
        get
        &#123;
            object data = Thread.GetData(\_numSlot);
            return data == null ? -1 : (int)data;
        &#125;

        set
        &#123;
            Thread.SetData(\_numSlot, value);
        &#125;
    &#125;

    static void Main(string\[\] args)
    &#123;
        Thread t1 = new Thread(() =&gt;
        &#123;
            Console.WriteLine(&quot;t1 before name: &quot; + MyName);
            MyName = &quot;T1!&quot;;
            Console.WriteLine(&quot;t1 after name: &quot; + MyName);

            Console.WriteLine(&quot;t1 before num: &quot; + MyNum);
            MyNum = 555;
            Console.WriteLine(&quot;t1 after num: &quot; + MyNum);
        &#125;);

        Thread t2 = new Thread(() =&gt;
        &#123;
            Console.WriteLine(&quot;t2 before name: &quot; + MyName);
            MyName = &quot;T2?&quot;;
            Console.WriteLine(&quot;t2 after name: &quot; + MyName);

            Console.WriteLine(&quot;t2 before num: &quot; + MyNum);
            MyNum = 777;
            Console.WriteLine(&quot;t2 after num: &quot; + MyNum);
        &#125;);

        t1.Start();
        t2.Start();

        Console.WriteLine(&quot;Main before name: &quot; + MyName);
        MyName = &quot;Main name&quot;;
        Console.WriteLine(&quot;Main after name: &quot; + MyName);



        Console.WriteLine(&quot;Main before num: &quot; + MyNum);
        MyNum = 12345678;
        Console.WriteLine(&quot;Main after num: &quot; + MyNum);

        Console.ReadLine();

        string s1 = Thread.GetData(Thread.GetNamedDataSlot(&quot;Name&quot;)) as string;
        Console.WriteLine(&quot;Main before clear: &quot; + s1);

        Thread.FreeNamedDataSlot(&quot;Name&quot;);

        string s2 = Thread.GetData(Thread.GetNamedDataSlot(&quot;Name&quot;)) as string;
        Console.WriteLine(&quot;Main after clear: &quot; + s2);

        Console.ReadLine();
    &#125;
&#125;
</code></pre>
<p>}</p>
<h3 id="Timers"><a href="#Timers" class="headerlink" title="Timers"></a>Timers</h3><ul>
<li>Timer可提供某些工作做週期性的執行</li>
<li>在不用Timer的寫法如下, 缺點是會綁住Thread的資源, 且DoSomeAction的任務將逐漸延遲執行</li>
</ul>
<p>new Thread (delegate() {<br>                         while (enabled)<br>                         {<br>                           DoSomeAction();<br>                           Thread.Sleep (TimeSpan.FromHours (24));<br>                         }<br>                       }).Start();</p>
<ul>
<li>Net提供4種Timer, 其中2種是一般性的multi-thread timer:</li>
</ul>
<ol>
<li>System.Threading.Timer</li>
<li>System.Timers.Timer</li>
</ol>
<ul>
<li>Single-thread timer:</li>
</ul>
<ol>
<li>System.Windows.Forms.Timer (Windows Form timer)</li>
<li>System.Windows.Threading.DispatcherTimer (WPF timer)</li>
</ol>
<ul>
<li>multi-thread timer能更精準、彈性, 而single-thread timer是安全、方便的執行簡單任務, 比如更新Wiform &#x2F; WPF 的元件</li>
</ul>
<h4 id="Multithreaded-Timers"><a href="#Multithreaded-Timers" class="headerlink" title="Multithreaded Timers"></a>Multithreaded Timers</h4><ul>
<li>System.Threading.Timer是最簡單的multi-thread timer</li>
<li>可以呼叫Change方法來改變執行的時間</li>
<li>以下範例是建立Timer, 等5秒後才開始做任務, 每個任務間隔1秒.</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace ThreadingTImer<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            Timer tmr &#x3D; new Timer(Tick, “tick…”, 5000, 1000);<br>            Console.ReadLine();<br>            tmr.Dispose();<br>        }</p>
<pre><code>    static void Tick(object data)
    &#123;
        Console.WriteLine(data);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>另一個System.Timers的Timer, 是基於System.Threading.Timer的包裝, 主要增加的功能有:</li>
</ul>
<ol>
<li>實作Component, 可用在Visual Studio’s designer</li>
<li>不使用Change, 改成Interval property</li>
<li>不使用直接的委託, 而是Elapsedevent</li>
<li>用Enabled來啟用或停止timer</li>
<li>如果對Enabled感到疑惑, 改用Start和Stop方法</li>
<li>AutoReset代表著重複執行的事件</li>
<li>SynchronizingObject property可以呼叫Invoke和BeginInvoke方法, 可以安全呼叫WPF &#x2F; Winform的元件</li>
</ol>
<ul>
<li>以下是System.Timers.Timer的範例, 每0.5秒執行任務, 透過Start和Stop啟用和停止timer.</li>
</ul>
<p>using System;<br>using System.Timers;</p>
<p>namespace TimersTimer<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            Timer tmr &#x3D; new Timer();<br>            tmr.Interval &#x3D; 500;<br>            tmr.Elapsed +&#x3D; tmr_Elapsed;<br>            tmr.Start();<br>            Console.ReadLine();<br>            tmr.Stop();<br>            Console.ReadLine();<br>            tmr.Start();<br>            Console.ReadLine();<br>            tmr.Dispose();<br>        }</p>
<pre><code>    private static void tmr\_Elapsed(object sender, ElapsedEventArgs e)
    &#123;
        Console.WriteLine(&quot;Tick&quot;);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>Multi-thread timer是從thread pool的少量thread來支援timer, 也代表每次執行的委託任務, 都可能由不同的thread來執行.</li>
<li>Elapsed事件幾乎是很準時的執行, 不管前一段時間的任務執行完畢與否, 因此委託給它的任務必須是thread-safe</li>
<li>Multi-thread timer的精準度是基於作業系統 誤差約10~20ms, 如果要更精準, 需要使用native interop來呼叫Windows multimedia timer, 誤差可降至1ms. 這interop定義在winmm.dll. 使用winmm.dll的一般流程:</li>
</ul>
<ol>
<li>呼叫timeBeginPeriod, 通知作業系統需要高精度的timing</li>
<li>呼叫timeSetEvent啟用timer</li>
<li>任務完成後, 呼叫timeKillEvent停止timer</li>
<li>呼叫timeEndPeriod, 通知作業系統不再需要高精度的timing</li>
</ol>
<ul>
<li>搜尋 [dllimport winmm.dll timesetevent] 能找到winmm.dll的範例</li>
</ul>
<h4 id="Single-Threaded-Timers"><a href="#Single-Threaded-Timers" class="headerlink" title="Single-Threaded Timers"></a>Single-Threaded Timers</h4><ul>
<li>Single-thread timer是用來在WPF或Winform, 如果拿到別的應用程式, 則那個timer將不會觸發</li>
<li>Winform &#x2F; WPF的timer並不是基於thread pool, 而是用User interface model的message pumping技術. 也就是Timer觸發的任務都會是同一個thread, 而那thread是一開始建立timer的thread.</li>
<li>使用single-thread timer的好處:</li>
</ul>
<ol>
<li>忘記thread-safe的問題</li>
<li>Timer執行的任務(Tick), 必須前一個任務完成才會觸發下一個</li>
<li>不需要呼叫元件的Invoke, 能直接在Tick委託任務執行更新UI元件的功能</li>
</ol>
<ul>
<li>因為single-thread的限制, 帶來的缺點是:</li>
</ul>
<ol>
<li>除非Tick任務執行地很快, 否則UI將會沒辦法反應</li>
</ol>
<ul>
<li>WPF &#x2F; Winform的timer只適合簡單的任務, 否則需要採用multi-thread timer.</li>
<li>Single-thread的timer的精準度和multi-thread timer差不多, 會有幾十ms的差異. 而會因為UI的request或其他timer的事件而造成更不準確.</li>
</ul>
<h3 id="Threading-in-C-參考資料"><a href="#Threading-in-C-參考資料" class="headerlink" title="Threading in C# 參考資料"></a>Threading in C# 參考資料</h3><ol>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3lQcLky">C# 9.0 in a Nutshell: The Definitive Reference, Joseph Albahari (Amazon)</a></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/threading-in-csharp-series-book-summary/">Threading in C# 系列的讀書筆記</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiJyu Gao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">206</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiJyu Gao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
