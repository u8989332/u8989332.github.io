<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/26/professional-javascript-for-web-developers-chapter-5-basic-reference-types/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/26/professional-javascript-for-web-developers-chapter-5-basic-reference-types/" class="post-title-link" itemprop="url">JavaScript Basic Reference Type</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-26 16:22:00" itemprop="dateCreated datePublished" datetime="2021-12-26T16:22:00+08:00">2021-12-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:26" itemprop="dateModified" datetime="2023-11-19T15:47:26+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index"><span itemprop="name">JavaScript</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/" itemprop="url" rel="index"><span itemprop="name">è®€æ›¸ç­†è¨˜</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æœ¬ç¯‡ç‚º Professional JavaScript for Web Developers ç¬¬5ç«  Basic Reference Type çš„è®€æ›¸ç­†è¨˜</p>
<h4 id="1-1-Date-Type"><a href="#1-1-Date-Type" class="headerlink" title="1.1Â Date Type"></a>1.1Â Date Type</h4><ul>
<li>Dateå„²å­˜å¾1970å¹´1æœˆ1æ—¥ UTC å‰å¾Œç¶“éçš„æ¯«ç§’.</li>
<li>new Date()å¯å¾—åˆ°localçš„ç¾åœ¨æ™‚é–“</li>
<li>Dateçš„constructorå¯ä»£å…¥æ¯«ç§’åšåˆå§‹åŒ–ç‚ºåˆ¥çš„æ™‚é–“</li>
<li>Date.parse()å’ŒDate.UTC()å¯å›å‚³1970&#x2F;1&#x2F;1 UTCçš„ç¶“éæ¯«ç§’æ™‚é–“</li>
<li>Date.parse()å¯è§£æå¤šç¨®æ—¥æœŸå­—ä¸², ä¸”æœƒå—åœ°å€å½±éŸ¿</li>
<li>åœ¨Date() constructorä»£å…¥æ—¥æœŸå­—ä¸², å…¶èƒŒå¾Œä¹Ÿæ˜¯Date.parse()</li>
<li>Date.UTC()ä»¥UTCæ™‚é–“ç‚ºåŸºæº–</li>
<li>ä½†åœ¨Date() constructorä»£å…¥å’ŒUTCçš„åƒæ•¸æ–¹å¼, æ˜¯å¾—åˆ°local time</li>
<li>ä¸€æ®µç¨‹å¼ç¢¼é‹è¡Œçš„æ™‚é–“å·®å¯ä»¥ç”¨2ç­†Date.now()ç›¸æ¸›, å–å¾—åŸ·è¡Œå‰å¾Œçš„æ¯«ç§’å·®</li>
</ul>
<p>&#x2F;&#x2F; å‡å¦‚ç¾åœ¨æ˜¯å°ç£ GMT+8 çš„ 2020&#x2F;6&#x2F;13 ä¸‹åˆ2é»<br>let d1 &#x3D; new Date();<br>console.log(d1.getUTCHours()); &#x2F;&#x2F; è¼¸å‡º UTCçš„ æ—©ä¸Š6é»</p>
<p>let d2 &#x3D; new Date(Date.parse(â€œ2020&#x2F;6&#x2F;13 14:00:00â€));<br>console.log(d2.getUTCHours()); &#x2F;&#x2F; è¼¸å‡º UTCçš„ æ—©ä¸Š6é»</p>
<p>let d3 &#x3D; new Date(Date.UTC(2020, 5, 13, 14, 0, 0));<br>console.log(d3.getUTCHours()); &#x2F;&#x2F; è¼¸å‡º UTCçš„ ä¸‹åˆ2é»</p>
<p>let d4 &#x3D; new Date(2020, 5, 13, 14, 0, 0);<br>console.log(d4.getUTCHours()); &#x2F;&#x2F; è¼¸å‡º UTCçš„ æ—©ä¸Š6é»</p>
<p>let startD &#x3D; Date.now();<br>console.log(â€˜do somethingâ€™);<br>let endD &#x3D; Date.now();<br>let diff &#x3D; endD - startD;<br>console.log(diff); &#x2F;&#x2F; è¼¸å‡º æ¯«ç§’å·®</p>
<h5 id="1-1-1-Inherited-Methods"><a href="#1-1-1-Inherited-Methods" class="headerlink" title="1.1.1 Inherited Methods"></a>1.1.1 Inherited Methods</h5><ul>
<li>toLocaleString()å’ŒtoString()æ¯å€‹ç€è¦½å™¨è¼¸å‡ºçš„æ ¼å¼ç¨å¾®ä¸åŒ, åªèƒ½ç”¨åœ¨Debug</li>
<li>valueOf()æœƒç”¨åœ¨æ¯”è¼ƒçš„operatorç­‰, åšæ™‚é–“å‰å¾Œçš„æ¯”è¼ƒé‹ç®—, å¯¦éš›é‚è¼¯æ˜¯å–å‡ºæ¯«ç§’å€¼åšå¤§å°æ¯”å°</li>
</ul>
<h5 id="1-1-2-Date-Formatting-Methods"><a href="#1-1-2-Date-Formatting-Methods" class="headerlink" title="1.1.2Â Date-Formatting Methods"></a>1.1.2Â Date-Formatting Methods</h5><ul>
<li>æœ‰toDateString(), toTimeString(), toLocaleDateString(), toLocalseTimeString(), toUTCString(), éƒ½å’ŒtoString()ä¸€æ¨£, æ¯å€‹ç€è¦½å™¨çš„è¼¸å‡ºå„æœ‰ç¨å¾®ä¸åŒ</li>
<li>é‚„æœ‰å€‹toGMTString(), å’ŒtoUTCString()çµæœä¸€æ¨£, æ‰€ä»¥å»ºè­°ç”¨toUTCString()</li>
</ul>
<h5 id="1-1-3-Date-Time-Component-Methods"><a href="#1-1-3-Date-Time-Component-Methods" class="headerlink" title="1.1.3Â Date&#x2F;Time Component Methods"></a>1.1.3Â Date&#x2F;Time Component Methods</h5><ul>
<li>å‰©ä¸‹çš„Dateæ–¹æ³•æœ‰å–ç‰¹å®šæ—¥æœŸ&#x2F;æ™‚é–“æ ¼å¼ã€è¨­ç½®ç‰¹å®šæ—¥æœŸ&#x2F;æ ¼å¼, ä»¥getXXXX()æˆ–setXXXX()å‘½å.</li>
<li>å…¶ä¸­getTime()å’ŒvalueOf()ä¸€æ¨£, éƒ½æ˜¯å–UTCç‚ºæº–çš„æ¯«ç§’å·®.</li>
</ul>
<h4 id="1-2-RexExp-Type"><a href="#1-2-RexExp-Type" class="headerlink" title="1.2 RexExp Type"></a>1.2 RexExp Type</h4><ul>
<li>ç”¨é€™typeæ”¯æ´regular expressionçš„åŒ¹é…</li>
<li>æ ¼å¼ç‚º let expression &#x3D; &#x2F;pattern&#x2F;flags</li>
<li>patternç‚ºä»»æ„çš„regular expression, è€Œflagså¯ä»¥æ˜¯1å€‹æˆ–å¤šå€‹</li>
<li>flagæœ‰6ç¨®</li>
</ul>
<ol>
<li>g : ä»£è¡¨globalæ¨¡å¼, æ‡‰ç”¨æ‰€æœ‰å­—ä¸², è€Œä¸æ˜¯åªæœ‰å‰é¢å­—ä¸²æœ‰matchå°±åœæ­¢</li>
<li>i: ä¸å€åˆ†å¤§å°å¯«</li>
<li>m: å¤šè¡Œæ¨¡å¼, é‡åˆ°çµå°¾ç¬¦è™Ÿä»ç¹¼çºŒå¾€ä¸‹æ‰¾</li>
<li>y: stickyæ¨¡å¼, patternå¾lastIndexé–‹å§‹æ‰¾</li>
<li>u: unicodeæ¨¡å¼</li>
<li>s: (é€™æœ¬æ›¸é‚„æœªæåˆ°) ES2018å‡ºç¾çš„æ–°æ¨¡å¼, å…è¨± . å­—å…ƒ matchè·³è¡Œ, å¯åƒè€ƒ<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp/dotAll">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects&#x2F;RegExp&#x2F;dotAll</a></li>
</ol>
<p>let pattern1 &#x3D; &#x2F;ad&#x2F;g; &#x2F;&#x2F; matchå­—ä¸²ä¸­æœ‰adçš„å­å­—ä¸²</p>
<p>let pattern2 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; matchç¬¬1å€‹æœ‰badæˆ–sadçš„å­å­—ä¸², ä¸”ä¸åˆ†å¤§å°å¯«</p>
<p>let pattern3 &#x3D; &#x2F;.ad&#x2F;gi; &#x2F;&#x2F; matchä»¥adçµå°¾, ä¸”ä¸å€åˆ†å¤§å°å¯«</p>
<ul>
<li>Regular expressionæœ‰äº›ç‰¹æ®Šçš„å­—å…ƒ, å…¶æœ‰ç‰¹æ®Šçš„æ„ç¾©, æƒ³æŠŠç‰¹æ®Šå­—å…ƒç•¶ä½œæ¯”å°çš„å­—, åŠ ä¸ŠÂ \ ç¬¦è™Ÿ</li>
<li>( { [ ^ $ ) ] } ? * + .</li>
</ul>
<p>Â </p>
<p>let pattern1 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; matchç¬¬1å€‹æœ‰badæˆ–sadçš„å­å­—ä¸², ä¸”ä¸åˆ†å¤§å°å¯«</p>
<p>let pattern2 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; matchç¬¬1å€‹æœ‰[bs]adçš„å­å­—ä¸², ä¸”ä¸åˆ†å¤§å°å¯«</p>
<p>let pattern3 &#x3D; &#x2F;.ad&#x2F;gi; &#x2F;&#x2F; matchä»¥adçµå°¾, ä¸”ä¸å€åˆ†å¤§å°å¯«</p>
<p>let pattern4 &#x3D; &#x2F;.ad&#x2F;gi; &#x2F;&#x2F; matchå­—ä¸²æœ‰.adçš„å­å­—ä¸², ä¸”ä¸å€åˆ†å¤§å°å¯«</p>
<ul>
<li>ä½¿ç”¨RegExpæ§‹é€ å‡½æ•¸å’Œä¸€èˆ¬expressionçš„æ˜¯åŒä¸€å€‹Type</li>
<li>RegExpä»£å…¥çš„å­—ä¸²pattern, è¦å†ç¶“éè½‰æ›æ‰èƒ½ç”¨</li>
</ul>
<p>let pattern1 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; matchç¬¬1å€‹æœ‰badæˆ–sadçš„å­å­—ä¸², ä¸”ä¸åˆ†å¤§å°å¯«</p>
<p>let pattern2 &#x3D; new RegExp(â€œ[bs]adâ€, â€œiâ€); &#x2F;&#x2F; å’Œpattern1ä¸€æ¨£</p>
<p>let pattern3 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; matchç¬¬1å€‹æœ‰[bs]adçš„å­å­—ä¸², ä¸”ä¸åˆ†å¤§å°å¯«</p>
<p>let pattern4 &#x3D; new RegExp(â€œ\[bs\]adâ€, â€œiâ€); &#x2F;&#x2F; å’Œpattern3ä¸€æ¨£</p>
<p>let pattern5 &#x3D; &#x2F;.ad&#x2F;gi; &#x2F;&#x2F; matchå­—ä¸²æœ‰.adçš„å­å­—ä¸², ä¸”ä¸å€åˆ†å¤§å°å¯«</p>
<p>let pattern6 &#x3D; new RegExp(â€œ\.ad&#x2F;giâ€, â€œiâ€); &#x2F;&#x2F; å’Œpattern5ä¸€æ¨£</p>
<ul>
<li>ç”¨RegExpçš„test, å¯æ¸¬è©¦æ˜¯å¦æŸå­—ä¸²æœ‰matchæ­¤pattern</li>
<li>ä½†RegExpåªè¦åšæ¯”å°çš„åŠŸèƒ½, å…§éƒ¨çš„æ¯”å°indexä¸æœƒé‡ç½®, æ‰€ä»¥æœƒæœ‰éœ€è¦é‡æ–°åˆå§‹åŒ–çš„åŠŸèƒ½</li>
</ul>
<p>let pattern1 &#x3D; &#x2F;[bs]ad&#x2F;g; &#x2F;&#x2F; matchæœ‰badæˆ–sadçš„å­å­—ä¸²</p>
<p>console.log(pattern1.test(â€˜sad_manâ€™)); &#x2F;&#x2F; è¼¸å‡ºtrue</p>
<p>console.log(pattern1.test(â€˜sad_manâ€™)); &#x2F;&#x2F; å› ç‚ºå‰é¢æ¯”å°éè€Œindexå¾€å¾Œæ²’å†match, è¼¸å‡ºfalse</p>
<h5 id="1-2-1-RegExp-Instance-Properties"><a href="#1-2-1-RegExp-Instance-Properties" class="headerlink" title="1.2.1 RegExp Instance Properties"></a>1.2.1 RegExp Instance Properties</h5><ul>
<li>global: boolean, æ˜¯å¦æœ‰è¨­å®šg flag</li>
<li>ignoreCase: boolean,Â æ˜¯å¦æœ‰è¨­ç½®i flag</li>
<li>unicode: boolean,Â æ˜¯å¦æœ‰è¨­ç½®u flag</li>
<li>sticky: boolean,Â æ˜¯å¦æœ‰è¨­ç½®y flag</li>
<li>lastIndex: integer, ä¸‹æ¬¡åŒ¹é…é–‹å§‹çš„ä½ç½®, ä½ç½®æ˜¯å¾0é–‹å§‹</li>
<li>multiline: boolean, æ˜¯å¦æœ‰è¨­ç½®m flag</li>
<li>source: expression patternå­—ä¸²</li>
<li>flags: expression flagå­—ä¸²</li>
<li>dotAll: (é€™æœ¬æ›¸å°šæœªæåˆ°) boolean, æ˜¯å¦æœ‰è¨­ç½®s flag</li>
</ul>
<p>let pattern1 &#x3D; &#x2F;[bs]ad&#x2F;i; &#x2F;&#x2F; matchç¬¬1å€‹æœ‰[bs]adçš„å­å­—ä¸², ä¸”ä¸åˆ†å¤§å°å¯«</p>
<p>console.log(pattern1.global); &#x2F;&#x2F; false<br>console.log(pattern1.ignoreCase); &#x2F;&#x2F; true<br>console.log(pattern1.multiline); &#x2F;&#x2F; false<br>console.log(pattern1.dotAll); &#x2F;&#x2F; false<br>console.log(pattern1.lastIndex); &#x2F;&#x2F; 0<br>console.log(pattern1.source); &#x2F;&#x2F; â€œ[bs]adâ€<br>console.log(pattern1.flags); &#x2F;&#x2F; â€œiâ€</p>
<p>let pattern2 &#x3D; new RegExp(â€œ\[bs\]adâ€, â€œiâ€); &#x2F;&#x2F; å’Œpattern1ä¸€æ¨£<br>console.log(pattern2.global); &#x2F;&#x2F; false<br>console.log(pattern2.ignoreCase); &#x2F;&#x2F; true<br>console.log(pattern2.multiline); &#x2F;&#x2F; false<br>console.log(pattern2.dotAll); &#x2F;&#x2F; false<br>console.log(pattern2.lastIndex); &#x2F;&#x2F; 0<br>console.log(pattern2.source); &#x2F;&#x2F; â€œ[bs]adâ€<br>console.log(pattern2.flags); &#x2F;&#x2F; â€œiâ€</p>
<h5 id="1-2-2-RegExp-Instance-Methods"><a href="#1-2-2-RegExp-Instance-Methods" class="headerlink" title="1.2.2 RegExp Instance Methods"></a>1.2.2 RegExp Instance Methods</h5><ul>
<li>exec()æ˜¯ä¸»è¦åšmatchçš„å‡½å¼, å›å‚³çš„ç‰©ä»¶æ˜¯Arrayå’Œä¸€äº›é¡å¤–å±¬æ€§: indexå’Œinput</li>
<li>indexä»£è¡¨ç›®å‰matchåˆ°çš„å­—ä¸²èµ·å§‹ä½ç½®, è€Œinputæ˜¯è¢«æ¯”å°çš„å­—ä¸²</li>
<li>å‡å¦‚æ²’æœ‰ä»»ä½•match, å›å‚³çš„ç‰©ä»¶æ˜¯Null, å¦å‰‡Arrayçš„ç¬¬1ç­†è³‡æ–™æ˜¯æœ‰æ¯”å°åˆ°çš„å­—ä¸², ç¬¬2ç­†ä»¥å¾Œæ˜¯æœ‰ç”¨ () åˆ†çµ„çš„capturing group</li>
<li>RegExpç‰©ä»¶æœƒæ›´æ–°lastIndexçš„å€¼, ä»£è¡¨ä¸‹æ¬¡è¦matchçš„èµ·å§‹ä½ç½®</li>
<li>RegExpçš„valueOf()æ˜¯å›å‚³æœ¬èº«RegExpç‰©ä»¶</li>
</ul>
<p>let text &#x3D; â€˜hello my mom my dadâ€™;<br>let pattern &#x3D; &#x2F;hello( my mom( my dad)?)?&#x2F;gi;</p>
<p>let arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; æ¯”å°åˆ°çš„èµ·å§‹ä½ç½®æ˜¯ 0<br>console.log(arr.input); &#x2F;&#x2F; æ¯”å°çš„åŸå§‹å­—ä¸² â€˜hello my mom my dadâ€™<br>console.log(arr[0]); &#x2F;&#x2F; æ¯”å°åˆ°çš„çµæœ â€˜hello my mom my dadâ€™<br>console.log(arr[1]); &#x2F;&#x2F; æœ€å¤–å±¤åˆ†çµ„ â€˜ my mom my dadâ€™<br>console.log(arr[2]); &#x2F;&#x2F; ç¬¬2å±¤åˆ†çµ„ â€˜ my dadâ€™</p>
<p>&#x2F;&#x2F; å‡å¦‚æ²’æœ‰ç”¨ g flag, patternåªæœƒå¾ç¬¬1å€‹é–‹å§‹<br>let text &#x3D; â€˜sad, bad, cad, dadâ€™;<br>let pattern &#x3D; &#x2F;.ad&#x2F;; &#x2F;&#x2F; å‰é¢æœ‰ä»»æ„å­—å…ƒ, æ¥è‘—ç”¨ad</p>
<p>let arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; æ¯”å°åˆ°çš„èµ·å§‹ä½ç½®æ˜¯ 0<br>console.log(arr[0]); &#x2F;&#x2F; æ¯”å°åˆ°çš„çµæœ â€˜sadâ€™<br>console.log(pattern.lastIndex); &#x2F;&#x2F; ä¸‹æ¬¡æ¯”å°ä»å¾ä½ç½® 0 é–‹å§‹</p>
<p>arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; æ¯”å°åˆ°çš„èµ·å§‹ä½ç½®é‚„æ˜¯ 0<br>console.log(arr[0]); &#x2F;&#x2F; æ¯”å°åˆ°çš„çµæœ â€˜sadâ€™<br>console.log(pattern.lastIndex); &#x2F;&#x2F; ä¸‹æ¬¡æ¯”å°ä»å¾ä½ç½® 0 é–‹å§‹</p>
<p>&#x2F;&#x2F; å‡å¦‚æœ‰ç”¨ g flag, patternä¸åªæ¯”å°åˆ°ç¬¬1å€‹å­—å°±åœ, ä¸‹æ¬¡ç¹¼çºŒå¾€å¾Œé¢æœå°‹<br>let text &#x3D; â€˜sad, bad, cad, dadâ€™;<br>let pattern &#x3D; &#x2F;.ad&#x2F;g; &#x2F;&#x2F; å‰é¢æœ‰ä»»æ„å­—å…ƒ, æ¥è‘—ç”¨ad</p>
<p>let arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; æ¯”å°åˆ°çš„èµ·å§‹ä½ç½®æ˜¯ 0<br>console.log(arr[0]); &#x2F;&#x2F; æ¯”å°åˆ°çš„çµæœ â€˜sadâ€™<br>console.log(pattern.lastIndex); &#x2F;&#x2F; ä¸‹æ¬¡æ¯”å°å¾ä½ç½® 3 é–‹å§‹</p>
<p>arr &#x3D; pattern.exec(text);<br>console.log(arr.index); &#x2F;&#x2F; æ¯”å°åˆ°çš„èµ·å§‹ä½ç½®æ˜¯ 5<br>console.log(arr[0]); &#x2F;&#x2F; æ¯”å°åˆ°çš„çµæœ â€˜badâ€™<br>console.log(pattern.lastIndex); &#x2F;&#x2F; ä¸‹æ¬¡æ¯”å°å¾ä½ç½® 8 é–‹å§‹</p>
<h5 id="1-2-3-RegExp-Constructor-Properties"><a href="#1-2-3-RegExp-Constructor-Properties" class="headerlink" title="1.2.3 RegExp Constructor Properties"></a>1.2.3 RegExp Constructor Properties</h5><ul>
<li>RegExpæœ‰äº›å±¬æ€§æ˜¯ç•¶å‰scopeå…±é€šçš„å±¬æ€§, æ¯å€‹RegExp ç‰©ä»¶æœƒå…±ç”¨é€™äº›å±¬æ€§</li>
<li>Constructor Propertiesä¸¦éæ‰€æœ‰ç€è¦½å™¨æœ‰å¯¦ä½œ</li>
<li>å¸¸è¦‹çš„Constructorå±¬æ€§æœ‰å®Œæ•´åå­—å’ŒçŸ­åå­—</li>
</ul>
<ol>
<li>input, çŸ­åå­—ç‚º $_ , ä»£è¡¨æœ€è¿‘è¢«æ¯”å°çš„å­—ä¸²</li>
<li>lastMatch, çŸ­åå­—ç‚º $&amp;, ä»£è¡¨æœ€è¿‘æ¯”å°æˆåŠŸçš„å­—ä¸²</li>
<li>lastParen, çŸ­åå­—ç‚º $+, ä»£è¡¨æœ€è¿‘æ¯”å°çš„capturing group</li>
<li>leftContext, çŸ­åå­—ç‚º $`, æ–¼inputçš„lastMatchä¹‹å‰çš„å­—ä¸²</li>
<li>rightContext, çŸ­åå­—ç‚º $â€™, æ–¼inputçš„lastMatchä¹‹å¾Œçš„å­—ä¸²Â </li>
<li>ç”¨$1ã€$2â€¦åˆ°$9, ä¹Ÿèƒ½é¡¯ç¤ºæœ€è¿‘æ¯”å°çš„capturing group, æœ€å¤šèƒ½å–9å€‹</li>
</ol>
<p>let text &#x3D; â€˜choose character: captain teemo on dutyâ€™;<br>let pattern &#x3D; &#x2F;(.)aptain&#x2F;g;</p>
<p>if(pattern.test(text)){<br>   console.log(RegExp.input); &#x2F;&#x2F; è¼¸å‡º â€˜choose character: captain teemo on dutyâ€™<br>   console.log(RegExp.$_); &#x2F;&#x2F; è¼¸å‡º â€˜choose character: captain teemo on dutyâ€™</p>
<p>   console.log(RegExp.leftContext); &#x2F;&#x2F; è¼¸å‡º â€˜choose character: â€˜<br>   console.log(RegExp[â€œ$`â€œ]); &#x2F;&#x2F; è¼¸å‡º â€˜choose character: â€˜</p>
<p>   console.log(RegExp.rightContext); &#x2F;&#x2F; è¼¸å‡º â€˜ teemo on dutyâ€™<br>   console.log(RegExp[â€œ$â€™â€]); &#x2F;&#x2F; è¼¸å‡º â€˜ teemo on dutyâ€™</p>
<p>   console.log(RegExp.lastMatch); &#x2F;&#x2F; è¼¸å‡º â€˜captainâ€™<br>   console.log(RegExp[â€œ$&amp;â€]); &#x2F;&#x2F; è¼¸å‡º â€˜captainâ€™</p>
<p>   console.log(RegExp.lastParen); &#x2F;&#x2F; è¼¸å‡º â€˜câ€™<br>   console.log(RegExp[â€œ$+â€]); &#x2F;&#x2F; è¼¸å‡º â€˜câ€™<br>   console.log(RegExp.$1); &#x2F;&#x2F; è¼¸å‡º â€˜câ€™<br>}</p>
<h5 id="1-2-4-Pattern-Limitations"><a href="#1-2-4-Pattern-Limitations" class="headerlink" title="1.2.4 Pattern Limitations"></a>1.2.4 Pattern Limitations</h5><ul>
<li>ECMAScriptä¸¦éå®Œæ•´æ”¯æ´Regular Expression</li>
<li>ä¸æ”¯æ´çš„åŠŸèƒ½æœ‰</li>
</ul>
<ol>
<li>é–‹å§‹å’Œçµå°¾Aå’ŒZ anchor</li>
<li>å¾€å¾Œå°‹æ‰¾ lookbehind</li>
<li>union å’Œ intersection é¡</li>
<li>atomic grouping</li>
<li>unicode</li>
<li>æœ‰å‘½åçš„capturing group</li>
<li>å–®è¡Œs å’Œ ç„¡é–“éš”x çš„match æ¨¡å¼</li>
<li>æ¢ä»¶å¼</li>
<li>comments</li>
</ol>
<h4 id="1-3-Primitive-Wrapper-Types"><a href="#1-3-Primitive-Wrapper-Types" class="headerlink" title="1.3 Primitive Wrapper Types"></a>1.3 Primitive Wrapper Types</h4><ul>
<li>æœ‰String, Booleanå’ŒNumber, å¯ä»¥ç”¨ new çš„æ–¹å¼å»ºç«‹objectåŒ…è£çš„ç‰©ä»¶</li>
<li>åªè¦è®€å–é€™3ç¨®Primitive, JSèƒŒå¾Œæœƒè‡ªå‹•å»ºç«‹Wrapper Object, è®“æˆ‘å€‘èƒ½å‘¼å«ä¸€äº›æ–¹æ³•</li>
<li>ä½¿ç”¨è‡ªå‹•Wrapper Object, è¢«å‹•æ…‹æŒ‡å®šçš„å±¬æ€§éƒ½æœƒç«‹å³éŠ·æ¯€</li>
</ul>
<p>let text &#x3D; â€˜hello worldâ€™;<br>let text2 &#x3D; text.substring(3); &#x2F;&#x2F; é€™èƒŒå¾Œä½¿ç”¨Wrapper Object, æ‰èƒ½è®“æˆ‘å€‘æœ‰å‡½å¼å¯ç”¨</p>
<p>text.myWord &#x3D; â€˜not workâ€™;<br>console.log(text.myWord); &#x2F;&#x2F; å·²ç¶“è¢«éŠ·æ¯€, æ‰€ä»¥è¼¸å‡º undefined</p>
<h5 id="1-3-1-Boolean-Type"><a href="#1-3-1-Boolean-Type" class="headerlink" title="1.3.1 Boolean Type"></a>1.3.1 Boolean Type</h5><ul>
<li>å»ºè­°ä¸è¦ç”¨new Booleanç‰©ä»¶, å®¹æ˜“æœ‰èª¤è§£</li>
</ul>
<p>let v1 &#x3D; new Boolean(false);<br>let result &#x3D; v1 &amp;&amp; true;<br>console.log(result); &#x2F;&#x2F; è¼¸å‡ºtrue, å› ç‚ºv1 æ˜¯ object, ä¸¦éBooleanå€¼</p>
<h5 id="1-3-2-Number-Type"><a href="#1-3-2-Number-Type" class="headerlink" title="1.3.2 Number Type"></a>1.3.2 Number Type</h5><ul>
<li>å¸¸è¦‹æ•¸å­—æ ¼å¼åŒ–çš„æ–¹æ³• toFixed(æ•¸å­—)ã€toExponential(æ•¸å­—)ã€toPrecision(æ•¸å­—), æœ‰äº›ç€è¦½å™¨å¯¦ä½œçš„ç¯„åœä¸ä¸€æ¨£</li>
<li>å’ŒBooleanä¸€æ¨£, ä¹Ÿä¸å»ºè­°ç”¨new Numberç‰©ä»¶</li>
<li>åœ¨ES6å°å…¥Number.isInteger()æ–¹æ³•åˆ¤æ–·æ˜¯å¦æ•´æ•¸ã€Number.isSafeInteger()åˆ¤æ–·æ˜¯å¦ç‚ºæ•´æ•¸ä¸”åœ¨Number.MAX_SAFE_INTEGERèˆ‡ Number.MIN_SAFE_INTEGERç¯„åœä¹‹é–“</li>
</ul>
<p>Â </p>
<h5 id="1-3-3-String-Type"><a href="#1-3-3-String-Type" class="headerlink" title="1.3.3 String Type"></a>1.3.3 String Type</h5><h6 id="1-3-3-1-The-JavaScript-Character"><a href="#1-3-3-1-The-JavaScript-Character" class="headerlink" title="1.3.3.1 The JavaScript Character"></a>1.3.3.1 The JavaScript Character</h6><ul>
<li>æ¯å€‹å­—å…ƒä½¿ç”¨16bitå„²å­˜</li>
<li>JSçš„å­—ä¸²æœƒåˆ¤æ–·2ç¨®Unicodeç·¨ç¢¼:Â UCS-2 å’Œ UTF-16 , éƒ½æ˜¯16bit</li>
<li>å¯ç”¨charCodeAt(ä½ç½®)é¡¯ç¤ºè©²å­—å…ƒçš„ç·¨ç¢¼æ•´æ•¸</li>
<li>å¯ç”¨fromCharCode(ç·¨ç¢¼æ•´æ•¸1, ç·¨ç¢¼æ•´æ•¸2, â€¦.)çµ„æˆUTF-16è¡¨ç¤ºçš„å­—ä¸², ç·¨ç¢¼ç¯„åœæ˜¯å¾U+0000 åˆ° U+FFFF, ä¹Ÿç¨±ä¹‹ç‚º Basic Multilingual PlaneÂ æ¶µè“‹ç¯„åœÂ </li>
<li>æœ‰çš„ç‰¹æ®Šç¬¦è™Ÿè¶…éU+FFFFç¯„åœ, æœƒè®Šæˆä½”2å€‹16bit, lengthå’ŒcharAtç­‰æœƒå–åˆ°ç•°ä½çš„å€¼,Â </li>
<li>åœ¨U+10000åˆ°U+1FFFDç¯„åœç¨±ä¹‹ Supplementary Multilingual Plane,</li>
</ul>
<p>let text1 &#x3D; â€˜å¤§å®¶å¥½â€™;<br>console.log(text1.charCodeAt(1)); &#x2F;&#x2F; è¼¸å‡º 23478</p>
<p>let text2 &#x3D; String.fromCharCode(0x7a0b, 0x5f0f, 0x8a2d, 0x8a08);<br>console.log(text2); &#x2F;&#x2F; è¼¸å‡º ç¨‹å¼è¨­è¨ˆ</p>
<p>let text3 &#x3D; â€˜ğŸ˜­â€™; &#x2F;&#x2F; ç”¨å“­è‡‰ç¬¦è™Ÿä½œç¯„ä¾‹, å®ƒç”¨UTF-16ç‚º 0xD83D 0xDE2D<br>console.log(text3.length); &#x2F;&#x2F; ä½”äº†2å€‹16 bit, æ‰€ä»¥lengthç‚º2<br>console.log(text3.charAt(0)); &#x2F;&#x2F; è¼¸å‡ºç„¡æ³•è­˜åˆ¥çš„ç·¨ç¢¼ ï¿½<br>console.log(text3.charAt(1)); &#x2F;&#x2F; è¼¸å‡ºç„¡æ³•è­˜åˆ¥çš„ç·¨ç¢¼ ï¿½</p>
<p>console.log(text3.charCodeAt(0)); &#x2F;&#x2F; è¼¸å‡ºç¬¬1å€‹16bit 55357 &#x3D; 0xD83D<br>console.log(text3.charCodeAt(1)); &#x2F;&#x2F; è¼¸å‡ºç¬¬2å€‹16bit 36877 &#x3D; 0xDE2D</p>
<h6 id="1-3-3-2-The-normalize-method"><a href="#1-3-3-2-The-normalize-method" class="headerlink" title="1.3.3.2 The normalize() method"></a>1.3.3.2 The normalize() method</h6><ul>
<li>Unicodeæœ‰äº›å­—æ˜¯åŒæ¨£çš„, ä½†å‡ºç¾åœ¨ä¸åŒçš„ç·¨ç¢¼, è€Œä¸åŒç·¨ç¢¼çš„å­—ç”¨ &#x3D;&#x3D; æ¯”å°å¿…ç‚ºfalse</li>
<li>ä¾ç…§<a target="_blank" rel="noopener" href="http://www.unicode.org/reports/tr15/">http://www.unicode.org/reports/tr15/</a>Â , å…±å€åˆ†4ç¨®Normalization Form: Cã€Dã€KCã€KD</li>
<li>normalizationçš„è¦å‰‡, å¾ˆåƒè±¡å½¢ç¬¦è™Ÿçš„çµ„åˆ</li>
</ul>
<p>&#x2F;&#x2F; ç¬¦è™Ÿ á¸‰ çš„åŸå§‹Unicode-16 æ˜¯0x1E09, ä¹Ÿèƒ½å¾å¦å¤–2ç¨®ç·¨ç¢¼å–å¾—</p>
<p>let c1 &#x3D; String.fromCharCode(0x1E09),<br> c2 &#x3D; String.fromCharCode(0x00E7, 0x0301),<br>c3 &#x3D; String.fromCharCode(0x0063, 0x0327, 0x0301);<br>console.log(c1); &#x2F;&#x2F; è¼¸å‡º á¸‰<br>console.log(c2); &#x2F;&#x2F; è¼¸å‡º á¸‰<br>console.log(c3); &#x2F;&#x2F; è¼¸å‡º á¸‰</p>
<p>console.log(c1 &#x3D;&#x3D;&#x3D; c2); &#x2F;&#x2F; è¼¸å‡º false<br>console.log(c2 &#x3D;&#x3D;&#x3D; c3); &#x2F;&#x2F; è¼¸å‡º false<br>console.log(c3 &#x3D;&#x3D;&#x3D; c1); &#x2F;&#x2F; è¼¸å‡º false</p>
<p>&#x2F;&#x2F; U+1E09 å·²ç¶“æ˜¯ 0x00E7&#x2F;0x0301 çš„ NFC&#x2F;NFKCçš„normalization, æ‰€ä»¥æ¯”å°ä»ç›¸ç­‰<br>console.log(c1 &#x3D;&#x3D;&#x3D; c1.normalize(â€œNFDâ€)); &#x2F;&#x2F; false<br>console.log(c1 &#x3D;&#x3D;&#x3D; c1.normalize(â€œNFCâ€)); &#x2F;&#x2F; true<br>console.log(c1 &#x3D;&#x3D;&#x3D; c1.normalize(â€œNFKDâ€)); &#x2F;&#x2F; false<br>console.log(c1 &#x3D;&#x3D;&#x3D; c1.normalize(â€œNFKCâ€)); &#x2F;&#x2F; true</p>
<p>&#x2F;&#x2F; U+00E7&#x2F;U+0301 å°šæœªnormalization, æ‰€ä»¥æ¯”å°éƒ½ä¸ç›¸ç­‰<br>console.log(c2 &#x3D;&#x3D;&#x3D; c2.normalize(â€œNFDâ€)); &#x2F;&#x2F; false<br>console.log(c2 &#x3D;&#x3D;&#x3D; c2.normalize(â€œNFCâ€)); &#x2F;&#x2F; false<br>console.log(c2 &#x3D;&#x3D;&#x3D; c2.normalize(â€œNFKDâ€)); &#x2F;&#x2F; false<br>console.log(c2 &#x3D;&#x3D;&#x3D; c2.normalize(â€œNFKCâ€)); &#x2F;&#x2F; false</p>
<p>&#x2F;&#x2F; U+0063&#x2F;U+0327&#x2F;U+0301 å·²ç¶“æ˜¯ 0x00E7&#x2F;0x0301 çš„ NFD&#x2F;NFKDçš„normalization, æ‰€ä»¥æ¯”å°ä»ç›¸ç­‰<br>console.log(c3 &#x3D;&#x3D;&#x3D; c3.normalize(â€œNFDâ€)); &#x2F;&#x2F; true<br>console.log(c3 &#x3D;&#x3D;&#x3D; c3.normalize(â€œNFCâ€)); &#x2F;&#x2F; false<br>console.log(c3 &#x3D;&#x3D;&#x3D; c3.normalize(â€œNFKDâ€)); &#x2F;&#x2F; true<br>console.log(c3 &#x3D;&#x3D;&#x3D; c3.normalize(â€œNFKCâ€)); &#x2F;&#x2F; false</p>
<h6 id="1-3-3-3-String-Manipulation-Methods"><a href="#1-3-3-3-String-Manipulation-Methods" class="headerlink" title="1.3.3.3 String-Manipulation Methods"></a>1.3.3.3 String-Manipulation Methods</h6><ul>
<li>concatå¯ä¸²æ¥å¤šå€‹å­—ä¸², ä½†å¸¸ç”¨ + é‹ç®—ç¬¦è™Ÿ</li>
<li>slice(), substring()å’Œ substr()éƒ½å¯ä»¥å›å‚³å­å­—ä¸², ä½†ç”¨æ³•æœ‰äº›ä¸åŒ, å¯åƒè€ƒ<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/substring">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects&#x2F;String&#x2F;substring</a></li>
</ul>
<h6 id="1-3-3-4-String-Location-Methods"><a href="#1-3-3-4-String-Location-Methods" class="headerlink" title="1.3.3.4 String Location Methods"></a>1.3.3.4 String Location Methods</h6><ul>
<li>indexOf()å’ŒlastIndexOf()å¯æ‰¾å­—ä¸²çš„èµ·å§‹ä½ç½®, å‰è€…å¾å‰é¢æ‰¾, å¾Œè€…å¾å¾Œé¢æ‰¾, æ²’æ‰¾åˆ°å›å‚³-1</li>
<li>éƒ½å¯ä»¥ä»£ç¬¬2å€‹åƒæ•¸, é–‹å§‹å°‹æ‰¾çš„ä½ç½®.</li>
</ul>
<h6 id="1-3-3-5-String-Inclusion-Methods"><a href="#1-3-3-5-String-Inclusion-Methods" class="headerlink" title="1.3.3.5 String Inclusion Methods"></a>1.3.3.5 String Inclusion Methods</h6><ul>
<li>ES6å°å…¥çš„åŠŸèƒ½, åˆ†åˆ¥æ˜¯startWith(), endWith(), includes(), ä»£è¡¨å¾é–‹é ­ã€çµå°¾å’Œä¸­é–“æ˜¯å¦æœ‰å­˜åœ¨æŸå­—ä¸², è‹¥ç¬¦åˆå›å‚³true, å¦å‰‡ç‚ºfalse.</li>
<li>startWith()å’Œincludes()å¯ä»¥ä»£ç¬¬2å€‹åƒæ•¸, é–‹å§‹å°‹æ‰¾çš„ä½ç½®.</li>
</ul>
<h6 id="1-3-3-6-The-trim-Method"><a href="#1-3-3-6-The-trim-Method" class="headerlink" title="1.3.3.6 The trim() Method"></a>1.3.3.6 The trim() Method</h6><ul>
<li>trim()æœƒåˆªé™¤å‰å¾Œæœ‰ç©ºç™½çš„å­—ä¸²</li>
<li>trimLeft()å’ŒtrimRight()å‰‡åªåˆªé™¤æœ€å‰&#x2F;æœ€å¾Œçš„ç©ºç™½å­—ä¸²</li>
</ul>
<h6 id="1-3-3-7-The-repeat-Method"><a href="#1-3-3-7-The-repeat-Method" class="headerlink" title="1.3.3.7 The repeat() Method"></a>1.3.3.7 The repeat() Method</h6><ul>
<li>å¯ä»£å…¥æ•¸å­—, ä»£è¡¨è¦é‡è¤‡å­—ä¸²çš„æ¬¡æ•¸</li>
</ul>
<h6 id="1-3-3-8-The-padStart-and-padEnd-Method"><a href="#1-3-3-8-The-padStart-and-padEnd-Method" class="headerlink" title="1.3.3.8 The padStart() and padEnd() Method"></a>1.3.3.8 The padStart() and padEnd() Method</h6><ul>
<li>æœ‰2å€‹åƒæ•¸, è‹¥åªä»£ç¬¬1å€‹åƒæ•¸æ•¸å­—, ä»£è¡¨è¦æ“´å……æˆé•·åº¦ç‚ºnçš„å­—ä¸², é è¨­è£œä¸Šç©ºç™½</li>
<li>ç¬¬2å€‹åƒæ•¸æ˜¯è¦æ“´å……çš„å­—ä¸²</li>
</ul>
<h6 id="1-3-3-9-String-Iterators-and-Destructuring"><a href="#1-3-3-9-String-Iterators-and-Destructuring" class="headerlink" title="1.3.3.9 String Iterators and Destructuring"></a>1.3.3.9 String Iterators and Destructuring</h6><ul>
<li>stringæœ‰iterator, å¯ä»¥æ­·éæ¯å€‹å­—å…ƒ</li>
<li>åŸºæ–¼iterator, å¯ä»¥ç”¨for â€¦ ofçš„æ–¹å¼å–æ¯å€‹å­—å…ƒ</li>
<li>ç”¨[â€¦æŸå­—ä¸²]å¯ä»¥æ‹†æˆå­—å…ƒé™£åˆ—(Destructuring)</li>
</ul>
<p>let text1 &#x3D; â€˜helloâ€™;<br>let stringIterator &#x3D; text1[Symbol.iterator]();<br>console.log(stringIterator.next()); &#x2F;&#x2F; è¼¸å‡º {value: â€˜hâ€™, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; è¼¸å‡º {value: â€˜eâ€™, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; è¼¸å‡º {value: â€˜lâ€™, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; è¼¸å‡º {value: â€˜lâ€™, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; è¼¸å‡º {value: â€˜oâ€™, done: false}<br>console.log(stringIterator.next()); &#x2F;&#x2F; è¼¸å‡º {value: undefined, done: true}</p>
<p>for(const c of text1){<br>console.log(c); &#x2F;&#x2F; ä¾åºè¼¸å‡º h e l l o<br>}</p>
<p>console.log([â€¦text1]); &#x2F;&#x2F; è¼¸å‡º [â€˜hâ€™, â€˜eâ€™, â€˜lâ€™, â€˜lâ€™, â€˜oâ€™]</p>
<h6 id="1-3-3-10-String-Case-Methods"><a href="#1-3-3-10-String-Case-Methods" class="headerlink" title="1.3.3.10 String Case Methods"></a>1.3.3.10 String Case Methods</h6><ul>
<li>é™¤äº†toLowerCase(), toUpperCase()è½‰æ›å¤§å°å¯«, é‚„æœ‰toLocaleLowerCase(), toLocaleUpperCase()èƒ½æŒ‡å®šç‰¹å®šåœ°å€çš„å¤§å°å¯«, æ¯”å¦‚åœŸè€³å…¶èª.</li>
<li>ä¸ç¢ºå®šè¦åŸ·è¡Œçš„ç’°å¢ƒ, ç›´æ¥ç”¨localeçš„æ–¹æ³•åšå¤§å°å¯«è½‰æ›</li>
</ul>
<h6 id="1-3-3-11-String-Pattern-Matching-Methods"><a href="#1-3-3-11-String-Pattern-Matching-Methods" class="headerlink" title="1.3.3.11 String Pattern-Matching Methods"></a>1.3.3.11 String Pattern-Matching Methods</h6><ul>
<li>é€™äº›patternæ–¹æ³•éƒ½æ”¯æ´RegExpç‰©ä»¶</li>
<li>ç”¨å­—ä¸²çš„match(pattern)ç­‰åŒRegExpçš„exec(pattern)</li>
<li>search(pattern)æ˜¯å¾å­—ä¸²çš„é ­å¾€å¾Œæœå°‹æœ‰æ¯”å°åˆ°patternç¬¬1å€‹å‡ºç¾ä½ç½®, è‹¥æ²’æ¯”å°åˆ°å‰‡å›å‚³-1. å’ŒindexOfå·®ç•°æ˜¯èƒ½ç”¨RegExp</li>
<li>replace(pattern, è¦æ›¿æ›çš„å–®å­—)èƒ½æ‰¾åˆ°patternç¬¦åˆçš„å­—ä¸¦æ›¿æ›æ‰. å…¶ä¸­è¦æ›¿æ›çš„å–®å­—èƒ½ç”¨ç‰¹æ®Šçš„å­—ä¸², æ¯”å¦‚ç”¨$1å¯ä»¥æŠŠcaptured groupå›å¡«</li>
<li>replace(pattern, someFunction), å¯ä»¥ç”¨æŸå€‹functionä¾†åšæ›¿æ›çš„é‚è¼¯</li>
</ul>
<p>let text &#x3D; â€˜sad, bad, cad, dadâ€™;<br>let result &#x3D; text.replace(&#x2F;(.ad)&#x2F;g, â€˜myWord ($1)â€™);<br>console.log(result); &#x2F;&#x2F; è¼¸å‡º myWord (sad), myWord (bad), myWord (cad), myWord (dad)</p>
<p>let text2 &#x3D; â€˜I am a boy, my dog is tall. So what is your name?â€™;<br>function replaceArticle(text){<br>return text.replace(&#x2F;[,.?]&#x2F;g, function(match, pos, originalText){<br> switch(match){<br> case â€˜,â€™:<br> return â€˜!â€™;<br> case â€˜.â€™:<br> return â€˜*â€˜;<br> case â€˜?â€™:<br> return â€˜#â€™;<br> }<br> });<br>}<br>console.log(replaceArticle(text2)); &#x2F;&#x2F; è¼¸å‡º I am a boy! my dog is tall* So what is your name#</p>
<ul>
<li>splitä¹Ÿèƒ½æ”¯æ´RegExp patternåšåˆ‡å‰²å­—ä¸²æˆé™£åˆ—, ç¬¬2å€‹åƒæ•¸æ˜¯åˆ‡å‰²å¾Œé™£åˆ—çš„æœ€å¤§Size</li>
</ul>
<h6 id="1-3-3-12-The-localeCompare-Method"><a href="#1-3-3-12-The-localeCompare-Method" class="headerlink" title="1.3.3.12 The localeCompare() Method"></a>1.3.3.12 The localeCompare() Method</h6><ul>
<li>åšå­—ä¸²çš„å­—å…¸æ’åºæ¯”å°, å°çš„å›å‚³ -1ã€ç›¸ç­‰å›å‚³0ã€å¤§çš„å›å‚³1</li>
<li>æ”¯æ´localeä»£è¡¨å¤§å°å¯«æœ‰å·®ç•°</li>
</ul>
<h6 id="1-3-3-13-HTML-Methods"><a href="#1-3-3-13-HTML-Methods" class="headerlink" title="1.3.3.13 HTML Methods"></a>1.3.3.13 HTML Methods</h6><ul>
<li>å­—ä¸²æœ‰HTMLç›¸é—œçš„æ–¹æ³•, ç”¢ç”ŸHTMLå­—ä¸², æ¯”å¦‚anchor, big, linkç­‰</li>
</ul>
<p>let text &#x3D; â€˜Hello Worldâ€™;<br>console.log(text.anchor(â€˜testâ€™)); &#x2F;&#x2F; è¼¸å‡º <a name="test">Hello World</a><br>console.log(text.big()); &#x2F;&#x2F; è¼¸å‡º <big>Hello World</big><br>console.log(text.link(â€˜<a target="_blank" rel="noopener" href="http://www.example.com/">http://www.example.com</a>â€˜)); &#x2F;&#x2F; è¼¸å‡º <a target="_blank" rel="noopener" href="http://www.example.com">Hello World</a></p>
<h4 id="1-4-Singleton-Built-in-Objects"><a href="#1-4-Singleton-Built-in-Objects" class="headerlink" title="1.4 Singleton Built-in Objects"></a>1.4 Singleton Built-in Objects</h4><ul>
<li>ä¸ä¾è³´host environmentçš„ç‰©ä»¶, ä¸”åœ¨JSç¨‹å¼åŸ·è¡Œå‰å·²åˆå§‹åŒ–.</li>
<li>åŒ…å«Globalå’ŒMath 2ç¨®.</li>
</ul>
<h5 id="1-4-1-The-Global-Object"><a href="#1-4-1-The-Global-Object" class="headerlink" title="1.4.1 The Global Object"></a>1.4.1 The Global Object</h5><ul>
<li>ä¸å±¬æ–¼ç‰¹å®šç‰©ä»¶çš„å±¬æ€§å’Œæ–¹æ³•, é‚£å°±æœƒæ˜¯Globalçš„å±¬æ€§å’Œæ–¹æ³•.</li>
<li>æ¯”å¦‚parseInt(), isNaN()ç­‰, éƒ½æ˜¯Globalçš„æ–¹æ³•</li>
</ul>
<h6 id="1-4-1-1-URI-Encoding-Methods"><a href="#1-4-1-1-URI-Encoding-Methods" class="headerlink" title="1.4.1.1Â URI-Encoding Methods"></a>1.4.1.1Â URI-Encoding Methods</h6><ul>
<li>encodeURI()å’ŒencodeURIComponent()å¯å°URIåšç·¨ç¢¼, å°‡ä¸€äº›ä¸ç¬¦åˆURIçš„å­—å…ƒåšUTF-8ç·¨ç¢¼</li>
<li>encodeURIåªå°éƒ¨åˆ†å­—å…ƒç·¨ç¢¼ã€encodeURIComponent()å…¨éƒ¨å­—å…ƒéƒ½ç·¨ç¢¼</li>
<li>å¯¦å‹™ä¸Šå¸¸ç”¨encodeURIComponentå°query stringåšç·¨ç¢¼</li>
</ul>
<p>let text &#x3D; â€˜<a target="_blank" rel="noopener" href="https://www.example.com/special%20and%20words/#mobile-devices">https://www.example.com/special%20and%20words/#mobile-devices</a>â€˜;<br>console.log(encodeURI(text)); &#x2F;&#x2F; è¼¸å‡º <a target="_blank" rel="noopener" href="https://www.example.com/special%2520and%2520words/#mobile-devices">https://www.example.com/special%2520and%2520words/#mobile-devices</a><br>console.log(encodeURIComponent(text)); &#x2F;&#x2F; è¼¸å‡º https%3A%2F%2F<a href="http://www.example.com%2Fspecial%2520and%2520words%2F%23mobile-devices">www.example.com%2Fspecial%2520and%2520words%2F%23mobile-devices</a></p>
<ul>
<li>å°æ‡‰è§£ç¢¼çš„æ–¹æ³•ç‚ºdecodeURI()å’ŒdecodeURIComponent()</li>
<li>encodeURI&#x2F;decodeURIç­‰å·²å–ä»£èˆŠç‰ˆçš„escape&#x2F;unescape</li>
</ul>
<h6 id="1-4-1-2-The-eval-Method"><a href="#1-4-1-2-The-eval-Method" class="headerlink" title="1.4.1.2Â The eval() Method"></a>1.4.1.2Â The eval() Method</h6><ul>
<li>eval()å¯ä»¥å°‡ESèªæ³•åšç›´è­¯, ä¸¦ä¸”è£¡é¢çš„è®Šæ•¸ã€å‡½å¼ç­‰éƒ½å¯æ˜¯åŒå€‹Scope</li>
</ul>
<p>eval(â€œconsole.log(â€˜helloâ€™)â€); &#x2F;&#x2F; è¼¸å‡ºhello</p>
<p>let myWord &#x3D; â€˜Testingâ€™;<br>eval(â€œconsole.log(myWord)â€); &#x2F;&#x2F; è¼¸å‡ºmyWord</p>
<p>eval(â€œfunction sayHi() { console.log(â€˜hiiiiâ€™); }â€);<br>sayHi(); &#x2F;&#x2F; è¼¸å‡º hiiii</p>
<ul>
<li>åœ¨strict modeç’°å¢ƒ, åœ¨evalå®£å‘Šçš„è®Šæ•¸ã€å‡½å¼éƒ½ä¸èƒ½è¢«å¤–éƒ¨ç”¨, ä¸”evalä¸èƒ½è¢«æŒ‡å®šç‚ºè®Šæ•¸</li>
<li>å°å¿ƒä½¿ç”¨eval(), ä»¥å… XSS æ”»æ“Š</li>
</ul>
<h6 id="1-4-1-3-Global-Object-Properties"><a href="#1-4-1-3-Global-Object-Properties" class="headerlink" title="1.4.1.3Â Global Object Properties"></a>1.4.1.3Â Global Object Properties</h6><ul>
<li>ç›®å‰æœ‰é€™äº›properties:</li>
</ul>
<ol>
<li>undefined</li>
<li>NaN</li>
<li>Infinity</li>
<li>Object</li>
<li>Array</li>
<li>Function</li>
<li>Boolean</li>
<li>String</li>
<li>Number</li>
<li>Date</li>
<li>RegExp</li>
<li>Symbol</li>
<li>Error</li>
<li>EvalError</li>
<li>RangeError</li>
<li>ReferenceError</li>
<li>SyntaxError</li>
<li>TypeError</li>
<li>URIError</li>
</ol>
<h6 id="1-4-1-4-The-Window-Object"><a href="#1-4-1-4-The-Window-Object" class="headerlink" title="1.4.1.4Â The Window Object"></a>1.4.1.4Â The Window Object</h6><ul>
<li>ESç„¡è¦ç¯„å¦‚ä½•ç›´æ¥å­˜å–Global Object, ä½†Webçš„å…¨åŸŸè®Šæ•¸å’Œæ–¹æ³•, éƒ½å¯å­˜å–windowç‰©ä»¶å–å¾—.</li>
<li>å¯ç”¨return thiså–å¾—Global object</li>
</ul>
<p>var text &#x3D; â€˜Hello Worldâ€™; &#x2F;&#x2F; è¦ç”¨var, æ‰æœƒæŒ‡å®šåˆ°windowç‰©ä»¶</p>
<p>function sayHello(){<br>console.log(window.text); &#x2F;&#x2F; textå·²åœ¨windowç‰©ä»¶<br>}</p>
<p>window.sayHello(); &#x2F;&#x2F; sayHelloå·²åœ¨windowç‰©ä»¶, è¼¸å‡º Hello World</p>
<p>&#x2F;&#x2F; thisèƒ½ä»£è¡¨global, åœ¨debug consoleèƒ½çœ‹è¦‹globalè®Šæ•¸æœ‰è¨±å¤šç€è¦½å™¨ç›¸é—œçš„è®Šæ•¸å’Œå‡½æ•¸<br>let global &#x3D; function(){<br>return this;<br>}();</p>
<h5 id="1-4-2-The-Math-Object"><a href="#1-4-2-The-Math-Object" class="headerlink" title="1.4.2 The Math Object"></a>1.4.2 The Math Object</h5><ul>
<li>æä¾›è¨ˆç®—ç›¸é—œçš„å¸¸æ•¸å’Œå‡½å¼</li>
<li>Mathæä¾›çš„å‡½å¼æœƒæ¯”è‡ªå·±å¯«çš„å‡½å¼é‚„è¦æœ‰æ•ˆç‡, ä½†å› ç€è¦½å™¨ã€ä½œæ¥­ç³»çµ±ç­‰ç’°å¢ƒ, ç²¾æº–åº¦æœƒæœ‰å·®ç•°</li>
</ul>
<h6 id="1-4-2-1-Math-Object-Properties"><a href="#1-4-2-1-Math-Object-Properties" class="headerlink" title="1.4.2.1Â Math Object Properties"></a>1.4.2.1Â Math Object Properties</h6><ul>
<li>å¸¸è¦‹çš„å¸¸æ•¸</li>
<li>Math.E</li>
<li>Math.LN10</li>
<li>Math.LN2</li>
<li>Math.LOG2E</li>
<li>Math.LOG10E</li>
<li>Math.PI</li>
<li>Math.SQRT1_2</li>
<li>Math.SQRT2</li>
</ul>
<h6 id="1-4-2-2-The-min-and-max-Methods"><a href="#1-4-2-2-The-min-and-max-Methods" class="headerlink" title="1.4.2.2Â The min() and max() Methods"></a>1.4.2.2Â The min() and max() Methods</h6><ul>
<li>å›å‚³ä¸€çµ„æ•¸å­—è£¡æœ€å°&#x2F;æœ€å¤§å€¼</li>
<li>å¦‚æœæ˜¯array, è¦ç”¨apply, ç¬¬1å€‹åƒæ•¸ä»£å…¥Math, ç¬¬2å€‹åƒæ•¸å¸¶å…¥é™£åˆ—</li>
</ul>
<p>console.log(Math.min(1, 2, 3)); &#x2F;&#x2F; è¼¸å‡º 1<br>console.log(Math.max.apply(Math, [4, 5, 6])); &#x2F;&#x2F; è¼¸å‡º 6</p>
<h6 id="1-4-2-3-Rounding-Methods"><a href="#1-4-2-3-Rounding-Methods" class="headerlink" title="1.4.2.3 RoundingÂ Methods"></a>1.4.2.3 RoundingÂ Methods</h6><ul>
<li>Roundingçš„ä¸­æ–‡æ˜¯æ¨å…¥, Mathæœ‰4ç¨®æ¨å…¥å‡½å¼</li>
</ul>
<ol>
<li>Math.ceil(): å›å‚³ceiling functionçš„æ•´æ•¸çµæœ</li>
<li>Math.floor(): å›å‚³floor functionçš„æ•´æ•¸çµæœ</li>
<li>Math.round(): å››æ¨äº”å…¥çš„å‡½å¼, å°æ•¸é» &gt;&#x3D; 0.5 å‰‡é€²ä½</li>
<li>Math.fround(): å°‡æµ®é»æ•¸è½‰æ›æˆæœ€æ¥è¿‘çš„single precision 32 bitè¡¨ç¤º. å¯ä»¥åƒè€ƒæ­¤ç¶²ç«™åšé©—è­‰ <a target="_blank" rel="noopener" href="https://www.exploringbinary.com/floating-point-converter/">https://www.exploringbinary.com/floating-point-converter/</a></li>
</ol>
<p>console.log(Math.ceil(11.6)); &#x2F;&#x2F; è¼¸å‡º 12<br>console.log(Math.ceil(11.1)); &#x2F;&#x2F; è¼¸å‡º 12</p>
<p>console.log(Math.floor(11.6)); &#x2F;&#x2F; è¼¸å‡º 11<br>console.log(Math.floor(11.1)); &#x2F;&#x2F; è¼¸å‡º 11</p>
<p>console.log(Math.round(11.6)); &#x2F;&#x2F; è¼¸å‡º 12<br>console.log(Math.round(11.1)); &#x2F;&#x2F; è¼¸å‡º 11</p>
<p>console.log(Math.fround(0.4)); &#x2F;&#x2F; JSçš„æµ®é»æ•¸éƒ½æ˜¯64-bit, å¯¦éš›ä¸Š0.4æ˜¯0.40000000000000002220446049250313080847263336181640625, è½‰æˆ32-bitæ˜¯ 0.4000000059604644775390625<br>console.log(Math.fround(0.5)); &#x2F;&#x2F; è¼¸å‡º 0.5</p>
<h6 id="1-4-2-4-The-random-Method"><a href="#1-4-2-4-The-random-Method" class="headerlink" title="1.4.2.4 The random()Â Method"></a>1.4.2.4 The random()Â Method</h6><ul>
<li>Math.random()æœƒå›å‚³ 0~1ä¹‹é–“çš„æ•¸å­—, ä½†ä¸åŒ…å«0èˆ‡1</li>
<li>å¯¦ç”¨çš„æ–¹å¼æ˜¯å¯ä»¥å¾æŸlowerValue ~ upperValueè£¡éš¨æ©ŸæŒ‘1å€‹æ•´æ•¸, å»¶ä¼¸çš„ç”¨æ³•æ˜¯éš¨æ©ŸæŒ‘é¸é™£åˆ—è£¡çš„å€¼</li>
<li>å¯†ç¢¼å­¸ç”¢ç”Ÿéš¨æ©Ÿæ•¸å­—å»ºè­°ç”¨window.crypto.getRandomValues()</li>
</ul>
<p>function selectFrom(lowerValue, upperValue){<br>let choices &#x3D; upperValue - lowerValue + 1;<br> return Math.floor(Math.random() * choices + lowerValue);<br>}</p>
<p>let num &#x3D; selectFrom(3, 6); &#x2F;&#x2F; å¾3 4 5 6 çš„4å€‹æ•¸å­—æŒ‘1å€‹<br>console.log(num);</p>
<p>let words &#x3D; [â€˜helloâ€™, â€˜skyâ€™, â€˜snowâ€™, â€˜happyâ€™];<br>console.log(words[selectFrom(0, words.length - 1)]); </p>
<h6 id="1-4-2-5-Other-Methods"><a href="#1-4-2-5-Other-Methods" class="headerlink" title="1.4.2.5 OtherÂ Methods"></a>1.4.2.5 OtherÂ Methods</h6><ul>
<li>å…¶å®ƒçš„æ–¹æ³•è«‹åƒè€ƒ MDNÂ <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects&#x2F;Math</a></li>
</ul>
<h4 id="2-åƒè€ƒè³‡æ–™"><a href="#2-åƒè€ƒè³‡æ–™" class="headerlink" title="2. åƒè€ƒè³‡æ–™"></a>2. åƒè€ƒè³‡æ–™</h4><ol>
<li><a target="_blank" rel="noopener" href="https://www.amazon.com/-/zh_TW/Matt-Frisbie/dp/1119366445?crid=2IKRLQD88C73Q&keywords=javascript&qid=1640523661&sprefix=javascrip,aps,272&sr=8-24&linkCode=ll1&tag=glj89893320b-20&linkId=0a4b475800517718840fceead024db61&language=zh_TW&ref_=as_li_ss_tl">Professional JavaScript for Web Developers 4th Edition, Chapter 5 : Basic Reference Types, Matt Frisbie.</a></li>
</ol>
<p>Javascript Basic Reference Type</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/05/threading-in-csharp-part-3-using-threads/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/05/threading-in-csharp-part-3-using-threads/" class="post-title-link" itemprop="url">Threading in C# - USING THREADS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-05 15:45:00" itemprop="dateCreated datePublished" datetime="2021-12-05T15:45:00+08:00">2021-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Thread/" itemprop="url" rel="index"><span itemprop="name">Thread</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/" itemprop="url" rel="index"><span itemprop="name">è®€æ›¸ç­†è¨˜</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Threading-in-C-PART-3-USING-THREADS"><a href="#Threading-in-C-PART-3-USING-THREADS" class="headerlink" title="Threading in C# - PART 3: USING THREADS"></a>Threading in C# - PART 3: USING THREADS</h3><p>é€™ç¯‡æ–‡ç« ç‚ºé–±è®€ Threading in C# ç³»åˆ—çš„Part 3ç­†è¨˜.</p>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2021/12/NewThread.png" alt="Multi-Threading"></p>
<p>Multi-Threading in C# (Picture source: <a target="_blank" rel="noopener" href="http://www.albahari.com/threading/">Threading in C#<br>Joseph Albahari</a>)</p>
<h3 id="Threading-Pattern-The-Event-Based-Asynchronous-Pattern"><a href="#Threading-Pattern-The-Event-Based-Asynchronous-Pattern" class="headerlink" title="Threading Pattern - The Event-Based Asynchronous Pattern"></a>Threading Pattern - The Event-Based Asynchronous Pattern</h3><ul>
<li>EAPå¯å•Ÿç”¨å¤šåŸ·è¡Œç·’ä¸”ä¸éœ€è¦Consumerä¸»å‹•æˆ–ç®¡ç†thread, æœ‰ä»¥ä¸‹ç‰¹å¾µ</li>
</ul>
<ol>
<li>åˆä½œå¼å–æ¶ˆæ¨¡å‹</li>
<li>ç•¶Worker threadå®Œæˆå·¥ä½œ, å¯å®‰å…¨æ›´æ–°WFP&#x2F;Winformçš„UIå…ƒä»¶</li>
<li>åœ¨å®Œæˆçš„äº‹ä»¶å‚³éException</li>
</ol>
<ul>
<li>EAPåªæ˜¯å€‹Pattern, å¯¦ä½œä¸Šæœ€å¸¸è¦‹çš„æœ‰BackgroundWorker, WebClientç­‰</li>
<li>é€™äº›ClassåŒ…å«æœ‰*Asyncçš„æ–¹æ³•, é€šå¸¸å°±æ˜¯EAP. å‘¼å«*Asyncçš„æ–¹æ³•, å°‡ä»»å‹™äº¤çµ¦å…¶ä»–threadåŸ·è¡Œ, è€Œä»»å‹™å®Œæˆå¾Œ, æœƒè§¸ç™¼Completedäº‹ä»¶</li>
<li>*Completedäº‹ä»¶çš„åƒæ•¸åŒ…å«é€™äº›:</li>
</ul>
<ol>
<li>æœ‰å€‹flagæ¨™ç¤ºè©²ä»»å‹™æ˜¯å¦æœ‰è¢«å–æ¶ˆ</li>
<li>æœ‰exceptionæ‹‹å‡ºæ™‚, åŒ…è£åœ¨Errorç‰©ä»¶</li>
<li>call functionä»£å…¥çš„userToken</li>
</ol>
<ul>
<li>ä½¿ç”¨EAPçš„è¨­è¨ˆ, å¦‚æœæœ‰éµå¾ªAPMçš„è¦å‰‡, å¯ä»¥ç¯€çœThread</li>
<li>ä¹‹å¾Œçš„Taskå¯¦ä½œå’ŒEAPå¾ˆç›¸ä¼¼, è®“EAPçš„é­…åŠ›å¤§æ¸›</li>
</ul>
<h3 id="BackgroundWorker"><a href="#BackgroundWorker" class="headerlink" title="BackgroundWorker"></a>BackgroundWorker</h3><ul>
<li>BackgroundWorkeræ˜¯åœ¨System.ComponentModel, ç¬¦åˆEAPè¨­è¨ˆ, ä¸¦æœ‰ä»¥ä¸‹ç‰¹å¾µ:</li>
</ul>
<ol>
<li>åˆä½œçš„å–æ¶ˆæ¨¡å‹</li>
<li>ç•¶Workerå®Œæˆ, å¯ä»¥å®‰å…¨æ›´æ–°WPF&#x2F;Winformçš„Control</li>
<li>æŠŠExceptionå‚³éåˆ°å®Œæˆäº‹ä»¶</li>
<li>æœ‰å€‹é€²åº¦å›å ±çš„protocol</li>
<li>å¯¦ä½œIComponent, åœ¨Design time(Ex: Visual Studio Designer)å¯ä»¥è¢«è¨—ç®¡</li>
</ol>
<h4 id="Using-BackgroundWorker"><a href="#Using-BackgroundWorker" class="headerlink" title="Using BackgroundWorker"></a>Using BackgroundWorker</h4><ul>
<li>å»ºç«‹BackgroundWorkerçš„æœ€å°æ­¥é©Ÿ: å»ºç«‹BackgroundWorkerä¸¦è™•ç†DoWorkäº‹ä»¶, å†å‘¼å«RunWorkerAsyncå‡½å¼, æ­¤å‡½å¼ä¹Ÿèƒ½ä»£å…¥åƒæ•¸. åœ¨DoWorkå§”è¨—çš„å‡½å¼, å¾DoWorkEventArgså–å‡ºArgument, ä»£è¡¨æœ‰ä»£å…¥çš„åƒæ•¸.</li>
<li>ä»¥ä¸‹æ˜¯åŸºæœ¬çš„ç¯„ä¾‹</li>
</ul>
<p>using System;<br>using System.ComponentModel;</p>
<p>namespace BackgroundWorkerTest<br>{<br>    class Program<br>    {<br>        static BackgroundWorker _bw &#x3D; new BackgroundWorker();<br>        static void Main(string[] args)<br>        {<br>            _bw.DoWork +&#x3D; MyDoWork;<br>            _bw.RunWorkerAsync(123456);<br>            Console.ReadLine();<br>        }</p>
<pre><code>    private static void MyDoWork(object sender, DoWorkEventArgs e)
    &#123;
        Console.WriteLine(e.Argument);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>BackgroundWorkeræœ‰å€‹RunWorkerCompletedäº‹ä»¶, ç•¶DoWorkçš„äº‹ä»¶å®Œæˆå°‡æœƒè§¸ç™¼, è€Œåœ¨RunWorkerCompletedè£¡æŸ¥è©¢æœ‰DoWorkæ‹‹å‡ºçš„Exceptionã€ä¹Ÿèƒ½å°UI Controlåšæ›´æ–°</li>
<li>å¦‚æœè¦å¢åŠ progress reporting, è¦ä»¥ä¸‹æ­¥é©Ÿ:</li>
</ul>
<ol>
<li>è¨­ç½®WorkerReportsProgresså±¬æ€§ç‚ºtrue</li>
<li>å®šæœŸåœ¨DoWorkçš„å§”è¨—äº‹ä»¶å‘¼å«ReportProgress, ä»£å…¥ç›®å‰å®Œæˆçš„é€²åº¦å€¼, ä¹Ÿå¯é¸ä»£å…¥user-state</li>
<li>æ–°å¢ProgressChangedäº‹ä»¶è™•ç†, æŸ¥è©¢å‰é¢ä»£å…¥çš„é€²åº¦å€¼, ç”¨ProgressPercentageåƒæ•¸æŸ¥</li>
<li>åœ¨ProgressChangedä¹Ÿèƒ½æ›´æ–°UI Control</li>
</ol>
<ul>
<li>å¦‚æœè¦å¢åŠ Cancellationçš„åŠŸèƒ½:</li>
</ul>
<ol>
<li>è¨­ç½®WorkerSupportsCancellationå±¬æ€§ç‚ºtrue</li>
<li>å®šæœŸåœ¨DoWorkçš„å§”è¨—äº‹ä»¶å…§æª¢æŸ¥CancellationPendingé€™å€‹booleanå€¼, å¦‚æœå®ƒæ˜¯true, å‰‡å¯ä»¥è¨­ç½®DoWorkEventArgsçš„Cancelç‚ºtrueä¸¦åšreturn. å¦‚æœDoWorkçš„å·¥ä½œå¤ªå›°é›£è€Œä¸èƒ½ç¹¼çºŒåŸ·è¡Œ, ä¹Ÿå¯ä»¥ä¸ç†æœƒCancellationPendingçš„ç‹€æ…‹è€Œç›´æ¥è¨­Cancelç‚ºtrue</li>
<li>å‘¼å«CancelAsyncä¾†è«‹æ±‚å–æ¶ˆä»»å‹™</li>
</ol>
<ul>
<li>ä»¥ä¸‹æ˜¯progress reportingå’Œcancellationçš„ç¯„ä¾‹, æ¯ç¶“é1ç§’æœƒå›å ±ç´¯åŠ çš„é€²åº¦(æ¯æ¬¡å¢åŠ 20). å¦‚æœåœ¨5ç§’å…§æŒ‰ä¸‹ä»»ä½•éµ, æœƒé€å‡ºcancelè«‹æ±‚ä¸¦åœæ­¢DoWork. å¦å‰‡è¶…é5ç§’å¾Œ, åœ¨DoWorkEventArgsçš„Resultå¯ä»¥è¨­å€¼, ä¸¦åœ¨RunWorkerCompletedçš„RunWorkerCompletedEventArgsçš„Resultå–å€¼.</li>
</ul>
<p>using System;<br>using System.ComponentModel;<br>using System.Threading;</p>
<p>namespace BackgroundWorkerProgressCancel<br>{<br>    class Program<br>    {<br>        static BackgroundWorker _bw;<br>        static void Main(string[] args)<br>        {<br>            _bw &#x3D; new BackgroundWorker<br>            {<br>                WorkerReportsProgress &#x3D; true,<br>                WorkerSupportsCancellation &#x3D; true<br>            };<br>            _bw.DoWork +&#x3D; bw_DoWork;<br>            _bw.ProgressChanged +&#x3D; bw_ProgressChanged;<br>            _bw.RunWorkerCompleted +&#x3D; bw_RunWorkerCompleted;</p>
<pre><code>        \_bw.RunWorkerAsync(&quot;Run worker now&quot;);

        Console.WriteLine(&quot;Press Enter in the next 5 seconds to cancel&quot;);
        Console.ReadLine();
        if (\_bw.IsBusy)
        &#123;
            \_bw.CancelAsync();
        &#125;

        Console.ReadLine();
    &#125;

    private static void bw\_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
    &#123;
        if (e.Cancelled)
        &#123;
            Console.WriteLine(&quot;You canceled&quot;);
        &#125;
        else if(e.Error != null)
        &#123;
            Console.WriteLine(&quot;Worker exception: &quot; + e.Error.ToString());
        &#125;
        else
        &#123;
            Console.WriteLine(&quot;Completed: &quot; + e.Result);
        &#125;
    &#125;

    private static void bw\_ProgressChanged(object sender, ProgressChangedEventArgs e)
    &#123;
        Console.WriteLine(&quot;Reached &quot; + e.ProgressPercentage + &quot;%&quot;);
    &#125;

    private static void bw\_DoWork(object sender, DoWorkEventArgs e)
    &#123;
        for(int i = 0; i &lt;= 100; i+= 20)
        &#123;
            if (\_bw.CancellationPending)
            &#123;
                e.Cancel = true;
                return;
            &#125;

            \_bw.ReportProgress(i);
            Thread.Sleep(1000);
        &#125;

        e.Result = 123456;
    &#125;
&#125;
</code></pre>
<p>}</p>
<h4 id="Subclassing-BackgroundWorker"><a href="#Subclassing-BackgroundWorker" class="headerlink" title="Subclassing BackgroundWorker"></a>Subclassing BackgroundWorker</h4><ul>
<li>å¯ä»¥ç¹¼æ‰¿BackgroundWorkerä¾†å¯¦ä½œEAP</li>
<li>ä»¥ä¸‹ç¯„ä¾‹æ˜¯æ•´åˆå‰é¢BackgroundWorkerçš„ç¯„ä¾‹, å†æ­é…åŸä½œè€…æœªå®Œæ•´çš„ç¹¼æ‰¿æ¡ˆä¾‹, åŠŸèƒ½æ˜¯æ¯ä¸€ç§’æœƒç´¯åŠ è²¡å‹™çš„é‡‘é¡å’Œä¿¡ç”¨é»æ•¸, å¢åŠ çš„å€¼æ˜¯å»ºæ§‹ç‰©ä»¶æ™‚çµ¦çš„åƒæ•¸. ç¶“é5ç§’å¾ŒæŠŠç´¯åŠ çš„çµæœæ”¾åœ¨Dictionary</li>
</ul>
<p>using System;<br>using System.Collections.Generic;<br>using System.ComponentModel;<br>using System.Threading;</p>
<p>namespace BackgroundWorkerSubClass<br>{<br>    class Program<br>    {<br>        static FinancialWorker _bw;<br>        static void Main(string[] args)<br>        {<br>            _bw &#x3D; new Client().GetFinancialTotalsBackground(10, 50);<br>            _bw.ProgressChanged +&#x3D; bw_ProgressChanged;<br>            _bw.RunWorkerCompleted +&#x3D; bw_RunWorkerCompleted;</p>
<pre><code>        \_bw.RunWorkerAsync(&quot;Hello to worker&quot;);
        Console.WriteLine(&quot;Press Enter in the next 5 seconds to cancel&quot;);
        Console.ReadLine();
        if (\_bw.IsBusy) \_bw.CancelAsync();
        Console.ReadLine();
    &#125;

    static void bw\_RunWorkerCompleted(object sender,
                                 RunWorkerCompletedEventArgs e)
    &#123;
        if (e.Cancelled)
            Console.WriteLine(&quot;You canceled!&quot;);
        else if (e.Error != null)
            Console.WriteLine(&quot;Worker exception: &quot; + e.Error.ToString());
        else
        &#123;
            Dictionary&lt;string, int&gt; result = e.Result as Dictionary&lt;string, int&gt;;
            Console.WriteLine(&quot;Complete: &quot;);      // from DoWork
            foreach (var item in result)
            &#123;
                Console.WriteLine($&quot;Key &#123;item.Key&#125; Value &#123;item.Value&#125;&quot;);
            &#125;
        &#125;

    &#125;

    static void bw\_ProgressChanged(object sender,
                                    ProgressChangedEventArgs e)
    &#123;
        Console.WriteLine(&quot;Reached &quot; + e.ProgressPercentage + &quot;%&quot;);
    &#125;
&#125;

public class Client
&#123;
    public FinancialWorker GetFinancialTotalsBackground(int moneyIncreaseBase, int creditPointIncreaseBase)
    &#123;
        return new FinancialWorker(moneyIncreaseBase, creditPointIncreaseBase);
    &#125;
&#125;

public class FinancialWorker : BackgroundWorker
&#123;
    public Dictionary&lt;string, int&gt; Result;   // You can add typed fields.
    public readonly int MoneyIncreaseBase, CreditPointIncreaseBase;

    public FinancialWorker()
    &#123;
        WorkerReportsProgress = true;
        WorkerSupportsCancellation = true;
    &#125;

    public FinancialWorker(int moneyIncreaseBase, int creditPointIncreaseBase) : this()
    &#123;
        this.MoneyIncreaseBase = moneyIncreaseBase;
        this.CreditPointIncreaseBase = creditPointIncreaseBase;
    &#125;

    protected override void OnDoWork(DoWorkEventArgs e)
    &#123;
        Result = new Dictionary&lt;string, int&gt;();
        Result.Add(&quot;Money&quot;, 0);
        Result.Add(&quot;CreditPoint&quot;, 0);

        int percentCompleteCalc = 0;
        while (percentCompleteCalc &lt;= 80)
        &#123;
            if (CancellationPending)
            &#123;
                e.Cancel = true;
                return;
            &#125;
            ReportProgress(percentCompleteCalc, &quot;Monet &amp; Credit Point is increasing!&quot;);
            percentCompleteCalc += 20;
            Result\[&quot;Money&quot;\] += MoneyIncreaseBase;
            Result\[&quot;CreditPoint&quot;\] += CreditPointIncreaseBase;
            Thread.Sleep(1000);
        &#125;
        ReportProgress(100, &quot;Done!&quot;);
        e.Result = Result;
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>é€™ç¨®ç¹¼æ‰¿å¯«æ³•, å¯ä»¥è®“Callerä¸ç”¨æŒ‡å®šDoWorkå§”è¨—, åœ¨å‘¼å«RunWorkerAsyncæ™‚åŸ·è¡Œæœ‰overrideçš„OnDoWork.</li>
<li>ä¸»è¦æ˜¯æŠŠprogress report, cancellationå’Œcomleted(å¯ä»¥æ›´æ–°UIä¹‹é¡ã€å–é‹ç®—çµæœ)è¦è² è²¬çš„åŠŸèƒ½çµ¦calleræŒ‡å®š, è€ŒDoWorkçš„é‚è¼¯äº¤çµ¦è©²BackgroundWorkerå­é¡åˆ¥è² è²¬.</li>
</ul>
<h3 id="Threading-çš„-åœæ­¢-Interrupt-and-Abort"><a href="#Threading-çš„-åœæ­¢-Interrupt-and-Abort" class="headerlink" title="Threading çš„[åœæ­¢]: Interrupt and Abort"></a>Threading çš„[åœæ­¢]: Interrupt and Abort</h3><ul>
<li>Interruptå’ŒAbortèƒ½åœæ­¢Blockedçš„thread</li>
<li>Abortä¹Ÿèƒ½åœæ­¢éblockçš„thread, æ¯”å¦‚ä¸€ç›´åœ¨ç„¡é™è¿´åœˆåŸ·è¡Œçš„thread, æ‰€ä»¥Abortæœƒåœ¨ç‰¹å®šå ´åˆä½¿ç”¨, ä½†Interruptå¾ˆå°‘ç”¨åˆ°</li>
</ul>
<h4 id="Interrupt"><a href="#Interrupt" class="headerlink" title="Interrupt"></a>Interrupt</h4><ul>
<li>Interruptèƒ½å¼·åˆ¶ä½¿blocked threadé‡‹æ”¾, ä¸¦æ‹‹å‡ºThreadInterruptedException.</li>
<li>é™¤éæ²’æœ‰handle ThreadInterruptedException(CatchæŠ“åˆ°å®ƒ), å¦å‰‡è©²threadåœ¨interruptå¾Œä¸æœƒçµæŸ.</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace InterruptBasic<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            Thread t &#x3D; new Thread(() &#x3D;&gt;<br>            {<br>                try<br>                {<br>                    Thread.Sleep(Timeout.Infinite);<br>                }<br>                catch (ThreadInterruptedException)<br>                {<br>                    Console.WriteLine(â€œForciblyâ€);<br>                }<br>                Console.WriteLine(â€œWoken!â€);<br>            });</p>
<pre><code>        t.Start();
        t.Interrupt();
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>å¦‚æœå°ä¸€å€‹non-blockedçš„threadä½¿ç”¨interrupt, å®ƒä»æœƒæŒçºŒé€²è¡Œ, ç›´åˆ°å®ƒblocked, å°±æœƒæ‹‹å‡ºThreadInterruptedException. ä»¥ä¸‹ç¯„ä¾‹å‘ˆç¾æ­¤åŠŸèƒ½, Main threadå°worker threadåšinterrupt, è€ŒworkeråŸ·è¡Œå®Œä¸€å€‹ç¨å¾®ä¹…çš„è¿´åœˆå†åšBlocked(Sleep)å°±æœƒæ‹‹exception</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace ThreadInterruptNonblocking<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            Thread t &#x3D; new Thread(() &#x3D;&gt;<br>            {<br>                try<br>                {<br>                    long count &#x3D; 0;<br>                    while (count &lt; 1000000000)<br>                    {<br>                        count++;<br>                    }<br>                    Console.WriteLine(â€œSleepâ€);<br>                    Thread.Sleep(1000);<br>                    Console.WriteLine(â€œI am doneâ€);<br>                }<br>                catch(ThreadInterruptedException ex)<br>                {<br>                    Console.WriteLine(â€œCatch interrupt!â€);<br>                }<br>            });</p>
<pre><code>        t.Start();
        Console.WriteLine(&quot;Call interrupt&quot;);
        t.Interrupt();

        Console.ReadLine();
    &#125;
&#125;
</code></pre>
<p>} </p>
<ul>
<li>å…ˆç¢ºèªthreadçš„ç‹€æ…‹å†å‘¼å«interrupt, å¯ä»¥é¿å…æ­¤å•é¡Œ, ä½†é€™æ–¹æ³•ä¸æ˜¯thread-safe, å› ç‚ºif å’Œ interrupt æœƒæœ‰æ©Ÿç‡ç™¼ç”Ÿæ¶å </li>
</ul>
<p>if ((worker.ThreadState &amp; ThreadState.WaitSleepJoin) &gt; 0)<br>  worker.Interrupt();</p>
<ul>
<li>åªè¦æœ‰threadåœ¨lockæˆ–synchronizedçš„æ™‚å€™ç™¼ç”Ÿblocked, å‰‡æœ‰å°å®ƒinterruptçš„æŒ‡ä»¤èœ‚æ“è€Œä¸Š. å¦‚æœè©²threadæ²’æœ‰è™•ç†å¥½ç™¼ç”Ÿinterruptå¾Œçš„å¾ŒçºŒ(æ¯”å¦‚åœ¨finallyè¦é‡‹æ”¾è³‡æº), å°‡å°è‡´è³‡æºä¸æ­£ç¢ºé‡‹æ”¾ã€ç‰©ä»¶ç‹€æ…‹æœªçŸ¥åŒ–.</li>
<li>å› æ­¤, interruptæ˜¯ä¸å¿…è¦çš„, è¦å¼·åˆ¶å°blocked threadåšé‡‹æ”¾, å®‰å…¨çš„æ–¹å¼æ˜¯ç”¨cancellation token. å¦‚æœæ˜¯è¦unblock thread, Abortç›¸è¼ƒæ˜¯æ¯”è¼ƒæœ‰ç”¨çš„.</li>
</ul>
<h4 id="Abort-Net-Coreä¸æ”¯æ´"><a href="#Abort-Net-Coreä¸æ”¯æ´" class="headerlink" title="Abort (Net Coreä¸æ”¯æ´)"></a>Abort (Net Coreä¸æ”¯æ´)</h4><ul>
<li>Abortä¹Ÿæ˜¯å¼·åˆ¶é‡‹æ”¾blocked thread, ä¸”æœƒæ‹‹å‡ºThreadAbortException. ä½†æ˜¯åœ¨catchçµå°¾æœƒå†é‡æ‹‹ä¸€æ¬¡è©²exception</li>
<li>å¦‚æœæœ‰åœ¨catchå‘¼å«Thread.ResetAbort, å°±ä¸æœƒç™¼ç”Ÿé‡æ‹‹</li>
<li>åœ¨å‘¼å«Abortå¾Œçš„æ™‚é–“å…§, è©²threadçš„ThreadStateæ˜¯AbortRequested</li>
<li>å°šæœªhandleçš„ThreadAbortException ä¸¦ä¸æœƒé€ æˆç¨‹å¼shutdown</li>
<li>Abortå’ŒInterruptçš„æœ€å¤§å·®ç•°åœ¨æ–¼è¢«å‘¼å«çš„non-blocked threadæœƒç™¼ç”Ÿä»€éº¼äº‹. Interruptæœƒç­‰åˆ°è©²thread blockæ‰é‹ä½œ, è€ŒAbortæœƒç«‹å³æ‹‹å‡ºexceptio(unmanaged codeé™¤å¤–)</li>
<li>Managed codeä¸æ˜¯abort-safe, æ¯”å¦‚æœ‰å€‹FileStreamåœ¨å»ºæ§‹è®€æª”çš„éç¨‹è¢«Abort, è€Œunmanagedçš„file handleræ²’è¢«ä¸­æ­¢, å°è‡´æª”æ¡ˆä¸€ç›´open, ç›´åˆ°è©²ç¨‹å¼çš„AppDomainçµæŸæ‰æœƒé‡‹æ”¾.</li>
<li>æœ‰2å€‹æ¡ˆä¾‹æ˜¯å¯ä»¥å®‰å…¨åšAbort:</li>
</ul>
<ol>
<li>åœ¨abortè©²threadå¾Œ, é€£å®ƒçš„AppDomainä¹Ÿè¦ä¸­æ­¢. æ¯”å¦‚Unit testing</li>
<li>å°è‡ªèº«ThreadåšAbort, æ¯”å¦‚ASP.NETçš„Redirectæ©Ÿåˆ¶æ˜¯é€™æ¨£åš</li>
</ol>
<ul>
<li>ä½œè€…çš„LINQPadå·¥å…·, ç•¶å–æ¶ˆæŸå€‹æŸ¥è©¢æ™‚, å°å®ƒçš„thread abort. abortçµæŸå¾Œ, æœƒæ‹†è§£ä¸¦é‡æ–°å»ºç«‹æ–°çš„application domain, é¿å…ç™¼ç”Ÿæ½›åœ¨å—æ±™æŸ“ç‹€æ…‹</li>
</ul>
<h3 id="Safe-Cancellation"><a href="#Safe-Cancellation" class="headerlink" title="Safe Cancellation"></a>Safe Cancellation</h3><ul>
<li>Abortåœ¨å¤§éƒ¨åˆ†çš„æƒ…å¢ƒ, æ˜¯å€‹å¾ˆå±éšªçš„åŠŸèƒ½</li>
<li>å»ºè­°æ›¿ä»£çš„æ–¹å¼æ˜¯å¯¦ä½œcooperative pattern, ä¹Ÿå°±æ˜¯workeræœƒå®šæœŸæª¢æŸ¥æŸå€‹flag, å¦‚æœè©²flagè¢«è¨­ç«‹, å‰‡è‡ªå·±åšabort(æ¯”å¦‚BackgroundWorker)</li>
<li>Callerå°è©²flagè¨­ç½®, Workeræœƒå®šæœŸæª¢æŸ¥åˆ°.</li>
<li>é€™ç¨®patternçš„ç¼ºé»æ˜¯workerçš„methodå¿…é ˆé¡¯å¼æ”¯æ´cancellation</li>
<li>é€™ç¨®æ˜¯å°‘æ•¸å®‰å…¨çš„cancellation pattern</li>
<li>ä»¥ä¸‹æ˜¯è‡ªå®šç¾©å°è£çš„cancellation flag class:</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace CancellationCustom<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            var canceler &#x3D; new RulyCanceler();<br>            new Thread(()&#x3D;&gt;{<br>                try{<br>                    Work(canceler);<br>                }<br>                catch(OperationCanceledException){<br>                    Console.WriteLine(â€œCanceledâ€);<br>                }<br>            }).Start();</p>
<pre><code>        Thread.Sleep(1000);
        canceler.Cancel();
    &#125;

    private static void Work(RulyCanceler canceler)
    &#123;
        while(true)
        &#123;
            canceler.ThrowIfCancellationRequested();
            try
            &#123;
                // other method
                OtherMethod(canceler);
            &#125;
            finally
            &#123;
                // any required cleanup
            &#125;
        &#125;
    &#125;

    private static void OtherMethod(RulyCanceler canceler)
    &#123;
        // do stuff...
        for(int i = 0 ; i &lt; 1000000;++i)
        &#123;
        &#125;
        Console.WriteLine(&quot;I am doing work&quot;);


        canceler.ThrowIfCancellationRequested();
    &#125;
&#125;

class RulyCanceler
&#123;
    object \_cancelLocker = new object();
    bool \_cancelRequest;
    public bool IsCancellationRequested
    &#123;
        get
        &#123;
            lock(\_cancelLocker)
            &#123;
                return \_cancelRequest;
            &#125;
        &#125;
    &#125;

    public void Cancel()
    &#123;
        lock(\_cancelLocker)
        &#123;
            \_cancelRequest = true;
        &#125;
    &#125;

    public void ThrowIfCancellationRequested()
    &#123;
        if(IsCancellationRequested)
        &#123;
            throw new OperationCanceledException();
        &#125;
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>ä¸Šè¿°å¯«æ³•æ˜¯å®‰å…¨çš„cancellation pattern, ä½†æ˜¯Work methodæœ¬èº«ä¸éœ€è¦RulyCancelerç‰©ä»¶, å› æ­¤NET Frameworkæä¾›Cancellation Token, è®“è¨­ç½®</li>
</ul>
<h4 id="Cancellation-Tokens"><a href="#Cancellation-Tokens" class="headerlink" title="Cancellation Tokens"></a>Cancellation Tokens</h4><ul>
<li>Net Framework 4.0æä¾›cooperative cancellation patternçš„CancellationTokenSourceå’ŒCancellationToken, ä½¿ç”¨æ–¹å¼ç‚º:</li>
</ul>
<ol>
<li>CancellationTokenSourceæä¾›Cancelæ–¹æ³•</li>
<li>CancellationTokenæœ‰IsCancellationRequestedå±¬æ€§å’ŒThrowIfCancellationRequestedæ–¹æ³•</li>
</ol>
<ul>
<li>é€™å€‹é¡åˆ¥æ˜¯æ›´å‰é¢ç¯„ä¾‹æ›´è¤‡é›œ, æ‹†å‡º2å€‹é¡åˆ¥ä½œåˆ†é–‹çš„åŠŸèƒ½(Cancelå’Œæª¢æŸ¥flag)</li>
<li>ä½¿ç”¨CancellationTokenSourceç¯„ä¾‹å¦‚ä¸‹:</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace CancellationTokenCustom<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            var cancelSource &#x3D; new CancellationTokenSource();<br>            new Thread(() &#x3D;&gt; {<br>                try<br>                {<br>                    Work(cancelSource.Token);<br>                }<br>                catch (OperationCanceledException)<br>                {<br>                    Console.WriteLine(â€œCanceledâ€);<br>                }<br>            }).Start();</p>
<pre><code>        Thread.Sleep(1000);
        cancelSource.Cancel();
        Console.ReadLine();
    &#125;

    private static void Work(CancellationToken cancelToken)
    &#123;
        while (true)
        &#123;
            cancelToken.ThrowIfCancellationRequested();
            try
            &#123;
                // other method
                OtherMethod(cancelToken);
            &#125;
            finally
            &#123;
                // any required cleanup
            &#125;
        &#125;
    &#125;

    private static void OtherMethod(CancellationToken cancelToken)
    &#123;
        // do stuff...
        for (int i = 0; i &lt; 1000000; ++i)
        &#123;
        &#125;
        Console.WriteLine(&quot;I am doing work&quot;);


        cancelToken.ThrowIfCancellationRequested();
    &#125;

&#125;
</code></pre>
<p>}</p>
<ul>
<li>ä¸»è¦æµç¨‹ç‚º</li>
</ul>
<ol>
<li>å…ˆå»ºç«‹CancellationTokenSourceç‰©ä»¶</li>
<li>å°‡CancellationTokenSourceçš„CancellationTokenä»£å…¥å¯æ”¯æ´å–æ¶ˆçš„å‡½å¼</li>
<li>åœ¨æ”¯æ´å–æ¶ˆçš„å‡½å¼, ä¸æ–·ç”¨CancellationTokenç‰©ä»¶æª¢æŸ¥IsCancellationRequestedæˆ–è€…é€éThrowIfCancellationRequestedä¾†ä¸­æ­¢ç¨‹å¼</li>
<li>å°CancellationTokenSourceç‰©ä»¶å‘¼å«Cancelæ–¹æ³•</li>
</ol>
<ul>
<li>CancellationTokenæ˜¯struct, æ„å‘³é€™å¦‚æœæœ‰éš±å¼copyçµ¦å…¶ä»–çš„token, å‰‡éƒ½æ˜¯åƒè€ƒåŒä¸€å€‹CancellationTokenSource</li>
<li>CancellationTokençš„WaitHandleå±¬æ€§æœƒå›å‚³å–æ¶ˆçš„è¨Šè™Ÿ, è€ŒRegisteræ–¹æ³•å¯ä»¥è¨»å†Šä¸€å€‹å§”è¨—äº‹ä»¶, ç•¶cancelè¢«å‘¼å«æ™‚å¯ä»¥è§¸ç™¼è©²å§”è¨—.</li>
<li>Cancellation tokensåœ¨Net Frameworkå¸¸ç”¨çš„é¡åˆ¥å¦‚ä¸‹:</li>
</ul>
<ol>
<li>ManualResetEventSlim and SemaphoreSlim</li>
<li>CountdownEvent</li>
<li>Barrier</li>
<li>BlockingCollection</li>
<li>PLINQ and Task Parallel Library</li>
</ol>
<ul>
<li>é€™äº›é¡åˆ¥é€šå¸¸æœ‰Waitçš„å‡½å¼, å¦‚æœæœ‰å‘¼å«Waitå¾Œå†ç”¨CancellationTokenåšcancel, å°‡å–æ¶ˆé‚£Waitçš„åŠŸèƒ½. æ¯”èµ·Interruptæ›´æ¸…æ¥šã€å®‰å…¨.</li>
</ul>
<h3 id="Lazy-Initialization"><a href="#Lazy-Initialization" class="headerlink" title="Lazy Initialization"></a>Lazy Initialization</h3><ul>
<li>é¡åˆ¥çš„Field, æœ‰äº›åœ¨Constructéœ€è¦èŠ±è²»è¼ƒå¤šçš„è³‡æº, æ¯”å¦‚ä¸‹æ–¹çš„ç¨‹å¼:</li>
</ul>
<p>class Foo<br>{<br>public readonly Expensive Expensive &#x3D; new Expensive();<br>}</p>
<p>class Expensive<br>{<br>&#x2F;&#x2F; suppose this is expensive to construct<br>}</p>
<ul>
<li>å¯ä»¥æ”¹æˆä¸€é–‹å§‹æ˜¯null, ç›´åˆ°å­˜å–æ™‚æ‰åšåˆå§‹åŒ–, ä¹Ÿå°±æ˜¯lazily initialize, æ¯”å¦‚ä¸‹æ–¹ç¨‹å¼:</li>
</ul>
<p>class Foo<br>{<br>Expensive _expensive;<br>public Expensive Expensive<br>{<br>get<br>{<br>if(_expensive &#x3D;&#x3D; null)<br>{<br>_expensive &#x3D; new Expensive();<br>}</p>
<p>return _expensive;<br>}<br>}<br>}</p>
<p>class Expensive<br>{<br>&#x2F;&#x2F; suppose this is expensive to construct<br>}</p>
<ul>
<li>ä½†æ˜¯åœ¨å¤šåŸ·è¡Œç·’çš„ç‹€æ³ä¸‹, å–Expensive propertyå¯èƒ½æœƒæœ‰é‡è¤‡åšnew Expensive()çš„æ©Ÿç‡, ä¸¦éthread-safe. è¦é”åˆ°Thread-safe, å¯ä»¥åŠ ä¸Šlock:</li>
</ul>
<p>class Foo<br>{<br>Expensive _expensive;<br>readonly object _expensiveLock &#x3D; new object();<br>public Expensive Expensive<br>{<br>get<br>{<br>lock(_expensiveLock)<br>{<br>if(_expensive &#x3D;&#x3D; null)<br>{<br>_expensive &#x3D; new Expensive();<br>}</p>
<p>return _expensive;<br>}<br>}<br>}<br>}</p>
<p>class Expensive<br>{<br>&#x2F;&#x2F; suppose this is expensive to construct<br>}</p>
<h4 id="Lazy"><a href="#Lazy" class="headerlink" title="Lazy"></a>Lazy<T></h4><ul>
<li>.NET Framework 4.0æä¾›Lazy<T>çš„é¡åˆ¥, èƒ½åšlazy initializationçš„åŠŸèƒ½. Constructoræœ‰1å€‹åƒæ•¸isThreadSafe, è¨­ç‚ºtrueæ™‚, ä»£è¡¨èƒ½æ”¯æ´thread-safe, è‹¥ç‚ºfalse, åªèƒ½ç”¨åœ¨single-threadçš„æƒ…å¢ƒ.</li>
<li>Lazyåœ¨æ”¯æ´thread-safeçš„å¯¦ä½œ, æ¡ç”¨Double-checked locking, æ›´æœ‰æ•ˆç‡æª¢æŸ¥åˆå§‹åŒ–</li>
<li>æ”¹æˆç”¨Lazyä¸”æ˜¯factoryçš„å¯«æ³•:</li>
</ul>
<p>class Foo<br>{<br>Lazy<Expensive> _expensive &#x3D; new Lazy<Expensive>(() &#x3D;&gt; new Expensive(), true);<br>readonly object _expensiveLock &#x3D; new object();<br>public Expensive Expensive<br>{<br>get<br>{<br>return _expensive.Value;<br>}<br>}<br>}</p>
<h4 id="LazyInitializer"><a href="#LazyInitializer" class="headerlink" title="LazyInitializer"></a>LazyInitializer</h4><ul>
<li>LazyInitializeræ˜¯staticé¡åˆ¥, å’ŒLazy<T>å·®ç•°åœ¨</li>
</ul>
<ol>
<li>å®ƒçš„static methodå¯ä»¥ç›´æ¥å°æƒ³åšlazy initializationçš„field, å¯ä»¥æ•ˆèƒ½å„ªåŒ–</li>
<li>æœ‰æä¾›å…¶ä»–çš„åˆå§‹åŒ–æ¨¡å¼, æœƒæœ‰å¤šå€‹åŸ·è¡Œç·’ç«¶çˆ­</li>
</ol>
<ul>
<li>ä»¥ä¸‹æ˜¯LazyInitializerä½¿ç”¨EnsureInitializedçš„åˆå§‹åŒ–fieldçš„ç¯„ä¾‹:</li>
</ul>
<p>class Foo<br>{<br>Expensive _expensive;<br>public Expensive Expensive<br>{<br>get<br>{<br>LazyInitializer.EnsureInitialized(ref _expensive, () &#x3D;&gt; new Expensive());<br>return _expensive;<br>}<br>}<br>}</p>
<ul>
<li>å¯ä»¥å‚³å¦ä¸€å€‹åƒæ•¸åšthread raceçš„åˆå§‹åŒ–, æœ€çµ‚åªæœƒæœ‰1å€‹threadå–å¾—1å€‹ç‰©ä»¶. é€™ç¨®ä½œæ³•å¥½è™•æ˜¯æ¯”èµ·Double-checked lockingé‚„è¦å¿«, å› ç‚ºå®ƒä¸éœ€è¦lock.</li>
<li>ä½†thread raceçš„åˆå§‹åŒ–å¾ˆå°‘æœƒç”¨åˆ°, ä¸”å®ƒæœ‰ä¸€äº›ç¼ºé»:</li>
</ul>
<ol>
<li>å¦‚æœæœ‰å¤šå€‹threadç«¶çˆ­, æ•¸é‡æ¯”CPU coreé‚„å¤š, æœƒæ¯”è¼ƒæ…¢</li>
<li>æ½›åœ¨å¾—æµªè²»CPUè³‡æºåšé‡è¤‡çš„åˆå§‹åŒ–</li>
<li>åˆå§‹åŒ–çš„é‚è¼¯å¿…é ˆæ˜¯thread-safe, æ¯”å¦‚å‰è¿°Expensiveçš„Constructor, æœ‰staticè®Šæ•¸è¦å¯«å…¥çš„è©±, å°±å¯èƒ½æ˜¯thread-unsafe</li>
<li>initializerå°ç‰©ä»¶çš„åˆå§‹åŒ–éœ€è¦disposeæ™‚, è€Œæ²’æœ‰é¡å¤–çš„é‚è¼¯å°±ç„¡æ³•å°æµªè²»çš„ç‰©ä»¶åšdispose</li>
</ol>
<ul>
<li>double-checked lockingçš„åƒè€ƒå¯«æ³•:</li>
</ul>
<p>volatile Expensive _expensive;<br>public Expensive Expensive<br>{<br>  get<br>  {<br>    if (_expensive &#x3D;&#x3D; null)             &#x2F;&#x2F; First check (outside lock)<br>      lock (_expenseLock)<br>        if (_expensive &#x3D;&#x3D; null)         &#x2F;&#x2F; Second check (inside lock)<br>          _expensive &#x3D; new Expensive();<br>    return _expensive;<br>  }<br>}</p>
<ul>
<li>race-to-initializeçš„åƒè€ƒå¯«æ³•:</li>
</ul>
<p>volatile Expensive _expensive;<br>public Expensive Expensive<br>{<br>  get<br>  {<br>    if (_expensive &#x3D;&#x3D; null)<br>    {<br>      var instance &#x3D; new Expensive();<br>      Interlocked.CompareExchange (ref _expensive, instance, null);<br>    }<br>    return _expensive;<br>  }<br>}</p>
<h3 id="Thread-Local-Storage"><a href="#Thread-Local-Storage" class="headerlink" title="Thread-Local Storage"></a>Thread-Local Storage</h3><ul>
<li>Threadæ“æœ‰è‡ªå·±ç¨ç«‹çš„è³‡æ–™, åˆ¥çš„Threadç„¡æ³•å­˜å–</li>
<li>æœ‰3ç¨®thread-local storageçš„å¯¦ä½œ</li>
</ul>
<h4 id="ThreadStatic"><a href="#ThreadStatic" class="headerlink" title="[ThreadStatic]"></a>[ThreadStatic]</h4><ul>
<li>å°1å€‹staticçš„fieldåŠ ä¸ŠThreadStaticå±¬æ€§, å› æ­¤æ¯å€‹threadå­˜å–è©²è®Šæ•¸éƒ½æ˜¯ç¨ç«‹çš„</li>
<li>ç¼ºé»æ˜¯ä¸èƒ½ç”¨åœ¨instanceçš„è®Šæ•¸, ä¸”å®ƒåªæœ‰åœ¨ç¬¬1å€‹threadå­˜å–å®ƒæ™‚æ‰åˆå§‹åŒ–å€¼ä¸€æ¬¡, å› æ­¤å…¶ä»–threadä¸€é–‹å§‹éƒ½æ‹¿åˆ°é è¨­å€¼.</li>
<li>ä»¥ä¸‹ç¯„ä¾‹æ˜¯å¦å¤–å»º2å€‹threadå°ThreadStaticè®Šæ•¸_xå„è‡ªä¿®æ”¹å€¼ä¸¦è¼¸å‡º. Static constructoråœ¨ç¨‹å¼å‰›å•Ÿå‹•ä»¥Main ThreadåŸ·è¡Œ, å› æ­¤åˆå§‹åŒ–çš„å€¼5åªæœ‰çµ¦Main Thread, è€Œt1å’Œt2çš„_xå€¼æ˜¯0. åœ¨Sleep 2ç§’å¾Œ, Main threadçš„_xå€¼ä»æ˜¯ 5 .</li>
</ul>
<p>using System;<br>using System.Threading;<br>namespace ThreadStaticTest<br>{<br>    class Program<br>    {<br>        [ThreadStatic] static int _x;<br>        static Program()<br>        {<br>            _x &#x3D; 5;<br>        }<br>        static void Main(string[] args)<br>        {<br>            Thread t1 &#x3D; new Thread(() &#x3D;&gt; {<br>                Console.WriteLine(â€œt1 before: â€œ + _x);<br>                _x &#x3D; 666;<br>                Console.WriteLine(â€œt1 after: â€œ + _x);<br>            });</p>
<pre><code>        Thread t2 = new Thread(() =&gt; &#123;
            Console.WriteLine(&quot;t2 before: &quot; + \_x);
            \_x = 777;
            Console.WriteLine(&quot;t2 after: &quot; + \_x);
        &#125;);

        t1.Start();
        t2.Start();
        Thread.Sleep(2000);
        Console.WriteLine(\_x);
        Console.ReadLine();
    &#125;
&#125;
</code></pre>
<p>}</p>
<h4 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal<T></h4><ul>
<li>åœ¨Net Framework 4.0æ¨å‡º, èƒ½å°static å’Œ instanceçš„fieldæŒ‡å®šé è¨­å€¼</li>
<li>ç”¨ThreadLocalå»ºç«‹çš„å€¼, è¦å­˜å–æ™‚ä½¿ç”¨å®ƒçš„Value property</li>
<li>ThreadLocalæœ‰ä½¿ç”¨Lazyå­˜å–, å› æ­¤æ¯å€‹Threadå†å­˜å–æ™‚æœƒåšLazyçš„è¨ˆç®—</li>
<li>å¦‚ä¸‹é¢ç¯„ä¾‹, æ¯å€‹Threadçš„_xåˆå§‹å€¼éƒ½æ˜¯3</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace ThreadLocalTest<br>{<br>    class Program<br>    {<br>        static ThreadLocal<int> _x &#x3D; new ThreadLocal<int> (() &#x3D;&gt; 3);<br>        static void Main(string[] args)<br>        {<br>            Console.WriteLine(â€œHello World!â€);</p>
<pre><code>        Thread t1 = new Thread(() =&gt; &#123;
            Console.WriteLine(&quot;t1 before: &quot; + \_x);
            \_x.Value = 666;
            Console.WriteLine(&quot;t1 after: &quot; + \_x);
        &#125;);

        Thread t2 = new Thread(() =&gt; &#123;
            Console.WriteLine(&quot;t2 before: &quot; + \_x);
            \_x.Value = 777;
            Console.WriteLine(&quot;t2 after: &quot; + \_x);
        &#125;);

        t1.Start();
        t2.Start();
        Thread.Sleep(2000);
        Console.WriteLine(\_x);
        Console.ReadLine();
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>å¦‚æœæ˜¯å»ºç«‹instance field, ç”¨Randomä½œç‚ºç¯„ä¾‹, Randomé¡åˆ¥æ˜¯thread-unsafe, å› æ­¤åœ¨multi-threadçš„ç’°å¢ƒä½¿ç”¨lockä¹‹å¤–, å¯ä»¥ç”¨ThreadLocalå»ºç«‹å±¬æ–¼å„threadçš„ç¨ç«‹ç‰©ä»¶, å¦‚ä¸‹ç¯„ä¾‹:</li>
</ul>
<p>var localRandom &#x3D; new ThreadLocal<Random>(() &#x3D;&gt; new Random());<br>Console.WriteLine (localRandom.Value.Next());</p>
<ul>
<li>å‰é¢Randomæœ¬èº«æœ‰å°ç¼ºé™·, å¦‚æœmulti-threadåœ¨ç›¸å·®10msä¹‹é–“éƒ½å°Randomå–å€¼, å¯èƒ½æœƒå–åˆ°ç›¸åŒçš„å€¼, å› æ­¤å¯ä»¥æ”¹è‰¯å¸¶å…¥ä¸€äº›éš¨æ©Ÿåƒæ•¸åšåˆå§‹åŒ–:</li>
</ul>
<p>var localRandom &#x3D; new ThreadLocal<Random><br> ( () &#x3D;&gt; new Random (Guid.NewGuid().GetHashCode()) );</p>
<h4 id="GetData-and-SetData"><a href="#GetData-and-SetData" class="headerlink" title="GetData and SetData"></a>GetData and SetData</h4><ul>
<li>æŠŠè³‡æ–™å­˜åœ¨LocalDataStoreSlot, è€Œé€™slotå¯ä»¥è¨­å®šåç¨±æˆ–è€…ä¸å‘½å</li>
<li>ç”±Threadçš„GetNamedDataSlotæ–¹æ³•è¨­å®šæœ‰åç¨±çš„slot, è€ŒAllocateDataSlotæ–¹æ³•å–å¾—ä¸å‘½åçš„slot</li>
<li>Threadçš„FreeNamedDataSlotæ–¹æ³•æœƒé‡‹æ”¾æœ‰ç‰¹å®šåç¨±çš„slotèˆ‡æ‰€æœ‰threadçš„é—œè¯, ä½†åŸæœ¬çš„slotç‰©ä»¶ä»å¯ä»¥å­˜å–è©²è³‡æ–™</li>
<li>ä»¥ä¸‹ç¯„ä¾‹æ˜¯å»ºç«‹åç¨±ç‚ºNameçš„slotå’Œä¸å‘½åçš„slot, åˆ†åˆ¥æ˜¯å­˜å­—ä¸²MyNameå’Œæ•´æ•¸å€¼MyNum. Main Threadå’Œå¦å¤–å»ºç«‹çš„t1 t2 thread, å°MyNameèˆ‡MyNuméƒ½æ˜¯ç¨ç«‹çš„å€¼. æœ€å¾Œåœ¨å‘¼å«FreeNamedDataSlotä¹‹å‰, å¾Nameå–slotçš„å€¼ä»æ˜¯â€Main nameâ€, ä½†å‘¼å«FreeNamedDataSlotå¾Œ, å¾Nameå–slotçš„å€¼è®Šæˆnull.</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace TestLocalDataStoreSlot<br>{<br>    class Program<br>    {<br>        static LocalDataStoreSlot _nameSlot &#x3D; Thread.GetNamedDataSlot(â€œNameâ€);<br>        static LocalDataStoreSlot _numSlot &#x3D; Thread.AllocateDataSlot();</p>
<pre><code>    static string MyName
    &#123;
        get
        &#123;
            object data = Thread.GetData(\_nameSlot);
            return data == null ? string.Empty : (string)data;
        &#125;

        set
        &#123;
            Thread.SetData(\_nameSlot, value);
        &#125;
    &#125;

    static int MyNum
    &#123;
        get
        &#123;
            object data = Thread.GetData(\_numSlot);
            return data == null ? -1 : (int)data;
        &#125;

        set
        &#123;
            Thread.SetData(\_numSlot, value);
        &#125;
    &#125;

    static void Main(string\[\] args)
    &#123;
        Thread t1 = new Thread(() =&gt;
        &#123;
            Console.WriteLine(&quot;t1 before name: &quot; + MyName);
            MyName = &quot;T1!&quot;;
            Console.WriteLine(&quot;t1 after name: &quot; + MyName);

            Console.WriteLine(&quot;t1 before num: &quot; + MyNum);
            MyNum = 555;
            Console.WriteLine(&quot;t1 after num: &quot; + MyNum);
        &#125;);

        Thread t2 = new Thread(() =&gt;
        &#123;
            Console.WriteLine(&quot;t2 before name: &quot; + MyName);
            MyName = &quot;T2?&quot;;
            Console.WriteLine(&quot;t2 after name: &quot; + MyName);

            Console.WriteLine(&quot;t2 before num: &quot; + MyNum);
            MyNum = 777;
            Console.WriteLine(&quot;t2 after num: &quot; + MyNum);
        &#125;);

        t1.Start();
        t2.Start();

        Console.WriteLine(&quot;Main before name: &quot; + MyName);
        MyName = &quot;Main name&quot;;
        Console.WriteLine(&quot;Main after name: &quot; + MyName);



        Console.WriteLine(&quot;Main before num: &quot; + MyNum);
        MyNum = 12345678;
        Console.WriteLine(&quot;Main after num: &quot; + MyNum);

        Console.ReadLine();

        string s1 = Thread.GetData(Thread.GetNamedDataSlot(&quot;Name&quot;)) as string;
        Console.WriteLine(&quot;Main before clear: &quot; + s1);

        Thread.FreeNamedDataSlot(&quot;Name&quot;);

        string s2 = Thread.GetData(Thread.GetNamedDataSlot(&quot;Name&quot;)) as string;
        Console.WriteLine(&quot;Main after clear: &quot; + s2);

        Console.ReadLine();
    &#125;
&#125;
</code></pre>
<p>}</p>
<h3 id="Timers"><a href="#Timers" class="headerlink" title="Timers"></a>Timers</h3><ul>
<li>Timerå¯æä¾›æŸäº›å·¥ä½œåšé€±æœŸæ€§çš„åŸ·è¡Œ</li>
<li>åœ¨ä¸ç”¨Timerçš„å¯«æ³•å¦‚ä¸‹, ç¼ºé»æ˜¯æœƒç¶ä½Threadçš„è³‡æº, ä¸”DoSomeActionçš„ä»»å‹™å°‡é€æ¼¸å»¶é²åŸ·è¡Œ</li>
</ul>
<p>new Thread (delegate() {<br>                         while (enabled)<br>                         {<br>                           DoSomeAction();<br>                           Thread.Sleep (TimeSpan.FromHours (24));<br>                         }<br>                       }).Start();</p>
<ul>
<li>Netæä¾›4ç¨®Timer, å…¶ä¸­2ç¨®æ˜¯ä¸€èˆ¬æ€§çš„multi-thread timer:</li>
</ul>
<ol>
<li>System.Threading.Timer</li>
<li>System.Timers.Timer</li>
</ol>
<ul>
<li>Single-thread timer:</li>
</ul>
<ol>
<li>System.Windows.Forms.Timer (Windows Form timer)</li>
<li>System.Windows.Threading.DispatcherTimer (WPF timer)</li>
</ol>
<ul>
<li>multi-thread timerèƒ½æ›´ç²¾æº–ã€å½ˆæ€§, è€Œsingle-thread timeræ˜¯å®‰å…¨ã€æ–¹ä¾¿çš„åŸ·è¡Œç°¡å–®ä»»å‹™, æ¯”å¦‚æ›´æ–°Wiform &#x2F; WPF çš„å…ƒä»¶</li>
</ul>
<h4 id="Multithreaded-Timers"><a href="#Multithreaded-Timers" class="headerlink" title="Multithreaded Timers"></a>Multithreaded Timers</h4><ul>
<li>System.Threading.Timeræ˜¯æœ€ç°¡å–®çš„multi-thread timer</li>
<li>å¯ä»¥å‘¼å«Changeæ–¹æ³•ä¾†æ”¹è®ŠåŸ·è¡Œçš„æ™‚é–“</li>
<li>ä»¥ä¸‹ç¯„ä¾‹æ˜¯å»ºç«‹Timer, ç­‰5ç§’å¾Œæ‰é–‹å§‹åšä»»å‹™, æ¯å€‹ä»»å‹™é–“éš”1ç§’.</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace ThreadingTImer<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            Timer tmr &#x3D; new Timer(Tick, â€œtickâ€¦â€, 5000, 1000);<br>            Console.ReadLine();<br>            tmr.Dispose();<br>        }</p>
<pre><code>    static void Tick(object data)
    &#123;
        Console.WriteLine(data);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>å¦ä¸€å€‹System.Timersçš„Timer, æ˜¯åŸºæ–¼System.Threading.Timerçš„åŒ…è£, ä¸»è¦å¢åŠ çš„åŠŸèƒ½æœ‰:</li>
</ul>
<ol>
<li>å¯¦ä½œComponent, å¯ç”¨åœ¨Visual Studioâ€™s designer</li>
<li>ä¸ä½¿ç”¨Change, æ”¹æˆInterval property</li>
<li>ä¸ä½¿ç”¨ç›´æ¥çš„å§”è¨—, è€Œæ˜¯Elapsedevent</li>
<li>ç”¨Enabledä¾†å•Ÿç”¨æˆ–åœæ­¢timer</li>
<li>å¦‚æœå°Enabledæ„Ÿåˆ°ç–‘æƒ‘, æ”¹ç”¨Startå’ŒStopæ–¹æ³•</li>
<li>AutoResetä»£è¡¨è‘—é‡è¤‡åŸ·è¡Œçš„äº‹ä»¶</li>
<li>SynchronizingObject propertyå¯ä»¥å‘¼å«Invokeå’ŒBeginInvokeæ–¹æ³•, å¯ä»¥å®‰å…¨å‘¼å«WPF &#x2F; Winformçš„å…ƒä»¶</li>
</ol>
<ul>
<li>ä»¥ä¸‹æ˜¯System.Timers.Timerçš„ç¯„ä¾‹, æ¯0.5ç§’åŸ·è¡Œä»»å‹™, é€éStartå’ŒStopå•Ÿç”¨å’Œåœæ­¢timer.</li>
</ul>
<p>using System;<br>using System.Timers;</p>
<p>namespace TimersTimer<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            Timer tmr &#x3D; new Timer();<br>            tmr.Interval &#x3D; 500;<br>            tmr.Elapsed +&#x3D; tmr_Elapsed;<br>            tmr.Start();<br>            Console.ReadLine();<br>            tmr.Stop();<br>            Console.ReadLine();<br>            tmr.Start();<br>            Console.ReadLine();<br>            tmr.Dispose();<br>        }</p>
<pre><code>    private static void tmr\_Elapsed(object sender, ElapsedEventArgs e)
    &#123;
        Console.WriteLine(&quot;Tick&quot;);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>Multi-thread timeræ˜¯å¾thread poolçš„å°‘é‡threadä¾†æ”¯æ´timer, ä¹Ÿä»£è¡¨æ¯æ¬¡åŸ·è¡Œçš„å§”è¨—ä»»å‹™, éƒ½å¯èƒ½ç”±ä¸åŒçš„threadä¾†åŸ·è¡Œ.</li>
<li>Elapsedäº‹ä»¶å¹¾ä¹æ˜¯å¾ˆæº–æ™‚çš„åŸ·è¡Œ, ä¸ç®¡å‰ä¸€æ®µæ™‚é–“çš„ä»»å‹™åŸ·è¡Œå®Œç•¢èˆ‡å¦, å› æ­¤å§”è¨—çµ¦å®ƒçš„ä»»å‹™å¿…é ˆæ˜¯thread-safe</li>
<li>Multi-thread timerçš„ç²¾æº–åº¦æ˜¯åŸºæ–¼ä½œæ¥­ç³»çµ± èª¤å·®ç´„10~20ms, å¦‚æœè¦æ›´ç²¾æº–, éœ€è¦ä½¿ç”¨native interopä¾†å‘¼å«Windows multimedia timer, èª¤å·®å¯é™è‡³1ms. é€™interopå®šç¾©åœ¨winmm.dll. ä½¿ç”¨winmm.dllçš„ä¸€èˆ¬æµç¨‹:</li>
</ul>
<ol>
<li>å‘¼å«timeBeginPeriod, é€šçŸ¥ä½œæ¥­ç³»çµ±éœ€è¦é«˜ç²¾åº¦çš„timing</li>
<li>å‘¼å«timeSetEventå•Ÿç”¨timer</li>
<li>ä»»å‹™å®Œæˆå¾Œ, å‘¼å«timeKillEventåœæ­¢timer</li>
<li>å‘¼å«timeEndPeriod, é€šçŸ¥ä½œæ¥­ç³»çµ±ä¸å†éœ€è¦é«˜ç²¾åº¦çš„timing</li>
</ol>
<ul>
<li>æœå°‹ [dllimport winmm.dll timesetevent] èƒ½æ‰¾åˆ°winmm.dllçš„ç¯„ä¾‹</li>
</ul>
<h4 id="Single-Threaded-Timers"><a href="#Single-Threaded-Timers" class="headerlink" title="Single-Threaded Timers"></a>Single-Threaded Timers</h4><ul>
<li>Single-thread timeræ˜¯ç”¨ä¾†åœ¨WPFæˆ–Winform, å¦‚æœæ‹¿åˆ°åˆ¥çš„æ‡‰ç”¨ç¨‹å¼, å‰‡é‚£å€‹timerå°‡ä¸æœƒè§¸ç™¼</li>
<li>Winform &#x2F; WPFçš„timerä¸¦ä¸æ˜¯åŸºæ–¼thread pool, è€Œæ˜¯ç”¨User interface modelçš„message pumpingæŠ€è¡“. ä¹Ÿå°±æ˜¯Timerè§¸ç™¼çš„ä»»å‹™éƒ½æœƒæ˜¯åŒä¸€å€‹thread, è€Œé‚£threadæ˜¯ä¸€é–‹å§‹å»ºç«‹timerçš„thread.</li>
<li>ä½¿ç”¨single-thread timerçš„å¥½è™•:</li>
</ul>
<ol>
<li>å¿˜è¨˜thread-safeçš„å•é¡Œ</li>
<li>TimeråŸ·è¡Œçš„ä»»å‹™(Tick), å¿…é ˆå‰ä¸€å€‹ä»»å‹™å®Œæˆæ‰æœƒè§¸ç™¼ä¸‹ä¸€å€‹</li>
<li>ä¸éœ€è¦å‘¼å«å…ƒä»¶çš„Invoke, èƒ½ç›´æ¥åœ¨Tickå§”è¨—ä»»å‹™åŸ·è¡Œæ›´æ–°UIå…ƒä»¶çš„åŠŸèƒ½</li>
</ol>
<ul>
<li>å› ç‚ºsingle-threadçš„é™åˆ¶, å¸¶ä¾†çš„ç¼ºé»æ˜¯:</li>
</ul>
<ol>
<li>é™¤éTickä»»å‹™åŸ·è¡Œåœ°å¾ˆå¿«, å¦å‰‡UIå°‡æœƒæ²’è¾¦æ³•åæ‡‰</li>
</ol>
<ul>
<li>WPF &#x2F; Winformçš„timeråªé©åˆç°¡å–®çš„ä»»å‹™, å¦å‰‡éœ€è¦æ¡ç”¨multi-thread timer.</li>
<li>Single-threadçš„timerçš„ç²¾æº–åº¦å’Œmulti-thread timerå·®ä¸å¤š, æœƒæœ‰å¹¾åmsçš„å·®ç•°. è€Œæœƒå› ç‚ºUIçš„requestæˆ–å…¶ä»–timerçš„äº‹ä»¶è€Œé€ æˆæ›´ä¸æº–ç¢º.</li>
</ul>
<h3 id="Threading-in-C-åƒè€ƒè³‡æ–™"><a href="#Threading-in-C-åƒè€ƒè³‡æ–™" class="headerlink" title="Threading in C# åƒè€ƒè³‡æ–™"></a>Threading in C# åƒè€ƒè³‡æ–™</h3><ol>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3lQcLky">C# 9.0 in a Nutshell: The Definitive Reference, Joseph Albahari (Amazon)</a></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/threading-in-csharp-series-book-summary/">Threading in C# ç³»åˆ—çš„è®€æ›¸ç­†è¨˜</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/05/threading-in-csharp-part-2-basic-synchronization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/05/threading-in-csharp-part-2-basic-synchronization/" class="post-title-link" itemprop="url">Threading in C# - BASIC SYNCHRONIZATION</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-05 14:04:00" itemprop="dateCreated datePublished" datetime="2021-12-05T14:04:00+08:00">2021-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Thread/" itemprop="url" rel="index"><span itemprop="name">Thread</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/" itemprop="url" rel="index"><span itemprop="name">è®€æ›¸ç­†è¨˜</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Threading-in-C-PART-2-BASIC-SYNCHRONIZATION"><a href="#Threading-in-C-PART-2-BASIC-SYNCHRONIZATION" class="headerlink" title="Threading in C# - PART 2: BASIC SYNCHRONIZATION"></a>Threading in C# - PART 2: BASIC SYNCHRONIZATION</h3><p>é€™ç¯‡æ–‡ç« ç‚ºé–±è®€ Threading in C# ç³»åˆ—çš„Part 2ç­†è¨˜.</p>
<h3 id="Threading-Synchronization-Essentials"><a href="#Threading-Synchronization-Essentials" class="headerlink" title="Threading - Synchronization Essentials"></a>Threading - Synchronization Essentials</h3><ul>
<li>åŒæ­¥çš„çµæ§‹åˆ†4ç¨®:</li>
</ul>
<ol>
<li>Simple blocking methods: åƒæ˜¯Sleep, Join, Task.Waitç­‰</li>
<li>Locking constructs: é™åˆ¶æ•¸å€‹Threadåšå¾ŒçºŒæ“ä½œ, Excluseive lockingåªæœ‰ä¸€å€‹thread, æ¯”å¦‚lock(Monitor.Enter, Monitor.Exit), Mutex å’Œ SpinLock. è€ŒNonexclusive lockingåƒæ˜¯Semaphore, SemaphoreSlim å’Œ reader&#x2F;writer locks</li>
<li>Signaling constructs: Threadå¯ä»¥æš«åœ, ç›´åˆ°æ”¶åˆ°é€šçŸ¥æ‰æ¢å¾©, é€™å¯é¿å…æ²’æ•ˆç‡çš„è¼ªè©¢. æ¯”å¦‚ç”¨ event wait handler, Monitorçš„Wait&#x2F;Pulse, CountdownEventå’ŒBarrier</li>
<li>Nonblocking synchronization constructs: Thread.MemoryBarrier, Thread.VolatileRead, Thread.VolatileWrite, volatileé—œéµå­— å’Œ Interlockedé¡åˆ¥</li>
</ol>
<h4 id="Blocking"><a href="#Blocking" class="headerlink" title="Blocking"></a>Blocking</h4><ul>
<li>ç­‰å¾…ã€Sleepç­‰æœƒè®“threadæš«åœ, æŠŠtime sliceé‚„çµ¦CPU.</li>
<li>å¯ç”¨ThreadStateæª¢æŸ¥æ˜¯å¦Blocked</li>
</ul>
<p>bool blocked &#x3D; (someThread.ThreadState &amp; ThreadState.WaitSleepJoin) !&#x3D; 0</p>
<ul>
<li>ç•¶Threadç™¼ç”Ÿblock æˆ– unblock, éƒ½æœƒé€ æˆ Context Switch</li>
<li>unblockçš„è§¸ç™¼æ¢ä»¶:</li>
</ul>
<ol>
<li>blockingæ¢ä»¶å·²æ»¿è¶³</li>
<li>operation timing out(æœ‰æŒ‡å®štimeoutçš„æ™‚å€™)</li>
<li>è¢«interrupt</li>
<li>è¢«aborted</li>
</ol>
<h4 id="Blocking-Versus-Spinning"><a href="#Blocking-Versus-Spinning" class="headerlink" title="Blocking Versus Spinning"></a>Blocking Versus Spinning</h4><ul>
<li>ç”¨loopä¸€ç›´æŸ¥è©¢æŸæ¢ä»¶, é€ æˆCPUæ¶ˆè€—å¾ˆå¤§çš„é‹ç®—è³‡æº</li>
<li>ä¸€ç¨®æ¯”è¼ƒå¥½ä¸€é»çš„å¯«æ³•æ˜¯, åœ¨loopå…§åŠ å€‹Thread.Sleep</li>
<li>å¦‚æœè¦ç”¨Spinningçš„å¯«æ³•, ä¸€ç¨®æ˜¯ä¿è­‰è©²æ¢ä»¶å¾ˆå¿«å°±æ»¿è¶³çš„é‹ç®—, å¦å¤–ä¸€ç¨®æ˜¯ç”¨SpinLock&#x2F;SpinWait</li>
</ul>
<h4 id="ThreadState"><a href="#ThreadState" class="headerlink" title="ThreadState"></a>ThreadState</h4><p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/wp-content/uploads/2022/01/image-11.png"><img src="https://geekcodeparadise.com/wp-content/uploads/2022/01/image-11.png"></a></p>
<ul>
<li>ThreadStateå¯ä»¥æª¢æŸ¥Threadçš„ç‹€æ…‹</li>
</ul>
<h3 id="Locking"><a href="#Locking" class="headerlink" title="Locking"></a>Locking</h3><ul>
<li>å€åˆ† thread-safeå’Œthread-unsafeçš„ç¨‹å¼ç¢¼, é€šå¸¸æ˜¯æœ‰staticè®Šæ•¸, å¦‚æœæœ‰å¤šå€‹threadå­˜å–æ™‚æœƒä¸æœƒéŒ¯èª¤</li>
<li>æœ€ç°¡å–®çš„æ–¹å¼æ˜¯ç”¨locké—œéµå­—åšåŒæ­¥åŒ–, ç¶ä½æŸå€‹åŒæ­¥åŒ–ç‰©ä»¶, åªå…è¨±ä¸€å€‹threadæ“ä½œ, å…¶ä»–çš„threadè®Šæˆblockedç‹€æ…‹, ä¸”ä¾ç…§queueçš„é †åºä¾†æ’éšŠ</li>
</ul>
<h4 id="A-Comparison-of-Locking-Constructs"><a href="#A-Comparison-of-Locking-Constructs" class="headerlink" title="A Comparison of Locking Constructs"></a>A Comparison of Locking Constructs</h4><ul>
<li>ä¸‹è¡¨çš„overheadæ˜¯æŒ‡å°ä¸€å€‹threadåšblockå’Œunblockçš„æ™‚é–“</li>
</ul>
<p>Construct</p>
<p>Purpose</p>
<p>Cross-Process ?</p>
<p>Overhead</p>
<p>lock (Monitor.Enter &#x2F; Monitor.Exit)</p>
<p>ç¢ºä¿åªæœ‰ä¸€å€‹Threadèƒ½å­˜å–è³‡æºæˆ–ä¸€æ®µcode</p>
<p>Â </p>
<p>20 ns</p>
<p>Mutext</p>
<p>åŒlock</p>
<p>Yes</p>
<p>1000 ns</p>
<p>SemaphoreSlim</p>
<p>ç¢ºä¿æŒ‡å®šæ•¸é‡çš„threadèƒ½å­˜å–è³‡æºæˆ–ä¸€æ®µcode</p>
<p>Â </p>
<p>200 ns</p>
<p>Semaphore</p>
<p>åŒSemaphore</p>
<p>Yes</p>
<p>1000 ns</p>
<p>ReaderWriterLockSlim</p>
<p>å…è¨±å¤šå€‹readerèƒ½èˆ‡ä¸€å€‹writerå…±å­˜</p>
<p>Â </p>
<p>40 ns</p>
<p>ReaderWriterLock</p>
<p>åŒReaderWriterLockSlim</p>
<p>Â </p>
<p>100 ns</p>
<h4 id="Monitor-Enter-and-Monitor-Exit"><a href="#Monitor-Enter-and-Monitor-Exit" class="headerlink" title="Monitor.Enter and Monitor.Exit"></a>Monitor.Enter and Monitor.Exit</h4><ul>
<li>lock &#x3D; Monitor.Enter + Monitor.Exit + try&#x2F;finally</li>
</ul>
<p>try<br>{<br>    DoSomething();<br>}<br>finally<br>{<br>    Monitor.Exit(_locker);<br>}</p>
<ul>
<li>ä¸Šé¢å¯«æ³•æœƒæœ‰bug, å¦‚æœåœ¨Enterå’Œtryä¹‹é–“ç™¼ç”Ÿexception (æ¯”å¦‚threadè¢«Abortæˆ–è¨˜æ†¶é«”æº¢å‡º), å‰‡æ°¸é ä¸é‡‹æ”¾è©²locker</li>
<li>æ›´å¥½çš„å¯«æ³•æ˜¯åœ¨tryå…§ç”¨Enter, ä¸”ä»£å…¥boolçš„è®Šæ•¸, ç”¨ä¾†åˆ¤æ–·æ˜¯å¦lockæˆåŠŸ, æˆåŠŸçš„è©±å¯ä»¥å‘¼å«Exit</li>
</ul>
<p>bool lockTaken &#x3D; false;<br>try<br>{<br>Monitor.Enter(_locker, ref lockTaken)<br>}<br>finally<br>{<br>if(lockTaken)<br>{<br>Monitor.Exit(_locker);<br>}<br>}</p>
<ul>
<li>é‚„æœ‰å€‹TryEnter, å¯ä»¥ä»£å…¥timeout, å¦‚æœå›å‚³trueä»£è¡¨lockæˆåŠŸ, å¦‚æœå›å‚³falseä»£è¡¨lockéç¨‹è¶…æ™‚</li>
</ul>
<h4 id="Choosing-the-Synchronization-Object"><a href="#Choosing-the-Synchronization-Object" class="headerlink" title="Choosing the Synchronization Object"></a>Choosing the Synchronization Object</h4><ul>
<li>å¿…é ˆæ˜¯reference typeçš„ç‰©ä»¶</li>
<li>ä¸€èˆ¬æ˜¯privateçš„ç‰©ä»¶, åšé‚è¼¯å°è£</li>
<li>ç²¾æº–çš„lockæœƒç”¨å°ˆé–€çš„lockerç‰©ä»¶</li>
<li>lock(this)æˆ–lock(typeof(SomeClass)), å¾ˆé›£é é˜²æ­»çµå’Œéå¤šçš„blocking</li>
</ul>
<h4 id="When-to-Lock"><a href="#When-to-Lock" class="headerlink" title="When to Lock"></a>When to Lock</h4><ul>
<li>åŸºæœ¬çš„è¦å‰‡æ˜¯, lockåœ¨å­˜å–å¯å¯«çš„å…±äº«ç‰©ä»¶</li>
<li>Thread safeèˆ‡unsafeçš„å¯«æ³•</li>
</ul>
<p>class ThreadUnsafe<br>{<br>static int _x;<br>static void Increment() { ++_x; }<br>static void Assign() { _x &#x3D; 123; }<br>}</p>
<p>class ThreadSafe<br>{<br>static readonly object _locker &#x3D; new object();<br>static int _x;<br>static void Increment() { lock(_locker) { ++_x; }}<br>static void Assign() { lock(_locker) { _x &#x3D; 123; }}<br>}</p>
<ul>
<li>non-blockingçš„åŒæ­¥åŒ–, å¾ŒçºŒæœ‰memory-barrierså’ŒInterlockedå¯ç”¨</li>
</ul>
<h4 id="Locking-and-Atomicity"><a href="#Locking-and-Atomicity" class="headerlink" title="Locking and Atomicity"></a>Locking and Atomicity</h4><ul>
<li>æœ‰ä¸€çµ„è®Šæ•¸, å¯«è·Ÿè®€ç¸½æ˜¯åœ¨åŒä¸€å€‹lock, å‰‡ç¨±å®ƒå€‘æ˜¯Atomic</li>
<li>æ¯”å¦‚ä¸‹é¢xèˆ‡yçš„é™¤æ³•ç¯„ä¾‹</li>
</ul>
<p>lock (_locker)<br>{<br>if(x!&#x3D;0)<br>y &#x2F;&#x3D; x;<br>}</p>
<ul>
<li>æœ‰æ™‚æœƒæœ‰ç ´å£atomicityçš„bug, æ¯”å¦‚æœ‰å‘¼å«å…¶ä»–å‡½å¼é€ æˆexception, ä½¿æŸäº›è®Šæ•¸æ²’å®Œæ•´è¨ˆç®—å®Œ</li>
<li>å»ºè­°å…¶ä»–å‡½å¼å…ˆé‹ç®—å®Œå†æŠŠå®ƒçš„å€¼å¸¶å…¥åˆ°lock, æˆ–è€…tryçš„catch&#x2F;finallyåšrollback</li>
</ul>
<h4 id="Nested-Locking"><a href="#Nested-Locking" class="headerlink" title="Nested Locking"></a>Nested Locking</h4><ul>
<li>lockå¯ä»¥å·¢ç‹€åŒ…è£</li>
<li>é©ç”¨æ–¼lockçš„å…§å®¹, æœ‰callå…¶ä»–çš„å‡½å¼, é€™äº›å‡½å¼å¯¦ä½œå†åŠ ä¸Šlock</li>
</ul>
<h4 id="Deadlocks"><a href="#Deadlocks" class="headerlink" title="Deadlocks"></a>Deadlocks</h4><ul>
<li>ç•¶å…©å€‹threadéƒ½æŒæ¡å°æ–¹çš„è³‡æºä¸”ç­‰å¾…å°æ–¹é‡‹æ”¾, æ²’ä»»ä½•é€²å±•å°±æ˜¯æ­»çµ</li>
<li>åŸºæœ¬çš„æ­»çµæ¡ˆä¾‹:</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class TestDeadlocks<br>{<br>    static void Main(string[] args){<br>        object locker1 &#x3D; new object();<br>        object locker2 &#x3D; new object();<br>        new Thread(() &#x3D;&gt; {<br>            lock(locker1){<br>                Thread.Sleep(1000);<br>                Console.WriteLine(â€œReady to lock 2â€);<br>                lock(locker2);<br>            }<br>        }).Start();<br>        lock(locker2){<br>            Thread.Sleep(1000);<br>            Console.WriteLine(â€œReady to lock 1â€);<br>            lock(locker1);<br>        }</p>
<pre><code>    Console.WriteLine(&quot;Hi&quot;);
    Console.Read();
&#125;
</code></pre>
<p>}</p>
<ul>
<li>æ›´è¤‡é›œçš„æ­»çµæ˜¯,Thread 1 lock è€Œå‘¼å«A classçš„Xæ–¹æ³•, Xæ–¹æ³•å‘¼å«B classçš„Y æ–¹æ³•, å¦å¤–Thread 2 lockè€Œå‘¼å«B classçš„Yæ–¹æ³•, Yæ–¹æ³•å‘¼å«A classçš„Xæ–¹æ³•.</li>
<li>è€ƒæ…®lockæ˜¯å¦è¦ç”¨åœ¨åˆ¥çš„classçš„å‡½å¼</li>
<li>ä¹‹å¾Œçš„declarative, data parallelism, immutable types å’Œ nonblock synchronizationèƒ½æ¸›å°‘lockçš„éœ€æ±‚</li>
<li>å¦ä¸€äº›å¸¸è¦‹çš„æ­»çµç™¼ç”Ÿåœ¨WPFçš„Dispatcher.Invokeæˆ–Winformçš„Control.Invoke, è§£æ³•æ˜¯ç”¨BeginInvoke</li>
</ul>
<h4 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h4><ul>
<li>åŸºæœ¬ä¸Šlockçš„é€Ÿåº¦å¾ˆå¿«</li>
<li>å¦‚æœæœ‰å¾ˆçŸ­æš«çš„lock, å¯ä»¥æ”¹ç”¨SpinLock, æ¸›å°‘Context Switch</li>
<li>Lockå¾—å¤ªä¹…, æœƒæ¸›å°‘å…±æ™‚æ€§çš„æ•ˆèƒ½; Lockä¹Ÿæ˜¯é€ æˆDeadlockçš„é¢¨éšª</li>
</ul>
<h4 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h4><ul>
<li>è·¨Processçš„lock, å¤§ç´„æ¯”lockæ…¢50å€</li>
<li>ä½¿ç”¨WaitOneåšlock, ReleaseMutex unlock, è€Œç”¨closeæˆ–disposeä¹Ÿæ˜¯release</li>
<li>Mutexèªå‡ºåŒæ¨£çš„lockæ˜¯ç”¨Name</li>
<li>å¦‚æœæ˜¯åŸ·è¡Œåœ¨Terminal Servicesç’°å¢ƒ, ä¸€èˆ¬çš„Mutexç„¡æ³•è·¨terminal server session, è¦åœ¨NameåŠ ä¸ŠGlobal å‰ç¶´å­—</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class OneAtATimePlease<br>{<br>    static void Main(string[] args){<br>        using(var mutex &#x3D; new Mutex(false, â€œtest oreillyâ€))<br>        {<br>            if(!mutex.WaitOne(TimeSpan.FromSeconds(3), false)){<br>                Console.WriteLine(â€œ another is runningâ€);<br>                Console.Read();<br>                return;<br>            }<br>            RunProgram();<br>        }<br>    }</p>
<pre><code>static void RunProgram()
&#123;
    Console.WriteLine(&quot;To exit&quot;);
    Console.Read();
&#125;
</code></pre>
<p>}</p>
<h4 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h4><ul>
<li>Semaphoreå…è¨±å¤šå€‹Threadåœ¨åŒä¸€å€æ®µåŸ·è¡Œ, è¶…éæ­¤å®¹é‡çš„threadæœƒblockç­‰å¾…</li>
<li>æŠŠSemaphoreçš„å®¹é‡è¨­ç‚º1, å°±å’Œlockèˆ‡mutexä¸€æ¨£, ä½†Semaphoreçš„Releaseæ˜¯ä»»ä½•threadéƒ½èƒ½å‘¼å«</li>
<li>SemaphoreSlimæœ‰æ›´ä½å»¶é², ä¸”èƒ½å¸¶cancellation token, ç”¨åœ¨parallel programming</li>
<li>å¦‚æœSemaphoreæœ‰çµ¦åå­—, ä¹Ÿæ˜¯èƒ½è·¨Process</li>
<li>ä¸‹é¢ç¯„ä¾‹æ˜¯æœ€å¤š3å€‹Threadé€²å…¥</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class SemaphoreClub<br>{<br>    static SemaphoreSlim _sem &#x3D; new SemaphoreSlim(3);<br>    static void Main(string[] args){<br>        for(int i &#x3D; 0 ; i &lt; 5; ++i){<br>            new Thread(Enter).Start(i);<br>        }<br>        Console.Read();<br>    }</p>
<pre><code>static void Enter(object id)
&#123;
    Console.WriteLine(id + &quot; wants to enter&quot;);
    \_sem.Wait();
    Console.WriteLine(id + &quot; is in!&quot;);
    Thread.Sleep(500 \* (int) id);
    Console.WriteLine(id + &quot; is leaving&quot;);
    \_sem.Release();
&#125;
</code></pre>
<p>}</p>
<h3 id="Thread-Safety"><a href="#Thread-Safety" class="headerlink" title="Thread Safety"></a>Thread Safety</h3><ul>
<li>ä¸€èˆ¬çš„typeå¾ˆå°‘æ˜¯Thread-safe, åŸå› æœ‰å¦‚ä¸‹:</li>
</ul>
<ol>
<li>é–‹ç™¼æ™‚è¦ç¶­è­·è©²typeæ‰€æœ‰Thread-safeæ¬„ä½</li>
<li>Thread-safetyæœ‰æ•ˆèƒ½ä¸Šçš„èŠ±è²», å³ä½¿æ²’æœ‰å¤šåŸ·è¡Œç·’ä¹Ÿå¿…è¦èŠ±è²»</li>
<li>ä½¿ç”¨Thread-safeçš„typeä¸ä¸€å®šèƒ½è®“åŸ·è¡Œç¨‹å¼thread-safe</li>
</ol>
<ul>
<li>åŸºæœ¬çš„ç”¨æ³•æ˜¯ç”¨exclusive lockå»é–å®šç‰¹å®šçš„ç¨‹å¼ç¢¼è€Œé”åˆ°thread-safe</li>
<li>å¦å¤–æ˜¯æ¸›å°‘å…±äº«è³‡æ–™, é”åˆ°ç„¡ç‹€æ…‹çš„åŠŸèƒ½, æ¯”å¦‚ASP.NET Webçš„Request, å¤§éƒ½æ˜¯ç¨è‡ªè™•ç†</li>
<li>æœ€å¾Œæ˜¯ç”¨automatic locking regimeçš„æ–¹å¼, å°classæˆ–propertyåŠ ä¸ŠContextBoundObjectå’ŒSynchronizationå±¬æ€§, å°±èƒ½è‡ªå‹•æœ‰é–çš„åŠŸèƒ½. ä½†ç¼ºé»æ˜¯æœƒç”¢ç”Ÿå¦ä¸€ç¨®æ–¹å¼çš„æ­»çµã€ä½µç™¼æ€§å·®ã€æ„å¤–é‡å…¥ç­‰å•é¡Œ. ç›¡é‡ç”¨exlusive lock.</li>
</ul>
<h4 id="Thread-Safety-and-NET-Framework-Types"><a href="#Thread-Safety-and-NET-Framework-Types" class="headerlink" title="Thread Safety and .NET Framework Types"></a>Thread Safety and .NET Framework Types</h4><ul>
<li>Enumerationæ˜¯thread-unsafeçš„è¡Œç‚º, æ‰€ä»¥å…±åŒè³‡æ–™è¦enumerationæ™‚, å…ˆå®£å‘Šä¸€å€‹localè®Šæ•¸, å†ç”¨lockçš„æ–¹å¼copy (ToList, ToArrayç­‰)åˆ°localè®Šæ•¸</li>
<li>Enumerationçš„å¦ä¸€ç¨®è§£æ³•æ˜¯reader&#x2F;writer lock</li>
</ul>
<p>class ThreadSafe<br>{<br>static List<string> _list &#x3D; new List<string>();<br>static void Main()<br>{<br>new Thread(AddItem).Start();<br>new Thread(AddItem).Start();<br>}</p>
<p>static void AddItem()<br>{<br>lock (_list) _list.Add(â€œItem â€œ + _list.Count());<br>string[] items;<br>lock (_list) items &#x3D; _list.ToArray();<br>foreach(string s in items) Console.WriteLine(s);<br>}<br>}</p>
<p><em><strong>Locking around thread-safe objects</strong></em></p>
<ul>
<li>å¦‚æœç‰©ä»¶æœ¬èº«æ˜¯thread-safe, ä½†æ˜¯å°å®ƒçš„æœ‰äº›æ“ä½œä»æ˜¯è¦lock, æ¯”å¦‚ifçš„æ•˜è¿°, æ²’æœ‰lockçš„ç‹€æ³ä¸‹, å¤šåŸ·è¡Œç·’çš„æƒ…æ³æœƒå­˜å–åˆ°åŒæ¨£çš„å€¼è€Œåšå¾ŒçºŒif blockçš„æ“ä½œ(ä¸”å¯èƒ½æœƒæ”¹å€¼).</li>
</ul>
<p><em><strong>Static members</strong></em></p>
<ul>
<li>.net frameworkè¨­è¨ˆstatic memberæ˜¯thread-safe, è€Œå¯¦ä¾‹çš„memberä¸æ˜¯. æ¯”å¦‚å–DateTime.Now, å°±ä¸éœ€è¦å»ç”¨lockä¾†å–</li>
<li>static functionä¸æ˜¯thread-safe, è¦ç¢ºèªåŠŸèƒ½å°è³‡æ–™çš„å…±äº«æ€§</li>
</ul>
<p><em><strong>Read-only thread safety</strong></em></p>
<ul>
<li>èƒ½åœ¨æ–‡ä»¶è¨»æ˜è©²collectionæ˜¯åªè®€è¨ªå•çš„thread-safe, ä¸¦è¦æ±‚ä½¿ç”¨è€…åœ¨åªè®€çš„æ–¹æ³•åšå¯«å…¥</li>
<li>å¯¦ä½œToArrayç­‰, æœ¬èº«æœƒæœ‰thread-unsafeçš„issue</li>
<li>å¦‚æœæ–‡ä»¶ç¼ºå°‘èªªæ˜, è¦æ³¨æ„æ˜¯å¦æŸäº›æ–¹æ³•æ˜¯read-only. æ¯”å¦‚Random.Next(), å…§éƒ¨å¯¦ä½œæœ‰æ›´æ–°private seed, å› æ­¤è¦ç”¨lockå–å€¼æˆ–è€…åˆ†é–‹çš„Randomç‰©ä»¶</li>
</ul>
<h4 id="Thread-Safety-in-Application-Servers"><a href="#Thread-Safety-in-Application-Servers" class="headerlink" title="Thread Safety in Application Servers"></a>Thread Safety in Application Servers</h4><ul>
<li>é€šå¸¸åƒASP.NET,WCFéƒ½æ˜¯ç¨ç«‹threadè™•ç†request, ä½†æœ‰æ™‚éœ€è¦å…±äº«è³‡æ–™, åƒcatch, æ›´æ–°å’Œå–è³‡æ–™éƒ½è¦lock, æœƒæ¸›å°‘æ•ˆèƒ½</li>
</ul>
<h4 id="Rich-Client-Applications-and-Thread-Affinity"><a href="#Rich-Client-Applications-and-Thread-Affinity" class="headerlink" title="Rich Client Applications and Thread Affinity"></a>Rich Client Applications and Thread Affinity</h4><ul>
<li>åœ¨WPFæˆ–Winform, UIçš„å…ƒä»¶æœ‰Affinityç‰¹æ€§, ä»£è¡¨å“ªå€‹threadå»ºç«‹å…ƒä»¶, é‚£å…ƒä»¶åªèƒ½è¢«é‚£threadå­˜å–.</li>
<li>æ‰€ä»¥åˆ¥çš„threadéœ€è¦marshalåŸæœ¬threadä¾†æ§åˆ¶å…ƒä»¶, æ¯”å¦‚Winformçš„Invokeæˆ–BeginInvoke, WPFçš„Invokeæˆ–BeginInvoke</li>
<li>Invokeæ˜¯åŒæ­¥æ–¹æ³•, æœƒblockç›®å‰thread; BeginInvokeæ˜¯éåŒæ­¥æ–¹æ³•, ç«‹å³å›å‚³callerè€Œmarshalçš„requestæœƒé€²åˆ°queue(å’Œkeyboard, mouseçš„äº‹ä»¶ä½¿ç”¨åŒæ¨£çš„message queue)</li>
</ul>
<p><strong><em>Worker threads versus UI threads</em></strong></p>
<ul>
<li>Rich clientæœ‰å…©å¤§thread: UI Threadå’ŒWorker Thread</li>
<li>UI Threadå°ˆé–€å»ºç«‹UIå…ƒä»¶, Worker threadä¸€èˆ¬ç”¨ä¾†åŸ·è¡Œlong-running job</li>
<li>Rich clientéƒ½æœƒæœ‰ä¸€å€‹UI Threadä¸”æ˜¯Main thread, å†ç”±å®ƒç”Ÿæˆwork thread, å¯ç›´æ¥ç”Ÿæˆæˆ–è€…ç”¨BackgroundWorker</li>
<li>Single Document Interface (SDI), åƒæ˜¯Word, æœƒæœ‰å¤šå€‹UI Thread</li>
</ul>
<h4 id="Immutable-Objects"><a href="#Immutable-Objects" class="headerlink" title="Immutable Objects"></a>Immutable Objects</h4><ul>
<li>ç‰©ä»¶èƒ½å°è£æˆè£¡é¢çš„ç‹€æ…‹ä¸èƒ½è¢«å…§éƒ¨èˆ‡å¤–éƒ¨æ”¹è®Š, ç¨±ç‚ºimmutable object. æ±ºå®šå®ƒå…§éƒ¨å€¼æ˜¯åœ¨Constructorä¸”å€¼æ˜¯Read-only. å¯æ¸›å°‘lockçš„åŸ·è¡Œæ™‚é–“.</li>
<li>ä¸‹é¢ç¯„ä¾‹æ˜¯å»ºç«‹ä¸€å€‹immutable object, åªæœ‰assignæ–°ç‰©ä»¶æ‰æœƒéœ€è¦lock, å–å€¼ä¸éœ€è¦</li>
</ul>
<p>class ProgressStatus<br>{<br>public readonly int PercentComplete;<br>public readonly string StatusMessage;<br>public ProgressStatus(int percentComplete, string statusMessage)<br>{<br>PercentComplete &#x3D; percentComplete;<br>StatusMessage &#x3D; statusMessage;<br>}<br>}</p>
<p>class Program<br>{<br>readonly object _statusLocker &#x3D; new object();<br>ProgressStatus _status;<br>void SomeFunction()<br>{<br>_status &#x3D; new ProgressStatus(50, â€œWorking on itâ€);<br>ProgressStatus statusCopy;<br>lock(_statusLocker) statusCopy &#x3D; _status;<br>int pc &#x3D; statusCopy.PercentComplete;<br>string msg &#x3D; statusCopy.StatusMessage;<br>}<br>}</p>
<ul>
<li>åœ¨int pc &#x3D; â€¦ çš„æœ€å¾Œ2è¡Œ, æœ‰éš±å«ç”¨Memory barrieråŒ…è£</li>
<li>å¾ŒçºŒä¸ä½¿ç”¨lock, é‚„æœƒæœ‰é¡¯ç¤ºMemory barrier, Interlocked.CompareExchange, spin-waitsç­‰åŠŸèƒ½å¯ç”¨</li>
</ul>
<h3 id="Threading-Signaling-with-Event-Wait-Handles"><a href="#Threading-Signaling-with-Event-Wait-Handles" class="headerlink" title="Threading - Signaling with Event Wait Handles"></a>Threading - Signaling with Event Wait Handles</h3><ul>
<li>Signalingæ˜¯æŒ‡threadæœƒä¸€ç›´ç­‰å¾…, ç›´åˆ°æ”¶åˆ°å¾åˆ¥çš„Threadç™¼çš„é€šçŸ¥</li>
<li>å’Œä¸€èˆ¬C#çš„eventä¸ç›¸é—œ</li>
<li>3ç¨®é¡å‹: AutoResetEvent, ManualResetEvent, CountdownEvent</li>
</ul>
<h4 id="A-Comparison-of-Signaling-Constructs"><a href="#A-Comparison-of-Signaling-Constructs" class="headerlink" title="A Comparison of Signaling Constructs"></a>A Comparison of Signaling Constructs</h4><ul>
<li>ä¸‹è¡¨çš„overheadæ˜¯æŒ‡å°ä¸€å€‹signalå’Œwaitçš„æ™‚é–“</li>
</ul>
<p>Construct</p>
<p>Purpose</p>
<p>Cross-Process ?</p>
<p>Overhead</p>
<p>AutoResetEvent</p>
<p>å…è¨±ä¸€å€‹threadç•¶æ”¶åˆ°singalæ™‚,åŸ·è¡Œä¸€æ¬¡unblock</p>
<p>Yes</p>
<p>1000 ns</p>
<p>ManualResetEvent</p>
<p>å…è¨±ä¸€å€‹threadç•¶æ”¶åˆ°singalæ™‚,åŸ·è¡Œç„¡é™æœŸçš„unblock (ç›´åˆ°å®ƒé‡ç½®)</p>
<p>Yes</p>
<p>1000 ns</p>
<p>ManualResetEventSlim (Net Framework 4)</p>
<p>åŒManualResetEvent</p>
<p>Â </p>
<p>40 ns</p>
<p>CountdownEvent (Net Framework 4)</p>
<p>å…è¨±ä¸€å€‹threadç•¶æ”¶åˆ°é å®šæ•¸é‡çš„singalæ™‚,åŸ·è¡Œunblock</p>
<p>Â </p>
<p>40 ns</p>
<p>Barrier (Net Framework 4)</p>
<p>å¯¦ä½œThreadåŸ·è¡Œå±éšœ</p>
<p>Â </p>
<p>80 ns</p>
<p>Wait and Pulse</p>
<p>å…è¨±ä¸€å€‹thread blockç›´åˆ°æŸæ¢ä»¶é”æˆ</p>
<p>Â </p>
<p>120 ns for a Pulse</p>
<h4 id="AutoResetEvent"><a href="#AutoResetEvent" class="headerlink" title="AutoResetEvent"></a>AutoResetEvent</h4><ul>
<li>å®ƒåƒæ˜¯ä¸€å€‹ç¥¨é–˜, æ’å…¥ä¸€å¼µç¥¨åªè®“ä¸€å€‹äººé</li>
<li>Thread åœ¨é–€é–˜æ™‚å‘¼å«WaitOneä¾†wait&#x2F;block, è€Œå‘¼å«Setæ’å…¥ç¥¨</li>
<li>å¦‚æœæœ‰å¤šå€‹threadåœ¨é–€é–˜å‘¼å«WaitOne, è®Šæˆqueueæ’éšŠ</li>
<li>Ticketå¯ä»¥ä¾†è‡ªä»»ä½•thread, ä»£è¡¨ä»»ä½•unblockçš„threadå¯å­˜å–è©²AutoResetEventç‰©ä»¶ä¸¦å‘¼å«Set</li>
<li>åœ¨constructorä»£å…¥trueçš„è©±, ä»£è¡¨ç›´æ¥å‘¼å«Set</li>
<li>ç”¨EventWaitHandleå¯é”åˆ°ç›¸åŒçš„åŠŸèƒ½ (EventWaitHandleæ˜¯AutoResetEventçš„çˆ¶é¡åˆ¥)</li>
</ul>
<p>var auto &#x3D; new AutoResetEvent (false);</p>
<p>&#x2F;&#x2F; ç­‰åŒå¯«æ³•</p>
<p>var auto2 &#x3D; new EventWaitHandle(false, EventResetMode.AutoReset);</p>
<ul>
<li>ä½¿ç”¨çš„ç¯„ä¾‹å¦‚ä¸‹:</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class TestAutoResetEvent<br>{<br>    static EventWaitHandle _waitHandle &#x3D; new AutoResetEvent(false);<br>    static void Main(string[] args){</p>
<pre><code>    new Thread(() =&amp;gt; &#123;
        Console.WriteLine(&quot;Wait...&quot;);
        \_waitHandle.WaitOne();
        Console.WriteLine(&quot;awake&quot;);
    &#125;).Start();
    Thread.Sleep(1000);
    \_waitHandle.Set();
    Console.Read();
&#125;
</code></pre>
<p>}</p>
<ul>
<li>ç¯„ä¾‹å°æ‡‰çš„æ™‚åºè¡¨</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/wp-content/uploads/2022/01/image-12.png"><img src="https://geekcodeparadise.com/wp-content/uploads/2022/01/image-12.png"></a></p>
<p><em><strong>Producer&#x2F;consumer queue</strong></em></p>
<ul>
<li>ä¸€å€‹queueç”¨ä¾†æ”¾é€²è¦åŸ·è¡Œçš„ä»»å‹™, è€Œå…¶ä»–threadåœ¨èƒŒæ™¯å¾é€™queueæŒ‘ä»»å‹™ä¾†åš</li>
<li>ç”¨é€™ç¨®queueèƒ½æœ‰æ•ˆç®¡ç†è¦åŸ·è¡Œçš„threadæ•¸é‡, æ¯”å¦‚IOå¯†é›†å‹ä»»å‹™å¯åªå®‰æ’ä¸€å€‹thread, å…¶ä»–éœ€è¦10å€‹</li>
<li>CLRçš„Thread poolä¹Ÿæ˜¯ä¸€ç¨®Producer&#x2F;consumer queue</li>
<li>queueæ’å…¥çš„è³‡æ–™æœƒæœ‰å°æ‡‰çš„ä»»å‹™, æ¯”å¦‚å¡«å…¥æª”æ¡ˆåç¨±, è€Œå°æ‡‰çš„ä»»å‹™æ˜¯åŠ å¯†è©²æª”æ¡ˆ</li>
<li>ä»¥ä¸‹ç”¨AutoResetEventå¯¦ä½œç¯„ä¾‹</li>
</ul>
<p>using System;<br>using System.Collections.Generic;<br>using System.Threading;</p>
<p>namespace ProducerConsumerTest<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            using (ProducerConsumerQueue q &#x3D; new ProducerConsumerQueue())<br>            {<br>                q.EnqueueTask(â€œHelloâ€);<br>                for(int i &#x3D; 0; i &lt; 20; ++i)<br>                {<br>                    q.EnqueueTask(â€œSay â€œ + i);<br>                }<br>                q.EnqueueTask(â€œGood byeâ€);<br>            }<br>        }<br>    }</p>
<pre><code>public class ProducerConsumerQueue : IDisposable
&#123;
    EventWaitHandle \_wh = new AutoResetEvent(false);
    Thread \_worker;
    readonly object \_locker = new object();
    Queue&amp;lt;string&amp;gt; \_tasks = new Queue&amp;lt;string&amp;gt;();
    public ProducerConsumerQueue()
    &#123;
        \_worker = new Thread(Work);
        \_worker.Start();
    &#125;

    public void EnqueueTask(string task)
    &#123;
        lock (\_locker)
        &#123;
            \_tasks.Enqueue(task);
        &#125;
        \_wh.Set();
    &#125;

    public void Dispose()
    &#123;
        EnqueueTask(null); // signal the consumer to exit
        \_worker.Join(); // wait for the consumer&#39;s thread to finish
        \_wh.Close(); // release any OS Resources
    &#125;

    private void Work()
    &#123;
        while (true)
        &#123;
            string task = null;
            lock(\_locker)
            &#123;
                if(\_tasks.Count &amp;gt; 0)
                &#123;
                    task = \_tasks.Dequeue();
                    if(task == null)
                    &#123;
                        return;
                    &#125;
                &#125;
            &#125;
            if(task != null)
            &#123;
                Console.WriteLine(&quot;Performing task : &quot; + task);
                Thread.Sleep(1000); // simulate work...
            &#125;
            else
            &#123;
                \_wh.WaitOne(); // no more tasks , wait for a signal
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
<p>}</p>
<ol>
<li>ç”¨lockå»é–å®šqueue, é”åˆ°thread-safe</li>
<li>åœ¨enqueueä¹‹å¾Œ, å‘¼å«Set, é€šçŸ¥åœ¨while(true)æœ‰waitçš„threadå¯ä»¥å¾€ä¸‹åš</li>
<li>å¦‚æœcalleræ’å…¥nullçš„è³‡æ–™, ç›´æ¥çµæŸ</li>
<li>queueå¦‚æœæ˜¯ç©ºçš„, æœƒå‘¼å«WaitOneç­‰å¾…signal</li>
<li>åœ¨Disposeçš„å¯¦ä½œ, å‘¼å«Enqueue(null), è®“Workæ–¹æ³•è®€åˆ°nullè€ŒreturnçµæŸ, å¦å‰‡Threadçš„Joinæ°¸é ä¸çµæŸ; å°EventWaitHandleå‘¼å«Close, å¯ä»¥é‡‹æ”¾å…§éƒ¨æœ‰ç”¨åˆ°çš„è³‡æº</li>
</ol>
<ul>
<li>.Net Framework 4 æœ‰BlockingCollection, å¯¦ä½œProducer&#x2F;Consumer queue</li>
<li>ä¸Šè¿°ç”¨AutoResetEventçš„Producer&#x2F;Consumer queueæ˜¯å€‹å¥½çš„ç¯„ä¾‹, æœªä¾†åŠ ä¸Šcancellationæˆ–bounded queue, éƒ½å¯ä»¥æ­¤ç‚ºèµ·é»</li>
</ul>
<h4 id="ManualResetEvent"><a href="#ManualResetEvent" class="headerlink" title="ManualResetEvent"></a>ManualResetEvent</h4><ul>
<li>å’ŒAutoResetEventç›¸æ¯”, ManualResetEventæ˜¯ä¸€èˆ¬çš„é–˜é–€, å‘¼å«Setæ™‚, è®“æ‰€æœ‰ç­‰å¾…(æœ‰å‘¼å«éWaitOne)çš„Threadå…¨éƒ½èƒ½é€²å…¥</li>
<li>å‘¼å«Resetèƒ½æŠŠé–˜é–€é—œä¸Š</li>
<li>å‘¼å«WaitOneå°±æœƒBlock</li>
<li>ç­‰åŒçš„å¯«æ³•</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var manual1 = new ManualResetEvent(false);</span><br><span class="line">var manual2 = new EventWaitHandle(false, EventResetModel.ManualReset);</span><br></pre></td></tr></table></figure>

<ul>
<li>å¦ä¸€å€‹æ˜¯ManualResetEventSlimèƒ½åŸ·è¡Œæ›´å¿«ä¸”æ”¯æ´CancellationToken, ä½†ä¸èƒ½è·¨Process</li>
<li>ManualResetEventæ˜¯è®“ä¸€å€‹Threadå…è¨±å¤šå€‹Thread unblock, CountdownEventå‰‡ç›¸å</li>
</ul>
<h4 id="CountdownEvent"><a href="#CountdownEvent" class="headerlink" title="CountdownEvent"></a>CountdownEvent</h4><ul>
<li>ç”¨CountdownEventå¯ä»¥ç­‰å¤šå€‹ThreadåŸ·è¡Œå¾Œå†å¾€å¾ŒåŸ·è¡Œ</li>
<li>åœ¨.NET Framework 4ä¹‹å‰, å¯ä»¥ç”¨Wait and Pulseä¾†å¯¦ä½œCountdownEvent</li>
<li>å»ºæ§‹CountdownEventæŒ‡å®šè¦çš„æ•¸é‡, å‘¼å«Waitå‰‡blockè©²thread, è€Œå‘¼å«Signalæœƒé™ä½count, ç›´åˆ°countç‚º0, è©²threadå°‡unblock</li>
<li>ä»¥ä¸‹ç¯„ä¾‹æ˜¯ç­‰å¾…3å€‹ThreadåŸ·è¡Œå¾Œ, æ‰ç¹¼çºŒåŸ·è¡Œ</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>public class Program<br>{<br>static CountdownEvent _countDown &#x3D; new CountdownEvent(3);<br>public static void Main()<br>{<br>new Thread(SaySomething).Start(â€œThread 1â€);<br>new Thread(SaySomething).Start(â€œThread 2â€);<br>new Thread(SaySomething).Start(â€œThread 3â€);<br>_countDown.Wait();<br>Console.WriteLine(â€œAll threads have finishedâ€);<br>}<br>static void SaySomething(object msg)<br>{<br>Thread.Sleep(3000);<br>Console.WriteLine(msg);<br>_countDown.Signal();<br>}<br>}</p>
<ul>
<li>Countå¯ä»¥ç”¨AddCountä¾†åŠ æ›´å¤šéœ€ç­‰å¾…çš„æ•¸é‡, ä½†å¦‚æœå·²ç¶“é”åˆ°count &#x3D; 0è€Œåˆå‘¼å«AddCount, å°‡æ‹‹å‡ºexception</li>
<li>å»ºè­°å¯ç”¨TryAddCount, å›å‚³falseä»£è¡¨countå·²ç¶“æ˜¯0</li>
<li>å‘¼å«Resetå°‡Countå›åˆ°åˆå§‹å€¼</li>
</ul>
<h4 id="Creating-a-Cross-Process-EventWaitHandle"><a href="#Creating-a-Cross-Process-EventWaitHandle" class="headerlink" title="Creating a Cross-Process EventWaitHandle"></a>Creating a Cross-Process EventWaitHandle</h4><ul>
<li>EventWaitHandleå¯ä»¥æŒ‡å®šåå­—, è®“å¤šå€‹Processæ ¹æ“šåŒä¸€å€‹åå­—è€Œå…±åŒåƒè€ƒ</li>
<li>åŸºæœ¬ç”¨æ³•:</li>
</ul>
<p>EventWaitHandle wh &#x3D; new EventWaitHandle(false, EventResetMode.AutoReset, â€œMyCompany.MyApp.Nameâ€);</p>
<h4 id="Wait-Handles-and-the-Thread-Pool"><a href="#Wait-Handles-and-the-Thread-Pool" class="headerlink" title="Wait Handles and the Thread Pool"></a>Wait Handles and the Thread Pool</h4><ul>
<li>ä½¿ç”¨ThreadPool.RegisterWaitForSingleObject, å¯ä»¥ä¸ç¶ç‰¹å®šçš„Threadä¾†åŸ·è¡Œ, å°‡è¦å§”è¨—çš„ä»»å‹™äº¤çµ¦Thread poolåŸ·è¡Œ</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace TestWaitHandleThreadPool<br>{<br>    class Program<br>    {<br>        static ManualResetEvent _starter &#x3D; new ManualResetEvent(false);<br>        static void Main(string[] args)<br>        {<br>            RegisteredWaitHandle reg &#x3D; ThreadPool.RegisterWaitForSingleObject(_starter, Go, â€œSome Dataâ€, -1, true);<br>            Thread.Sleep(5000);<br>            _starter.Set();<br>            Console.ReadLine();<br>            reg.Unregister(_starter);<br>        }</p>
<pre><code>    static void Go(object data, bool timeOut)
    &#123;
        Console.WriteLine(&quot;Start work : &quot; + data);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>åƒæ•¸-1ä»£è¡¨ä¸ç”¨timeout, å¦‚æœæœ‰timeoutçš„è©±, æœƒæª¢æ¸¬å‚³é€çš„ç‰©ä»¶ï¼ˆç¯„ä¾‹æ˜¯Some Dataå­—ä¸²ï¼‰çš„ç‹€æ…‹; åƒæ•¸trueä»£è¡¨è©²Thread poolæ”¶åˆ°signalå¾Œ, ä¸å†é‡è¨­è¦Wait.</li>
<li>å‡å¦‚åŸæœ¬ç”¨WaiOneçš„æ–¹å¼è™•ç†, Serveræ”¶åˆ°100å€‹ä»»å‹™å°±å¾—new 100å€‹Thread, è®Šæˆç¶å®šå¤ªå¤šä¸”å¤§é‡Block. æ”¹å¯«çš„æ–¹æ³•å¦‚ä¸‹, è®“å¾ŒçºŒçš„å§”è¨—å·¥ä½œéƒ½çµ¦â€˜hread Poolè™•ç†</li>
</ul>
<p>void AppServerMethod()<br>{<br>_wh.WaitOne();<br>&#x2F;&#x2F; â€¦ continue execution<br>}</p>
<p>&#x2F;&#x2F; è®Šæˆ</p>
<p>void AppServerMethod()<br>{<br> RegisteredWaitHandle reg &#x3D; ThreadPool.RegisterWaitForSingleObject(_starter, Resume, null, -1, true);<br> &#x2F;&#x2F; â€¦<br>}</p>
<p>static void Resume(object data, bool timeOut)<br>{<br>&#x2F;&#x2F; â€¦ continue execution<br>}</p>
<h4 id="WaitAny-WaitAll-and-SignalAndWait"><a href="#WaitAny-WaitAll-and-SignalAndWait" class="headerlink" title="WaitAny, WaitAll, and SignalAndWait"></a>WaitAny, WaitAll, and SignalAndWait</h4><ul>
<li>WaitHandleæä¾›static method, åŒ…å«WaitNay, WaitAll, SignalAndWait, å¯ä»¥å°æœ‰ç¹¼æ‰¿WaitHandleçš„ç‰©ä»¶ä½¿ç”¨è¼ƒè¤‡é›œçš„Signal&#x2F;Waitçš„åŠŸèƒ½</li>
<li>WaitAny: ç­‰å¾…ä»»ä¸€å€‹Threadæ”¶åˆ°Signal</li>
<li>WaitAll: ç­‰å¾…æ‰€æœ‰Threadéƒ½æ”¶åˆ°Signal</li>
<li>SignalAndWait: å°ç¬¬ä¸€å€‹åƒæ•¸çš„threadç™¼å‡ºsignal, å°ç¬¬äºŒå€‹åƒæ•¸çš„threadåšç­‰å¾…</li>
</ul>
<p><em><strong>Alternatives to WaitAll and SignalAndWait</strong></em></p>
<ul>
<li>WaitAllå’ŒSignalAndWaitä¸èƒ½åœ¨å–®ä¸€åŸ·è¡Œç·’çš„ç’°å¢ƒåŸ·è¡Œ.</li>
<li>SignalAndWaitçš„æ›¿ä»£æ–¹æ¡ˆæ˜¯Barrieré¡åˆ¥, è€ŒWaitAllçš„æ›¿ä»£æ–¹æ¡ˆæ˜¯Parallel classçš„Invokeæ–¹æ³•</li>
</ul>
<h3 id="Synchronization-Contexts-NET-Coreå·²ä¸å­˜åœ¨ï¼‰"><a href="#Synchronization-Contexts-NET-Coreå·²ä¸å­˜åœ¨ï¼‰" class="headerlink" title="Synchronization Contexts (.NET Coreå·²ä¸å­˜åœ¨ï¼‰"></a>Synchronization Contexts (.NET Coreå·²ä¸å­˜åœ¨ï¼‰</h3><ul>
<li>ç¹¼æ‰¿ContextBoundObjectä¸”åŠ ä¸ŠSynchronizationå±¬æ€§, CLRåœ¨é€™ç‰©ä»¶æœƒè‡ªå‹•ä½¿ç”¨lock</li>
<li>å¦‚ä¸‹ç¯„ä¾‹, æ¯å€‹Demoå‡½å¼æœƒæ’éšŠåŸ·è¡Œ</li>
</ul>
<p>using System;<br>using System.Runtime.Remoting.Contexts;<br>using System.Threading;</p>
<p>namespace TestAutoLock<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            AutoLock safeInstance &#x3D; new AutoLock();<br>            new Thread(safeInstance.Demo).Start();<br>            new Thread(safeInstance.Demo).Start();<br>            safeInstance.Demo();<br>        }<br>    }</p>
<pre><code>\[Synchronization\]
public class AutoLock : ContextBoundObject
&#123;
    public void Demo()
    &#123;
        Console.Write(&quot;Thread id : &quot; + Thread.CurrentThread.ManagedThreadId);
        Console.Write(&quot; Start.....&quot;);
        Thread.Sleep(1000);
        Console.WriteLine(&quot;End&quot;);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>è‡ªå‹•lockä¸åŒ…å«staticçš„æˆå“¡å’Œæ²’æœ‰ç¹¼æ‰¿ContextBoundObjectçš„ç‰©ä»¶(æ¯”å¦‚Form)</li>
<li>æƒ³åƒæ˜¯CLRå°‡åŸå§‹Classå¥—ä¸Šä¸€å±¤ContextBoundObject Proxy, èƒ½å‘¼å«åŸå§‹Classçš„æˆå“¡, å†ç‚ºå®ƒçš„æ–¹æ³•éƒ½åŠ ä¸ŠåŒæ­¥åŒ–çš„åŠŸèƒ½</li>
<li>å¦‚æœå‰é¢çš„AutoLockæ˜¯å€‹Collection, å‰‡ä½¿ç”¨å®ƒçš„ç‰©ä»¶ä¹Ÿå¿…é ˆæ˜¯ContextBoundObject, å¦å‰‡å­˜å–å®ƒçš„iteméœ€è¦æ‰‹å‹•åŠ ä¸Šlock</li>
<li>Synchronization Contexté è¨­æœƒå»¶ä¼¸å¾åŒä¸€å±¤Scopeçš„Context, ä¹Ÿå°±æ˜¯lockåŒ…å«çš„æ·±åº¦ä¸€ç›´å‘ä¸‹</li>
<li>åœ¨Synchronizationçš„attributeå¯ä»¥æ”¹è®Šé è¨­çš„è¡Œç‚º, æœ‰é€™äº›é¸é …:</li>
</ul>
<ol>
<li>NOT_SUPPORTED: å°±è·Ÿæ²’åŠ ä¸ŠSynchronizationçš„å±¬æ€§ä¸€æ¨£</li>
<li>SUPPORTED: å¦‚æœä¾†è‡ªåˆ¥çš„synchronized ç‰©ä»¶åšåˆå§‹åŒ–, å‰‡å»¶ä¼¸å®ƒçš„context, å¦å‰‡ä¿æŒunsynchronized</li>
<li>REQUIRED (é è¨­): å¦‚æœä¾†è‡ªåˆ¥çš„synchronized ç‰©ä»¶åšåˆå§‹åŒ–, å‰‡å»¶ä¼¸å®ƒçš„context, å¦å‰‡å»ºç«‹æ–°çš„Context</li>
<li>REQUIRES_NEW: ç¸½æ˜¯å»ºç«‹æ–°å¢Synchronization context</li>
</ol>
<ul>
<li>ä»¥ä¸‹ç¯„ä¾‹æ˜¯æœƒç”¢ç”ŸDeadlockçš„Synchronization:</li>
</ul>
<p>using System;<br>using System.Runtime.Remoting.Contexts;<br>using System.Threading;</p>
<p>namespace TestAutoLockDeadlock<br>{<br>    [Synchronization]<br>    public class Deadlock : ContextBoundObject<br>    {<br>        public Deadlock Other;</p>
<pre><code>    public void Demo()
    &#123;
        Console.WriteLine(Thread.CurrentThread.ManagedThreadId);
        Thread.Sleep(1000);
        Console.WriteLine(&quot;Call other&quot;);
        Other.Hello();
    &#125;

    void Hello()
    &#123;
        Console.WriteLine(&quot;hello&quot;);
    &#125;
&#125;
class Program
&#123;
    private static void Main(string\[\] args)
    &#123;
        Deadlock dead1 = new Deadlock();
        Deadlock dead2 = new Deadlock();
        dead1.Other = dead2;
        dead2.Other = dead1;
        new Thread(dead1.Demo).Start();
        dead2.Demo();
        Console.Read();
    &#125;
&#125;
</code></pre>
<p>}</p>
<ol>
<li>å…©å€‹Deadlockç‰©ä»¶éƒ½æ˜¯åœ¨Programå»ºç«‹, Programæœ¬èº«æ˜¯unsynchronized, æ‰€ä»¥Deadlockç‰©ä»¶å»ºç«‹å„è‡ªçš„Synchronization Context, ä¹Ÿæœ‰å„è‡ªçš„lock</li>
<li>å‘¼å«å°æ–¹çš„Helloæ–¹æ³•å¾Œ, å³ç™¼ç”ŸDeadlock</li>
</ol>
<h4 id="Reentrancy"><a href="#Reentrancy" class="headerlink" title="Reentrancy"></a>Reentrancy</h4><ul>
<li>Reentrantçš„å®šç¾©æ˜¯, å¦‚æœæœ‰æ®µç¨‹å¼ç¢¼è¢«ä¸­æ–·, åŸ·è¡Œç·’å»åŸ·è¡Œåˆ¥çš„ç¨‹å¼, ä¹‹å¾Œå†å›ä¾†åŸ·è¡Œé€™æ®µç¨‹å¼è€Œæ²’é€ æˆå½±éŸ¿</li>
<li>é€šå¸¸Thread-safeå’Œreentrantè¦–ç‚ºåŒç­‰</li>
<li>å¦‚æœ[Synchronization(true)]é€™æ¨£ä½¿ç”¨, ä»£è¡¨éœ€è¦reentry, ç•¶åŸ·è¡Œé›¢é–‹æ­¤ç¨‹å¼ç¢¼æ™‚, æœƒæŠŠlocké‡‹æ”¾, å¯é¿å…deadlock. å‰¯ä½œç”¨æ˜¯åœ¨é€™é‡‹æ”¾æœŸé–“, ä»»ä½•threadå¯ä»¥é€²å…¥è©²ç‰©ä»¶çš„context(æ¯”å¦‚å‘¼å«å®ƒçš„æ–¹æ³•)</li>
<li>[Synchronization(true)]æ˜¯é¡åˆ¥å±¤ç´š, æ‰€ä»¥åœ¨éè©²contextçš„å‘¼å«éƒ½æœƒç•¶classå±¤é¢çš„æœ¨é¦¬(?)</li>
<li>å¦‚æœæ²’æœ‰reentrancy, å‰‡åœ¨ä¸€äº›å ´åˆæ¯”è¼ƒé›£å·¥ä½œ, æ¯”å¦‚åœ¨ä¸€å€‹synchronized classå¯¦ä½œå¤šåŸ·è¡Œç·’, å°‡é‚è¼¯å§”è¨—çµ¦å…¶ä»–worker thread, å‰‡worker threadå½¼æ­¤é–“è¦æºé€šæ²’æœ‰reentrancyçš„è©±, å°‡æœƒå—é˜».</li>
<li>åŒæ­¥è‡ªå‹•é–é€ æˆdeadlock, reentrancy, åˆªé™¤ä½µç™¼ç­‰å•é¡Œ, åœ¨ä¸€äº›æ‡‰ç”¨å ´åˆæ²’æœ‰æ‰‹å‹•lockä¾†çš„å¥½ç”¨</li>
</ul>
<h2 id="åƒè€ƒè³‡æ–™"><a href="#åƒè€ƒè³‡æ–™" class="headerlink" title="åƒè€ƒè³‡æ–™"></a>åƒè€ƒè³‡æ–™</h2><ol>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3lQcLky">C# 9.0 in a Nutshell: The Definitive Reference, Joseph Albahari (Amazon)</a></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/threading-in-csharp-series-book-summary/">Threading in C# ç³»åˆ—çš„è®€æ›¸ç­†è¨˜</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/05/threading-in-csharp-part-1-getting-started/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/05/threading-in-csharp-part-1-getting-started/" class="post-title-link" itemprop="url">Threading in C# - GETTING STARTED</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-05 10:45:00" itemprop="dateCreated datePublished" datetime="2021-12-05T10:45:00+08:00">2021-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Thread/" itemprop="url" rel="index"><span itemprop="name">Thread</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/" itemprop="url" rel="index"><span itemprop="name">è®€æ›¸ç­†è¨˜</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Threading-in-C-å‰è¨€"><a href="#Threading-in-C-å‰è¨€" class="headerlink" title="Threading in C# å‰è¨€"></a>Threading in C# å‰è¨€</h3><p>é€™é™£å­æ›äº†æ–°å·¥ä½œç’°å¢ƒï¼Œå…¬å¸ä½¿ç”¨ä¸å°‘C# Threadç›¸é—œçš„æŠ€è¡“ï¼Œè€ŒçŸ¥åæ›¸ç±C# in a Nutshellçš„ä½œè€…Joseph Albahariï¼Œå°‡C# Threading çš„æŠ€è¡“æ•™å­¸éƒ½å…è²»å…¬é–‹ï¼Œå› æ­¤æœƒé–±è®€ä»–çš„æ•™å­¸æ–‡ä¾†æ’°å¯«è®€æ›¸ç­†è¨˜ï¼Œå¸Œæœ›åœ¨å·¥ä½œå°ˆæ¡ˆæˆ–Side Projectéƒ½æœ‰å¹«åŠ©åˆ°ã€‚</p>
<p>ä½œè€…æœ‰ä¸€äº›ç¨‹å¼ç¢¼ä¸¦éå®Œæ•´ï¼Œæˆ‘æœƒç›¡é‡å¯«å‡ºå¯¦éš›å¯åŸ·è¡Œçš„ç¯„ä¾‹ï¼Œä¸”æœ‰äº›åŠŸèƒ½Net Coreä»¥å¾Œä¸æ”¯æ´ï¼Œä¹ŸæœƒåŠ ä¸Šè¨»æ˜ã€‚ä»¥ä¸‹æ­£å¼é–‹å§‹ã€‚</p>
<h3 id="Introduction-and-Concepts"><a href="#Introduction-and-Concepts" class="headerlink" title="Introduction and Concepts"></a>Introduction and Concepts</h3><ul>
<li>Threadæ˜¯ç¨ç«‹çš„åŸ·è¡Œè·¯å¾‘, ä¹Ÿèƒ½åŒæ™‚å’Œå…¶ä»–Threadå·¥ä½œ</li>
<li>C# Clientç¨‹å¼(Console, wpf, winformç­‰), CLRéƒ½æœƒèµ·å–®ä¸€çš„Main threadåŸ·è¡Œ</li>
</ul>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2021/12/NewThread.png" alt="Multi-Threading"></p>
<p>Multi-Threading in C# (Picture source: <a target="_blank" rel="noopener" href="http://www.albahari.com/threading/">Threading in C#<br>Joseph Albahari</a>)</p>
<ul>
<li>è¢«è³¦äºˆå·¥ä½œçš„Thread, åªè¦é‚£å·¥ä½œ(function)å®Œæˆ, è©²Threadä¹Ÿå°±çµæŸ,ä¹Ÿç„¡æ³•é‡æ–°å·¥ä½œ</li>
<li>æ¯å€‹Threadæœƒåˆ†é…åˆ°è¨˜æ†¶é«”ç¨ç«‹çš„Stackå€å¡Š, æ‰€ä»¥functionçš„è®Šæ•¸èƒ½æœ‰åœ°æ–¹å„²å­˜</li>
<li>Threadå¦‚æœåƒè€ƒåˆ°åŒä¸€ç‰©ä»¶, è©²ç‰©ä»¶çš„è³‡æ–™æœƒå…±äº«. å¦‚æœç”¨staticçš„è³‡æ–™ä¹Ÿä¸€æ¨£æ˜¯å…±äº«</li>
<li>ä½†è³‡æ–™å…±äº«å®¹æ˜“é€ æˆ_<strong>Thread-Safe</strong>_çš„å•é¡Œ, è¦ç‰¹åˆ¥è™•ç†, åƒä¸‹é¢ç¯„ä¾‹, å› ç‚ºå…©å€‹å–åˆ°doneçš„å€¼éƒ½æ˜¯false, æ‰€ä»¥éƒ½æœƒåŸ·è¡Œ</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class ThreadTestWithSharedData<br>{<br>    private bool done &#x3D; false;<br>    static void Main()<br>    {<br>        ThreadTestWithSharedData test &#x3D; new ThreadTestWithSharedData();<br>        Thread t &#x3D; new Thread(test.GoMaybeNotSafe);<br>        t.Start();<br>        test.GoMaybeNotSafe();<br>        Console.Read();<br>    }</p>
<pre><code>public void Go()
&#123;
    if(!done)&#123;
        done = true;
        Console.WriteLine(&quot;done&quot;);
    &#125;
&#125;

public void GoMaybeNotSafe()
&#123;
    if(!done)&#123;
        Console.WriteLine(&quot;done&quot;);
        done = true;
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>ä½¿ç”¨Exclusive lock, åªå…è¨±ä¸€å€‹threadé‹ç®—</li>
<li>ç•¶Threadè¢«Blocked, ä¸æœƒæ¶ˆè€—CPUè³‡æº</li>
</ul>
<h4 id="Join-and-Sleep"><a href="#Join-and-Sleep" class="headerlink" title="Join and Sleep"></a>Join and Sleep</h4><ul>
<li>ä½¿ç”¨Joinå¯ç­‰å¾…Threadå®Œæˆ</li>
<li>ä½¿ç”¨Sleepè®“ç•¶å‰Threadæš«åœæŒ‡å®šçš„æ™‚é–“</li>
<li>ä¸ç®¡æ˜¯Joinæˆ–Sleep, éƒ½æ˜¯_<strong>Blocked</strong>_</li>
<li>Thread.Sleep(0) å°‡ç›®å‰Threadçš„é‹ç®—æ™‚é–“æ”¾å…¶, å°‡CPUæ™‚é–“äº¤çµ¦åˆ¥çš„Thread, ç­‰åŒåŠŸèƒ½æ˜¯ Thread.Yield()</li>
<li>ç”¨Sleep(0)æˆ–Yield, å¯ä»¥ç”¨ä¾†æ‰¾thread safetyçš„å•é¡Œ, å‡å¦‚æŠŠYieldå¡«å…¥ç¨‹å¼ä»»ä½•åœ°æ–¹ä¸”å‡ºç¾å•é¡Œ, ä»£è¡¨é€™ç¨‹å¼ç¢¼æœ‰Bug</li>
</ul>
<h4 id="How-Threading-Works"><a href="#How-Threading-Works" class="headerlink" title="How Threading Works"></a>How Threading Works</h4><ul>
<li>åœ¨CLRè£¡æœ‰å€‹Thread Scheduler, ä»£è¡¨ä½œæ¥­ç³»çµ±, ç”±å®ƒThreadçš„åŸ·è¡Œæ™‚é–“</li>
<li>å–®ä¸€è™•ç†å™¨çš„ç³»çµ±, åˆ‡çš„time sliceæ™‚é–“æ¯”switch contextçš„æ™‚é–“é‚„é•·</li>
<li>å¤šè™•ç†å™¨çš„ç³»çµ±, åˆ‡çš„time sliceæœ‰concurrency, å¯ä»¥åŒæ™‚åŸ·è¡Œå¤šå€‹thread</li>
<li>Threadå¦‚æœè¢«preempted(æ¶å ), ä»£è¡¨å®ƒæ˜¯è¢«interrupted, æ¯”å¦‚time-slicing</li>
</ul>
<h4 id="Threads-vs-Processes"><a href="#Threads-vs-Processes" class="headerlink" title="Threads vs Processes"></a>Threads vs Processes</h4><ul>
<li>å¤šå€‹Threadå¯ä»¥åŸ·è¡Œåœ¨1å€‹Process</li>
<li>Processä¹‹é–“æ˜¯äº’ç›¸éš”é›¢</li>
<li>Threadä¹‹é–“äº’ç›¸åˆ†äº«Heapè¨˜æ†¶é«”çš„è³‡æ–™</li>
</ul>
<h4 id="Threadingâ€™s-Uses-and-Misuses-èª¤ç”¨"><a href="#Threadingâ€™s-Uses-and-Misuses-èª¤ç”¨" class="headerlink" title="Threadingâ€™s Uses and Misuses(èª¤ç”¨)"></a>Threadingâ€™s Uses and Misuses(èª¤ç”¨)</h4><ul>
<li>Maintaining a responsive user interface: å…¶ä»–çš„Worker Threadå¯èƒŒå¾ŒåŸ·è¡Œæ¶ˆè€—çš„ä»»å‹™, è€ŒMain(UI) Threadèˆ‡Useræ“ä½œäº’å‹•</li>
<li>Making efficient use of an otherwise blocked CPU:</li>
<li>Parallel programming: åœ¨å¤šæ ¸å¿ƒ&#x2F;å¤šè™•ç†å™¨çš„ç’°å¢ƒ, å¤šå€‹åŸ·è¡Œç·’èƒ½å¹³è¡Œåˆ†æ“”å·¥ä½œ</li>
<li>Speculative(æŠ•æ©Ÿæ€§) execution: æœ‰äº›ä»»å‹™å¯ä»¥ç”¨å¤šå€‹æ¼”ç®—æ³•åŒæ™‚é‹ç®—, æœ€çµ‚çµæœå–æœ€å¿«é‹ç®—å®Œçš„.</li>
<li>Allowing requests to be processed simultaneously: .NETçš„ServeråŠŸèƒ½(WCFã€ASP.NETç­‰) æ”¶åˆ°Request, æœƒè‡ªå‹•å»ºç«‹å¤šåŸ·è¡Œç·’ä¾†è™•ç†. Clientä¹Ÿæ˜¯å¯åŒæ¨£çš„ä½œæ³•.</li>
<li>å¼·èª¿å¤šåŸ·è¡Œç·’ä¹‹é–“å…±ç”¨è³‡æ–™æ™‚, éƒ½æœƒæœ‰Bugçš„ç”¢ç”Ÿ. å»ºè­°æŠŠå¤šåŸ·è¡Œç·’çš„é‚è¼¯èƒ½å°è£åœ¨ç¨ç«‹çš„library, ä¹Ÿæ¯”è¼ƒå¥½æ¸¬è©¦</li>
<li>æœ‰äº›åŠŸèƒ½ç”¨å¤ªå¤šåŸ·è¡Œç·’ä¸è¦‹å¾—æ›´å¿«, æ¯”å¦‚Disk IO, åªè¦å¹¾å€‹threadè®€å– æ¯” 10å¹¾å€‹threadé‚„å¿«</li>
</ul>
<h3 id="Creating-and-Starting-Threads"><a href="#Creating-and-Starting-Threads" class="headerlink" title="Creating and Starting Threads"></a>Creating and Starting Threads</h3><ul>
<li>Threadå»ºç«‹æ™‚æœƒå¸¶å…¥å§”è¨—TheadStart, ä½†å¯ä»¥çœç•¥ç›´æ¥å¸¶functioncæˆ–åŒ¿åfunction</li>
</ul>
<h4 id="Passing-Data-to-a-Thread"><a href="#Passing-Data-to-a-Thread" class="headerlink" title="Passing Data to a Thread"></a>Passing Data to a Thread</h4><ul>
<li>å¯ä»¥åœ¨Thread.Start(someArgs)ä»£å…¥è©²functionçš„åƒæ•¸</li>
<li>ä¹Ÿå¯ä»¥ç”¨ParameterizedThreadStart, ä½†æ˜¯functionçš„åƒæ•¸å¿…é ˆç”¨object, å†å¦å¤–è½‰å‹</li>
</ul>
<p><strong>Lambda expressions and captured variables:</strong> å‚³åƒæ•¸è¦æ³¨æ„å…±ç”¨æ€§çš„å•é¡Œ, ä¸‹é¢çš„è¼¸å‡ºå¯èƒ½æ˜¯0223557799, è€Œä¸æ˜¯0~9å„å‡ºç¾ä¸€æ¬¡, åŸå› æ˜¯æœ‰æ™‚å¤šå€‹Threadå°iæœƒå­˜å–åˆ°ä¸€æ¨£çš„</p>
<p>for (int i &#x3D; 0; i &lt; 10; i++)<br>  new Thread (() &#x3D;&gt; Console.Write (i)).Start();</p>
<p>è§£æ±ºCaptured variableçš„æ–¹æ³•æ˜¯æŒ‡å®šè®Šæ•¸:</p>
<p>for (int i &#x3D; 0; i &lt; 10; i++)<br>{<br>  int temp &#x3D; i;<br>  new Thread (() &#x3D;&gt; Console.Write (temp)).Start();<br>}</p>
<h4 id="Naming-Threads"><a href="#Naming-Threads" class="headerlink" title="Naming Threads"></a>Naming Threads</h4><ul>
<li>å¯ä»¥æŒ‡å®šThreadçš„åå­—, æ¯”è¼ƒå®¹æ˜“åšDebug</li>
<li>ç”¨<a target="_blank" rel="noopener" href="http://thread.currentthread.name/">Thread.CurrentThread.Name</a> &#x3D; XXXX æŒ‡å®šåå­—</li>
</ul>
<h4 id="Foreground-and-Background-Threads"><a href="#Foreground-and-Background-Threads" class="headerlink" title="Foreground and Background Threads"></a>Foreground and Background Threads</h4><ul>
<li>Threadé è¨­å»ºç«‹æ˜¯Foreground, ä»£è¡¨å®ƒåŸ·è¡Œå®Œæ‰æœƒè®“AppçµæŸ</li>
<li>æŒ‡å®šThread.IsBackground &#x3D; true, Appçµ‚æ­¢æ™‚ä¸¦ä¸æœƒç†æœƒBackgroundçš„threadè€Œå¼·åˆ¶çµ‚æ­¢</li>
<li>å¦‚æœåœ¨ç¨‹å¼è¦çµæŸä¸”æœ‰finallyçš„background thread, é€™threadä¹Ÿæœƒè¢«å¿½ç•¥æ‰, è§£æ±ºæ–¹æ³•æœ‰2</li>
</ul>
<ol>
<li>ç”¨Join</li>
<li>å¦‚æœæ˜¯Pooled thread, å¯ç”¨event wait handler</li>
</ol>
<ul>
<li>å¦‚æœæœ‰ç¨‹å¼è¢«ä»»å‹™ç®¡ç†å“¡ä¸­æ­¢, æ‰€æœ‰ç¨‹å¼å…§çš„threadéƒ½æœƒåƒbackgroundçš„ç›´æ¥ä¸­æ­¢</li>
</ul>
<h4 id="Thread-Priority"><a href="#Thread-Priority" class="headerlink" title="Thread Priority"></a>Thread Priority</h4><ul>
<li>Priorityæ±ºå®šthreadçš„åŸ·è¡Œæ™‚é–“é•·åº¦</li>
<li>å°å¿ƒä½¿ç”¨Priority, å¦å‰‡å¯èƒ½é€ æˆå°å…¶ä»–threadå–è³‡æºçš„starvation</li>
<li>å¦‚æœProcessçš„Priorityå¾ˆä½, å³ä½¿èª¿é«˜Threadçš„Priorityä¹Ÿæ˜¯æœƒè¢«é™åˆ¶è³‡æº</li>
<li>Processæœ‰å€‹RealTimeçš„Priority, é€™æœƒå¹¾ä¹æ¶ä½”æ‰€æœ‰ä½œæ¥­ç³»çµ±çš„è³‡æº, å°å¿ƒä½¿ç”¨, ä¸€èˆ¬ç”¨Highå°±å¥½</li>
<li>å¦‚æœè¦åšRealTimeçš„æ‡‰ç”¨ç¨‹å¼ä¸”åŒ…å«ä½¿ç”¨è€…ä»‹é¢, é€šå¸¸æœƒæ‹†é–‹ä¾†, ä½¿ç”¨è€…ä»‹é¢ä¸€å€‹ç¨‹å¼ã€å¾Œç«¯é‹ç®—æ˜¯å¦ä¸€å€‹ç¨‹å¼, å½¼æ­¤æºé€šç”¨Remoting(WCF, Web Apiä¹‹é¡)æˆ–memory-mapped files (C# in a Nutshell æœ‰æåˆ°!! æ²’ç”¨é~~)</li>
</ul>
<h4 id="Exception-Handling"><a href="#Exception-Handling" class="headerlink" title="Exception Handling"></a>Exception Handling</h4><ul>
<li>å»ºç«‹Threadçš„try&#x2F;catch&#x2F;finallyçš„scope, ç„¡æ³•æ•æ‰åˆ°threadæ‹‹å‡ºçš„exception, ä»¥ä¸‹ç¯„ä¾‹æœƒç›´æ¥æ‹‹å‡ºException, è€Œç¨‹å¼ç›´æ¥ä¸­æ­¢, ä¸æœƒé€²åˆ°catch</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class ThreadThrowException<br>{<br>    static void Main(string[] args){<br>        try{<br>            Thread t &#x3D; new Thread(Go);<br>            t.Start();<br>        }<br>        catch(Exception ex){<br>            Console.WriteLine(â€œHi i am hereâ€ + ex.Message);<br>        }</p>
<pre><code>    Console.Read();
&#125;

static void Go()
&#123;
    throw new Exception(&quot;Null&quot;);
&#125;
</code></pre>
<p>}</p>
<ul>
<li>å°‡try&#x2F;catchå¯«åœ¨è¢«ThreadåŸ·è¡Œçš„function</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class ThreadThrowException2<br>{<br>    static void Main(string[] args){<br>        Thread t &#x3D; new Thread(Go);<br>        t.Start();</p>
<pre><code>    Console.Read();
&#125;

static void Go()
&#123;
    try&#123;
        throw new Exception(&quot;Null&quot;);
    &#125;
    catch(Exception ex)&#123;
        Console.WriteLine(&quot;Hi i am here&quot; + ex.Message);
    &#125;
    
&#125;
</code></pre>
<p>}</p>
<ul>
<li>Globalçš„ç•°å¸¸äº‹ä»¶è™•ç†(WPFå’ŒWinformçš„Application.DispatcherUnhandledExceptionå’Œ Application.ThreadException), åªæœ‰Main UI threadæ‹‹å‡ºçš„ç•°å¸¸æ‰æœƒè™•ç†, å…¶ä»–Worker threadçš„ç•°å¸¸è¦è‡ªå·±è™•ç†</li>
<li>AppDomain.CurrentDomain.UnhandledExceptionæœƒè¢«ä»»ä½•ç•°å¸¸è§¸ç™¼, ä½†ç„¡æ³•é˜»æ­¢å¾ŒçºŒç¨‹å¼çš„ä¸­æ­¢, ä»¥ä¸‹ç¯„ä¾‹å…©å€‹exceptionéƒ½æœƒè¢«UnhandledExceptionæ•æ‰, ä½†ç¨‹å¼ä»ç›´æ¥ä¸­æ­¢</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class ThreadThrowExceptionWithAppDomainHandler<br>{<br>    static void Main(string[] args){<br>        AppDomain currentDomain &#x3D; AppDomain.CurrentDomain;<br>        currentDomain.UnhandledException +&#x3D; new UnhandledExceptionEventHandler(MyHandler);<br>        try{<br>            Thread t &#x3D; new Thread(Go);<br>            t.Start();<br>        }<br>        catch(Exception ex){<br>            Console.WriteLine(â€œHi i am hereâ€ + ex.Message);<br>        }</p>
<pre><code>    throw new Exception(&quot;TEST&quot;);

    Console.Read();
&#125;

static void Go()
&#123;
    throw new Exception(&quot;Null&quot;);
&#125;

static void MyHandler(object s, UnhandledExceptionEventArgs args)
&#123;
    Exception e = (Exception) args.ExceptionObject;
    Console.WriteLine(&quot;runtime terminating: &#123;0&#125; &quot;, args.IsTerminating);
&#125;
</code></pre>
<p>}</p>
<h3 id="Threading-Pool"><a href="#Threading-Pool" class="headerlink" title="Threading Pool"></a>Threading Pool</h3><ul>
<li>ä½¿ç”¨Threading Poolçš„4ç¨®æ–¹å¼</li>
</ul>
<ol>
<li>Task Parallel Library</li>
<li>ThreadPool.QueueUserWorkItem</li>
<li>asynchronous delegates (BeginXXXXXâ€¦)</li>
<li>BackgroundWorker</li>
</ol>
<ul>
<li>ä»¥ä¸‹æ˜¯é–“æ¥æœƒç”¨åˆ°Threading pool:</li>
</ul>
<ol>
<li>WCF, Remoting, ASP.NET, ASMX Web serviceç­‰çš„æ‡‰ç”¨ç¨‹å¼Server</li>
<li>System.Timers.Timerå’ŒSystem.Threading.Timer</li>
<li>Netæœ‰ç”¨Asyncçµå°¾çš„å‡½å¼, æ¯”å¦‚WebClient(ä½¿ç”¨event-based asynchronous pattern)å’ŒBeginXXXXé–‹é ­çš„å‡½å¼(asynchronous programming model pattern)</li>
<li>PLINQ</li>
</ol>
<ul>
<li>ä½¿ç”¨Threading Poolçš„æ³¨æ„äº‹é …</li>
</ul>
<ol>
<li>ä¸èƒ½å°Thread poolè¨­å®šName</li>
<li>thread pooléƒ½æ˜¯background thread</li>
<li>block thread poolå¯èƒ½æœƒé€ æˆä¸€äº›æ½›åœ¨å•é¡Œ, æœ‰ä¸€äº›å„ªåŒ–çš„æ‰‹æ³•(æ¯”å¦‚ThreadPool.SetMinThreads)</li>
</ol>
<ul>
<li>Thread poolè¨­épriorityå¾Œ, ä»»å‹™åŸ·è¡Œå®Œå›æ”¶åˆ°poolæœƒè³¦æ­¸æˆnormal priority</li>
<li>å¯ä»¥ç”¨Thread.CurrentThread.IsThreadPoolThread æŸ¥çœ‹ç›®å‰Threadæ˜¯ä¸æ˜¯å¾poolä¾†çš„</li>
</ul>
<h4 id="Entering-the-Thread-Pool-via-TPL"><a href="#Entering-the-Thread-Pool-via-TPL" class="headerlink" title="Entering the Thread Pool via TPL"></a>Entering the Thread Pool via TPL</h4><ul>
<li>æ–°çš„Taské¡åˆ¥ä½¿ç”¨Thread poolæ›´ç°¡å–®</li>
<li>éæ³›å‹çš„Taské¡åˆ¥å–ä»£ThreadPool.QueueUserWorkItem</li>
<li>æ³›å‹çš„Task<TResult>é¡åˆ¥å–ä»£asynchronous delegate (BeginXXXXXâ€¦)</li>
<li>éæ³›å‹çš„Taské¡åˆ¥ç”¨Task.Factory.StartNew</li>
<li>æœƒå›å‚³ä¸€å€‹Taskç‰©ä»¶, å¯ä»¥ç”¨Wait()ç­‰å¾…, è€ŒTaskæŒ‡å®šçš„å‡½å¼ç™¼ç”ŸExceptionæ™‚, æœƒæ•æ‰åˆ°</li>
<li>å¦‚æœä¸å°Taskç‰©ä»¶åšWait, è€Œä¸­é–“ç™¼ç”Ÿçš„Exceptionæœƒé€ æˆç¨‹å¼ä¸­æ­¢ ( é€™å€‹ç”¨Consoleç¨‹å¼ç„¡æ³•æˆåŠŸ, ä¸»ç¨‹å¼æ²’è¢«ä¸­æ­¢)</li>
<li>Task<TResult>çš„çµæœå¯ç”¨.Resultå–å¾—è©²Taskå›å‚³çš„çµæœ</li>
<li>åœ¨Task<TResult>å–Resultæœ‰Exceptionæ™‚, æœƒåŒ…è£åœ¨AggregateException, æ²’è™•ç†çš„è©±æœƒè®“ç¨‹å¼ä¸­æ­¢</li>
</ul>
<h4 id="Entering-the-Thread-Pool-Without-TPL"><a href="#Entering-the-Thread-Pool-Without-TPL" class="headerlink" title="Entering the Thread Pool Without TPL"></a>Entering the Thread Pool Without TPL</h4><ul>
<li>ThreadPool.QueueUserWorkItem å’Œ asynchronous delegateséƒ½æ˜¯ä¸ä½¿ç”¨TPLè€Œç”¨Thread poolçš„æ–¹æ³•, å·®ç•°åœ¨æ–¼asynchronous delegateså¯å¾threadå›å‚³è³‡æ–™ã€å›å‚³exceptionçµ¦caller</li>
</ul>
<p><em><strong>QueueUserWorkItem</strong></em></p>
<ul>
<li>åƒæ˜¯new Threadä¸€æ¨£, ä»£å…¥voidçš„function, ä¹Ÿèƒ½ä»£å…¥åƒæ•¸, éƒ½åŒ…è£åœ¨object</li>
<li>å¦‚æœfunctionæœ‰æœªè™•ç†çš„exception, å°‡é€ æˆç¨‹å¼ä¸­æ­¢</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class QueueUserWorkItem<br>{<br>    static void Main(string[] args){</p>
<pre><code>    ThreadPool.QueueUserWorkItem(Go);
    ThreadPool.QueueUserWorkItem(Go, 12345);
    Console.Read();
&#125;

static void Go(object data)
&#123;
    Console.WriteLine(&quot;Hello &quot; + data);
&#125;
</code></pre>
<p>}</p>
<p><em><strong>Asynchronous delegates</strong></em></p>
<ul>
<li>èƒ½å¤ å›å‚³å€¼, åŸºæ–¼IAsyncResult</li>
<li>Asynchronous delegateå’Œasynchronous methodsä¸ä¸€æ¨£, æœ‰äº›å‡½å¼åº«ä¹Ÿæ˜¯ç”¨BeginXXX&#x2F;EndXXXé–‹é ­</li>
<li>ä½¿ç”¨Asynchronous delegatesçš„æµç¨‹:</li>
</ul>
<ol>
<li>å»ºç«‹è¦è¢«å§”è¨—çš„å‡½å¼, å¿…éœ€æŒ‡å®šæˆFuncé¡åˆ¥</li>
<li>ç”¨Funcçš„BeginInvokeå‘¼å«è©²å‡½å¼, æœƒå›å‚³IAsyncResult</li>
<li>ç”¨Funcçš„EndInvokeä»£å…¥IAsyncResultè®Šæ•¸, å°‡å–å¾—çµæœ</li>
</ol>
<p>using System;<br>using System.Threading;</p>
<p>class AsynchronousDelegate<br>{<br>    static void Main(string[] args){<br>        Func&lt;string, int, string&gt; task &#x3D; Go;<br>        IAsyncResult cookie &#x3D; task.BeginInvoke(â€œtestâ€, 123, null, null);<br>        string result &#x3D; task.EndInvoke(cookie);<br>        Console.WriteLine(â€œResult is â€œ + result);<br>        Console.Read();<br>    }</p>
<pre><code>static string Go(string name, int n)
&#123;
    return name + &quot; and &quot; + n.ToString();
&#125;
</code></pre>
<p>}</p>
<ul>
<li>EndInvokeæœƒåš3ä»¶äº‹:</li>
</ul>
<ol>
<li>å¦‚æœäº‹æƒ…é‚„æœªå®Œæˆ, æœƒç­‰å®ƒå®Œæˆ</li>
<li>æ¥æ”¶å›å‚³å€¼</li>
<li>å°‡Exceptionæ‹‹å›è‡³Caller</li>
</ol>
<ul>
<li>æŠ€è¡“ä¸Šä¾†è¬›, å¦‚æœå‡½å¼æ²’æœ‰è¦å›å‚³å€¼, å¯ä»¥ä¸å‘¼å«EndInvoke, ä½†å…§éƒ¨é€ æˆçš„Exceptionè¦å°å¿ƒ. æ‰€ä»¥å»ºè­°éƒ½å‘¼å«EndInvoke</li>
<li>å¦ä¸€ç¨®ç”¨æ³•æ˜¯æŠŠè™•ç†é‹ç®—çµæœå¯«åœ¨å¦ä¸€å€‹å§”è¨—å‡½å¼, è©²å‡½å¼æ¥æ”¶IAsyncResultçš„åƒæ•¸. è€Œä¸æ˜¯åœ¨Callerå‘¼å« EndInvoke</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class AsynchronousDelegate2<br>{<br>    static void Main(string[] args){<br>        Func&lt;string, int, string&gt; task &#x3D; Go;<br>        task.BeginInvoke(â€œtestâ€, 123, Done, task);<br>        Console.Read();<br>    }</p>
<pre><code>static void Done(IAsyncResult cookie)
&#123;
    var target = (Func&amp;lt;string, int, string&gt;) cookie.AsyncState;
    string result = target.EndInvoke(cookie);
    Console.WriteLine(&quot;Result is &quot; + result);
&#125;

static string Go(string name, int n)
&#123;
    return name + &quot; and &quot; + n.ToString();
&#125;
</code></pre>
<p>}</p>
<h4 id="Optimizing-the-Thread-Pool"><a href="#Optimizing-the-Thread-Pool" class="headerlink" title="Optimizing the Thread Pool"></a>Optimizing the Thread Pool</h4><ul>
<li>ThreadPool.SetMaxThreadså¯ä»¥è¨­ç½®Thread poolæœ€å¤šçš„Threadæ•¸é‡</li>
<li>æ¯å€‹ç’°å¢ƒæœ‰é è¨­çš„ä¸Šé™</li>
</ul>
<ol>
<li>Framework 4.0 &amp; 32-bit å¯è¨­1023å€‹</li>
<li>Framework 4.0 &amp; 64-bit å¯è¨­32768å€‹</li>
<li>Framework 3.5 å¯è¨­æ¯å€‹æ ¸å¿ƒ250å€‹</li>
<li>Framework 2.0 å¯è¨­æ¯å€‹æ ¸å¿ƒ25å€‹</li>
</ol>
<ul>
<li>ThreadPool.SetMinThreadsèƒ½è¨­ç½®æœ€å°çš„Threadæ•¸é‡, é è¨­æ˜¯æ¯å€‹coreæœƒæœ‰1å€‹</li>
<li>SetMinThreadsèƒ½å„ªåŒ–çš„ç‹€æ³æ˜¯, å› ç‚ºå»ºç«‹Threadæœƒæœ‰å»¶é², ä½†å¦‚æœSetMinThreadsæŒ‡å®šXå€‹, é€™Xå€‹Threadä¸è¦æœ‰å»¶é².</li>
</ul>
<h2 id="åƒè€ƒè³‡æ–™"><a href="#åƒè€ƒè³‡æ–™" class="headerlink" title="åƒè€ƒè³‡æ–™"></a>åƒè€ƒè³‡æ–™</h2><ol>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3lQcLky">C# 9.0 in a Nutshell: The Definitive Reference, Joseph Albahari (Amazon)</a></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/threading-in-csharp-series-book-summary/">Threading in C# ç³»åˆ—çš„è®€æ›¸ç­†è¨˜</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/24/refactoring-chapter-3-bad-smells-in-code-book-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/24/refactoring-chapter-3-bad-smells-in-code-book-summary/" class="post-title-link" itemprop="url">Bad Smells in Code</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-24 00:15:00" itemprop="dateCreated datePublished" datetime="2021-10-24T00:15:00+08:00">2021-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="What-are-bad-smells-in-code"><a href="#What-are-bad-smells-in-code" class="headerlink" title="What are bad smells in code?"></a>What are bad smells in code?</h2><p>This article references the chapter 3 of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. Author had highlighted many â€œpopularâ€ bad smells in code. These code smells can be identified by some characteristics. Letâ€™s browse these code smells!</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/10/stink-4265849_960_720.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/10/stink-4265849_960_720.png" alt="Bad Smells"></a></p>
<p>Bad Smell (Photo source:Â <a target="_blank" rel="noopener" href="https://pixabay.com/vectors/stink-smell-silhouette-nose-4265849/">https://pixabay.com/vectors/stink-smell-silhouette-nose-4265849/</a> )</p>
<h4 id="1-Mysterious-Name"><a href="#1-Mysterious-Name" class="headerlink" title="1: Mysterious Name"></a>1: Mysterious Name</h4><ul>
<li>Naming is one of the two hard things in programming</li>
<li>Guessing the naming meaning is a wasteful thing</li>
<li>Some skills refactor this problem, for example, <em>Change Function Declaration</em>, <em>Rename Variable</em> Â and <em>Rename Field</em></li>
</ul>
<h4 id="2-Duplicated-Code"><a href="#2-Duplicated-Code" class="headerlink" title="2: Duplicated Code"></a>2: Duplicated Code</h4><ul>
<li>If there are similar code appearing in different place, we must seriously check what the difference is. If we want to modify the duplicated code, all similar codes must be modified.</li>
<li>Some skills refactor this problem, for example,Â  <em>Extract Function</em>,Â  <em>Slide Statements</em>Â andÂ  <em>Pull Up Method</em></li>
</ul>
<h4 id="3-Long-Function"><a href="#3-Long-Function" class="headerlink" title="3: Long Function"></a>3: Long Function</h4><ul>
<li>Small functions are good at explanation, sharing and choosing</li>
<li>Modern IDEs have convenient shortcuts to jump to any function</li>
<li>The principle: If there is something should be commented to describe, we need to take it written in a function. Function naming is able to tell us what the way of the function is.</li>
<li>Some skills refactor this problem, for example,Â  <em>Extract Function</em>,Â  _Replace Temp with Query, Introduce Parameter Object, Preserve Whole object,Â _ <em>Replace function with Command, Decompose Conditional, Replace Conditional with Polymorphism</em> andÂ  <em>Split Loop</em></li>
</ul>
<h4 id="4-Long-Parameter-List"><a href="#4-Long-Parameter-List" class="headerlink" title="4: Long Parameter List"></a>4: Long Parameter List</h4><ul>
<li>Long parameter list confuses developersâ€¦</li>
<li>Some skills refactor this problem, for example,Â  <em>Replace Temp with Query, Preserve Whole Object, Introduce Parameter Object, Remove Flag Argument</em> and <em>Combine Functions into Class</em></li>
</ul>
<h4 id="5-Global-Data"><a href="#5-Global-Data" class="headerlink" title="5: Global Data"></a>5: Global Data</h4><ul>
<li>Itâ€™s the one of the unpleasant code smells</li>
<li>Every code can access it so debugging is very hard</li>
<li>Some skills refactor this problem, for example, <em>Encapsulate Variable</em></li>
</ul>
<h4 id="6-Mutable-Data"><a href="#6-Mutable-Data" class="headerlink" title="6: Mutable Data"></a>6: Mutable Data</h4><ul>
<li>If some data is modified and the other date somewhere is unexpected, the system fails</li>
<li>Immutable data restricts the update of the data and reduces the previous risks</li>
<li>Some skills refactor this problem, for example,Â  <em>Encapsulate Variable, Split Variable, Slide Statements, Extract Function, Separate Query from Modifier, Remove Setting Method,</em> <em>Replace Derived Variable with Query, Combine Functions into Class, Combine Functions into Transform</em> and <em>Change Reference to Value</em></li>
</ul>
<h4 id="7-Divergent-Change"><a href="#7-Divergent-Change" class="headerlink" title="7: Divergent Change"></a>7: Divergent Change</h4><ul>
<li>If some moduleâ€™s modification can not focused on on point, the divergent change happens</li>
<li>For example, for a class, if a new data source is added, we must modify 3 functions; another new data source is added, we must modify 4 functions. This is the divergent change.</li>
<li>Only focus on one context to avoid divergent change. It looks like SoC (Separation of Concern)</li>
<li>Some skills refactor this problem, for example,Â  <em>Split Phase, Move Function</em> <em>, Extract Function</em> andÂ  <em>Extract Class</em></li>
</ul>
<h4 id="8-Shotgun-Surgery"><a href="#8-Shotgun-Surgery" class="headerlink" title="8: Shotgun Surgery"></a>8: Shotgun Surgery</h4><ul>
<li>I very like this namingâ€¦. Itâ€™s impressive!</li>
<li>If something changes, we must modify many different classes</li>
<li>Some skills refactor this problem, for example, _Â Move Function_ <em>, Move Field, Combine Functions into Class, Combine Functions into Transform, Split Phase, Inline Function</em> andÂ  <em>Inline Class</em></li>
</ul>
<h4 id="9-Feature-Envy"><a href="#9-Feature-Envy" class="headerlink" title="9: Feature Envy"></a>9: Feature Envy</h4><ul>
<li>Some function frequently interacts with other moduleâ€™s function or data, itâ€™s feature envy.</li>
<li>There are some skills refactor this problem, for example, _Â Move Function_ andÂ  <em>Extract Function</em></li>
<li>Some patterns break this rule, like Strategy, Visitor and Kent Beckâ€™s Self Delegation. They are used to solve divergent change.</li>
</ul>
<h4 id="10-Data-Clumps"><a href="#10-Data-Clumps" class="headerlink" title="10: Data Clumps"></a>10: Data Clumps</h4><ul>
<li>For example, 2 classes have the same fields or many functions have the same parameter</li>
<li>Some skills refactor this problem, for example, <em>Extract Class, Introduce Parameter Object</em> andÂ  <em>Preserve Whole Object</em></li>
<li>Advanced action is to find feature envy and solve it</li>
</ul>
<h4 id="11-Primitive-Obsession"><a href="#11-Primitive-Obsession" class="headerlink" title="11: Primitive Obsession"></a>11: Primitive Obsession</h4><ul>
<li>Some types are not organized as classes, like money, coordinates, or ranges. Only use basic data type (int, float, stringâ€¦) to represent them.</li>
<li>For example, phone number is not only a string, it should be encapsulated as a class and provides a display logic for GUI.</li>
<li>Only using a string to represent a type is called â€œstringly typedâ€</li>
<li>Some skills refactor this problem, for example, _Â Replace Primitive with Object_ <em>, Replace Type Code with Subclasses, Replace Conditional with Polymorphism, Extract Class</em> andÂ  <em>Introduce Parameter Object</em></li>
</ul>
<h4 id="12-Repeated-Switches"><a href="#12-Repeated-Switches" class="headerlink" title="12: Repeated Switches"></a>12: Repeated Switches</h4><ul>
<li>Somewhere code uses the same switch logic, including either switch&#x2F;case statements or if&#x2F;else statements. If we want to add a new clause, we must find all switches and update them.</li>
<li>Some skills refactor this problem, for example, <em>Replace Conditional with Polymorphism</em></li>
</ul>
<h4 id="13-Loops"><a href="#13-Loops" class="headerlink" title="13: Loops"></a>13: Loops</h4><ul>
<li>Omgâ€¦.The author think of â€œLoopâ€ as old-school thingâ€¦.</li>
<li>Some skills refactor this problem, for example, <em>Replace Loop with Pipeline</em></li>
<li>Pipeline like map&#x2F;filter can help us understand what elements are processed</li>
</ul>
<h4 id="14-Lazy-Elements"><a href="#14-Lazy-Elements" class="headerlink" title="14. Lazy Elements"></a>14. Lazy Elements</h4><ul>
<li>Some functions or classes are unnecessarily wrapped. For example, a class is just a function.</li>
<li>Some skills refactor this problem, for example, <em>Inline Function, Inline Class</em> andÂ  <em>Collapse Hierarchy</em></li>
</ul>
<h4 id="15-Speculative-Generality"><a href="#15-Speculative-Generality" class="headerlink" title="15. Speculative Generality"></a>15. Speculative Generality</h4><ul>
<li>Some logic is designed only for specificÂ machinery instead of all machinery, then this logic is speculative generality.</li>
<li>Some skills refactor this problem, for example, <em>Collapse Hierarchy, Inline Function, Inline Class, Change Function Declaration</em> andÂ  <em>Remove Dead Code</em></li>
</ul>
<h4 id="16-Temporary-Field"><a href="#16-Temporary-Field" class="headerlink" title="16. Temporary Field"></a>16. Temporary Field</h4><ul>
<li>A field of a class is only used in some situations. Other developers look at this field and guess what scope is.</li>
<li>Some skills refactor this problem, for example, <em>Extract Class, Move Function</em> and <em>Introduce Special Case</em></li>
</ul>
<h4 id="17-Message-Chains"><a href="#17-Message-Chains" class="headerlink" title="17. Message Chains"></a>17. Message Chains</h4><ul>
<li>A client calls one object A, then object A calls object B, then object B calls object C, and so on. If the relationship of the called objects changes, the client should correspondingly modify.</li>
<li>Some skills refactor this problem, for example, <em>Hide Delegate, Extract Function and Move Function</em></li>
</ul>
<h4 id="18-Middle-Man"><a href="#18-Middle-Man" class="headerlink" title="18. Middle Man"></a>18. Middle Man</h4><ul>
<li>If the half functions of a class are delegated to other classes, these delegations are overused.</li>
<li>Some skills refactor this problem, for example, <em>Remove Middle Man, Inline Function, Replace Superclass with Delegate</em> and <em>Replace Subclass with Delegate.</em></li>
</ul>
<h4 id="19-Insider-Trading"><a href="#19-Insider-Trading" class="headerlink" title="19. Insider Trading"></a>19. Insider Trading</h4><ul>
<li>A large amount of data exchange occurs between modules.</li>
<li>Some skills refactor this problem, for example, <em>Move Function, Move Field, Hide Delegate, Replace Subclass with Delegate</em> and <em>Replace Superclass with Delegate</em></li>
</ul>
<h4 id="20-Large-Class"><a href="#20-Large-Class" class="headerlink" title="20. Large Class"></a>20. Large Class</h4><ul>
<li>A class has many abilities so that it many fields. Repeated code follows up.</li>
<li>Some skills refactor this problem, for example, <em>Extract Class, Extract Superclass</em> and <em>Replace Type Code with Subclass</em></li>
</ul>
<h4 id="21-Alternative-Classes-with-Different-Interfaces"><a href="#21-Alternative-Classes-with-Different-Interfaces" class="headerlink" title="21. Alternative Classes with Different Interfaces"></a>21. Alternative Classes with Different Interfaces</h4><ul>
<li>A class is replaced with other class when they have the same interface</li>
<li>Some skills refactor this problem, for example, <em>Change Function Declaration, Move Function</em> and <em>Extract Superclass</em></li>
</ul>
<h4 id="22-Data-Class"><a href="#22-Data-Class" class="headerlink" title="22. Data Class"></a>22. Data Class</h4><ul>
<li>A data class only puts get&#x2F;set fields without behavior. Some clientâ€™s behavior should be put in this data class.</li>
<li>Some skills refactor this problem, for example, <em>Encapsulate Record, Remove Setting Method, Move Function, Extract Function</em> and <em>Split Phase</em></li>
</ul>
<h4 id="23-Refused-Bequest"><a href="#23-Refused-Bequest" class="headerlink" title="23. Refused Bequest"></a>23. Refused Bequest</h4><ul>
<li>A subclass has inherited superclassâ€™s functions and data. If this subclass doesnâ€™t want them, it only chooses some from them.</li>
<li>Some skills refactor this problem, for example, <em>Push Down Method, Push Down Field, Replace Subclass with Delegate</em> and <em>Replace Superclass with Delegate</em></li>
</ul>
<h4 id="24-Comments"><a href="#24-Comments" class="headerlink" title="24. Comments"></a>24. Comments</h4><ul>
<li>Some comments explain what the terrible code work for. If this code is refactored, the comments are redundant.</li>
<li>Some skills refactor this problem, for example, <em>Extract Function, Change Function Declaration</em> and <em>Introduce Assertion</em></li>
</ul>
<p>The tip at bookâ€™s page 84 describes:</p>
<blockquote>
<p>When you feel the need to write a comment, first try to refactor the code so that any comment becomes superfluous.</p>
</blockquote>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[Refactoring: Improving the Design of Existing Code (2nd Edition)](Improving the Design of Existing Code (2nd Edition))</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/17/refactoring-chapter-2-principles-in-refactoring-book-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/17/refactoring-chapter-2-principles-in-refactoring-book-summary/" class="post-title-link" itemprop="url">Principles in Refactoring</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-17 00:58:00" itemprop="dateCreated datePublished" datetime="2021-10-17T00:58:00+08:00">2021-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="What-are-principles-in-refactoring"><a href="#What-are-principles-in-refactoring" class="headerlink" title="What are principles in refactoring?"></a>What are principles in refactoring?</h1><p>This article references the chapter 2 ofÂ  <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. We need understand what principles are in refactoring and we can refactor codes smoothly.</p>
<h4 id="1-Defining-Refactoring"><a href="#1-Defining-Refactoring" class="headerlink" title="1. Defining Refactoring"></a>1. Defining Refactoring</h4><ul>
<li>Nounâ€™s definition: A change made to the internal structure of software to make it easier to understand and cheaper to modify without changing its observable behavior.</li>
<li>Verbâ€™s definition: To restructure software by applying a series of refactorings without changing its observable behavior.</li>
</ul>
<p>Both definitions have the same objective: donâ€™t change the softwareâ€™s behavior.</p>
<p>Like electrical wiring for our life, we plug electrical appliances and theÂ electric currentÂ moves through the wiring. The plug-in is like an API. Electrical appliances get the electric current with this API and donâ€™t understand what plug-in electrical panel works. If APIâ€™s internal code structure is like:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/10/before.jpg"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/10/before-300x277.jpg" alt="before refactoring"></a></p>
<p>Electrical Panel before re-wiring (Source:Â <a target="_blank" rel="noopener" href="https://theintegrityexperience.com/rewiring-a-house-and-electrical-panel-upgrade/">https://theintegrityexperience.com/rewiring-a-house-and-electrical-panel-upgrade/</a>)</p>
<p>Itâ€™s ugly but it still works to supply electric current. Someday, the power failure occurs and we should check the electrical panel then open it, OS: â€œWhat the hellâ€ and very hard to find the broken wiresâ€¦..</p>
<p>After refactorings(re-wiring), the new electrical panel is like:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/10/after.jpg"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/10/after-300x278.jpg" alt="after refactoring"></a></p>
<p>Electrical Panel after re-wiring (Source:Â <a target="_blank" rel="noopener" href="https://theintegrityexperience.com/rewiring-a-house-and-electrical-panel-upgrade/">https://theintegrityexperience.com/rewiring-a-house-and-electrical-panel-upgrade/</a>)</p>
<p>What a beautiful wiring! It supplies electric current like the last ugly wiring but next time we will find correct wires quickly. ThisÂ analogy to our coding refactorings is very similar.</p>
<p>The tip at bookâ€™s page 46 describes:</p>
<blockquote>
<p>If someone says their code was broken for a couple of days while they are refactoring, you can be pretty sure they were not refactoring.</p>
</blockquote>
<p>This tip is very funny XD. According to chapter 1â€™s tip, refactoring is driven by testings. Every refactoring step is done, then run the testings to validate theÂ observable behavior is not changed.</p>
<h4 id="2-The-Two-Hats"><a href="#2-The-Two-Hats" class="headerlink" title="2. The Two Hats"></a>2. The Two Hats</h4><p>When we are developing the software, we have 2 hats: one hat for adding functionality and the other one for refactoring. Only wear one of these 2 hats in a period of developing. Do not add functionality and refactor concurrently.</p>
<h4 id="3-Why-Should-We-Refactor"><a href="#3-Why-Should-We-Refactor" class="headerlink" title="3. Why Should We Refactor?"></a>3. Why Should We Refactor?</h4><h5 id="3-1-Refactoring-Improves-the-Design-of-Software"><a href="#3-1-Refactoring-Improves-the-Design-of-Software" class="headerlink" title="3.1 Refactoring Improves the Design of Software"></a>3.1 Refactoring Improves the Design of Software</h5><ul>
<li>If we donâ€™t refactor, the code becomes more messy</li>
<li>Messy code means maintenance is more difficult.</li>
<li>DRY (Donâ€™t Repeat Yourself) is a fundamental design principleÂ and reduces the code size</li>
</ul>
<h5 id="3-2-Refactoring-Makes-Software-Easier-to-Understand"><a href="#3-2-Refactoring-Makes-Software-Easier-to-Understand" class="headerlink" title="3.2 Refactoring Makes Software Easier to Understand"></a>3.2 Refactoring Makes Software Easier to Understand</h5><ul>
<li>Programmer is the reader of the code and itâ€™s the major time cost</li>
<li>If the reader spends 1 week understanding the code and modifying it â€”- What a terrible code</li>
<li>If the reader spends 1 hour understanding the codeÂ Â and modifying it â€”- What a great code</li>
<li>We spend a little time refactoring our code and make the code more readable. Next time the reader will spend less time working.</li>
<li>If the code function is easily looked up by documentation, programmers donâ€™tÂ deliberately remember them.</li>
</ul>
<h5 id="3-3-Refactoring-Helps-Me-Find-Bugs"><a href="#3-3-Refactoring-Helps-Me-Find-Bugs" class="headerlink" title="3.3 Refactoring Helps Me Find Bugs"></a>3.3 Refactoring Helps Me Find Bugs</h5><ul>
<li>When we are refactoring the code, code structure maybe shows some bugs we have never noticed</li>
</ul>
<h5 id="3-4-Refactoring-Helps-Me-Program-Faster"><a href="#3-4-Refactoring-Helps-Me-Program-Faster" class="headerlink" title="3.4 Refactoring Helps Me Program Faster"></a>3.4 Refactoring Helps Me Program Faster</h5><ul>
<li>The previous points result in this point</li>
<li>Does not the time of refactoring slow the development? No! If the system with poor design, it would add features like putting many â€œpatchesâ€ on itâ€¦. Itâ€™s hard to understand what a module works.</li>
<li>Design Stamina Hypothesis: Good designs increase the stamina of the software effort</li>
<li>Refactoring makes the design better than the last</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/10/cumulativeTimeWithGoodPoorDesign.drawio.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/10/cumulativeTimeWithGoodPoorDesign.drawio-300x209.png"></a></p>
<p>The development time with good and poor design (Redraw at bookâ€™s page 49)</p>
<h4 id="4-When-Should-We-Refactor"><a href="#4-When-Should-We-Refactor" class="headerlink" title="4. When Should We Refactor?"></a>4. When Should We Refactor?</h4><h5 id="The-Rule-of-Three"><a href="#The-Rule-of-Three" class="headerlink" title="The Rule of Three"></a>The Rule of Three</h5><p>The first time you do something, you just do it. The second time you do something similar, you wince at the duplication, but you do the duplicate thing anyway. The third time you do something similar, you refactor. Or for those who like baseball: <strong>Three strikes, then you refactor.</strong></p>
<h5 id="4-1-Preparatory-Refactoring-Making-It-Easier-to-Add-a-feature"><a href="#4-1-Preparatory-Refactoring-Making-It-Easier-to-Add-a-feature" class="headerlink" title="4.1 Preparatory Refactoring - Making It Easier to Add a feature"></a>4.1 Preparatory Refactoring - Making It Easier to Add a feature</h5><ul>
<li><em>Parameterize Function</em> skill reduces the duplicated code. Similar codes are centered.</li>
<li>Like before I move to a place, I check the map and find a short route to arrive at the place.</li>
</ul>
<h5 id="4-2-Comprehension-Refactoring-Making-Code-Easier-to-Understand"><a href="#4-2-Comprehension-Refactoring-Making-Code-Easier-to-Understand" class="headerlink" title="4.2 Comprehension Refactoring: Making Code Easier to Understand"></a>4.2 Comprehension Refactoring: Making Code Easier to Understand</h5><ul>
<li>Read codes to understand â€œWhat is the section of the code doing?â€. Spending much time readingÂ  code is a refactoring chance.</li>
<li>Refactoring makes the code logics clearer</li>
</ul>
<h5 id="4-3-Litter-Pickup-Refactoring"><a href="#4-3-Litter-Pickup-Refactoring" class="headerlink" title="4.3 Litter-Pickup Refactoring"></a>4.3 Litter-Pickup Refactoring</h5><ul>
<li>If there is a small trash code (duplicated codes, terrible variable namingâ€¦), immediately refactor it</li>
<li>If the trash code is not easy to be refactored with current task, note the trash code, put it aside and continue current task. After finish the task, then refactor the noted trash code.</li>
</ul>
<h5 id="4-4-Planned-and-Opportunistic-Refactoring"><a href="#4-4-Planned-and-Opportunistic-Refactoring" class="headerlink" title="4.4 Planned and Opportunistic Refactoring"></a>4.4 Planned and Opportunistic Refactoring</h5><ul>
<li>Previous 3 refactoring examples areÂ opportunistic. Planned refactoring is not a natural thing. Adding features or fixing bugs are normal with refactoring.</li>
</ul>
<p>The tip at bookâ€™s page 52 describes:</p>
<blockquote>
<p>You have to refactor when you run into ugly code - bug excellent code needs plenty of refactoring too.</p>
</blockquote>
<p>Kent Beck also described:</p>
<blockquote>
<p>For each desired change, make the change easy (warning: this may be hard), then make the easy change.</p>
</blockquote>
<p>The two sections are excellent points.</p>
<ul>
<li>Author thinks that creating a new branch to refactor codes in control version system is not good because refactoring is closed with adding new features.</li>
</ul>
<h5 id="4-5-Long-Term-Refactoring"><a href="#4-5-Long-Term-Refactoring" class="headerlink" title="4.5 Long-Term Refactoring"></a>4.5 Long-Term Refactoring</h5><ul>
<li>Like previous Planned Refactoring, itâ€™s not recommend by author.</li>
<li>Example: If the system wants to replace a existing library, use <em>Branch By Abstraction</em> to make the replacement easy</li>
</ul>
<h5 id="4-6-Refactoring-in-a-Code-Review"><a href="#4-6-Refactoring-in-a-Code-Review" class="headerlink" title="4.6 Refactoring in a Code Review"></a>4.6 Refactoring in a Code Review</h5><ul>
<li>Better practice: Pair-programming and refactoring&#x2F;reviewing the code</li>
</ul>
<h5 id="4-7-What-Do-I-Tell-My-Manager"><a href="#4-7-What-Do-I-Tell-My-Manager" class="headerlink" title="4.7 What Do I Tell My Manager?"></a>4.7 What Do I Tell My Manager?</h5><ul>
<li>If the manager doesnâ€™t know what the refactoring is, donâ€™t tell him&#x2F;her why you do refactoring. Manger just wants the task to be finished before the deadline. We just use refactoring this professional skill to smoothly complete the job.</li>
</ul>
<h5 id="4-8-When-Should-I-Not-Refactor"><a href="#4-8-When-Should-I-Not-Refactor" class="headerlink" title="4.8 When Should I Not Refactor?"></a>4.8 When Should I Not Refactor?</h5><ul>
<li>If there is a messy code and itâ€™s not required to be modified, donâ€™t refactor with it.</li>
<li>If some ugly code is hidden under an API, donâ€™t refactor.</li>
<li>Sometimes rewriting is easier than refactoring but itâ€™s hard to decide which method should be executed.</li>
</ul>
<h4 id="5-Problems-with-Refactoring"><a href="#5-Problems-with-Refactoring" class="headerlink" title="5. Problems with Refactoring"></a>5. Problems with Refactoring</h4><h5 id="5-1-Slowing-Down-New-Features"><a href="#5-1-Slowing-Down-New-Features" class="headerlink" title="5.1 Slowing Down New Features"></a>5.1 Slowing Down New Features</h5><p>The tip at bookâ€™s page 56 describes:</p>
<blockquote>
<p>The whole purpose of refactoring is to make us program faster, producing more value with less effort.</p>
</blockquote>
<ul>
<li>If there are a large-scale refactoring situation and small-scale urgent new feature, finish the urgent new feature and then back to the refactoring.</li>
<li>Refactoringâ€™s target doesnâ€™t equal to the one ofÂ  â€œClean Codeâ€ and â€œGood Engineering Practiceâ€. Refactoring focuses on adding features quickly, fixing bugs quickly.</li>
</ul>
<h5 id="5-2-Code-Ownership"><a href="#5-2-Code-Ownership" class="headerlink" title="5.2 Code Ownership"></a>5.2 Code Ownership</h5><ul>
<li>Example: A naming is not good and we use <em>Change Function Declaration</em> skill to rename it. But the renamed function is used by other teams &#x2F; product API caller, it will result in blocked situation.</li>
<li>Use <em>Rename Function</em> skill and the old function is pass-through to the new one. Mark the old function as [deprecated].</li>
<li>Team ownership of code is recommended by author, not only restricted to one person.</li>
</ul>
<h5 id="5-3-Branches"><a href="#5-3-Branches" class="headerlink" title="5.3 Branches"></a>5.3 Branches</h5><ul>
<li>Every branch is responsible for specific features, after a period, those branches will be merged into master&#x2F;trunk. But if the feature branch is isolated for a long time, the integration with master will be hard.</li>
<li>Refactoring like renaming for merging branch sometimes is a difficult integration</li>
<li>Continuous Integration (CI) &#x2F; Trunk-Based Development: Use this practice to require every member to merge branch into master and integrate. This action avoid the large difference between branches.</li>
<li>Refactoring very fits CI practice. Small changes are easily integrated when using CI.</li>
<li>Kent Beckâ€™s Extreme programming uses CI and refactoring</li>
</ul>
<h5 id="5-4-Testing"><a href="#5-4-Testing" class="headerlink" title="5.4 Testing"></a>5.4 Testing</h5><ul>
<li>If we want refactoring, self-testing code is required. This is a very important one of principles in refactoring!</li>
<li>If no testing can support, we can use automated refactoring. But it only executes safe refactoring methods.</li>
<li>Special style of refactoring: only use proved and absolutely safe refactoring methods. Like an example that shows how to safely execute <em>Extract Method</em> skill in C++ provided by Jay Bazuzi.</li>
<li>I very recommend that every programmer should read this book to learn unit testing:Â <a target="_blank" rel="noopener" href="http://bit.ly/3lIj2il">The Art of Unit Testing: with examples in C# written by Roy Osherove</a></li>
</ul>
<h5 id="5-5-Legacy-Code"><a href="#5-5-Legacy-Code" class="headerlink" title="5.5 Legacy Code"></a>5.5 Legacy Code</h5><ul>
<li>Legacy code without testings is very terribleâ€¦</li>
<li>Adding new testings in current legacy code is not easy</li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3LSs0o2">Working Effectively with Legacy Code byÂ Michael Feathers</a>Â is recommended by author. It teaches how to perform refactoring and testings in legacy code</li>
<li>Step-by-step refactor legacy code instead of changing it widely. I think this is the hardest one of principles in refactoring.</li>
</ul>
<h5 id="5-6-Databases"><a href="#5-6-Databases" class="headerlink" title="5.6 Databases"></a>5.6 Databases</h5><ul>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3ZibiRK">Refactoring Databases: Evolutionary Database DesignÂ byÂ Scott Ambler &amp; Pramod Sadalage</a>Â Â is recommended by author.</li>
<li>Add migration scripts into version control system with code. This makes the database development efficient</li>
<li>Example with .NET, Entity Framework has a migration tool to upgrade&#x2F;downgrade databaseâ€™s structure.</li>
<li>The book provides a refactoring skill:Â parallel change. I think I should buy this book to deeply learn it!</li>
</ul>
<h4 id="6-Refactoring-Architecture-and-Yagni"><a href="#6-Refactoring-Architecture-and-Yagni" class="headerlink" title="6. Refactoring, Architecture, and Yagni"></a>6. Refactoring, Architecture, and Yagni</h4><ul>
<li>In early period, architecture was first designed. So the later development was restricted with the architecture and the system continued to become decayed.</li>
<li>Refactoring is the iterative method to improve current design</li>
<li>you arenâ€™t going to need it : Yagni mixes architecture, design and development and depends on refactoring</li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/42E812e">Building Evolutionary Architecturesï¼š Support Constant Change byÂ Neal Ford, Rebecca Parsons, Patrick Kua</a>Â is a continuously developing subject and discover what pattern and practice are useful for iterative developement.</li>
</ul>
<h4 id="7-Refactoring-and-the-Wider-Software-Development-Process"><a href="#7-Refactoring-and-the-Wider-Software-Development-Process" class="headerlink" title="7. Refactoring and the Wider Software Development Process"></a>7. Refactoring and the Wider Software Development Process</h4><ul>
<li>Self-testing is the first foundation of refactoring</li>
<li>Self-testing, CI and refactoring are the 3 major practices for a refactoring team</li>
<li>Based on these 3 practices, some products can be published in one day</li>
<li>These practices are not easy to build up</li>
</ul>
<h4 id="8-Refactoring-and-Performance"><a href="#8-Refactoring-and-Performance" class="headerlink" title="8. Refactoring and Performance"></a>8. Refactoring and Performance</h4><ul>
<li>3 methods to write fast software</li>
</ul>
<ol>
<li>Time budgeting: Itâ€™s a serious method for real time system likeÂ heart pacemakers. Every module is restricted with limited resources. Â  Â  Â </li>
<li>Constant attention: Every programmer keeps the system with high performance anytime.</li>
<li>Use the optimization statistic analysis to improve the system</li>
</ol>
<h4 id="9-Where-Did-Refactoring-Come-From"><a href="#9-Where-Did-Refactoring-Come-From" class="headerlink" title="9. Where Did Refactoring Come From?"></a>9. Where Did Refactoring Come From?</h4><ul>
<li>In 1980, Smalltalk project with refactoring skills influenced the development community</li>
<li>First one wrote the refactoring book is Martin Fowler</li>
</ul>
<h4 id="10-Automated-Refactorings"><a href="#10-Automated-Refactorings" class="headerlink" title="10. Automated Refactorings"></a>10. Automated Refactorings</h4><ul>
<li>IntelliJ IDEA provides many automated refactoring tools for popular programming language.</li>
<li>IDE analyzes the syntax tree of the code and provides safer refactoring results</li>
</ul>
<h4 id="11-Going-Further"><a href="#11-Going-Further" class="headerlink" title="11. Going Further"></a>11. Going Further</h4><ul>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3TLvrhV">Refactoring Workbook byÂ Ross Venables, William Wake, John Fuller</a></li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3FNMrhJ">Refactoring to Patterns by Joshua Kerievsky</a> </li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/40fYOM0">Refactoring HTML: Improving the Design of Existing Web Applications by Elliotte Rusty Harold</a></li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3lLkwZi">Refactoring: Ruby Edition by Jay Fields, Shane Harvie, Martin Fowler, Kent Beck</a></li>
<li><a target="_blank" rel="noopener" href="http://refactoring.com/">refactoring.com</a></li>
<li>I think these great authors of the books have the similar principles in refactoring</li>
</ul>
<h4 id="12-Conclusion"><a href="#12-Conclusion" class="headerlink" title="12. Conclusion"></a>12. Conclusion</h4><p>All above principles in refactoring is impressive guideline for every programmers when they want to refactor their handy codes. Do you have special principles in refactoring? Comment them!</p>
<h4 id="13-References"><a href="#13-References" class="headerlink" title="13. References"></a>13. References</h4><p><a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/08/poeaa-data-source-architectural-pattern-data-mapper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/08/poeaa-data-source-architectural-pattern-data-mapper/" class="post-title-link" itemprop="url">Data Mapper Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-07-08 00:02:00" itemprop="dateCreated datePublished" datetime="2021-07-08T00:02:00+08:00">2021-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Data-Mapper"><a href="#1-What-is-Data-Mapper" class="headerlink" title="1. What is Data Mapper"></a>1. What is Data Mapper</h3><p>According to [PoEAA], this definition is â€œA layer of Mappers that moves data between objects and a database while keeping them independent of each other and the mapper itself.â€</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-5.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-3.png"></a></p>
<p>Figure 1. Data Mapper (FromÂ <a target="_blank" rel="noopener" href="https://martinfowler.com/eaaCatalog/index.html">PoEAA Page</a>)</p>
<h4 id="1-1-How-it-works"><a href="#1-1-How-it-works" class="headerlink" title="1.1 How it works"></a>1.1 How it works</h4><p><strong>Separating Domain from Data Source is the main ability.</strong> Figure 2 shows that a client uses a person mapperâ€™s Find function to get a person instance from database. This mapper uses an <strong>Identity Map</strong>Â to check if the person instance is loaded or not. If itâ€™s not loaded, then loads it to the map. Â  Figure 3 shows that a client uses mapperâ€™s Update function and mapper reads the data from person instance to write data into database. Â </p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/ReadData-2.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/ReadData-1.png" alt="Retrieving data from database data mapper"></a></p>
<p>Figure 2. Retrieving data from database</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/Update-2.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/Update-1.png" alt="Updating Data data mapper"></a></p>
<p>Figure 3. Updating Data</p>
<p>For finding function, there are 3 topics to discuss:</p>
<h5 id="1-1-1-Handling-Finders"><a href="#1-1-1-Handling-Finders" class="headerlink" title="1.1.1 Handling Finders"></a>1.1.1 Handling Finders</h5><p>Usually presentation layer uses mapperâ€™s finding function to load objects from database. But sometimes domain layer needs to use mapperâ€™s finding function. This situation can be avoided by using Lazy Load pattern. Â  Separating finding interfaces to domain namespace(package) for mapperâ€™s implementation is a decoupling method.</p>
<h5 id="1-1-2-Mapping-Data-to-Domain-Fields"><a href="#1-1-2-Mapping-Data-to-Domain-Fields" class="headerlink" title="1.1.2 Mapping Data to Domain Fields"></a>1.1.2 Mapping Data to Domain Fields</h5><p>Mapper creating a rich constructor to create a domain object is a recommend method. Avoid directly setting fields&#x2F;properties of domain object. If two objects are referenced each other when mapper creates them by rich constructor, using Lazy Load is a method to solve it. Â </p>
<h5 id="1-1-3-Metadata-Based-Mappings"><a href="#1-1-3-Metadata-Based-Mappings" class="headerlink" title="1.1.3 Metadata-Based Mappings"></a>1.1.3 Metadata-Based Mappings</h5><p>Metadata-Mapping pattern is a method that transfers domain objectâ€™s fields into databaseâ€™s records. The metadata is saved in a class or a independent file. Using it can have no more source code&#x2F;code generation&#x2F;reflection programs.</p>
<h4 id="1-2-When-to-use-it"><a href="#1-2-When-to-use-it" class="headerlink" title="1.2 When to use it"></a>1.2 When to use it</h4><ol>
<li>Domain Model donâ€™t understand database existence. Modifying domain objects or mappers is more efficient.</li>
<li>For more complex business logic.</li>
<li>If Domain Model is not used, Data Mapper is not required.</li>
</ol>
<h3 id="2-Pattern-Practice-The-Person-Management"><a href="#2-Pattern-Practice-The-Person-Management" class="headerlink" title="2. Pattern Practice: The Person Management"></a>2. Pattern Practice: The Person Management</h3><p>This problem is introduced in the previous articleÂ <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/">[PoEAA] Data Source Architectural Pattern - Table Data Gateway</a>. This article uses Data Mapper to build the data source architectural layer.</p>
<h4 id="2-1-Implementation-by-C-SQLite"><a href="#2-1-Implementation-by-C-SQLite" class="headerlink" title="2.1 Implementation by C# &amp; SQLite"></a>2.1 Implementation by C# &amp; SQLite</h4><p>This pattern is implemented by C# based on the content ofÂ <strong>Chapter 10 Data Source Architectural Patterns - Data Mapper</strong>Â of PoEAA. The database is SQLite.</p>
<p>By Martinâ€™s implementation, it doesnâ€™t contain a Delete function in a data mapper. So this article also has no Delete function.</p>
<h5 id="2-1-1-Domain-Mapper-layers"><a href="#2-1-1-Domain-Mapper-layers" class="headerlink" title="2.1.1 Domain&#x2F;Mapper layers"></a>2.1.1 Domain&#x2F;Mapper layers</h5><p>Create Domain and Mapper these 2 layers to separate responsibilities. Figure 4 shows: Â </p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/Architecture-2.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/Architecture-1.png" alt="Domain/Mapper layers data mapper"></a></p>
<p>Figure 4. Domain&#x2F;Mapper layers</p>
<p>Following sections explain what they work for.</p>
<h5 id="2-1-2-AbstractMapper-PersonMapper-classes"><a href="#2-1-2-AbstractMapper-PersonMapper-classes" class="headerlink" title="2.1.2 AbstractMapper&#x2F;PersonMapper classes"></a>2.1.2 AbstractMapper&#x2F;PersonMapper classes</h5><p>AbstractMapper class has common behaviors for concrete child Mapper classes. AbstractMapper has a <strong>Identity Map</strong>: Dictionary&lt;int, DomainObject&gt; LoadedMap. When loading is processing, mapper uses this map to check whether this domain object has been loaded or not. If not, then mapper loads it from database. Â  AbstractMapperâ€™s DoLoad&#x2F;DoInsert are abstract methods. They are override by concrete child Mapper classes. PersonMapper implements these abstract methods and access Person domain objects from database. Â  For Update function, this is implemented by concrete Mapper instead of abstract method. Â  PersonMapper has implemented IPersonFinder interface. This interface is defined in Domain layer for responsibility. Â </p>
<p>public abstract class AbstractMapper<br>{<br>protected Dictionary&lt;int, DomainObject&gt; LoadedMap &#x3D; new Dictionary&lt;int, DomainObject&gt;();<br>protected abstract string FindStatement();<br>protected abstract string InsertStatement();</p>
<p>protected abstract int FindNextDatabaseId();</p>
<p>protected DomainObject AbstractFind(int id)<br>{<br>bool findResult &#x3D; LoadedMap.TryGetValue(id, out DomainObject result);<br>if (findResult)<br>{<br>return result;<br>}</p>
<p>try<br>{<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(FindStatement(), conn);<br>comm.Parameters.Add(new SQLiteParameter(â€œ$idâ€, id));<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>reader.Read();<br>result &#x3D; Load(reader);<br>return result;<br>}<br>catch (Exception ex)<br>{<br>throw new ApplicationException(ex.Message);<br>}<br>}</p>
<p>protected DomainObject Load(IDataReader reader)<br>{<br>object[] resultSet &#x3D; new object[reader.FieldCount];<br>reader.GetValues(resultSet);</p>
<p>int id &#x3D; (int)resultSet[0];<br>if (LoadedMap.ContainsKey(id))<br>{<br>return LoadedMap[id];<br>}</p>
<p>DomainObject result &#x3D; DoLoad(id, reader);<br>LoadedMap.Add(id, result);<br>return result;<br>}</p>
<p>protected List&lt;DomainObject&gt; LoadAll(IDataReader reader)<br>{<br>List&lt;DomainObject&gt; result &#x3D; new List&lt;DomainObject&gt;();<br>while (reader.Read())<br>{<br>result.Add(Load(reader));<br>}</p>
<p>return result;<br>}</p>
<p>protected abstract DomainObject DoLoad(int id, IDataReader reader);</p>
<p>public int Insert(DomainObject subject)<br>{<br>try<br>{<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(InsertStatement(), conn);<br>subject.Id &#x3D; FindNextDatabaseId();<br>var parameter &#x3D; comm.CreateParameter();<br>parameter.DbType &#x3D; DbType.Int32;<br>parameter.Value &#x3D; subject.Id;<br>comm.Parameters.Add(parameter);<br>DoInsert(subject, comm);<br>comm.ExecuteNonQuery();<br>LoadedMap.Add(subject.Id, subject);<br>return subject.Id;<br>}<br>catch (Exception ex)<br>{<br>throw new ApplicationException(ex.Message);<br>}</p>
<p>}</p>
<p>protected abstract void DoInsert(DomainObject subject, IDbCommand insertStatement);</p>
<p>public List&lt;DomainObject&gt; FindMany(IStatementSource source)<br>{<br>try<br>{<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(source.Sql, conn);<br>foreach (var p in source.Parameters)<br>{<br>var parameter &#x3D; comm.CreateParameter();<br>parameter.DbType &#x3D; DbType.Object;<br>parameter.Value &#x3D; p;<br>comm.Parameters.Add(parameter);<br>}<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>return LoadAll(reader);<br>}<br>catch (Exception ex)<br>{<br>throw new ApplicationException(ex.Message);<br>}<br>}</p>
<p>}</p>
<p>public class PersonMapper : AbstractMapper, IPersonFinder<br>{<br>private const string Columns &#x3D; â€œ id, lastname, firstname, numberOfDependents â€œ;</p>
<p>private const string UpdateStatementString &#x3D;<br>â€œUPDATE person SET lastname &#x3D; ?, firstname &#x3D; ?, numberOfDependents &#x3D; ? WHERE id &#x3D; ?â€;<br>protected override string FindStatement()<br>{<br>return â€œSELECT â€œ + Columns + â€œ FROM person WHERE id &#x3D; $idâ€;<br>}</p>
<p>protected override string InsertStatement()<br>{<br>return â€œINSERT INTO person VALUES (?, ?, ?, ?)â€;<br>}</p>
<p>protected override int FindNextDatabaseId()<br>{<br>string sql &#x3D; â€œSELECT max(id) as curId from personâ€;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>bool hasResult &#x3D; reader.Read();<br>if (hasResult)<br>{<br>return ((int)((long)reader[â€œcurIdâ€] + 1));<br>}<br>else<br>{<br>return 1;<br>}<br>}</p>
<p>protected override DomainObject DoLoad(int id, IDataReader reader)<br>{<br>object[] resultSet &#x3D; new object[reader.FieldCount];<br>reader.GetValues(resultSet);<br>string lastName &#x3D; resultSet[1].ToString();<br>string firstName &#x3D; resultSet[2].ToString();<br>int numberOfDependents &#x3D; (int)resultSet[3];<br>return new Person(id, lastName, firstName, numberOfDependents);<br>}</p>
<p>protected override void DoInsert(DomainObject subject, IDbCommand insertStatement)<br>{<br>Person person &#x3D; (Person) subject;<br>var p1 &#x3D; insertStatement.CreateParameter();<br>p1.DbType &#x3D; DbType.String;<br>p1.Value &#x3D; person.LastName;</p>
<p>var p2 &#x3D; insertStatement.CreateParameter();<br>p2.DbType &#x3D; DbType.String;<br>p2.Value &#x3D; person.FirstName;</p>
<p>var p3 &#x3D; insertStatement.CreateParameter();<br>p3.DbType &#x3D; DbType.Int32;<br>p3.Value &#x3D; person.NumberOfDependents;<br>insertStatement.Parameters.Add(p1);<br>insertStatement.Parameters.Add(p2);<br>insertStatement.Parameters.Add(p3);<br>}</p>
<p>public Person Find(int id)<br>{<br>return (Person) AbstractFind(id);<br>}</p>
<p>public IList&lt;Person&gt; FindByLastName2(string pattern)<br>{<br>return FindMany(new FindByLastName(pattern))<br>.Cast&lt;Person&gt;().ToList();<br>}</p>
<p>public IList&lt;Person&gt; FinAll()<br>{<br>return FindMany(new FindAllStatement())<br>.Cast&lt;Person&gt;().ToList();<br>}</p>
<p>public void Update(Person subject)<br>{<br>try<br>{<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(UpdateStatementString, conn);<br>var p1 &#x3D; comm.CreateParameter();<br>p1.DbType &#x3D; DbType.String;<br>p1.Value &#x3D; subject.LastName;</p>
<p>var p2 &#x3D; comm.CreateParameter();<br>p2.DbType &#x3D; DbType.String;<br>p2.Value &#x3D; subject.FirstName;</p>
<p>var p3 &#x3D; comm.CreateParameter();<br>p3.DbType &#x3D; DbType.Int32;<br>p3.Value &#x3D; subject.NumberOfDependents;</p>
<p>var p4 &#x3D; comm.CreateParameter();<br>p4.DbType &#x3D; DbType.Int32;<br>p4.Value &#x3D; subject.Id;</p>
<p>comm.Parameters.Add(p1);<br>comm.Parameters.Add(p2);<br>comm.Parameters.Add(p3);<br>comm.Parameters.Add(p4);</p>
<p>comm.ExecuteNonQuery();<br>}<br>catch (Exception ex)<br>{<br>throw new ApplicationException(ex.Message);<br>}<br>}</p>
<p>private class FindByLastName : IStatementSource<br>{<br>private readonly string _lastName;</p>
<p>public string Sql { get; } &#x3D;<br>â€œSELECT â€œ + Columns + â€œ FROM person WHERE UPPER(lastname) like UPPER(?) ORDER BY lastNameâ€;</p>
<p>public object[] Parameters<br>{<br>get<br>{<br>return new object[] {_lastName};<br>}<br>}</p>
<p>public FindByLastName(string lastName)<br>{<br>_lastName &#x3D; lastName;<br>}<br>}</p>
<p>private class FindAllStatement : IStatementSource<br>{<br>private readonly string _lastName;</p>
<p>public string Sql { get; } &#x3D;<br>â€œSELECT * FROM personâ€;</p>
<p>public object[] Parameters<br>{<br>get<br>{<br>return new object[] {};<br>}<br>}<br>}<br>}</p>
<h5 id="2-1-3-IStatementSource-interface"><a href="#2-1-3-IStatementSource-interface" class="headerlink" title="2.1.3 IStatementSource interface"></a>2.1.3 IStatementSource interface</h5><p>This interface packs SQL string and SQL parameters for FindMany method. Â </p>
<p>public interface IStatementSource<br>{<br>    string Sql { get; }<br>    object[] Parameters { get; }<br>}</p>
<h5 id="2-1-4-DomainObject-Person-classes-and-IPersonFinder-interface"><a href="#2-1-4-DomainObject-Person-classes-and-IPersonFinder-interface" class="headerlink" title="2.1.4 DomainObject&#x2F;Person classes and IPersonFinder interface"></a>2.1.4 DomainObject&#x2F;Person classes and IPersonFinder interface</h5><p>Domain Modelâ€™s super class is DomainObject. For this person management case, Person class is the main Domain Model to perform business logic. Â  IPersonFinder interface associates with Person class and provides Find methods.</p>
<p>public abstract class DomainObject<br>{<br>public int Id { get; set; }<br>}</p>
<p>public class Person : DomainObject<br>{<br>public string LastName { get; }<br>public string FirstName { get; }<br>public int NumberOfDependents { get; }<br>public Person(int id, string lastName, string firstName, int numberOfDependents)<br>{<br>Id &#x3D; id;<br>LastName &#x3D; lastName;<br>FirstName &#x3D; firstName;<br>NumberOfDependents &#x3D; numberOfDependents;<br>}</p>
<p>public Money GetExemption()<br>{<br>Money baseExemption &#x3D; Money.Dollars(1500d);<br>Money dependentExemption &#x3D; Money.Dollars(750d);<br>return baseExemption.Add(dependentExemption.Multiply((double)NumberOfDependents));<br>}<br>}</p>
<p>public interface IPersonFinder<br>{<br>IList&lt;Person&gt; FinAll();<br>Person Find(int id);<br>IList&lt;Person&gt; FindByLastName2(string pattern);<br>}</p>
<h4 id="2-2-Demo"><a href="#2-2-Demo" class="headerlink" title="2.2 Demo"></a>2.2 Demo</h4><p>Create a console program and create 3 Persons in SQLite as the following code:</p>
<p>class Program<br>{<br>static void Main(string[] args)<br>{<br>InitializeData();</p>
<p>Console.WriteLine(â€œGet personsâ€);<br>PersonMapper mapper &#x3D; new PersonMapper();<br>&#x2F;&#x2F; get all persons<br>var people &#x3D; mapper.FinAll();<br>PrintPerson(people);</p>
<p>Console.WriteLine(â€œInsert a new personâ€);<br>mapper.Insert(new Person(0, â€œRoseâ€, â€œJacksonâ€, 60));<br>people &#x3D; mapper.FinAll();<br>PrintPerson(people);</p>
<p>Console.WriteLine(â€œUpdate a personâ€™s first nameâ€);<br>var firstPerson &#x3D; mapper.Find(1);<br>firstPerson.FirstName &#x3D; â€œJackâ€;<br>mapper.Update(firstPerson);</p>
<p>Console.WriteLine(â€œUpdate a personâ€™s number of dependentsâ€);<br>var secondPerson &#x3D; mapper.Find(2);<br>secondPerson.NumberOfDependents &#x3D; 0;<br>mapper.Update(secondPerson);</p>
<p>Console.WriteLine(â€œGet persons againâ€);<br>people &#x3D; mapper.FinAll();<br>PrintPerson(people);</p>
<p>Console.WriteLine(â€œGet persons with lastname containing nâ€);<br>people &#x3D; mapper.FindByLastName2(â€œ%n%â€);<br>PrintPerson(people);<br>}</p>
<p>private static void PrintPerson(IEnumerable&lt;Person&gt; people)<br>{<br>foreach (var person in people)<br>{<br>Console.WriteLine($â€ID: {person.Id}, â€œ +<br>  $â€last name: {person.LastName}, â€œ +<br>  $â€first name: {person.FirstName}, â€œ +<br>  $â€number of dependents: {person.NumberOfDependents}, â€œ +<br>  $â€exemption: {person.GetExemption().Amount}â€);<br>}<br>}</p>
<p>private static void InitializeData()<br>{<br>using (var connection &#x3D; DbManager.CreateConnection())<br>{<br>connection.Open();</p>
<p>using (var command &#x3D; connection.CreateCommand())<br>{<br>command.CommandText &#x3D;<br>@â€<br>DROP TABLE IF EXISTS person;<br>â€œ;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@â€<br>CREATE TABLE person (Id int primary key, lastname TEXT, firstname TEXT, numberOfDependents int);<br>â€œ;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@â€</p>
<p>INSERT INTO person<br>VALUES (1, â€˜Seanâ€™, â€˜Reidâ€™, 5);</p>
<p>INSERT INTO person<br>VALUES (2, â€˜Madeleineâ€™, â€˜Lymanâ€™, 13);</p>
<p>INSERT INTO person<br>VALUES (3, â€˜Oliverâ€™, â€˜Wrightâ€™, 66);<br>â€œ;<br>command.ExecuteNonQuery();<br>}</p>
<p>}<br>}<br>}</p>
<p>The console shows:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-6.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-4.png" alt="data mapper result"></a></p>
<h3 id="3-Conclusions-for-Data-Mapper"><a href="#3-Conclusions-for-Data-Mapper" class="headerlink" title="3. Conclusions for Data Mapper"></a>3. Conclusions for Data Mapper</h3><p>I very like â€œData Mapperâ€ pattern because of decoupling between Domain Model and Data Source. For testings and maintenance, these works are easier than other data source patterns. The above sample code is uploaded to thisÂ <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_DataMapper">Github Repository</a>.</p>
<p>For next article I will writeÂ <strong>Unit of Work</strong> pattern according toÂ <strong>Chapter 11 Object-Relational Behavioral PatternsÂ - Unit of Work</strong>Â of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/40CuWZT">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/01/poeaa-data-source-architectural-pattern-active-record/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/01/poeaa-data-source-architectural-pattern-active-record/" class="post-title-link" itemprop="url">Active Record Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-07-01 22:44:00" itemprop="dateCreated datePublished" datetime="2021-07-01T22:44:00+08:00">2021-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Active-Record"><a href="#1-What-is-Active-Record" class="headerlink" title="1. What is Active Record"></a>1. What is Active Record</h3><p>According to [PoEAA], Active Record definition is â€œAn object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data.â€</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/activeRecordSketch-1.gif"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/activeRecordSketch-1.gif" alt="Active Record"></a></p>
<p>Figure 1. Active Record (FromÂ <a target="_blank" rel="noopener" href="https://www.martinfowler.com/eaaCatalog/activeRecord.html">PoEAA Page</a>)</p>
<h4 id="1-1-How-it-works"><a href="#1-1-How-it-works" class="headerlink" title="1.1 How it works"></a>1.1 How it works</h4><p>It is a Domain Model. Every Active Recordâ€™s class is mapped to a record of the database and loads the data source to process with domain logic.<br>An approximate equality this pattern â‰ˆ Row Data Gateway + Domain Logic</p>
<h4 id="1-2-When-to-use-it"><a href="#1-2-When-to-use-it" class="headerlink" title="1.2 When to use it"></a>1.2 When to use it</h4><ol>
<li>For simple domain logic.</li>
<li>When design Domain Model pattern, choose either this pattern orÂ  Data Mapper.</li>
<li>If the application becomes more complex, Data Mapper is a better choice.</li>
<li>This pattern is hard to do refactoring because of tightly coupling with database.</li>
<li>When use Transaction Script, Row Data Gateway gradually evolves into Active Record.</li>
</ol>
<h3 id="2-Pattern-Practice-The-Person-Management"><a href="#2-Pattern-Practice-The-Person-Management" class="headerlink" title="2. Pattern Practice: The Person Management"></a>2. Pattern Practice: The Person Management</h3><p>This problem is introduced in the previous articleÂ <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/">[PoEAA] Data Source Architectural Pattern - Table Data Gateway</a>. This article uses this pattern to build the data source architectural layer.</p>
<h4 id="2-1-Implementation-by-C-SQLite"><a href="#2-1-Implementation-by-C-SQLite" class="headerlink" title="2.1 Implementation by C# &amp; SQLite"></a>2.1 Implementation by C# &amp; SQLite</h4><p>This pattern is implemented by C# based on the content ofÂ <strong>Chapter 10 Data Source Architectural Patterns - Active Record</strong>Â of PoEAA. The database is SQLite.</p>
<p>By Martinâ€™s implementation, it doesnâ€™t contain a Delete function in a record. So this article also has no Delete function.</p>
<h5 id="2-1-1-Person-class"><a href="#2-1-1-Person-class" class="headerlink" title="2.1.1 Person class"></a>2.1.1 Person class</h5><p>This Person class creates Insert&#x2F;Update&#x2F;Find&#x2F;Load basic functions to manipulate person table. One instance function GetExemption() is a business logic. Â </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Person</span> : <span class="title">BaseActiveRecord</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> LastName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> FirstName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> NumberOfDependents &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> FindStatementString = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">SELECT id, lastname, firstname, numberOfDependents</span></span><br><span class="line"><span class="string">FROM person</span></span><br><span class="line"><span class="string">WHERE id = $id</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> UpdateStatementString =</span><br><span class="line"><span class="string">@&quot;UPDATE person </span></span><br><span class="line"><span class="string">SET lastname = $lastname, firstname = $firstname, numberOfDependents = $numberOfDependents</span></span><br><span class="line"><span class="string">where id = $id&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> InsertStatementString =</span><br><span class="line"><span class="string">@&quot;INSERT INTO person </span></span><br><span class="line"><span class="string">VALUES ($id, $lastname, $firstname, $numberOfDependents)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Person</span>(<span class="params"><span class="built_in">int</span> id, <span class="built_in">string</span> lastName, <span class="built_in">string</span> firstName, <span class="built_in">int</span> numberOfDependents</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Id = id;</span><br><span class="line">LastName = lastName;</span><br><span class="line">FirstName = firstName;</span><br><span class="line">NumberOfDependents = numberOfDependents;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Person <span class="title">Find</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Person result = Registry.GetPerson(id);</span><br><span class="line"><span class="keyword">if</span> (result != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(FindStatementString, conn);</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$id&quot;</span>, id));</span><br><span class="line"><span class="keyword">using</span> IDataReader reader = comm.ExecuteReader();</span><br><span class="line">reader.Read();</span><br><span class="line">result = Load(reader);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(ex.Message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Person <span class="title">Load</span>(<span class="params">IDataReader reader</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">object</span>[] resultSet = <span class="keyword">new</span> <span class="built_in">object</span>[reader.FieldCount];</span><br><span class="line">reader.GetValues(resultSet);</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> id = (<span class="built_in">int</span>)resultSet[<span class="number">0</span>];</span><br><span class="line">Person result = Registry.GetPerson(id);</span><br><span class="line"><span class="keyword">if</span> (result != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> lastName = resultSet[<span class="number">1</span>].ToString();</span><br><span class="line"><span class="built_in">string</span> firstName = resultSet[<span class="number">2</span>].ToString();</span><br><span class="line"><span class="built_in">int</span> numberOfDependents = (<span class="built_in">int</span>)resultSet[<span class="number">3</span>];</span><br><span class="line">result = <span class="keyword">new</span> Person(id, lastName, firstName, numberOfDependents);</span><br><span class="line">Registry.AddPerson(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(UpdateStatementString, conn);</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$lastname&quot;</span>, LastName));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$firstname&quot;</span>, FirstName));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$numberOfDependents&quot;</span>, NumberOfDependents));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$id&quot;</span>, Id));</span><br><span class="line">comm.ExecuteNonQuery();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(ex.Message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Insert</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(InsertStatementString, conn);</span><br><span class="line">Id = FindNextDatabaseId();</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$id&quot;</span>, Id));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$lastname&quot;</span>, LastName));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$firstname&quot;</span>, FirstName));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$numberOfDependents&quot;</span>, NumberOfDependents));</span><br><span class="line">comm.ExecuteNonQuery();</span><br><span class="line">Registry.AddPerson(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Id;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(ex.Message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Money <span class="title">GetExemption</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">Money baseExemption = Money.Dollars(<span class="number">1500</span>d);</span><br><span class="line">Money dependentExemption = Money.Dollars(<span class="number">750</span>d);</span><br><span class="line"><span class="keyword">return</span> baseExemption.Add(dependentExemption.Multiply((<span class="built_in">double</span>) NumberOfDependents));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">FindNextDatabaseId</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">string</span> sql = <span class="string">&quot;SELECT max(id) as curId from person&quot;</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(sql, conn);</span><br><span class="line"><span class="keyword">using</span> IDataReader reader = comm.ExecuteReader();</span><br><span class="line"><span class="built_in">bool</span> hasResult = reader.Read();</span><br><span class="line"><span class="keyword">if</span> (hasResult)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> ((<span class="built_in">int</span>)((<span class="built_in">long</span>)reader[<span class="string">&quot;curId&quot;</span>] + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">BaseActiveRecord</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-1-2-Registry"><a href="#2-1-2-Registry" class="headerlink" title="2.1.2 Registry"></a>2.1.2 Registry</h5><p>The Registry has been used in <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/06/23/poeaa-data-source-architectural-pattern-row-data-gateway/">[PoEAA] Data Source Architectural Pattern - Row Data Gateway</a>. This article uses it to register Person instances. Â </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Registry</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Registry Instance = <span class="keyword">new</span> Registry();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="built_in">int</span>, Person&gt; _personsMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, Person&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Registry</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddPerson</span>(<span class="params">Person person</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Instance._personsMap.Add(person.Id, person);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Person <span class="title">GetPerson</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Instance._personsMap.ContainsKey(id))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> Instance._personsMap[id];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-Demo"><a href="#2-2-Demo" class="headerlink" title="2.2 Demo"></a>2.2 Demo</h4><p>Create a console program and create 3 Persons in SQLite as the following code:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> FindAllPersonsStatementString = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">SELECT id, lastname, firstname, numberOfDependents</span></span><br><span class="line"><span class="string">FROM person</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">InitializeData();</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Get persons&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> people = FindPersons();</span><br><span class="line">PrintPerson(people);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Insert a new person&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> Person(<span class="number">0</span>, <span class="string">&quot;Rose&quot;</span>, <span class="string">&quot;Jackson&quot;</span>, <span class="number">60</span>).Insert();</span><br><span class="line">people = FindPersons();</span><br><span class="line">PrintPerson(people);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Update a person&#x27;s first name&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> firstPerson = Person.Find(<span class="number">1</span>);</span><br><span class="line">firstPerson.FirstName = <span class="string">&quot;Jack&quot;</span>;</span><br><span class="line">firstPerson.Update();</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Update a person&#x27;s number of dependents&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> secondPerson = Person.Find(<span class="number">2</span>);</span><br><span class="line">secondPerson.NumberOfDependents = <span class="number">0</span>;</span><br><span class="line">secondPerson.Update();</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Get persons again&quot;</span>);</span><br><span class="line">people = FindPersons();</span><br><span class="line">PrintPerson(people);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Person&gt; <span class="title">FindPersons</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">List&lt;Person&gt; result = <span class="keyword">new</span> List&lt;Person&gt;();</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(FindAllPersonsStatementString, conn);</span><br><span class="line"><span class="keyword">using</span> IDataReader reader = comm.ExecuteReader();</span><br><span class="line"><span class="keyword">while</span> (reader.Read())</span><br><span class="line">&#123;</span><br><span class="line">result.Add(Person.Load(reader));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(ex.Message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PrintPerson</span>(<span class="params">IEnumerable&lt;Person&gt; people</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> person <span class="keyword">in</span> people)</span><br><span class="line">&#123;</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;ID: <span class="subst">&#123;person.Id&#125;</span>, &quot;</span> +</span><br><span class="line">  <span class="string">$&quot;last name: <span class="subst">&#123;person.LastName&#125;</span>, &quot;</span> +</span><br><span class="line">  <span class="string">$&quot;first name: <span class="subst">&#123;person.FirstName&#125;</span>, &quot;</span> +</span><br><span class="line">  <span class="string">$&quot;number of dependents: <span class="subst">&#123;person.NumberOfDependents&#125;</span>, &quot;</span> +</span><br><span class="line">  <span class="string">$&quot;exemption: <span class="subst">&#123;person.GetExemption().Amount&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitializeData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> connection = DbManager.CreateConnection())</span><br><span class="line">&#123;</span><br><span class="line">connection.Open();</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> command = connection.CreateCommand())</span><br><span class="line">&#123;</span><br><span class="line">command.CommandText =</span><br><span class="line"><span class="string">@&quot;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS person;</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line">command.ExecuteNonQuery();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">command.CommandText =</span><br><span class="line"><span class="string">@&quot;</span></span><br><span class="line"><span class="string">CREATE TABLE person (Id int primary key, lastname TEXT, firstname TEXT, numberOfDependents int);</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line">command.ExecuteNonQuery();</span><br><span class="line"></span><br><span class="line">command.CommandText =</span><br><span class="line"><span class="string">@&quot;</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">INSERT INTO person</span></span><br><span class="line"><span class="string">VALUES (1, &#x27;Sean&#x27;, &#x27;Reid&#x27;, 5);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INSERT INTO person</span></span><br><span class="line"><span class="string">VALUES (2, &#x27;Madeleine&#x27;, &#x27;Lyman&#x27;, 13);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INSERT INTO person</span></span><br><span class="line"><span class="string">VALUES (3, &#x27;Oliver&#x27;, &#x27;Wright&#x27;, 66);</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line">command.ExecuteNonQuery();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The console shows:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-8.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-7.png" alt="active record result"></a></p>
<h3 id="3-Conclusions-for-Active-Record"><a href="#3-Conclusions-for-Active-Record" class="headerlink" title="3. Conclusions for Active Record"></a>3. Conclusions for Active Record</h3><p>This pattern is a advanced version of Row Data Gateway. The above sample code is uploaded to thisÂ <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_ActiveRecord">Github Repository</a>.</p>
<p>For next article I will writeÂ <strong>D</strong>ata Mapper pattern according toÂ <strong>Chapter 10 Data Source Architectural Pattern - Data Mapper</strong>Â of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/3gV8eak">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/poeaa-data-source-architectural-pattern-row-data-gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/23/poeaa-data-source-architectural-pattern-row-data-gateway/" class="post-title-link" itemprop="url">Row Data Gateway Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-23 23:23:00" itemprop="dateCreated datePublished" datetime="2021-06-23T23:23:00+08:00">2021-06-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Row-Data-Gateway"><a href="#1-What-is-Row-Data-Gateway" class="headerlink" title="1. What is Row Data Gateway"></a>1. What is Row Data Gateway</h3><p>According to [PoEAA], Row Data Gateway definition is â€œAn object that acts as a Gateway to a single record in a data source. There is one instance per row.â€</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-10.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-8.png"></a></p>
<p>Figure 1. Row Data Gateway (FromÂ <a target="_blank" rel="noopener" href="https://www.martinfowler.com/eaaCatalog/rowDataGateway.html">PoEAA Page</a>)</p>
<h4 id="1-1-How-it-works"><a href="#1-1-How-it-works" class="headerlink" title="1.1 How it works"></a>1.1 How it works</h4><p>In a gateway, the property&#x2F;field is mapped to a recordâ€™s attribute. For finding function, there are FinderÂ  Class and Gateway Class to retrieve a tableâ€™s records. As the following sequence diagram shows: Â </p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/rowdatagateway_with_finder-2.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/rowdatagateway_with_finder-1.png"></a></p>
<p>Figure 2.Â Interactions for a find with a row-based Row Data Gateway.</p>
<h4 id="1-2-When-to-use-it"><a href="#1-2-When-to-use-it" class="headerlink" title="1.2 When to use it"></a>1.2 When to use it</h4><ol>
<li>Consider whether the architecture needs a gateway and what gateway to use (Table&#x2F;Row Data Gateway).</li>
<li>Transaction Script pattern fits this pattern.</li>
<li>Domain Model pattern is not recommended to use this pattern.</li>
<li>When use Transaction Script and this pattern and the application becomes more complex, this pattern will evolve into an Active Record.</li>
<li>This pattern can combine with Data Mapper when gateway is generated by Metadata Mapping</li>
</ol>
<h3 id="2-Pattern-Practice-The-Person-Management"><a href="#2-Pattern-Practice-The-Person-Management" class="headerlink" title="2. Pattern Practice: The Person Management"></a>2. Pattern Practice: The Person Management</h3><p>This problem is introduced in the previous articleÂ <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/">[PoEAA] Data Source Architectural Pattern - Table Data Gateway</a>. This article uses this pattern to build the data source architectural layer.</p>
<h4 id="2-1-Implementation-by-C-SQLite"><a href="#2-1-Implementation-by-C-SQLite" class="headerlink" title="2.1 Implementation by C# &amp; SQLite"></a>2.1 Implementation by C# &amp; SQLite</h4><p>This pattern is implemented by C# based on the content ofÂ <strong>Chapter 10 Data Source Architectural Patterns - Row Data Gateway</strong>Â of PoEAA. The database is SQLite.</p>
<p>By Martinâ€™s implementation, it doesnâ€™t contain a Delete function in a gateway. So this article also has no Delete function.</p>
<h5 id="2-1-1-PersonGateway"><a href="#2-1-1-PersonGateway" class="headerlink" title="2.1.1 PersonGateway"></a>2.1.1 PersonGateway</h5><p>This gateway creates Insert&#x2F;Update basic functions to manipulate person table. One static Load function is used by Finder Class. Â </p>
<p>class PersonGateway: BaseGateway {<br>  public PersonGateway(int id, string lastName, string firstName, int numberOfDependents) {<br>    Id &#x3D; id;<br>    LastName &#x3D; lastName;<br>    FirstName &#x3D; firstName;<br>    NumberOfDependents &#x3D; numberOfDependents;<br>  }<br>  private<br>  const string UpdateStatementString &#x3D; @ â€œUPDATE person SET lastname &#x3D; $lastname, firstname &#x3D; $firstname, numberOfDependents &#x3D; $numberOfDependentswhere id &#x3D; $idâ€;<br>  private<br>  const string InsertStatementString &#x3D; @ â€œINSERT INTO person VALUES ($id, $lastname, $firstname, $numberOfDependents)â€;<br>  public string LastName {<br>    get;<br>    set;<br>  }<br>  public string FirstName {<br>    get;<br>    set;<br>  }<br>  public int NumberOfDependents {<br>    get;<br>    set;<br>  }<br>  public static PersonGateway Load(IDataReader reader) {<br>    object[] resultSet &#x3D; new object[reader.FieldCount];<br>    reader.GetValues(resultSet);<br>    int id &#x3D; (int) resultSet[0];<br>    PersonGateway result &#x3D; Registry.GetPerson(id);<br>    if (result !&#x3D; null) {<br>      return result;<br>    }<br>    string lastName &#x3D; resultSet[1].ToString();<br>    string firstName &#x3D; resultSet[2].ToString();<br>    int numberOfDependents &#x3D; (int) resultSet[3];<br>    result &#x3D; new PersonGateway(id, lastName, firstName, numberOfDependents);<br>    Registry.AddPerson(result);<br>    return result;<br>  }<br>  public void Update() {<br>    try {<br>      using<br>      var conn &#x3D; DbManager.CreateConnection();<br>      conn.Open();<br>      using IDbCommand comm &#x3D; new SQLiteCommand(UpdateStatementString, conn);<br>      comm.Parameters.Add(new SQLiteParameter(â€œ$lastnameâ€, LastName));<br>      comm.Parameters.Add(new SQLiteParameter(â€œ$firstnameâ€, FirstName));<br>      comm.Parameters.Add(new SQLiteParameter(â€œ$numberOfDependentsâ€, NumberOfDependents));<br>      comm.Parameters.Add(new SQLiteParameter(â€œ$idâ€, Id));<br>      comm.ExecuteNonQuery();<br>    } catch (Exception ex) {<br>      throw new ApplicationException(ex.Message);<br>    }<br>  }<br>  public int Insert() {<br>    try {<br>      using<br>      var conn &#x3D; DbManager.CreateConnection();<br>      conn.Open();<br>      using IDbCommand comm &#x3D; new SQLiteCommand(InsertStatementString, conn);<br>      Id &#x3D; FindNextDatabaseId();<br>      comm.Parameters.Add(new SQLiteParameter(â€œ$idâ€, Id));<br>      comm.Parameters.Add(new SQLiteParameter(â€œ$lastnameâ€, LastName));<br>      comm.Parameters.Add(new SQLiteParameter(â€œ$firstnameâ€, FirstName));<br>      comm.Parameters.Add(new SQLiteParameter(â€œ$numberOfDependentsâ€, NumberOfDependents));<br>      comm.ExecuteNonQuery();<br>      Registry.AddPerson(this);<br>      return Id;<br>    } catch (Exception ex) {<br>      throw new ApplicationException(ex.Message);<br>    }<br>  }<br>  private int FindNextDatabaseId() {<br>    string sql &#x3D; â€œSELECT max(id) as curId from personâ€;<br>    using<br>    var conn &#x3D; DbManager.CreateConnection();<br>    conn.Open();<br>    using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>    using IDataReader reader &#x3D; comm.ExecuteReader();<br>    bool hasResult &#x3D; reader.Read();<br>    if (hasResult) {<br>      return ((int)((long) reader[â€œcurIdâ€] + 1));<br>    } else {<br>      return 1;<br>    }<br>  }<br>}<br>internal class BaseGateway {<br>  public int Id {<br>    get;<br>    set;<br>  }<br>  public BaseGateway() {}<br>}</p>
<h5 id="2-1-2-PersonFinder"><a href="#2-1-2-PersonFinder" class="headerlink" title="2.1.2 PersonFinder"></a>2.1.2 PersonFinder</h5><p>This finder class queries single&#x2F;multiple record(s) with PersonGateway. Â </p>
<p>class PersonFinder {<br>  private<br>  const string FindStatementString &#x3D; @ â€œSELECT id, lastname, firstname, numberOfDependentsfrom personWHERE id &#x3D; $idâ€;<br>  private<br>  const string FindResponsibleStatementString &#x3D; @ â€œSELECT id, lastname, firstname, numberOfDependentsfrom personWHERE numberOfDependents &gt; 0â€;<br>  public PersonGateway Find(int id) {<br>    PersonGateway result &#x3D; Registry.GetPerson(id);<br>    if (result !&#x3D; null) {<br>      return result;<br>    }<br>    try {<br>      using<br>      var conn &#x3D; DbManager.CreateConnection();<br>      conn.Open();<br>      using IDbCommand comm &#x3D; new SQLiteCommand(FindStatementString, conn);<br>      comm.Parameters.Add(new SQLiteParameter(â€œ$idâ€, id));<br>      using IDataReader reader &#x3D; comm.ExecuteReader();<br>      reader.Read();<br>      result &#x3D; PersonGateway.Load(reader);<br>      return result;<br>    } catch (Exception ex) {<br>      throw new ApplicationException(ex.Message);<br>    }<br>  }<br>  public List<PersonGateway> FindResponsibles() {<br>    List<PersonGateway> result &#x3D; new List<PersonGateway>();<br>    try {<br>      using<br>      var conn &#x3D; DbManager.CreateConnection();<br>      conn.Open();<br>      using IDbCommand comm &#x3D; new SQLiteCommand(FindResponsibleStatementString, conn);<br>      using IDataReader reader &#x3D; comm.ExecuteReader();<br>      while (reader.Read()) {<br>        result.Add(PersonGateway.Load(reader));<br>      }<br>      return result;<br>    } catch (Exception ex) {<br>      throw new ApplicationException(ex.Message);<br>    }<br>  }<br>}</p>
<h5 id="2-1-3-Registry"><a href="#2-1-3-Registry" class="headerlink" title="2.1.3 Registry"></a>2.1.3 Registry</h5><p>The above finder&#x2F;gateway classes have used a Registry. This Registry pattern holds a kind of dictionary that keeps one key mapped to a instance. In this article the Registry has a &lt;id, PersonGateway&gt; dictionary for finding&#x2F;insertion functions. When insertion completes, Registry adds this Person; When finding is called, it first checks the Registry whether has the Person. If the Person exists, return it. Otherwise it queries Person from the database and stores it in Registry. Â </p>
<p>internal class Registry {<br>  private static readonly Registry Instance &#x3D; new Registry();<br>  private readonly Dictionary&lt;int, PersonGateway&gt; _personsMap &#x3D; new Dictionary&lt;int, PersonGateway&gt;();<br>  private Registry() {}<br>  public static void AddPerson(PersonGateway personGateway) {<br>    Instance._personsMap.Add(personGateway.Id, personGateway);<br>  }<br>  public static PersonGateway GetPerson(int id) {<br>    if (Instance._personsMap.ContainsKey(id)) {<br>      return Instance._personsMap[id];<br>    }<br>    return null;<br>  }<br>}</p>
<h4 id="2-2-Demo"><a href="#2-2-Demo" class="headerlink" title="2.2 Demo"></a>2.2 Demo</h4><p>Create a console program and create 3 Persons in SQLite as the following code:</p>
<p>class Program {<br>  static void Main(string[] args) {<br>    InitializeData();<br>    Console.WriteLine(â€œGet responsible personsâ€);<br>    PersonFinder finder &#x3D; new PersonFinder();<br>    var people &#x3D; finder.FindResponsibles();<br>    PrintPersonGateway(people);<br>    Console.WriteLine(â€œInsert a new personâ€);<br>    new PersonGateway(0, â€œRoseâ€, â€œJacksonâ€, 60).Insert();<br>    people &#x3D; finder.FindResponsibles();<br>    PrintPersonGateway(people);<br>    Console.WriteLine(â€œUpdate a personâ€™s first nameâ€);<br>    var firstPerson &#x3D; finder.Find(1);<br>    firstPerson.FirstName &#x3D; â€œJackâ€;<br>    firstPerson.Update();<br>    Console.WriteLine(â€œUpdate a personâ€™s number of dependentsâ€);<br>    var secondPerson &#x3D; finder.Find(2);<br>    secondPerson.NumberOfDependents &#x3D; 0;<br>    secondPerson.Update();<br>    Console.WriteLine(â€œGet responsible persons againâ€);<br>    people &#x3D; finder.FindResponsibles();<br>    PrintPersonGateway(people);<br>  }<br>  private static void PrintPersonGateway(IEnumerable<PersonGateway> people) {<br>    foreach(var person in people) {<br>      Console.WriteLine($â€ID: {person.Id}, last name: {person.LastName}, first name: {person.FirstName}, number of dependents: {person.NumberOfDependents}â€);<br>    }<br>  }<br>  private static void InitializeData() {<br>    using(var connection &#x3D; DbManager.CreateConnection()) {<br>      connection.Open();<br>      using(var command &#x3D; connection.CreateCommand()) {<br>        command.CommandText &#x3D; @ â€œDROP TABLE IF EXISTS person;â€;<br>        command.ExecuteNonQuery();<br>        command.CommandText &#x3D; @ â€œCREATE TABLE person (Id int primary key, lastname TEXT, firstname TEXT, numberOfDependents int);â€;<br>        command.ExecuteNonQuery();<br>        command.CommandText &#x3D; @ â€œ   INSERT INTO personVALUES (1, â€˜Seanâ€™, â€˜Reidâ€™, 5);INSERT INTO personVALUES (2, â€˜Madeleineâ€™, â€˜Lymanâ€™, 13);INSERT INTO personVALUES (3, â€˜Oliverâ€™, â€˜Wrightâ€™, 66);â€;<br>        command.ExecuteNonQuery();<br>      }<br>    }<br>  }<br>}</p>
<p>The console shows:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-11.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-9.png" alt="Row Data Gateway result"></a></p>
<h3 id="3-Conclusions-for-Row-Data-Gateway"><a href="#3-Conclusions-for-Row-Data-Gateway" class="headerlink" title="3. Conclusions for Row Data Gateway"></a>3. Conclusions for Row Data Gateway</h3><p>This pattern is also a simpler data source architectural pattern. I think of it as a fine-grained version of Table Data Gateway. The above sample code is uploaded to thisÂ <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_RowDataGateway">Github Repository</a>.</p>
<p>For next article I will writeÂ <strong>Active Record</strong> pattern according toÂ <strong>Chapter 10 Data Source Architectural Pattern - Active Record Gateway</strong>Â of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/40CuWZT">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/" class="post-title-link" itemprop="url">Table Data Gateway Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-20 15:22:00" itemprop="dateCreated datePublished" datetime="2021-06-20T15:22:00+08:00">2021-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Table-Data-Gateway"><a href="#1-What-is-Table-Data-Gateway" class="headerlink" title="1. What is Table Data Gateway"></a>1. What is Table Data Gateway</h3><p>According to [PoEAA], Table Data Gateway definition is â€œAn object that acts as a Gateway to a database table. One instance handles all the rows in the table.â€</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-2.png"><img src="https://www.martinfowler.com/eaaCatalog/dbgateTable.gif" alt="Table Data Gateway"></a></p>
<p>Figure 1. Table Data Gateway (FromÂ <a target="_blank" rel="noopener" href="https://www.martinfowler.com/eaaCatalog/tableDataGateway.html">PoEAA Page</a>)</p>
<h4 id="1-1-How-it-works"><a href="#1-1-How-it-works" class="headerlink" title="1.1 How it works"></a>1.1 How it works</h4><p>Every function provided by a gateway maps a SQL query to the database. The functions are usually finding&#x2F;updating&#x2F;deleting.Â  Â  Â </p>
<h4 id="1-2-When-to-use-it"><a href="#1-2-When-to-use-it" class="headerlink" title="1.2 When to use it"></a>1.2 When to use it</h4><ol>
<li>It does not usually work with Domain Model pattern. Domain Model pattern fits Data Mapper pattern.</li>
<li>Table Module pattern very fits this pattern.</li>
<li>It fits Transaction Script pattern.</li>
<li>It hides the table schema and provides functions that are implemented by SQL Queries or Stored Procedures.</li>
</ol>
<h3 id="2-Pattern-Practice-The-Person-Management"><a href="#2-Pattern-Practice-The-Person-Management" class="headerlink" title="2. Pattern Practice: The Person Management"></a>2. Pattern Practice: The Person Management</h3><p>As Figure 1 shows, there is a person table that has a primary key id and 3 attributes (lastName, firstName and numberOfDependents).</p>
<h4 id="2-1-Implementation-by-C-SQLite"><a href="#2-1-Implementation-by-C-SQLite" class="headerlink" title="2.1 Implementation by C# &amp; SQLite"></a>2.1 Implementation by C# &amp; SQLite</h4><p>This pattern is implemented by C# based on the content ofÂ <strong>Chapter 10 Data Source Architectural Patterns - Table Data Gateway</strong>Â of PoEAA. The database is SQLite.</p>
<p>By Martinâ€™s implementation, it contains ADO.NET Reader version and ADO.NET DataSet version. The following sections show both versions.</p>
<h4 id="2-2-ADO-NET-Reader-Version"><a href="#2-2-ADO-NET-Reader-Version" class="headerlink" title="2.2 ADO.NET Reader Version"></a>2.2 ADO.NET Reader Version</h4><h5 id="2-2-1-PersonGateway"><a href="#2-2-1-PersonGateway" class="headerlink" title="2.2.1 PersonGateway"></a>2.2.1 PersonGateway</h5><p>This gateway creates Find&#x2F;Insert&#x2F;Update&#x2F;Delete basic functions to manipulate person table. Â </p>
<p>class PersonGateway<br>{<br>public IDataReader FindAll()<br>{<br>string sql &#x3D; â€œselect * from personâ€;<br>var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>return new SQLiteCommand(sql, conn).ExecuteReader();<br>}</p>
<p>public IDataReader FindWithLastName(string lastName)<br>{<br>string sql &#x3D; â€œselect * from person where lastname &#x3D; $lastnameâ€;<br>var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(â€œ$lastnameâ€, lastName));</p>
<p>return comm.ExecuteReader();<br>}</p>
<p>public IDataReader FindWhere(string whereClause)<br>{<br>string sql &#x3D; $â€select * from person where {whereClause}â€;<br>var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>return new SQLiteCommand(sql, conn).ExecuteReader();<br>}</p>
<p>public object[] FindRow(long key)<br>{<br>string sql &#x3D; â€œselect * from person where id &#x3D; $idâ€;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(â€œ$idâ€, key));<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>reader.Read();<br>object[] result &#x3D; new object[reader.FieldCount];<br>reader.GetValues(result);<br>return result;<br>}</p>
<p>public void Update(long key, string lastName, string firstName, int numberOfDependents)<br>{<br>string sql &#x3D;<br>@â€Update person SET lastname &#x3D; $lastname, firstname &#x3D; $firstname, numberOfDependents &#x3D; $numberOfDependents<br>WHERE id &#x3D; $idâ€;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(â€œ$lastnameâ€, lastName));<br>comm.Parameters.Add(new SQLiteParameter(â€œ$firstnameâ€, firstName));<br>comm.Parameters.Add(new SQLiteParameter(â€œ$numberOfDependentsâ€, numberOfDependents));<br>comm.Parameters.Add(new SQLiteParameter(â€œ$idâ€, key));<br>comm.ExecuteNonQuery();<br>}</p>
<p>public long Insert(string lastName, string firstName, int numberOfDependents)<br>{<br>string sql &#x3D;<br>@â€INSERT INTO person VALUES ($id, $lastname, $firstname, $numberOfDependents)â€;<br>long key &#x3D; GetNextId();<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(â€œ$idâ€, key));<br>comm.Parameters.Add(new SQLiteParameter(â€œ$lastnameâ€, lastName));<br>comm.Parameters.Add(new SQLiteParameter(â€œ$firstnameâ€, firstName));<br>comm.Parameters.Add(new SQLiteParameter(â€œ$numberOfDependentsâ€, numberOfDependents));<br>comm.ExecuteNonQuery();<br>return key;<br>}</p>
<p>public void Delete(long key)<br>{<br>string sql &#x3D; â€œDELETE FROM person WHERE id &#x3D; $idâ€;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(â€œ$idâ€, key));<br>comm.ExecuteNonQuery();<br>}</p>
<p>private long GetNextId()<br>{<br>string sql &#x3D; â€œSELECT max(id) as curId from personâ€;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>bool hasResult &#x3D; reader.Read();<br>if (hasResult)<br>{<br>return ((long)reader[â€œcurIdâ€] + 1);<br>}<br>else<br>{<br>return 1;<br>}<br>}<br>}</p>
<h4 id="2-3-ADO-NET-DataSet-Version"><a href="#2-3-ADO-NET-DataSet-Version" class="headerlink" title="2.3 ADO.NET DataSet Version"></a>2.3 ADO.NET DataSet Version</h4><p>Use a DataSetHolder class to hold a DataSet and a DataAdapter for a DataGateway. This definition is for generality as the following Figure 2 shows. Â </p>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2021/11/TableDataGateway.png" alt="Table Data Gateway data-set-oriented class diagram"></p>
<p>Figure 2.Â Class diagram of data-set-oriented gateway and the supporting data holder</p>
<h5 id="2-3-1-DataSetHolder-class"><a href="#2-3-1-DataSetHolder-class" class="headerlink" title="2.3.1 DataSetHolder class"></a>2.3.1 DataSetHolder class</h5><p>This class holds a DataSet and a dictionary. The dictionaryâ€™s key is the table name, its value mapped to a DataAdapter instance.</p>
<p>class DataSetHolder<br>{<br>public DataSet Data &#x3D; new DataSet();<br>private readonly Dictionary&lt;string, SQLiteDataAdapter&gt; _dataAdapters &#x3D; new Dictionary&lt;string, SQLiteDataAdapter&gt;();</p>
<p>public void FillData(string query, string tableName)<br>{<br>if (_dataAdapters.ContainsKey(tableName))<br>{<br>throw new MultipleLoadException();<br>}</p>
<p>var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>SQLiteDataAdapter da &#x3D; new SQLiteDataAdapter(query, conn);<br>SQLiteCommandBuilder builder &#x3D; new SQLiteCommandBuilder(da);<br>da.Fill(Data, tableName);<br>_dataAdapters.Add(tableName, da);<br>}</p>
<p>public void Update()<br>{<br>foreach (string table in _dataAdapters.Keys)<br>{<br>(_dataAdapters[table]).Update(Data, table);<br>}<br>}</p>
<p>public DataTable this[string tableName] &#x3D;&gt; Data.Tables[tableName];<br>}</p>
<h5 id="2-3-2-DataGateway-PersonGateway"><a href="#2-3-2-DataGateway-PersonGateway" class="headerlink" title="2.3.2 DataGateway &amp; PersonGateway"></a>2.3.2 DataGateway &amp; PersonGateway</h5><p>DataGateway is the base class and provides the common functions to child classes. DataGateway exposes a DataSet and a DataTable to clients. The child PersonGateway implements the table name â€œpersonâ€ and creates a new Insert function to add person record.</p>
<p>abstract class DataGateway<br>{<br>public abstract string TableName { get; }<br>public DataSetHolder Holder;</p>
<p>public DataSet Data &#x3D;&gt; Holder.Data;</p>
<p>public abstract DataTable Table { get; }</p>
<p>protected DataGateway()<br>{<br>Holder &#x3D; new DataSetHolder();<br>}</p>
<p>protected DataGateway(DataSetHolder holder)<br>{<br>this.Holder &#x3D; holder;<br>}</p>
<p>public void LoadAll()<br>{<br>string commandString &#x3D; $â€select * from {TableName}â€;<br>Holder.FillData(commandString, TableName);<br>}</p>
<p>public void LoadWhere(string whereClause)<br>{<br>string commandString &#x3D; $â€select * from {TableName} where {whereClause}â€;<br>Holder.FillData(commandString, TableName);<br>}<br>}</p>
<p>class PersonGateway : DataGateway<br>{<br>public override string TableName &#x3D;&gt; â€œpersonâ€;</p>
<p>public override DataTable Table &#x3D;&gt; Data.Tables[TableName];</p>
<p>public PersonGateway() : base()<br>{</p>
<p>}</p>
<p>public PersonGateway(DataSetHolder holder) : base(holder)<br>{</p>
<p>}</p>
<p>public DataRow this[long key]<br>{<br>get<br>{<br>string filter &#x3D; $â€id &#x3D; {key}â€;<br>return Table.Select(filter)[0];<br>}<br>}</p>
<p>public long Insert(string lastName, string firstName, int numberOfDependents)<br>{<br>long key &#x3D; GetNextId();<br>DataRow newRow &#x3D; Table.NewRow();<br>newRow[â€œidâ€] &#x3D; key;<br>newRow[â€œlastnameâ€] &#x3D; lastName;<br>newRow[â€œfirstnameâ€] &#x3D; firstName;<br>newRow[â€œnumberOfDependentsâ€] &#x3D; numberOfDependents;<br>Table.Rows.Add(newRow);</p>
<p>return key;<br>}</p>
<p>private long GetNextId()<br>{<br>var result &#x3D; Table.Compute(â€œmax([id])â€, string.Empty);<br>if (result !&#x3D; System.DBNull.Value)<br>{<br>return ((int)result + 1);<br>}<br>else<br>{<br>return 1;<br>}<br>}<br>}</p>
<h4 id="2-4-Demo"><a href="#2-4-Demo" class="headerlink" title="2.4 Demo"></a>2.4 Demo</h4><p>Create a console program and create 3 Persons in SQLite, the person records:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-3.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-3.png" alt="Table Data Gateway Person Records"></a></p>
<p>Figure 3. Person Records</p>
<p>The program first executes Reader version functions and second executes DataSet version functions.</p>
<p>As the following code:</p>
<p>class Program<br>{<br>static void Main(string[] args)<br>{<br>RunReaderVersionExample();<br>RunDataTableVersionExample();<br>}</p>
<p>private static void RunDataTableVersionExample()<br>{<br>InitializeData();</p>
<p>Console.WriteLine(â€œStart RunDataTableVersionExampleâ€);<br>Console.WriteLine(â€œFunction: Get all personsâ€);<br>var gateway &#x3D; new DataTableVersion.PersonGateway();<br>gateway.LoadAll();<br>var allPersons &#x3D; gateway.Table.Rows;<br>PrintPersonsRowData(allPersons);</p>
<p>Console.WriteLine(â€œFunction: Get person by id &#x3D; 2â€);<br>var onePerson &#x3D; gateway[2];<br>PrintPersonRowData(onePerson);</p>
<p>Console.WriteLine(â€œFunction: Update person by id &#x3D; 2â€);<br>onePerson[â€œlastnameâ€] &#x3D; â€œJacksonâ€;<br>onePerson[â€œfirstnameâ€] &#x3D; â€œMichaelâ€;<br>onePerson[â€œnumberOfDependentsâ€] &#x3D; 100;<br>gateway.Holder.Update();<br>Console.WriteLine(â€œFunction: Get person by id &#x3D; 2â€);<br>var updatedPerson &#x3D; gateway[2];<br>PrintPersonRowData(updatedPerson);</p>
<p>Console.WriteLine(â€œFunction: Insert a personâ€);<br>gateway.Insert(â€œSkinnerâ€, â€œNeilâ€, 3);<br>gateway.Holder.Update();<br>Console.WriteLine(â€œFunction: Get all personsâ€);<br>allPersons &#x3D; gateway.Table.Rows;<br>PrintPersonsRowData(allPersons);</p>
<p>Console.WriteLine(â€œFunction: Get persons by numberOfDependents &gt; 10â€);<br>gateway &#x3D; new DataTableVersion.PersonGateway();<br>gateway.LoadWhere(â€œnumberOfDependents &gt; 10â€);<br>var findPersons &#x3D; gateway.Table.Rows;<br>PrintPersonsRowData(findPersons);</p>
<p>Console.WriteLine(â€œFunction: Delete person by id &#x3D; 1â€);<br>gateway &#x3D; new DataTableVersion.PersonGateway();<br>gateway.LoadAll();<br>var deletedRow &#x3D; gateway[1];<br>deletedRow.Delete();<br>gateway.Holder.Update();</p>
<p>Console.WriteLine(â€œFunction: Get all personsâ€);<br>allPersons &#x3D; gateway.Table.Rows;<br>PrintPersonsRowData(allPersons);</p>
<p>Console.WriteLine(â€œEnd RunDataTableVersionExampleâ€);<br>}</p>
<p>private static void RunReaderVersionExample()<br>{<br>InitializeData();</p>
<p>Console.WriteLine(â€œStart RunReaderVersionExampleâ€);<br>Console.WriteLine(â€œFunction: Get all personsâ€);<br>var gateway &#x3D; new ReaderVersion.PersonGateway();<br>var allPersons &#x3D; gateway.FindAll();<br>PrintPersonsRowData(allPersons);<br>allPersons.Close();</p>
<p>Console.WriteLine(â€œFunction: Get person by id &#x3D; 2â€);<br>var onePerson &#x3D; gateway.FindRow(2);<br>PrintPersonRowData(onePerson);</p>
<p>Console.WriteLine(â€œFunction: Update person by id &#x3D; 2â€);<br>gateway.Update(2, â€œJacksonâ€, â€œMichaelâ€, 100);<br>Console.WriteLine(â€œFunction: Get person by id &#x3D; 2â€);<br>var updatedPerson &#x3D; gateway.FindRow(2);<br>PrintPersonRowData(updatedPerson);</p>
<p>Console.WriteLine(â€œFunction: Insert a personâ€);<br>gateway.Insert(â€œSkinnerâ€, â€œNeilâ€, 3);</p>
<p>Console.WriteLine(â€œFunction: Get all personsâ€);<br>allPersons &#x3D; gateway.FindAll();<br>PrintPersonsRowData(allPersons);<br>allPersons.Close();</p>
<p>Console.WriteLine(â€œFunction: Get persons by numberOfDependents &gt; 10â€);<br>var findPersons &#x3D; gateway.FindWhere(â€œnumberOfDependents &gt; 10â€);<br>PrintPersonsRowData(findPersons);<br>findPersons.Close();</p>
<p>Console.WriteLine(â€œFunction: Delete person by id &#x3D; 1â€);<br>gateway.Delete(1);</p>
<p>Console.WriteLine(â€œFunction: Get all personsâ€);<br>allPersons &#x3D; gateway.FindAll();<br>PrintPersonsRowData(allPersons);<br>allPersons.Close();</p>
<p>Console.WriteLine(â€œEnd RunReaderVersionExampleâ€);<br>}</p>
<p>private static void PrintPersonRowData(object[] columns)<br>{<br>Console.WriteLine($â€id: {columns[0]}, lastname: {columns[1]}, firstname: {columns[2]}, numberOfDependents: {columns[3]}â€);<br>}</p>
<p>private static void PrintPersonRowData(DataRow columns)<br>{<br>Console.WriteLine($â€id: {columns[0]}, lastname: {columns[1]}, firstname: {columns[2]}, numberOfDependents: {columns[3]}â€);<br>}</p>
<p>private static void PrintPersonsRowData(DataRowCollection dataRows)<br>{<br>foreach (DataRow row in dataRows)<br>{<br>Console.WriteLine($â€id: {row[â€œidâ€]}, lastname: {row[â€œlastnameâ€]}, firstname: {row[â€œfirstnameâ€]}, numberOfDependents: {row[â€œnumberOfDependentsâ€]}â€);<br>}<br>}</p>
<p>private static void PrintPersonsRowData(IDataReader reader)<br>{<br>while (reader.Read())<br>{<br>Console.WriteLine($â€id: {reader[â€œidâ€]}, lastname: {reader[â€œlastnameâ€]}, firstname: {reader[â€œfirstnameâ€]}, numberOfDependents: {reader[â€œnumberOfDependentsâ€]}â€);<br>}<br>}</p>
<p>private static void InitializeData()<br>{<br>using (var connection &#x3D; DbManager.CreateConnection())<br>{<br>connection.Open();</p>
<p>using (var command &#x3D; connection.CreateCommand())<br>{<br>command.CommandText &#x3D;<br>@â€<br>DROP TABLE IF EXISTS person;<br>â€œ;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@â€<br>CREATE TABLE person (Id int primary key, lastname TEXT, firstname TEXT, numberOfDependents int);<br>â€œ;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@â€</p>
<p>INSERT INTO person<br>VALUES (1, â€˜Seanâ€™, â€˜Reidâ€™, 5);</p>
<p>INSERT INTO person<br>VALUES (2, â€˜Madeleineâ€™, â€˜Lymanâ€™, 13);</p>
<p>INSERT INTO person<br>VALUES (3, â€˜Oliverâ€™, â€˜Wrightâ€™, 66);<br>â€œ;<br>command.ExecuteNonQuery();<br>}</p>
<p>}<br>}<br>}</p>
<p>The console shows:</p>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2021/11/result.png" alt="Table Data Gateway result"></p>
<h3 id="3-Conclusions-for-Table-Data-Gateway"><a href="#3-Conclusions-for-Table-Data-Gateway" class="headerlink" title="3. Conclusions for Table Data Gateway"></a>3. Conclusions for Table Data Gateway</h3><p>â€œTable Data Gatewayâ€ is a simpler data source architectural pattern. We can create a gateway to map a table(or a view&#x2F;a store procedure) even map to whole tables. If the application is not complex, this pattern is a good choice.</p>
<p>The above sample code is uploaded to thisÂ <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_TableDataGateway">Github Repository</a>.</p>
<p>For next article I will writeÂ <strong>Row Data Gateway</strong> pattern according toÂ <strong>Chapter 10 Data Source Architectural Pattern - Table Data Gateway</strong>Â of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/40CuWZT">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">208</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
