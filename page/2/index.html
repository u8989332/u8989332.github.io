<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="GeekCodeParadise">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="GeekCodeParadise">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="LiJyu Gao">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>GeekCodeParadise</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">GeekCodeParadise</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/05/threading-in-csharp-part-2-basic-synchronization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/05/threading-in-csharp-part-2-basic-synchronization/" class="post-title-link" itemprop="url">Threading in C# - BASIC SYNCHRONIZATION</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-05 14:04:00" itemprop="dateCreated datePublished" datetime="2021-12-05T14:04:00+08:00">2021-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Thread/" itemprop="url" rel="index"><span itemprop="name">Thread</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/" itemprop="url" rel="index"><span itemprop="name">讀書筆記</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Threading-in-C-PART-2-BASIC-SYNCHRONIZATION"><a href="#Threading-in-C-PART-2-BASIC-SYNCHRONIZATION" class="headerlink" title="Threading in C# - PART 2: BASIC SYNCHRONIZATION"></a>Threading in C# - PART 2: BASIC SYNCHRONIZATION</h3><p>這篇文章為閱讀 Threading in C# 系列的Part 2筆記.</p>
<h3 id="Threading-Synchronization-Essentials"><a href="#Threading-Synchronization-Essentials" class="headerlink" title="Threading - Synchronization Essentials"></a>Threading - Synchronization Essentials</h3><ul>
<li>同步的結構分4種:</li>
</ul>
<ol>
<li>Simple blocking methods: 像是Sleep, Join, Task.Wait等</li>
<li>Locking constructs: 限制數個Thread做後續操作, Excluseive locking只有一個thread, 比如lock(Monitor.Enter, Monitor.Exit), Mutex 和 SpinLock. 而Nonexclusive locking像是Semaphore, SemaphoreSlim 和 reader&#x2F;writer locks</li>
<li>Signaling constructs: Thread可以暫停, 直到收到通知才恢復, 這可避免沒效率的輪詢. 比如用 event wait handler, Monitor的Wait&#x2F;Pulse, CountdownEvent和Barrier</li>
<li>Nonblocking synchronization constructs: Thread.MemoryBarrier, Thread.VolatileRead, Thread.VolatileWrite, volatile關鍵字 和 Interlocked類別</li>
</ol>
<h4 id="Blocking"><a href="#Blocking" class="headerlink" title="Blocking"></a>Blocking</h4><ul>
<li>等待、Sleep等會讓thread暫停, 把time slice還給CPU.</li>
<li>可用ThreadState檢查是否Blocked</li>
</ul>
<p>bool blocked &#x3D; (someThread.ThreadState &amp; ThreadState.WaitSleepJoin) !&#x3D; 0</p>
<ul>
<li>當Thread發生block 或 unblock, 都會造成 Context Switch</li>
<li>unblock的觸發條件:</li>
</ul>
<ol>
<li>blocking條件已滿足</li>
<li>operation timing out(有指定timeout的時候)</li>
<li>被interrupt</li>
<li>被aborted</li>
</ol>
<h4 id="Blocking-Versus-Spinning"><a href="#Blocking-Versus-Spinning" class="headerlink" title="Blocking Versus Spinning"></a>Blocking Versus Spinning</h4><ul>
<li>用loop一直查詢某條件, 造成CPU消耗很大的運算資源</li>
<li>一種比較好一點的寫法是, 在loop內加個Thread.Sleep</li>
<li>如果要用Spinning的寫法, 一種是保證該條件很快就滿足的運算, 另外一種是用SpinLock&#x2F;SpinWait</li>
</ul>
<h4 id="ThreadState"><a href="#ThreadState" class="headerlink" title="ThreadState"></a>ThreadState</h4><p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/wp-content/uploads/2022/01/image-11.png"><img src="https://geekcodeparadise.com/wp-content/uploads/2022/01/image-11.png"></a></p>
<ul>
<li>ThreadState可以檢查Thread的狀態</li>
</ul>
<h3 id="Locking"><a href="#Locking" class="headerlink" title="Locking"></a>Locking</h3><ul>
<li>區分 thread-safe和thread-unsafe的程式碼, 通常是有static變數, 如果有多個thread存取時會不會錯誤</li>
<li>最簡單的方式是用lock關鍵字做同步化, 綁住某個同步化物件, 只允許一個thread操作, 其他的thread變成blocked狀態, 且依照queue的順序來排隊</li>
</ul>
<h4 id="A-Comparison-of-Locking-Constructs"><a href="#A-Comparison-of-Locking-Constructs" class="headerlink" title="A Comparison of Locking Constructs"></a>A Comparison of Locking Constructs</h4><ul>
<li>下表的overhead是指對一個thread做block和unblock的時間</li>
</ul>
<p>Construct</p>
<p>Purpose</p>
<p>Cross-Process ?</p>
<p>Overhead</p>
<p>lock (Monitor.Enter &#x2F; Monitor.Exit)</p>
<p>確保只有一個Thread能存取資源或一段code</p>
<p> </p>
<p>20 ns</p>
<p>Mutext</p>
<p>同lock</p>
<p>Yes</p>
<p>1000 ns</p>
<p>SemaphoreSlim</p>
<p>確保指定數量的thread能存取資源或一段code</p>
<p> </p>
<p>200 ns</p>
<p>Semaphore</p>
<p>同Semaphore</p>
<p>Yes</p>
<p>1000 ns</p>
<p>ReaderWriterLockSlim</p>
<p>允許多個reader能與一個writer共存</p>
<p> </p>
<p>40 ns</p>
<p>ReaderWriterLock</p>
<p>同ReaderWriterLockSlim</p>
<p> </p>
<p>100 ns</p>
<h4 id="Monitor-Enter-and-Monitor-Exit"><a href="#Monitor-Enter-and-Monitor-Exit" class="headerlink" title="Monitor.Enter and Monitor.Exit"></a>Monitor.Enter and Monitor.Exit</h4><ul>
<li>lock &#x3D; Monitor.Enter + Monitor.Exit + try&#x2F;finally</li>
</ul>
<p>try<br>{<br>    DoSomething();<br>}<br>finally<br>{<br>    Monitor.Exit(_locker);<br>}</p>
<ul>
<li>上面寫法會有bug, 如果在Enter和try之間發生exception (比如thread被Abort或記憶體溢出), 則永遠不釋放該locker</li>
<li>更好的寫法是在try內用Enter, 且代入bool的變數, 用來判斷是否lock成功, 成功的話可以呼叫Exit</li>
</ul>
<p>bool lockTaken &#x3D; false;<br>try<br>{<br>Monitor.Enter(_locker, ref lockTaken)<br>}<br>finally<br>{<br>if(lockTaken)<br>{<br>Monitor.Exit(_locker);<br>}<br>}</p>
<ul>
<li>還有個TryEnter, 可以代入timeout, 如果回傳true代表lock成功, 如果回傳false代表lock過程超時</li>
</ul>
<h4 id="Choosing-the-Synchronization-Object"><a href="#Choosing-the-Synchronization-Object" class="headerlink" title="Choosing the Synchronization Object"></a>Choosing the Synchronization Object</h4><ul>
<li>必須是reference type的物件</li>
<li>一般是private的物件, 做邏輯封裝</li>
<li>精準的lock會用專門的locker物件</li>
<li>lock(this)或lock(typeof(SomeClass)), 很難預防死結和過多的blocking</li>
</ul>
<h4 id="When-to-Lock"><a href="#When-to-Lock" class="headerlink" title="When to Lock"></a>When to Lock</h4><ul>
<li>基本的規則是, lock在存取可寫的共享物件</li>
<li>Thread safe與unsafe的寫法</li>
</ul>
<p>class ThreadUnsafe<br>{<br>static int _x;<br>static void Increment() { ++_x; }<br>static void Assign() { _x &#x3D; 123; }<br>}</p>
<p>class ThreadSafe<br>{<br>static readonly object _locker &#x3D; new object();<br>static int _x;<br>static void Increment() { lock(_locker) { ++_x; }}<br>static void Assign() { lock(_locker) { _x &#x3D; 123; }}<br>}</p>
<ul>
<li>non-blocking的同步化, 後續有memory-barriers和Interlocked可用</li>
</ul>
<h4 id="Locking-and-Atomicity"><a href="#Locking-and-Atomicity" class="headerlink" title="Locking and Atomicity"></a>Locking and Atomicity</h4><ul>
<li>有一組變數, 寫跟讀總是在同一個lock, 則稱它們是Atomic</li>
<li>比如下面x與y的除法範例</li>
</ul>
<p>lock (_locker)<br>{<br>if(x!&#x3D;0)<br>y &#x2F;&#x3D; x;<br>}</p>
<ul>
<li>有時會有破壞atomicity的bug, 比如有呼叫其他函式造成exception, 使某些變數沒完整計算完</li>
<li>建議其他函式先運算完再把它的值帶入到lock, 或者try的catch&#x2F;finally做rollback</li>
</ul>
<h4 id="Nested-Locking"><a href="#Nested-Locking" class="headerlink" title="Nested Locking"></a>Nested Locking</h4><ul>
<li>lock可以巢狀包裝</li>
<li>適用於lock的內容, 有call其他的函式, 這些函式實作再加上lock</li>
</ul>
<h4 id="Deadlocks"><a href="#Deadlocks" class="headerlink" title="Deadlocks"></a>Deadlocks</h4><ul>
<li>當兩個thread都掌握對方的資源且等待對方釋放, 沒任何進展就是死結</li>
<li>基本的死結案例:</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class TestDeadlocks<br>{<br>    static void Main(string[] args){<br>        object locker1 &#x3D; new object();<br>        object locker2 &#x3D; new object();<br>        new Thread(() &#x3D;&gt; {<br>            lock(locker1){<br>                Thread.Sleep(1000);<br>                Console.WriteLine(“Ready to lock 2”);<br>                lock(locker2);<br>            }<br>        }).Start();<br>        lock(locker2){<br>            Thread.Sleep(1000);<br>            Console.WriteLine(“Ready to lock 1”);<br>            lock(locker1);<br>        }</p>
<pre><code>    Console.WriteLine(&quot;Hi&quot;);
    Console.Read();
&#125;
</code></pre>
<p>}</p>
<ul>
<li>更複雜的死結是,Thread 1 lock 而呼叫A class的X方法, X方法呼叫B class的Y 方法, 另外Thread 2 lock而呼叫B class的Y方法, Y方法呼叫A class的X方法.</li>
<li>考慮lock是否要用在別的class的函式</li>
<li>之後的declarative, data parallelism, immutable types 和 nonblock synchronization能減少lock的需求</li>
<li>另一些常見的死結發生在WPF的Dispatcher.Invoke或Winform的Control.Invoke, 解法是用BeginInvoke</li>
</ul>
<h4 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h4><ul>
<li>基本上lock的速度很快</li>
<li>如果有很短暫的lock, 可以改用SpinLock, 減少Context Switch</li>
<li>Lock得太久, 會減少共時性的效能; Lock也是造成Deadlock的風險</li>
</ul>
<h4 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h4><ul>
<li>跨Process的lock, 大約比lock慢50倍</li>
<li>使用WaitOne做lock, ReleaseMutex unlock, 而用close或dispose也是release</li>
<li>Mutex認出同樣的lock是用Name</li>
<li>如果是執行在Terminal Services環境, 一般的Mutex無法跨terminal server session, 要在Name加上Global 前綴字</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class OneAtATimePlease<br>{<br>    static void Main(string[] args){<br>        using(var mutex &#x3D; new Mutex(false, “test oreilly”))<br>        {<br>            if(!mutex.WaitOne(TimeSpan.FromSeconds(3), false)){<br>                Console.WriteLine(“ another is running”);<br>                Console.Read();<br>                return;<br>            }<br>            RunProgram();<br>        }<br>    }</p>
<pre><code>static void RunProgram()
&#123;
    Console.WriteLine(&quot;To exit&quot;);
    Console.Read();
&#125;
</code></pre>
<p>}</p>
<h4 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h4><ul>
<li>Semaphore允許多個Thread在同一區段執行, 超過此容量的thread會block等待</li>
<li>把Semaphore的容量設為1, 就和lock與mutex一樣, 但Semaphore的Release是任何thread都能呼叫</li>
<li>SemaphoreSlim有更低延遲, 且能帶cancellation token, 用在parallel programming</li>
<li>如果Semaphore有給名字, 也是能跨Process</li>
<li>下面範例是最多3個Thread進入</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class SemaphoreClub<br>{<br>    static SemaphoreSlim _sem &#x3D; new SemaphoreSlim(3);<br>    static void Main(string[] args){<br>        for(int i &#x3D; 0 ; i &lt; 5; ++i){<br>            new Thread(Enter).Start(i);<br>        }<br>        Console.Read();<br>    }</p>
<pre><code>static void Enter(object id)
&#123;
    Console.WriteLine(id + &quot; wants to enter&quot;);
    \_sem.Wait();
    Console.WriteLine(id + &quot; is in!&quot;);
    Thread.Sleep(500 \* (int) id);
    Console.WriteLine(id + &quot; is leaving&quot;);
    \_sem.Release();
&#125;
</code></pre>
<p>}</p>
<h3 id="Thread-Safety"><a href="#Thread-Safety" class="headerlink" title="Thread Safety"></a>Thread Safety</h3><ul>
<li>一般的type很少是Thread-safe, 原因有如下:</li>
</ul>
<ol>
<li>開發時要維護該type所有Thread-safe欄位</li>
<li>Thread-safety有效能上的花費, 即使沒有多執行緒也必要花費</li>
<li>使用Thread-safe的type不一定能讓執行程式thread-safe</li>
</ol>
<ul>
<li>基本的用法是用exclusive lock去鎖定特定的程式碼而達到thread-safe</li>
<li>另外是減少共享資料, 達到無狀態的功能, 比如ASP.NET Web的Request, 大都是獨自處理</li>
<li>最後是用automatic locking regime的方式, 對class或property加上ContextBoundObject和Synchronization屬性, 就能自動有鎖的功能. 但缺點是會產生另一種方式的死結、併發性差、意外重入等問題. 盡量用exlusive lock.</li>
</ul>
<h4 id="Thread-Safety-and-NET-Framework-Types"><a href="#Thread-Safety-and-NET-Framework-Types" class="headerlink" title="Thread Safety and .NET Framework Types"></a>Thread Safety and .NET Framework Types</h4><ul>
<li>Enumeration是thread-unsafe的行為, 所以共同資料要enumeration時, 先宣告一個local變數, 再用lock的方式copy (ToList, ToArray等)到local變數</li>
<li>Enumeration的另一種解法是reader&#x2F;writer lock</li>
</ul>
<p>class ThreadSafe<br>{<br>static List<string> _list &#x3D; new List<string>();<br>static void Main()<br>{<br>new Thread(AddItem).Start();<br>new Thread(AddItem).Start();<br>}</p>
<p>static void AddItem()<br>{<br>lock (_list) _list.Add(“Item “ + _list.Count());<br>string[] items;<br>lock (_list) items &#x3D; _list.ToArray();<br>foreach(string s in items) Console.WriteLine(s);<br>}<br>}</p>
<p><em><strong>Locking around thread-safe objects</strong></em></p>
<ul>
<li>如果物件本身是thread-safe, 但是對它的有些操作仍是要lock, 比如if的敘述, 沒有lock的狀況下, 多執行緒的情況會存取到同樣的值而做後續if block的操作(且可能會改值).</li>
</ul>
<p><em><strong>Static members</strong></em></p>
<ul>
<li>.net framework設計static member是thread-safe, 而實例的member不是. 比如取DateTime.Now, 就不需要去用lock來取</li>
<li>static function不是thread-safe, 要確認功能對資料的共享性</li>
</ul>
<p><em><strong>Read-only thread safety</strong></em></p>
<ul>
<li>能在文件註明該collection是只讀訪問的thread-safe, 並要求使用者在只讀的方法做寫入</li>
<li>實作ToArray等, 本身會有thread-unsafe的issue</li>
<li>如果文件缺少說明, 要注意是否某些方法是read-only. 比如Random.Next(), 內部實作有更新private seed, 因此要用lock取值或者分開的Random物件</li>
</ul>
<h4 id="Thread-Safety-in-Application-Servers"><a href="#Thread-Safety-in-Application-Servers" class="headerlink" title="Thread Safety in Application Servers"></a>Thread Safety in Application Servers</h4><ul>
<li>通常像ASP.NET,WCF都是獨立thread處理request, 但有時需要共享資料, 像catch, 更新和取資料都要lock, 會減少效能</li>
</ul>
<h4 id="Rich-Client-Applications-and-Thread-Affinity"><a href="#Rich-Client-Applications-and-Thread-Affinity" class="headerlink" title="Rich Client Applications and Thread Affinity"></a>Rich Client Applications and Thread Affinity</h4><ul>
<li>在WPF或Winform, UI的元件有Affinity特性, 代表哪個thread建立元件, 那元件只能被那thread存取.</li>
<li>所以別的thread需要marshal原本thread來控制元件, 比如Winform的Invoke或BeginInvoke, WPF的Invoke或BeginInvoke</li>
<li>Invoke是同步方法, 會block目前thread; BeginInvoke是非同步方法, 立即回傳caller而marshal的request會進到queue(和keyboard, mouse的事件使用同樣的message queue)</li>
</ul>
<p><strong><em>Worker threads versus UI threads</em></strong></p>
<ul>
<li>Rich client有兩大thread: UI Thread和Worker Thread</li>
<li>UI Thread專門建立UI元件, Worker thread一般用來執行long-running job</li>
<li>Rich client都會有一個UI Thread且是Main thread, 再由它生成work thread, 可直接生成或者用BackgroundWorker</li>
<li>Single Document Interface (SDI), 像是Word, 會有多個UI Thread</li>
</ul>
<h4 id="Immutable-Objects"><a href="#Immutable-Objects" class="headerlink" title="Immutable Objects"></a>Immutable Objects</h4><ul>
<li>物件能封裝成裡面的狀態不能被內部與外部改變, 稱為immutable object. 決定它內部值是在Constructor且值是Read-only. 可減少lock的執行時間.</li>
<li>下面範例是建立一個immutable object, 只有assign新物件才會需要lock, 取值不需要</li>
</ul>
<p>class ProgressStatus<br>{<br>public readonly int PercentComplete;<br>public readonly string StatusMessage;<br>public ProgressStatus(int percentComplete, string statusMessage)<br>{<br>PercentComplete &#x3D; percentComplete;<br>StatusMessage &#x3D; statusMessage;<br>}<br>}</p>
<p>class Program<br>{<br>readonly object _statusLocker &#x3D; new object();<br>ProgressStatus _status;<br>void SomeFunction()<br>{<br>_status &#x3D; new ProgressStatus(50, “Working on it”);<br>ProgressStatus statusCopy;<br>lock(_statusLocker) statusCopy &#x3D; _status;<br>int pc &#x3D; statusCopy.PercentComplete;<br>string msg &#x3D; statusCopy.StatusMessage;<br>}<br>}</p>
<ul>
<li>在int pc &#x3D; … 的最後2行, 有隱含用Memory barrier包裝</li>
<li>後續不使用lock, 還會有顯示Memory barrier, Interlocked.CompareExchange, spin-waits等功能可用</li>
</ul>
<h3 id="Threading-Signaling-with-Event-Wait-Handles"><a href="#Threading-Signaling-with-Event-Wait-Handles" class="headerlink" title="Threading - Signaling with Event Wait Handles"></a>Threading - Signaling with Event Wait Handles</h3><ul>
<li>Signaling是指thread會一直等待, 直到收到從別的Thread發的通知</li>
<li>和一般C#的event不相關</li>
<li>3種類型: AutoResetEvent, ManualResetEvent, CountdownEvent</li>
</ul>
<h4 id="A-Comparison-of-Signaling-Constructs"><a href="#A-Comparison-of-Signaling-Constructs" class="headerlink" title="A Comparison of Signaling Constructs"></a>A Comparison of Signaling Constructs</h4><ul>
<li>下表的overhead是指對一個signal和wait的時間</li>
</ul>
<p>Construct</p>
<p>Purpose</p>
<p>Cross-Process ?</p>
<p>Overhead</p>
<p>AutoResetEvent</p>
<p>允許一個thread當收到singal時,執行一次unblock</p>
<p>Yes</p>
<p>1000 ns</p>
<p>ManualResetEvent</p>
<p>允許一個thread當收到singal時,執行無限期的unblock (直到它重置)</p>
<p>Yes</p>
<p>1000 ns</p>
<p>ManualResetEventSlim (Net Framework 4)</p>
<p>同ManualResetEvent</p>
<p> </p>
<p>40 ns</p>
<p>CountdownEvent (Net Framework 4)</p>
<p>允許一個thread當收到預定數量的singal時,執行unblock</p>
<p> </p>
<p>40 ns</p>
<p>Barrier (Net Framework 4)</p>
<p>實作Thread執行屏障</p>
<p> </p>
<p>80 ns</p>
<p>Wait and Pulse</p>
<p>允許一個thread block直到某條件達成</p>
<p> </p>
<p>120 ns for a Pulse</p>
<h4 id="AutoResetEvent"><a href="#AutoResetEvent" class="headerlink" title="AutoResetEvent"></a>AutoResetEvent</h4><ul>
<li>它像是一個票閘, 插入一張票只讓一個人過</li>
<li>Thread 在門閘時呼叫WaitOne來wait&#x2F;block, 而呼叫Set插入票</li>
<li>如果有多個thread在門閘呼叫WaitOne, 變成queue排隊</li>
<li>Ticket可以來自任何thread, 代表任何unblock的thread可存取該AutoResetEvent物件並呼叫Set</li>
<li>在constructor代入true的話, 代表直接呼叫Set</li>
<li>用EventWaitHandle可達到相同的功能 (EventWaitHandle是AutoResetEvent的父類別)</li>
</ul>
<p>var auto &#x3D; new AutoResetEvent (false);</p>
<p>&#x2F;&#x2F; 等同寫法</p>
<p>var auto2 &#x3D; new EventWaitHandle(false, EventResetMode.AutoReset);</p>
<ul>
<li>使用的範例如下:</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class TestAutoResetEvent<br>{<br>    static EventWaitHandle _waitHandle &#x3D; new AutoResetEvent(false);<br>    static void Main(string[] args){</p>
<pre><code>    new Thread(() =&amp;gt; &#123;
        Console.WriteLine(&quot;Wait...&quot;);
        \_waitHandle.WaitOne();
        Console.WriteLine(&quot;awake&quot;);
    &#125;).Start();
    Thread.Sleep(1000);
    \_waitHandle.Set();
    Console.Read();
&#125;
</code></pre>
<p>}</p>
<ul>
<li>範例對應的時序表</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/wp-content/uploads/2022/01/image-12.png"><img src="https://geekcodeparadise.com/wp-content/uploads/2022/01/image-12.png"></a></p>
<p><em><strong>Producer&#x2F;consumer queue</strong></em></p>
<ul>
<li>一個queue用來放進要執行的任務, 而其他thread在背景從這queue挑任務來做</li>
<li>用這種queue能有效管理要執行的thread數量, 比如IO密集型任務可只安排一個thread, 其他需要10個</li>
<li>CLR的Thread pool也是一種Producer&#x2F;consumer queue</li>
<li>queue插入的資料會有對應的任務, 比如填入檔案名稱, 而對應的任務是加密該檔案</li>
<li>以下用AutoResetEvent實作範例</li>
</ul>
<p>using System;<br>using System.Collections.Generic;<br>using System.Threading;</p>
<p>namespace ProducerConsumerTest<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            using (ProducerConsumerQueue q &#x3D; new ProducerConsumerQueue())<br>            {<br>                q.EnqueueTask(“Hello”);<br>                for(int i &#x3D; 0; i &lt; 20; ++i)<br>                {<br>                    q.EnqueueTask(“Say “ + i);<br>                }<br>                q.EnqueueTask(“Good bye”);<br>            }<br>        }<br>    }</p>
<pre><code>public class ProducerConsumerQueue : IDisposable
&#123;
    EventWaitHandle \_wh = new AutoResetEvent(false);
    Thread \_worker;
    readonly object \_locker = new object();
    Queue&amp;lt;string&amp;gt; \_tasks = new Queue&amp;lt;string&amp;gt;();
    public ProducerConsumerQueue()
    &#123;
        \_worker = new Thread(Work);
        \_worker.Start();
    &#125;

    public void EnqueueTask(string task)
    &#123;
        lock (\_locker)
        &#123;
            \_tasks.Enqueue(task);
        &#125;
        \_wh.Set();
    &#125;

    public void Dispose()
    &#123;
        EnqueueTask(null); // signal the consumer to exit
        \_worker.Join(); // wait for the consumer&#39;s thread to finish
        \_wh.Close(); // release any OS Resources
    &#125;

    private void Work()
    &#123;
        while (true)
        &#123;
            string task = null;
            lock(\_locker)
            &#123;
                if(\_tasks.Count &amp;gt; 0)
                &#123;
                    task = \_tasks.Dequeue();
                    if(task == null)
                    &#123;
                        return;
                    &#125;
                &#125;
            &#125;
            if(task != null)
            &#123;
                Console.WriteLine(&quot;Performing task : &quot; + task);
                Thread.Sleep(1000); // simulate work...
            &#125;
            else
            &#123;
                \_wh.WaitOne(); // no more tasks , wait for a signal
            &#125;
        &#125;
    &#125;
&#125;
</code></pre>
<p>}</p>
<ol>
<li>用lock去鎖定queue, 達到thread-safe</li>
<li>在enqueue之後, 呼叫Set, 通知在while(true)有wait的thread可以往下做</li>
<li>如果caller插入null的資料, 直接結束</li>
<li>queue如果是空的, 會呼叫WaitOne等待signal</li>
<li>在Dispose的實作, 呼叫Enqueue(null), 讓Work方法讀到null而return結束, 否則Thread的Join永遠不結束; 對EventWaitHandle呼叫Close, 可以釋放內部有用到的資源</li>
</ol>
<ul>
<li>.Net Framework 4 有BlockingCollection, 實作Producer&#x2F;Consumer queue</li>
<li>上述用AutoResetEvent的Producer&#x2F;Consumer queue是個好的範例, 未來加上cancellation或bounded queue, 都可以此為起點</li>
</ul>
<h4 id="ManualResetEvent"><a href="#ManualResetEvent" class="headerlink" title="ManualResetEvent"></a>ManualResetEvent</h4><ul>
<li>和AutoResetEvent相比, ManualResetEvent是一般的閘門, 呼叫Set時, 讓所有等待(有呼叫過WaitOne)的Thread全都能進入</li>
<li>呼叫Reset能把閘門關上</li>
<li>呼叫WaitOne就會Block</li>
<li>等同的寫法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var manual1 = new ManualResetEvent(false);</span><br><span class="line">var manual2 = new EventWaitHandle(false, EventResetModel.ManualReset);</span><br></pre></td></tr></table></figure>

<ul>
<li>另一個是ManualResetEventSlim能執行更快且支援CancellationToken, 但不能跨Process</li>
<li>ManualResetEvent是讓一個Thread允許多個Thread unblock, CountdownEvent則相反</li>
</ul>
<h4 id="CountdownEvent"><a href="#CountdownEvent" class="headerlink" title="CountdownEvent"></a>CountdownEvent</h4><ul>
<li>用CountdownEvent可以等多個Thread執行後再往後執行</li>
<li>在.NET Framework 4之前, 可以用Wait and Pulse來實作CountdownEvent</li>
<li>建構CountdownEvent指定要的數量, 呼叫Wait則block該thread, 而呼叫Signal會降低count, 直到count為0, 該thread將unblock</li>
<li>以下範例是等待3個Thread執行後, 才繼續執行</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>public class Program<br>{<br>static CountdownEvent _countDown &#x3D; new CountdownEvent(3);<br>public static void Main()<br>{<br>new Thread(SaySomething).Start(“Thread 1”);<br>new Thread(SaySomething).Start(“Thread 2”);<br>new Thread(SaySomething).Start(“Thread 3”);<br>_countDown.Wait();<br>Console.WriteLine(“All threads have finished”);<br>}<br>static void SaySomething(object msg)<br>{<br>Thread.Sleep(3000);<br>Console.WriteLine(msg);<br>_countDown.Signal();<br>}<br>}</p>
<ul>
<li>Count可以用AddCount來加更多需等待的數量, 但如果已經達到count &#x3D; 0而又呼叫AddCount, 將拋出exception</li>
<li>建議可用TryAddCount, 回傳false代表count已經是0</li>
<li>呼叫Reset將Count回到初始值</li>
</ul>
<h4 id="Creating-a-Cross-Process-EventWaitHandle"><a href="#Creating-a-Cross-Process-EventWaitHandle" class="headerlink" title="Creating a Cross-Process EventWaitHandle"></a>Creating a Cross-Process EventWaitHandle</h4><ul>
<li>EventWaitHandle可以指定名字, 讓多個Process根據同一個名字而共同參考</li>
<li>基本用法:</li>
</ul>
<p>EventWaitHandle wh &#x3D; new EventWaitHandle(false, EventResetMode.AutoReset, “MyCompany.MyApp.Name”);</p>
<h4 id="Wait-Handles-and-the-Thread-Pool"><a href="#Wait-Handles-and-the-Thread-Pool" class="headerlink" title="Wait Handles and the Thread Pool"></a>Wait Handles and the Thread Pool</h4><ul>
<li>使用ThreadPool.RegisterWaitForSingleObject, 可以不綁特定的Thread來執行, 將要委託的任務交給Thread pool執行</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>namespace TestWaitHandleThreadPool<br>{<br>    class Program<br>    {<br>        static ManualResetEvent _starter &#x3D; new ManualResetEvent(false);<br>        static void Main(string[] args)<br>        {<br>            RegisteredWaitHandle reg &#x3D; ThreadPool.RegisterWaitForSingleObject(_starter, Go, “Some Data”, -1, true);<br>            Thread.Sleep(5000);<br>            _starter.Set();<br>            Console.ReadLine();<br>            reg.Unregister(_starter);<br>        }</p>
<pre><code>    static void Go(object data, bool timeOut)
    &#123;
        Console.WriteLine(&quot;Start work : &quot; + data);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>參數-1代表不用timeout, 如果有timeout的話, 會檢測傳送的物件（範例是Some Data字串）的狀態; 參數true代表該Thread pool收到signal後, 不再重設要Wait.</li>
<li>假如原本用WaiOne的方式處理, Server收到100個任務就得new 100個Thread, 變成綁定太多且大量Block. 改寫的方法如下, 讓後續的委託工作都給‘hread Pool處理</li>
</ul>
<p>void AppServerMethod()<br>{<br>_wh.WaitOne();<br>&#x2F;&#x2F; … continue execution<br>}</p>
<p>&#x2F;&#x2F; 變成</p>
<p>void AppServerMethod()<br>{<br> RegisteredWaitHandle reg &#x3D; ThreadPool.RegisterWaitForSingleObject(_starter, Resume, null, -1, true);<br> &#x2F;&#x2F; …<br>}</p>
<p>static void Resume(object data, bool timeOut)<br>{<br>&#x2F;&#x2F; … continue execution<br>}</p>
<h4 id="WaitAny-WaitAll-and-SignalAndWait"><a href="#WaitAny-WaitAll-and-SignalAndWait" class="headerlink" title="WaitAny, WaitAll, and SignalAndWait"></a>WaitAny, WaitAll, and SignalAndWait</h4><ul>
<li>WaitHandle提供static method, 包含WaitNay, WaitAll, SignalAndWait, 可以對有繼承WaitHandle的物件使用較複雜的Signal&#x2F;Wait的功能</li>
<li>WaitAny: 等待任一個Thread收到Signal</li>
<li>WaitAll: 等待所有Thread都收到Signal</li>
<li>SignalAndWait: 對第一個參數的thread發出signal, 對第二個參數的thread做等待</li>
</ul>
<p><em><strong>Alternatives to WaitAll and SignalAndWait</strong></em></p>
<ul>
<li>WaitAll和SignalAndWait不能在單一執行緒的環境執行.</li>
<li>SignalAndWait的替代方案是Barrier類別, 而WaitAll的替代方案是Parallel class的Invoke方法</li>
</ul>
<h3 id="Synchronization-Contexts-NET-Core已不存在）"><a href="#Synchronization-Contexts-NET-Core已不存在）" class="headerlink" title="Synchronization Contexts (.NET Core已不存在）"></a>Synchronization Contexts (.NET Core已不存在）</h3><ul>
<li>繼承ContextBoundObject且加上Synchronization屬性, CLR在這物件會自動使用lock</li>
<li>如下範例, 每個Demo函式會排隊執行</li>
</ul>
<p>using System;<br>using System.Runtime.Remoting.Contexts;<br>using System.Threading;</p>
<p>namespace TestAutoLock<br>{<br>    class Program<br>    {<br>        static void Main(string[] args)<br>        {<br>            AutoLock safeInstance &#x3D; new AutoLock();<br>            new Thread(safeInstance.Demo).Start();<br>            new Thread(safeInstance.Demo).Start();<br>            safeInstance.Demo();<br>        }<br>    }</p>
<pre><code>\[Synchronization\]
public class AutoLock : ContextBoundObject
&#123;
    public void Demo()
    &#123;
        Console.Write(&quot;Thread id : &quot; + Thread.CurrentThread.ManagedThreadId);
        Console.Write(&quot; Start.....&quot;);
        Thread.Sleep(1000);
        Console.WriteLine(&quot;End&quot;);
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>自動lock不包含static的成員和沒有繼承ContextBoundObject的物件(比如Form)</li>
<li>想像是CLR將原始Class套上一層ContextBoundObject Proxy, 能呼叫原始Class的成員, 再為它的方法都加上同步化的功能</li>
<li>如果前面的AutoLock是個Collection, 則使用它的物件也必須是ContextBoundObject, 否則存取它的item需要手動加上lock</li>
<li>Synchronization Context預設會延伸從同一層Scope的Context, 也就是lock包含的深度一直向下</li>
<li>在Synchronization的attribute可以改變預設的行為, 有這些選項:</li>
</ul>
<ol>
<li>NOT_SUPPORTED: 就跟沒加上Synchronization的屬性一樣</li>
<li>SUPPORTED: 如果來自別的synchronized 物件做初始化, 則延伸它的context, 否則保持unsynchronized</li>
<li>REQUIRED (預設): 如果來自別的synchronized 物件做初始化, 則延伸它的context, 否則建立新的Context</li>
<li>REQUIRES_NEW: 總是建立新增Synchronization context</li>
</ol>
<ul>
<li>以下範例是會產生Deadlock的Synchronization:</li>
</ul>
<p>using System;<br>using System.Runtime.Remoting.Contexts;<br>using System.Threading;</p>
<p>namespace TestAutoLockDeadlock<br>{<br>    [Synchronization]<br>    public class Deadlock : ContextBoundObject<br>    {<br>        public Deadlock Other;</p>
<pre><code>    public void Demo()
    &#123;
        Console.WriteLine(Thread.CurrentThread.ManagedThreadId);
        Thread.Sleep(1000);
        Console.WriteLine(&quot;Call other&quot;);
        Other.Hello();
    &#125;

    void Hello()
    &#123;
        Console.WriteLine(&quot;hello&quot;);
    &#125;
&#125;
class Program
&#123;
    private static void Main(string\[\] args)
    &#123;
        Deadlock dead1 = new Deadlock();
        Deadlock dead2 = new Deadlock();
        dead1.Other = dead2;
        dead2.Other = dead1;
        new Thread(dead1.Demo).Start();
        dead2.Demo();
        Console.Read();
    &#125;
&#125;
</code></pre>
<p>}</p>
<ol>
<li>兩個Deadlock物件都是在Program建立, Program本身是unsynchronized, 所以Deadlock物件建立各自的Synchronization Context, 也有各自的lock</li>
<li>呼叫對方的Hello方法後, 即發生Deadlock</li>
</ol>
<h4 id="Reentrancy"><a href="#Reentrancy" class="headerlink" title="Reentrancy"></a>Reentrancy</h4><ul>
<li>Reentrant的定義是, 如果有段程式碼被中斷, 執行緒去執行別的程式, 之後再回來執行這段程式而沒造成影響</li>
<li>通常Thread-safe和reentrant視為同等</li>
<li>如果[Synchronization(true)]這樣使用, 代表需要reentry, 當執行離開此程式碼時, 會把lock釋放, 可避免deadlock. 副作用是在這釋放期間, 任何thread可以進入該物件的context(比如呼叫它的方法)</li>
<li>[Synchronization(true)]是類別層級, 所以在非該context的呼叫都會當class層面的木馬(?)</li>
<li>如果沒有reentrancy, 則在一些場合比較難工作, 比如在一個synchronized class實作多執行緒, 將邏輯委託給其他worker thread, 則worker thread彼此間要溝通沒有reentrancy的話, 將會受阻.</li>
<li>同步自動鎖造成deadlock, reentrancy, 刪除併發等問題, 在一些應用場合沒有手動lock來的好用</li>
</ul>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3lQcLky">C# 9.0 in a Nutshell: The Definitive Reference, Joseph Albahari (Amazon)</a></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/threading-in-csharp-series-book-summary/">Threading in C# 系列的讀書筆記</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/05/threading-in-csharp-part-1-getting-started/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/05/threading-in-csharp-part-1-getting-started/" class="post-title-link" itemprop="url">Threading in C# - GETTING STARTED</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-05 10:45:00" itemprop="dateCreated datePublished" datetime="2021-12-05T10:45:00+08:00">2021-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Thread/" itemprop="url" rel="index"><span itemprop="name">Thread</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/" itemprop="url" rel="index"><span itemprop="name">讀書筆記</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Threading-in-C-前言"><a href="#Threading-in-C-前言" class="headerlink" title="Threading in C# 前言"></a>Threading in C# 前言</h3><p>這陣子換了新工作環境，公司使用不少C# Thread相關的技術，而知名書籍C# in a Nutshell的作者Joseph Albahari，將C# Threading 的技術教學都免費公開，因此會閱讀他的教學文來撰寫讀書筆記，希望在工作專案或Side Project都有幫助到。</p>
<p>作者有一些程式碼並非完整，我會盡量寫出實際可執行的範例，且有些功能Net Core以後不支援，也會加上註明。以下正式開始。</p>
<h3 id="Introduction-and-Concepts"><a href="#Introduction-and-Concepts" class="headerlink" title="Introduction and Concepts"></a>Introduction and Concepts</h3><ul>
<li>Thread是獨立的執行路徑, 也能同時和其他Thread工作</li>
<li>C# Client程式(Console, wpf, winform等), CLR都會起單一的Main thread執行</li>
</ul>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2021/12/NewThread.png" alt="Multi-Threading"></p>
<p>Multi-Threading in C# (Picture source: <a target="_blank" rel="noopener" href="http://www.albahari.com/threading/">Threading in C#<br>Joseph Albahari</a>)</p>
<ul>
<li>被賦予工作的Thread, 只要那工作(function)完成, 該Thread也就結束,也無法重新工作</li>
<li>每個Thread會分配到記憶體獨立的Stack區塊, 所以function的變數能有地方儲存</li>
<li>Thread如果參考到同一物件, 該物件的資料會共享. 如果用static的資料也一樣是共享</li>
<li>但資料共享容易造成_<strong>Thread-Safe</strong>_的問題, 要特別處理, 像下面範例, 因為兩個取到done的值都是false, 所以都會執行</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class ThreadTestWithSharedData<br>{<br>    private bool done &#x3D; false;<br>    static void Main()<br>    {<br>        ThreadTestWithSharedData test &#x3D; new ThreadTestWithSharedData();<br>        Thread t &#x3D; new Thread(test.GoMaybeNotSafe);<br>        t.Start();<br>        test.GoMaybeNotSafe();<br>        Console.Read();<br>    }</p>
<pre><code>public void Go()
&#123;
    if(!done)&#123;
        done = true;
        Console.WriteLine(&quot;done&quot;);
    &#125;
&#125;

public void GoMaybeNotSafe()
&#123;
    if(!done)&#123;
        Console.WriteLine(&quot;done&quot;);
        done = true;
    &#125;
&#125;
</code></pre>
<p>}</p>
<ul>
<li>使用Exclusive lock, 只允許一個thread運算</li>
<li>當Thread被Blocked, 不會消耗CPU資源</li>
</ul>
<h4 id="Join-and-Sleep"><a href="#Join-and-Sleep" class="headerlink" title="Join and Sleep"></a>Join and Sleep</h4><ul>
<li>使用Join可等待Thread完成</li>
<li>使用Sleep讓當前Thread暫停指定的時間</li>
<li>不管是Join或Sleep, 都是_<strong>Blocked</strong>_</li>
<li>Thread.Sleep(0) 將目前Thread的運算時間放其, 將CPU時間交給別的Thread, 等同功能是 Thread.Yield()</li>
<li>用Sleep(0)或Yield, 可以用來找thread safety的問題, 假如把Yield填入程式任何地方且出現問題, 代表這程式碼有Bug</li>
</ul>
<h4 id="How-Threading-Works"><a href="#How-Threading-Works" class="headerlink" title="How Threading Works"></a>How Threading Works</h4><ul>
<li>在CLR裡有個Thread Scheduler, 代表作業系統, 由它Thread的執行時間</li>
<li>單一處理器的系統, 切的time slice時間比switch context的時間還長</li>
<li>多處理器的系統, 切的time slice有concurrency, 可以同時執行多個thread</li>
<li>Thread如果被preempted(搶占), 代表它是被interrupted, 比如time-slicing</li>
</ul>
<h4 id="Threads-vs-Processes"><a href="#Threads-vs-Processes" class="headerlink" title="Threads vs Processes"></a>Threads vs Processes</h4><ul>
<li>多個Thread可以執行在1個Process</li>
<li>Process之間是互相隔離</li>
<li>Thread之間互相分享Heap記憶體的資料</li>
</ul>
<h4 id="Threading’s-Uses-and-Misuses-誤用"><a href="#Threading’s-Uses-and-Misuses-誤用" class="headerlink" title="Threading’s Uses and Misuses(誤用)"></a>Threading’s Uses and Misuses(誤用)</h4><ul>
<li>Maintaining a responsive user interface: 其他的Worker Thread可背後執行消耗的任務, 而Main(UI) Thread與User操作互動</li>
<li>Making efficient use of an otherwise blocked CPU:</li>
<li>Parallel programming: 在多核心&#x2F;多處理器的環境, 多個執行緒能平行分擔工作</li>
<li>Speculative(投機性) execution: 有些任務可以用多個演算法同時運算, 最終結果取最快運算完的.</li>
<li>Allowing requests to be processed simultaneously: .NET的Server功能(WCF、ASP.NET等) 收到Request, 會自動建立多執行緒來處理. Client也是可同樣的作法.</li>
<li>強調多執行緒之間共用資料時, 都會有Bug的產生. 建議把多執行緒的邏輯能封裝在獨立的library, 也比較好測試</li>
<li>有些功能用太多執行緒不見得更快, 比如Disk IO, 只要幾個thread讀取 比 10幾個thread還快</li>
</ul>
<h3 id="Creating-and-Starting-Threads"><a href="#Creating-and-Starting-Threads" class="headerlink" title="Creating and Starting Threads"></a>Creating and Starting Threads</h3><ul>
<li>Thread建立時會帶入委託TheadStart, 但可以省略直接帶functionc或匿名function</li>
</ul>
<h4 id="Passing-Data-to-a-Thread"><a href="#Passing-Data-to-a-Thread" class="headerlink" title="Passing Data to a Thread"></a>Passing Data to a Thread</h4><ul>
<li>可以在Thread.Start(someArgs)代入該function的參數</li>
<li>也可以用ParameterizedThreadStart, 但是function的參數必須用object, 再另外轉型</li>
</ul>
<p><strong>Lambda expressions and captured variables:</strong> 傳參數要注意共用性的問題, 下面的輸出可能是0223557799, 而不是0~9各出現一次, 原因是有時多個Thread對i會存取到一樣的</p>
<p>for (int i &#x3D; 0; i &lt; 10; i++)<br>  new Thread (() &#x3D;&gt; Console.Write (i)).Start();</p>
<p>解決Captured variable的方法是指定變數:</p>
<p>for (int i &#x3D; 0; i &lt; 10; i++)<br>{<br>  int temp &#x3D; i;<br>  new Thread (() &#x3D;&gt; Console.Write (temp)).Start();<br>}</p>
<h4 id="Naming-Threads"><a href="#Naming-Threads" class="headerlink" title="Naming Threads"></a>Naming Threads</h4><ul>
<li>可以指定Thread的名字, 比較容易做Debug</li>
<li>用<a target="_blank" rel="noopener" href="http://thread.currentthread.name/">Thread.CurrentThread.Name</a> &#x3D; XXXX 指定名字</li>
</ul>
<h4 id="Foreground-and-Background-Threads"><a href="#Foreground-and-Background-Threads" class="headerlink" title="Foreground and Background Threads"></a>Foreground and Background Threads</h4><ul>
<li>Thread預設建立是Foreground, 代表它執行完才會讓App結束</li>
<li>指定Thread.IsBackground &#x3D; true, App終止時並不會理會Background的thread而強制終止</li>
<li>如果在程式要結束且有finally的background thread, 這thread也會被忽略掉, 解決方法有2</li>
</ul>
<ol>
<li>用Join</li>
<li>如果是Pooled thread, 可用event wait handler</li>
</ol>
<ul>
<li>如果有程式被任務管理員中止, 所有程式內的thread都會像background的直接中止</li>
</ul>
<h4 id="Thread-Priority"><a href="#Thread-Priority" class="headerlink" title="Thread Priority"></a>Thread Priority</h4><ul>
<li>Priority決定thread的執行時間長度</li>
<li>小心使用Priority, 否則可能造成對其他thread取資源的starvation</li>
<li>如果Process的Priority很低, 即使調高Thread的Priority也是會被限制資源</li>
<li>Process有個RealTime的Priority, 這會幾乎搶佔所有作業系統的資源, 小心使用, 一般用High就好</li>
<li>如果要做RealTime的應用程式且包含使用者介面, 通常會拆開來, 使用者介面一個程式、後端運算是另一個程式, 彼此溝通用Remoting(WCF, Web Api之類)或memory-mapped files (C# in a Nutshell 有提到!! 沒用過~~)</li>
</ul>
<h4 id="Exception-Handling"><a href="#Exception-Handling" class="headerlink" title="Exception Handling"></a>Exception Handling</h4><ul>
<li>建立Thread的try&#x2F;catch&#x2F;finally的scope, 無法捕捉到thread拋出的exception, 以下範例會直接拋出Exception, 而程式直接中止, 不會進到catch</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class ThreadThrowException<br>{<br>    static void Main(string[] args){<br>        try{<br>            Thread t &#x3D; new Thread(Go);<br>            t.Start();<br>        }<br>        catch(Exception ex){<br>            Console.WriteLine(“Hi i am here” + ex.Message);<br>        }</p>
<pre><code>    Console.Read();
&#125;

static void Go()
&#123;
    throw new Exception(&quot;Null&quot;);
&#125;
</code></pre>
<p>}</p>
<ul>
<li>將try&#x2F;catch寫在被Thread執行的function</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class ThreadThrowException2<br>{<br>    static void Main(string[] args){<br>        Thread t &#x3D; new Thread(Go);<br>        t.Start();</p>
<pre><code>    Console.Read();
&#125;

static void Go()
&#123;
    try&#123;
        throw new Exception(&quot;Null&quot;);
    &#125;
    catch(Exception ex)&#123;
        Console.WriteLine(&quot;Hi i am here&quot; + ex.Message);
    &#125;
    
&#125;
</code></pre>
<p>}</p>
<ul>
<li>Global的異常事件處理(WPF和Winform的Application.DispatcherUnhandledException和 Application.ThreadException), 只有Main UI thread拋出的異常才會處理, 其他Worker thread的異常要自己處理</li>
<li>AppDomain.CurrentDomain.UnhandledException會被任何異常觸發, 但無法阻止後續程式的中止, 以下範例兩個exception都會被UnhandledException捕捉, 但程式仍直接中止</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class ThreadThrowExceptionWithAppDomainHandler<br>{<br>    static void Main(string[] args){<br>        AppDomain currentDomain &#x3D; AppDomain.CurrentDomain;<br>        currentDomain.UnhandledException +&#x3D; new UnhandledExceptionEventHandler(MyHandler);<br>        try{<br>            Thread t &#x3D; new Thread(Go);<br>            t.Start();<br>        }<br>        catch(Exception ex){<br>            Console.WriteLine(“Hi i am here” + ex.Message);<br>        }</p>
<pre><code>    throw new Exception(&quot;TEST&quot;);

    Console.Read();
&#125;

static void Go()
&#123;
    throw new Exception(&quot;Null&quot;);
&#125;

static void MyHandler(object s, UnhandledExceptionEventArgs args)
&#123;
    Exception e = (Exception) args.ExceptionObject;
    Console.WriteLine(&quot;runtime terminating: &#123;0&#125; &quot;, args.IsTerminating);
&#125;
</code></pre>
<p>}</p>
<h3 id="Threading-Pool"><a href="#Threading-Pool" class="headerlink" title="Threading Pool"></a>Threading Pool</h3><ul>
<li>使用Threading Pool的4種方式</li>
</ul>
<ol>
<li>Task Parallel Library</li>
<li>ThreadPool.QueueUserWorkItem</li>
<li>asynchronous delegates (BeginXXXXX…)</li>
<li>BackgroundWorker</li>
</ol>
<ul>
<li>以下是間接會用到Threading pool:</li>
</ul>
<ol>
<li>WCF, Remoting, ASP.NET, ASMX Web service等的應用程式Server</li>
<li>System.Timers.Timer和System.Threading.Timer</li>
<li>Net有用Async結尾的函式, 比如WebClient(使用event-based asynchronous pattern)和BeginXXXX開頭的函式(asynchronous programming model pattern)</li>
<li>PLINQ</li>
</ol>
<ul>
<li>使用Threading Pool的注意事項</li>
</ul>
<ol>
<li>不能對Thread pool設定Name</li>
<li>thread pool都是background thread</li>
<li>block thread pool可能會造成一些潛在問題, 有一些優化的手法(比如ThreadPool.SetMinThreads)</li>
</ol>
<ul>
<li>Thread pool設過priority後, 任務執行完回收到pool會賦歸成normal priority</li>
<li>可以用Thread.CurrentThread.IsThreadPoolThread 查看目前Thread是不是從pool來的</li>
</ul>
<h4 id="Entering-the-Thread-Pool-via-TPL"><a href="#Entering-the-Thread-Pool-via-TPL" class="headerlink" title="Entering the Thread Pool via TPL"></a>Entering the Thread Pool via TPL</h4><ul>
<li>新的Task類別使用Thread pool更簡單</li>
<li>非泛型的Task類別取代ThreadPool.QueueUserWorkItem</li>
<li>泛型的Task<TResult>類別取代asynchronous delegate (BeginXXXXX…)</li>
<li>非泛型的Task類別用Task.Factory.StartNew</li>
<li>會回傳一個Task物件, 可以用Wait()等待, 而Task指定的函式發生Exception時, 會捕捉到</li>
<li>如果不對Task物件做Wait, 而中間發生的Exception會造成程式中止 ( 這個用Console程式無法成功, 主程式沒被中止)</li>
<li>Task<TResult>的結果可用.Result取得該Task回傳的結果</li>
<li>在Task<TResult>取Result有Exception時, 會包裝在AggregateException, 沒處理的話會讓程式中止</li>
</ul>
<h4 id="Entering-the-Thread-Pool-Without-TPL"><a href="#Entering-the-Thread-Pool-Without-TPL" class="headerlink" title="Entering the Thread Pool Without TPL"></a>Entering the Thread Pool Without TPL</h4><ul>
<li>ThreadPool.QueueUserWorkItem 和 asynchronous delegates都是不使用TPL而用Thread pool的方法, 差異在於asynchronous delegates可從thread回傳資料、回傳exception給caller</li>
</ul>
<p><em><strong>QueueUserWorkItem</strong></em></p>
<ul>
<li>像是new Thread一樣, 代入void的function, 也能代入參數, 都包裝在object</li>
<li>如果function有未處理的exception, 將造成程式中止</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class QueueUserWorkItem<br>{<br>    static void Main(string[] args){</p>
<pre><code>    ThreadPool.QueueUserWorkItem(Go);
    ThreadPool.QueueUserWorkItem(Go, 12345);
    Console.Read();
&#125;

static void Go(object data)
&#123;
    Console.WriteLine(&quot;Hello &quot; + data);
&#125;
</code></pre>
<p>}</p>
<p><em><strong>Asynchronous delegates</strong></em></p>
<ul>
<li>能夠回傳值, 基於IAsyncResult</li>
<li>Asynchronous delegate和asynchronous methods不一樣, 有些函式庫也是用BeginXXX&#x2F;EndXXX開頭</li>
<li>使用Asynchronous delegates的流程:</li>
</ul>
<ol>
<li>建立要被委託的函式, 必需指定成Func類別</li>
<li>用Func的BeginInvoke呼叫該函式, 會回傳IAsyncResult</li>
<li>用Func的EndInvoke代入IAsyncResult變數, 將取得結果</li>
</ol>
<p>using System;<br>using System.Threading;</p>
<p>class AsynchronousDelegate<br>{<br>    static void Main(string[] args){<br>        Func&lt;string, int, string&gt; task &#x3D; Go;<br>        IAsyncResult cookie &#x3D; task.BeginInvoke(“test”, 123, null, null);<br>        string result &#x3D; task.EndInvoke(cookie);<br>        Console.WriteLine(“Result is “ + result);<br>        Console.Read();<br>    }</p>
<pre><code>static string Go(string name, int n)
&#123;
    return name + &quot; and &quot; + n.ToString();
&#125;
</code></pre>
<p>}</p>
<ul>
<li>EndInvoke會做3件事:</li>
</ul>
<ol>
<li>如果事情還未完成, 會等它完成</li>
<li>接收回傳值</li>
<li>將Exception拋回至Caller</li>
</ol>
<ul>
<li>技術上來講, 如果函式沒有要回傳值, 可以不呼叫EndInvoke, 但內部造成的Exception要小心. 所以建議都呼叫EndInvoke</li>
<li>另一種用法是把處理運算結果寫在另一個委託函式, 該函式接收IAsyncResult的參數. 而不是在Caller呼叫 EndInvoke</li>
</ul>
<p>using System;<br>using System.Threading;</p>
<p>class AsynchronousDelegate2<br>{<br>    static void Main(string[] args){<br>        Func&lt;string, int, string&gt; task &#x3D; Go;<br>        task.BeginInvoke(“test”, 123, Done, task);<br>        Console.Read();<br>    }</p>
<pre><code>static void Done(IAsyncResult cookie)
&#123;
    var target = (Func&amp;lt;string, int, string&gt;) cookie.AsyncState;
    string result = target.EndInvoke(cookie);
    Console.WriteLine(&quot;Result is &quot; + result);
&#125;

static string Go(string name, int n)
&#123;
    return name + &quot; and &quot; + n.ToString();
&#125;
</code></pre>
<p>}</p>
<h4 id="Optimizing-the-Thread-Pool"><a href="#Optimizing-the-Thread-Pool" class="headerlink" title="Optimizing the Thread Pool"></a>Optimizing the Thread Pool</h4><ul>
<li>ThreadPool.SetMaxThreads可以設置Thread pool最多的Thread數量</li>
<li>每個環境有預設的上限</li>
</ul>
<ol>
<li>Framework 4.0 &amp; 32-bit 可設1023個</li>
<li>Framework 4.0 &amp; 64-bit 可設32768個</li>
<li>Framework 3.5 可設每個核心250個</li>
<li>Framework 2.0 可設每個核心25個</li>
</ol>
<ul>
<li>ThreadPool.SetMinThreads能設置最小的Thread數量, 預設是每個core會有1個</li>
<li>SetMinThreads能優化的狀況是, 因為建立Thread會有延遲, 但如果SetMinThreads指定X個, 這X個Thread不要有延遲.</li>
</ul>
<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3lQcLky">C# 9.0 in a Nutshell: The Definitive Reference, Joseph Albahari (Amazon)</a></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://geekcodeparadise.com/threading-in-csharp-series-book-summary/">Threading in C# 系列的讀書筆記</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/24/refactoring-chapter-3-bad-smells-in-code-book-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/24/refactoring-chapter-3-bad-smells-in-code-book-summary/" class="post-title-link" itemprop="url">Bad Smells in Code</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-24 00:15:00" itemprop="dateCreated datePublished" datetime="2021-10-24T00:15:00+08:00">2021-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="What-are-bad-smells-in-code"><a href="#What-are-bad-smells-in-code" class="headerlink" title="What are bad smells in code?"></a>What are bad smells in code?</h2><p>This article references the chapter 3 of <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. Author had highlighted many “popular” bad smells in code. These code smells can be identified by some characteristics. Let’s browse these code smells!</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/10/stink-4265849_960_720.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/10/stink-4265849_960_720.png" alt="Bad Smells"></a></p>
<p>Bad Smell (Photo source: <a target="_blank" rel="noopener" href="https://pixabay.com/vectors/stink-smell-silhouette-nose-4265849/">https://pixabay.com/vectors/stink-smell-silhouette-nose-4265849/</a> )</p>
<h4 id="1-Mysterious-Name"><a href="#1-Mysterious-Name" class="headerlink" title="1: Mysterious Name"></a>1: Mysterious Name</h4><ul>
<li>Naming is one of the two hard things in programming</li>
<li>Guessing the naming meaning is a wasteful thing</li>
<li>Some skills refactor this problem, for example, <em>Change Function Declaration</em>, <em>Rename Variable</em>  and <em>Rename Field</em></li>
</ul>
<h4 id="2-Duplicated-Code"><a href="#2-Duplicated-Code" class="headerlink" title="2: Duplicated Code"></a>2: Duplicated Code</h4><ul>
<li>If there are similar code appearing in different place, we must seriously check what the difference is. If we want to modify the duplicated code, all similar codes must be modified.</li>
<li>Some skills refactor this problem, for example,  <em>Extract Function</em>,  <em>Slide Statements</em> and  <em>Pull Up Method</em></li>
</ul>
<h4 id="3-Long-Function"><a href="#3-Long-Function" class="headerlink" title="3: Long Function"></a>3: Long Function</h4><ul>
<li>Small functions are good at explanation, sharing and choosing</li>
<li>Modern IDEs have convenient shortcuts to jump to any function</li>
<li>The principle: If there is something should be commented to describe, we need to take it written in a function. Function naming is able to tell us what the way of the function is.</li>
<li>Some skills refactor this problem, for example,  <em>Extract Function</em>,  _Replace Temp with Query, Introduce Parameter Object, Preserve Whole object, _ <em>Replace function with Command, Decompose Conditional, Replace Conditional with Polymorphism</em> and  <em>Split Loop</em></li>
</ul>
<h4 id="4-Long-Parameter-List"><a href="#4-Long-Parameter-List" class="headerlink" title="4: Long Parameter List"></a>4: Long Parameter List</h4><ul>
<li>Long parameter list confuses developers…</li>
<li>Some skills refactor this problem, for example,  <em>Replace Temp with Query, Preserve Whole Object, Introduce Parameter Object, Remove Flag Argument</em> and <em>Combine Functions into Class</em></li>
</ul>
<h4 id="5-Global-Data"><a href="#5-Global-Data" class="headerlink" title="5: Global Data"></a>5: Global Data</h4><ul>
<li>It’s the one of the unpleasant code smells</li>
<li>Every code can access it so debugging is very hard</li>
<li>Some skills refactor this problem, for example, <em>Encapsulate Variable</em></li>
</ul>
<h4 id="6-Mutable-Data"><a href="#6-Mutable-Data" class="headerlink" title="6: Mutable Data"></a>6: Mutable Data</h4><ul>
<li>If some data is modified and the other date somewhere is unexpected, the system fails</li>
<li>Immutable data restricts the update of the data and reduces the previous risks</li>
<li>Some skills refactor this problem, for example,  <em>Encapsulate Variable, Split Variable, Slide Statements, Extract Function, Separate Query from Modifier, Remove Setting Method,</em> <em>Replace Derived Variable with Query, Combine Functions into Class, Combine Functions into Transform</em> and <em>Change Reference to Value</em></li>
</ul>
<h4 id="7-Divergent-Change"><a href="#7-Divergent-Change" class="headerlink" title="7: Divergent Change"></a>7: Divergent Change</h4><ul>
<li>If some module’s modification can not focused on on point, the divergent change happens</li>
<li>For example, for a class, if a new data source is added, we must modify 3 functions; another new data source is added, we must modify 4 functions. This is the divergent change.</li>
<li>Only focus on one context to avoid divergent change. It looks like SoC (Separation of Concern)</li>
<li>Some skills refactor this problem, for example,  <em>Split Phase, Move Function</em> <em>, Extract Function</em> and  <em>Extract Class</em></li>
</ul>
<h4 id="8-Shotgun-Surgery"><a href="#8-Shotgun-Surgery" class="headerlink" title="8: Shotgun Surgery"></a>8: Shotgun Surgery</h4><ul>
<li>I very like this naming…. It’s impressive!</li>
<li>If something changes, we must modify many different classes</li>
<li>Some skills refactor this problem, for example, _ Move Function_ <em>, Move Field, Combine Functions into Class, Combine Functions into Transform, Split Phase, Inline Function</em> and  <em>Inline Class</em></li>
</ul>
<h4 id="9-Feature-Envy"><a href="#9-Feature-Envy" class="headerlink" title="9: Feature Envy"></a>9: Feature Envy</h4><ul>
<li>Some function frequently interacts with other module’s function or data, it’s feature envy.</li>
<li>There are some skills refactor this problem, for example, _ Move Function_ and  <em>Extract Function</em></li>
<li>Some patterns break this rule, like Strategy, Visitor and Kent Beck’s Self Delegation. They are used to solve divergent change.</li>
</ul>
<h4 id="10-Data-Clumps"><a href="#10-Data-Clumps" class="headerlink" title="10: Data Clumps"></a>10: Data Clumps</h4><ul>
<li>For example, 2 classes have the same fields or many functions have the same parameter</li>
<li>Some skills refactor this problem, for example, <em>Extract Class, Introduce Parameter Object</em> and  <em>Preserve Whole Object</em></li>
<li>Advanced action is to find feature envy and solve it</li>
</ul>
<h4 id="11-Primitive-Obsession"><a href="#11-Primitive-Obsession" class="headerlink" title="11: Primitive Obsession"></a>11: Primitive Obsession</h4><ul>
<li>Some types are not organized as classes, like money, coordinates, or ranges. Only use basic data type (int, float, string…) to represent them.</li>
<li>For example, phone number is not only a string, it should be encapsulated as a class and provides a display logic for GUI.</li>
<li>Only using a string to represent a type is called “stringly typed”</li>
<li>Some skills refactor this problem, for example, _ Replace Primitive with Object_ <em>, Replace Type Code with Subclasses, Replace Conditional with Polymorphism, Extract Class</em> and  <em>Introduce Parameter Object</em></li>
</ul>
<h4 id="12-Repeated-Switches"><a href="#12-Repeated-Switches" class="headerlink" title="12: Repeated Switches"></a>12: Repeated Switches</h4><ul>
<li>Somewhere code uses the same switch logic, including either switch&#x2F;case statements or if&#x2F;else statements. If we want to add a new clause, we must find all switches and update them.</li>
<li>Some skills refactor this problem, for example, <em>Replace Conditional with Polymorphism</em></li>
</ul>
<h4 id="13-Loops"><a href="#13-Loops" class="headerlink" title="13: Loops"></a>13: Loops</h4><ul>
<li>Omg….The author think of “Loop” as old-school thing….</li>
<li>Some skills refactor this problem, for example, <em>Replace Loop with Pipeline</em></li>
<li>Pipeline like map&#x2F;filter can help us understand what elements are processed</li>
</ul>
<h4 id="14-Lazy-Elements"><a href="#14-Lazy-Elements" class="headerlink" title="14. Lazy Elements"></a>14. Lazy Elements</h4><ul>
<li>Some functions or classes are unnecessarily wrapped. For example, a class is just a function.</li>
<li>Some skills refactor this problem, for example, <em>Inline Function, Inline Class</em> and  <em>Collapse Hierarchy</em></li>
</ul>
<h4 id="15-Speculative-Generality"><a href="#15-Speculative-Generality" class="headerlink" title="15. Speculative Generality"></a>15. Speculative Generality</h4><ul>
<li>Some logic is designed only for specific machinery instead of all machinery, then this logic is speculative generality.</li>
<li>Some skills refactor this problem, for example, <em>Collapse Hierarchy, Inline Function, Inline Class, Change Function Declaration</em> and  <em>Remove Dead Code</em></li>
</ul>
<h4 id="16-Temporary-Field"><a href="#16-Temporary-Field" class="headerlink" title="16. Temporary Field"></a>16. Temporary Field</h4><ul>
<li>A field of a class is only used in some situations. Other developers look at this field and guess what scope is.</li>
<li>Some skills refactor this problem, for example, <em>Extract Class, Move Function</em> and <em>Introduce Special Case</em></li>
</ul>
<h4 id="17-Message-Chains"><a href="#17-Message-Chains" class="headerlink" title="17. Message Chains"></a>17. Message Chains</h4><ul>
<li>A client calls one object A, then object A calls object B, then object B calls object C, and so on. If the relationship of the called objects changes, the client should correspondingly modify.</li>
<li>Some skills refactor this problem, for example, <em>Hide Delegate, Extract Function and Move Function</em></li>
</ul>
<h4 id="18-Middle-Man"><a href="#18-Middle-Man" class="headerlink" title="18. Middle Man"></a>18. Middle Man</h4><ul>
<li>If the half functions of a class are delegated to other classes, these delegations are overused.</li>
<li>Some skills refactor this problem, for example, <em>Remove Middle Man, Inline Function, Replace Superclass with Delegate</em> and <em>Replace Subclass with Delegate.</em></li>
</ul>
<h4 id="19-Insider-Trading"><a href="#19-Insider-Trading" class="headerlink" title="19. Insider Trading"></a>19. Insider Trading</h4><ul>
<li>A large amount of data exchange occurs between modules.</li>
<li>Some skills refactor this problem, for example, <em>Move Function, Move Field, Hide Delegate, Replace Subclass with Delegate</em> and <em>Replace Superclass with Delegate</em></li>
</ul>
<h4 id="20-Large-Class"><a href="#20-Large-Class" class="headerlink" title="20. Large Class"></a>20. Large Class</h4><ul>
<li>A class has many abilities so that it many fields. Repeated code follows up.</li>
<li>Some skills refactor this problem, for example, <em>Extract Class, Extract Superclass</em> and <em>Replace Type Code with Subclass</em></li>
</ul>
<h4 id="21-Alternative-Classes-with-Different-Interfaces"><a href="#21-Alternative-Classes-with-Different-Interfaces" class="headerlink" title="21. Alternative Classes with Different Interfaces"></a>21. Alternative Classes with Different Interfaces</h4><ul>
<li>A class is replaced with other class when they have the same interface</li>
<li>Some skills refactor this problem, for example, <em>Change Function Declaration, Move Function</em> and <em>Extract Superclass</em></li>
</ul>
<h4 id="22-Data-Class"><a href="#22-Data-Class" class="headerlink" title="22. Data Class"></a>22. Data Class</h4><ul>
<li>A data class only puts get&#x2F;set fields without behavior. Some client’s behavior should be put in this data class.</li>
<li>Some skills refactor this problem, for example, <em>Encapsulate Record, Remove Setting Method, Move Function, Extract Function</em> and <em>Split Phase</em></li>
</ul>
<h4 id="23-Refused-Bequest"><a href="#23-Refused-Bequest" class="headerlink" title="23. Refused Bequest"></a>23. Refused Bequest</h4><ul>
<li>A subclass has inherited superclass’s functions and data. If this subclass doesn’t want them, it only chooses some from them.</li>
<li>Some skills refactor this problem, for example, <em>Push Down Method, Push Down Field, Replace Subclass with Delegate</em> and <em>Replace Superclass with Delegate</em></li>
</ul>
<h4 id="24-Comments"><a href="#24-Comments" class="headerlink" title="24. Comments"></a>24. Comments</h4><ul>
<li>Some comments explain what the terrible code work for. If this code is refactored, the comments are redundant.</li>
<li>Some skills refactor this problem, for example, <em>Extract Function, Change Function Declaration</em> and <em>Introduce Assertion</em></li>
</ul>
<p>The tip at book’s page 84 describes:</p>
<blockquote>
<p>When you feel the need to write a comment, first try to refactor the code so that any comment becomes superfluous.</p>
</blockquote>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[Refactoring: Improving the Design of Existing Code (2nd Edition)](Improving the Design of Existing Code (2nd Edition))</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/17/refactoring-chapter-2-principles-in-refactoring-book-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/17/refactoring-chapter-2-principles-in-refactoring-book-summary/" class="post-title-link" itemprop="url">Principles in Refactoring</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-17 00:58:00" itemprop="dateCreated datePublished" datetime="2021-10-17T00:58:00+08:00">2021-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-25 14:16:12" itemprop="dateModified" datetime="2023-11-25T14:16:12+08:00">2023-11-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="What-are-principles-in-refactoring"><a href="#What-are-principles-in-refactoring" class="headerlink" title="What are principles in refactoring?"></a>What are principles in refactoring?</h1><p>This article references the chapter 2 of  <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. We need understand what principles are in refactoring and we can refactor codes smoothly.</p>
<h1 id="Defining-Refactoring"><a href="#Defining-Refactoring" class="headerlink" title="Defining Refactoring"></a>Defining Refactoring</h1><ul>
<li>Noun’s definition: A change made to the internal structure of software to make it easier to understand and cheaper to modify without changing its observable behavior.</li>
<li>Verb’s definition: To restructure software by applying a series of refactorings without changing its observable behavior.</li>
</ul>
<p>Both definitions have the same objective: don’t change the software’s behavior.</p>
<p>Like electrical wiring for our life, we plug electrical appliances and the electric current moves through the wiring. The plug-in is like an API. Electrical appliances get the electric current with this API and don’t understand what plug-in electrical panel works. If API’s internal code structure is like:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/10/before.jpg"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/10/before-300x277.jpg" alt="before refactoring"></a></p>
<p>Electrical Panel before re-wiring (Source: <a target="_blank" rel="noopener" href="https://theintegrityexperience.com/rewiring-a-house-and-electrical-panel-upgrade/">https://theintegrityexperience.com/rewiring-a-house-and-electrical-panel-upgrade/</a>)</p>
<p>It’s ugly but it still works to supply electric current. Someday, the power failure occurs and we should check the electrical panel then open it, OS: “What the hell” and very hard to find the broken wires…..</p>
<p>After refactorings(re-wiring), the new electrical panel is like:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/10/after.jpg"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/10/after-300x278.jpg" alt="after refactoring"></a></p>
<p>Electrical Panel after re-wiring (Source: <a target="_blank" rel="noopener" href="https://theintegrityexperience.com/rewiring-a-house-and-electrical-panel-upgrade/">https://theintegrityexperience.com/rewiring-a-house-and-electrical-panel-upgrade/</a>)</p>
<p>What a beautiful wiring! It supplies electric current like the last ugly wiring but next time we will find correct wires quickly. This analogy to our coding refactorings is very similar.</p>
<p>The tip at book’s page 46 describes:</p>
<blockquote>
<p>If someone says their code was broken for a couple of days while they are refactoring, you can be pretty sure they were not refactoring.</p>
</blockquote>
<p>This tip is very funny XD. According to chapter 1’s tip, refactoring is driven by testings. Every refactoring step is done, then run the testings to validate the observable behavior is not changed.</p>
<h1 id="The-Two-Hats"><a href="#The-Two-Hats" class="headerlink" title="The Two Hats"></a>The Two Hats</h1><p>When we are developing the software, we have 2 hats: one hat for adding functionality and the other one for refactoring. Only wear one of these 2 hats in a period of developing. Do not add functionality and refactor concurrently.</p>
<h1 id="Why-Should-We-Refactor"><a href="#Why-Should-We-Refactor" class="headerlink" title="Why Should We Refactor?"></a>Why Should We Refactor?</h1><h2 id="Refactoring-Improves-the-Design-of-Software"><a href="#Refactoring-Improves-the-Design-of-Software" class="headerlink" title="Refactoring Improves the Design of Software"></a>Refactoring Improves the Design of Software</h2><ul>
<li>If we don’t refactor, the code becomes more messy</li>
<li>Messy code means maintenance is more difficult.</li>
<li>DRY (Don’t Repeat Yourself) is a fundamental design principle and reduces the code size</li>
</ul>
<h2 id="Refactoring-Makes-Software-Easier-to-Understand"><a href="#Refactoring-Makes-Software-Easier-to-Understand" class="headerlink" title="Refactoring Makes Software Easier to Understand"></a>Refactoring Makes Software Easier to Understand</h2><ul>
<li>Programmer is the reader of the code and it’s the major time cost</li>
<li>If the reader spends 1 week understanding the code and modifying it —- What a terrible code</li>
<li>If the reader spends 1 hour understanding the code  and modifying it —- What a great code</li>
<li>We spend a little time refactoring our code and make the code more readable. Next time the reader will spend less time working.</li>
<li>If the code function is easily looked up by documentation, programmers don’t deliberately remember them.</li>
</ul>
<h2 id="Refactoring-Helps-Me-Find-Bugs"><a href="#Refactoring-Helps-Me-Find-Bugs" class="headerlink" title="Refactoring Helps Me Find Bugs"></a>Refactoring Helps Me Find Bugs</h2><ul>
<li>When we are refactoring the code, code structure maybe shows some bugs we have never noticed</li>
</ul>
<h2 id="Refactoring-Helps-Me-Program-Faster"><a href="#Refactoring-Helps-Me-Program-Faster" class="headerlink" title="Refactoring Helps Me Program Faster"></a>Refactoring Helps Me Program Faster</h2><ul>
<li>The previous points result in this point</li>
<li>Does not the time of refactoring slow the development? No! If the system with poor design, it would add features like putting many “patches” on it…. It’s hard to understand what a module works.</li>
<li>Design Stamina Hypothesis: Good designs increase the stamina of the software effort</li>
<li>Refactoring makes the design better than the last</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/10/cumulativeTimeWithGoodPoorDesign.drawio.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/10/cumulativeTimeWithGoodPoorDesign.drawio-300x209.png"></a></p>
<p>The development time with good and poor design (Redraw at book’s page 49)</p>
<h1 id="When-Should-We-Refactor"><a href="#When-Should-We-Refactor" class="headerlink" title="When Should We Refactor?"></a>When Should We Refactor?</h1><h2 id="The-Rule-of-Three"><a href="#The-Rule-of-Three" class="headerlink" title="The Rule of Three"></a>The Rule of Three</h2><p>The first time you do something, you just do it. The second time you do something similar, you wince at the duplication, but you do the duplicate thing anyway. The third time you do something similar, you refactor. Or for those who like baseball: <strong>Three strikes, then you refactor.</strong></p>
<h2 id="Preparatory-Refactoring-Making-It-Easier-to-Add-a-feature"><a href="#Preparatory-Refactoring-Making-It-Easier-to-Add-a-feature" class="headerlink" title="Preparatory Refactoring - Making It Easier to Add a feature"></a>Preparatory Refactoring - Making It Easier to Add a feature</h2><ul>
<li><em>Parameterize Function</em> skill reduces the duplicated code. Similar codes are centered.</li>
<li>Like before I move to a place, I check the map and find a short route to arrive at the place.</li>
</ul>
<h2 id="Comprehension-Refactoring-Making-Code-Easier-to-Understand"><a href="#Comprehension-Refactoring-Making-Code-Easier-to-Understand" class="headerlink" title="Comprehension Refactoring: Making Code Easier to Understand"></a>Comprehension Refactoring: Making Code Easier to Understand</h2><ul>
<li>Read codes to understand “What is the section of the code doing?”. Spending much time reading  code is a refactoring chance.</li>
<li>Refactoring makes the code logics clearer</li>
</ul>
<h2 id="Litter-Pickup-Refactoring"><a href="#Litter-Pickup-Refactoring" class="headerlink" title="Litter-Pickup Refactoring"></a>Litter-Pickup Refactoring</h2><ul>
<li>If there is a small trash code (duplicated codes, terrible variable naming…), immediately refactor it</li>
<li>If the trash code is not easy to be refactored with current task, note the trash code, put it aside and continue current task. After finish the task, then refactor the noted trash code.</li>
</ul>
<h2 id="4-4-Planned-and-Opportunistic-Refactoring"><a href="#4-4-Planned-and-Opportunistic-Refactoring" class="headerlink" title="4.4 Planned and Opportunistic Refactoring"></a>4.4 Planned and Opportunistic Refactoring</h2><ul>
<li>Previous 3 refactoring examples are opportunistic. Planned refactoring is not a natural thing. Adding features or fixing bugs are normal with refactoring.</li>
</ul>
<p>The tip at book’s page 52 describes:</p>
<blockquote>
<p>You have to refactor when you run into ugly code - bug excellent code needs plenty of refactoring too.</p>
</blockquote>
<p>Kent Beck also described:</p>
<blockquote>
<p>For each desired change, make the change easy (warning: this may be hard), then make the easy change.</p>
</blockquote>
<p>The two sections are excellent points.</p>
<ul>
<li>Author thinks that creating a new branch to refactor codes in control version system is not good because refactoring is closed with adding new features.</li>
</ul>
<h5 id="4-5-Long-Term-Refactoring"><a href="#4-5-Long-Term-Refactoring" class="headerlink" title="4.5 Long-Term Refactoring"></a>4.5 Long-Term Refactoring</h5><ul>
<li>Like previous Planned Refactoring, it’s not recommend by author.</li>
<li>Example: If the system wants to replace a existing library, use <em>Branch By Abstraction</em> to make the replacement easy</li>
</ul>
<h5 id="4-6-Refactoring-in-a-Code-Review"><a href="#4-6-Refactoring-in-a-Code-Review" class="headerlink" title="4.6 Refactoring in a Code Review"></a>4.6 Refactoring in a Code Review</h5><ul>
<li>Better practice: Pair-programming and refactoring&#x2F;reviewing the code</li>
</ul>
<h5 id="4-7-What-Do-I-Tell-My-Manager"><a href="#4-7-What-Do-I-Tell-My-Manager" class="headerlink" title="4.7 What Do I Tell My Manager?"></a>4.7 What Do I Tell My Manager?</h5><ul>
<li>If the manager doesn’t know what the refactoring is, don’t tell him&#x2F;her why you do refactoring. Manger just wants the task to be finished before the deadline. We just use refactoring this professional skill to smoothly complete the job.</li>
</ul>
<h5 id="4-8-When-Should-I-Not-Refactor"><a href="#4-8-When-Should-I-Not-Refactor" class="headerlink" title="4.8 When Should I Not Refactor?"></a>4.8 When Should I Not Refactor?</h5><ul>
<li>If there is a messy code and it’s not required to be modified, don’t refactor with it.</li>
<li>If some ugly code is hidden under an API, don’t refactor.</li>
<li>Sometimes rewriting is easier than refactoring but it’s hard to decide which method should be executed.</li>
</ul>
<h4 id="5-Problems-with-Refactoring"><a href="#5-Problems-with-Refactoring" class="headerlink" title="5. Problems with Refactoring"></a>5. Problems with Refactoring</h4><h5 id="5-1-Slowing-Down-New-Features"><a href="#5-1-Slowing-Down-New-Features" class="headerlink" title="5.1 Slowing Down New Features"></a>5.1 Slowing Down New Features</h5><p>The tip at book’s page 56 describes:</p>
<blockquote>
<p>The whole purpose of refactoring is to make us program faster, producing more value with less effort.</p>
</blockquote>
<ul>
<li>If there are a large-scale refactoring situation and small-scale urgent new feature, finish the urgent new feature and then back to the refactoring.</li>
<li>Refactoring’s target doesn’t equal to the one of  “Clean Code” and “Good Engineering Practice”. Refactoring focuses on adding features quickly, fixing bugs quickly.</li>
</ul>
<h5 id="5-2-Code-Ownership"><a href="#5-2-Code-Ownership" class="headerlink" title="5.2 Code Ownership"></a>5.2 Code Ownership</h5><ul>
<li>Example: A naming is not good and we use <em>Change Function Declaration</em> skill to rename it. But the renamed function is used by other teams &#x2F; product API caller, it will result in blocked situation.</li>
<li>Use <em>Rename Function</em> skill and the old function is pass-through to the new one. Mark the old function as [deprecated].</li>
<li>Team ownership of code is recommended by author, not only restricted to one person.</li>
</ul>
<h5 id="5-3-Branches"><a href="#5-3-Branches" class="headerlink" title="5.3 Branches"></a>5.3 Branches</h5><ul>
<li>Every branch is responsible for specific features, after a period, those branches will be merged into master&#x2F;trunk. But if the feature branch is isolated for a long time, the integration with master will be hard.</li>
<li>Refactoring like renaming for merging branch sometimes is a difficult integration</li>
<li>Continuous Integration (CI) &#x2F; Trunk-Based Development: Use this practice to require every member to merge branch into master and integrate. This action avoid the large difference between branches.</li>
<li>Refactoring very fits CI practice. Small changes are easily integrated when using CI.</li>
<li>Kent Beck’s Extreme programming uses CI and refactoring</li>
</ul>
<h5 id="5-4-Testing"><a href="#5-4-Testing" class="headerlink" title="5.4 Testing"></a>5.4 Testing</h5><ul>
<li>If we want refactoring, self-testing code is required. This is a very important one of principles in refactoring!</li>
<li>If no testing can support, we can use automated refactoring. But it only executes safe refactoring methods.</li>
<li>Special style of refactoring: only use proved and absolutely safe refactoring methods. Like an example that shows how to safely execute <em>Extract Method</em> skill in C++ provided by Jay Bazuzi.</li>
<li>I very recommend that every programmer should read this book to learn unit testing: <a target="_blank" rel="noopener" href="http://bit.ly/3lIj2il">The Art of Unit Testing: with examples in C# written by Roy Osherove</a></li>
</ul>
<h5 id="5-5-Legacy-Code"><a href="#5-5-Legacy-Code" class="headerlink" title="5.5 Legacy Code"></a>5.5 Legacy Code</h5><ul>
<li>Legacy code without testings is very terrible…</li>
<li>Adding new testings in current legacy code is not easy</li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3LSs0o2">Working Effectively with Legacy Code by Michael Feathers</a> is recommended by author. It teaches how to perform refactoring and testings in legacy code</li>
<li>Step-by-step refactor legacy code instead of changing it widely. I think this is the hardest one of principles in refactoring.</li>
</ul>
<h5 id="5-6-Databases"><a href="#5-6-Databases" class="headerlink" title="5.6 Databases"></a>5.6 Databases</h5><ul>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3ZibiRK">Refactoring Databases: Evolutionary Database Design by Scott Ambler &amp; Pramod Sadalage</a>  is recommended by author.</li>
<li>Add migration scripts into version control system with code. This makes the database development efficient</li>
<li>Example with .NET, Entity Framework has a migration tool to upgrade&#x2F;downgrade database’s structure.</li>
<li>The book provides a refactoring skill: parallel change. I think I should buy this book to deeply learn it!</li>
</ul>
<h4 id="6-Refactoring-Architecture-and-Yagni"><a href="#6-Refactoring-Architecture-and-Yagni" class="headerlink" title="6. Refactoring, Architecture, and Yagni"></a>6. Refactoring, Architecture, and Yagni</h4><ul>
<li>In early period, architecture was first designed. So the later development was restricted with the architecture and the system continued to become decayed.</li>
<li>Refactoring is the iterative method to improve current design</li>
<li>you aren’t going to need it : Yagni mixes architecture, design and development and depends on refactoring</li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/42E812e">Building Evolutionary Architectures： Support Constant Change by Neal Ford, Rebecca Parsons, Patrick Kua</a> is a continuously developing subject and discover what pattern and practice are useful for iterative developement.</li>
</ul>
<h4 id="7-Refactoring-and-the-Wider-Software-Development-Process"><a href="#7-Refactoring-and-the-Wider-Software-Development-Process" class="headerlink" title="7. Refactoring and the Wider Software Development Process"></a>7. Refactoring and the Wider Software Development Process</h4><ul>
<li>Self-testing is the first foundation of refactoring</li>
<li>Self-testing, CI and refactoring are the 3 major practices for a refactoring team</li>
<li>Based on these 3 practices, some products can be published in one day</li>
<li>These practices are not easy to build up</li>
</ul>
<h4 id="8-Refactoring-and-Performance"><a href="#8-Refactoring-and-Performance" class="headerlink" title="8. Refactoring and Performance"></a>8. Refactoring and Performance</h4><ul>
<li>3 methods to write fast software</li>
</ul>
<ol>
<li>Time budgeting: It’s a serious method for real time system like heart pacemakers. Every module is restricted with limited resources.      </li>
<li>Constant attention: Every programmer keeps the system with high performance anytime.</li>
<li>Use the optimization statistic analysis to improve the system</li>
</ol>
<h4 id="9-Where-Did-Refactoring-Come-From"><a href="#9-Where-Did-Refactoring-Come-From" class="headerlink" title="9. Where Did Refactoring Come From?"></a>9. Where Did Refactoring Come From?</h4><ul>
<li>In 1980, Smalltalk project with refactoring skills influenced the development community</li>
<li>First one wrote the refactoring book is Martin Fowler</li>
</ul>
<h4 id="10-Automated-Refactorings"><a href="#10-Automated-Refactorings" class="headerlink" title="10. Automated Refactorings"></a>10. Automated Refactorings</h4><ul>
<li>IntelliJ IDEA provides many automated refactoring tools for popular programming language.</li>
<li>IDE analyzes the syntax tree of the code and provides safer refactoring results</li>
</ul>
<h4 id="11-Going-Further"><a href="#11-Going-Further" class="headerlink" title="11. Going Further"></a>11. Going Further</h4><ul>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3TLvrhV">Refactoring Workbook by Ross Venables, William Wake, John Fuller</a></li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3FNMrhJ">Refactoring to Patterns by Joshua Kerievsky</a> </li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/40fYOM0">Refactoring HTML: Improving the Design of Existing Web Applications by Elliotte Rusty Harold</a></li>
<li><a target="_blank" rel="noopener" href="https://amzn.to/3lLkwZi">Refactoring: Ruby Edition by Jay Fields, Shane Harvie, Martin Fowler, Kent Beck</a></li>
<li><a target="_blank" rel="noopener" href="http://refactoring.com/">refactoring.com</a></li>
<li>I think these great authors of the books have the similar principles in refactoring</li>
</ul>
<h4 id="12-Conclusion"><a href="#12-Conclusion" class="headerlink" title="12. Conclusion"></a>12. Conclusion</h4><p>All above principles in refactoring is impressive guideline for every programmers when they want to refactor their handy codes. Do you have special principles in refactoring? Comment them!</p>
<h4 id="13-References"><a href="#13-References" class="headerlink" title="13. References"></a>13. References</h4><p><a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/08/poeaa-data-source-architectural-pattern-data-mapper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/08/poeaa-data-source-architectural-pattern-data-mapper/" class="post-title-link" itemprop="url">Data Mapper Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-07-08 00:02:00" itemprop="dateCreated datePublished" datetime="2021-07-08T00:02:00+08:00">2021-07-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Data-Mapper"><a href="#1-What-is-Data-Mapper" class="headerlink" title="1. What is Data Mapper"></a>1. What is Data Mapper</h3><p>According to [PoEAA], this definition is “A layer of Mappers that moves data between objects and a database while keeping them independent of each other and the mapper itself.”</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-5.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-3.png"></a></p>
<p>Figure 1. Data Mapper (From <a target="_blank" rel="noopener" href="https://martinfowler.com/eaaCatalog/index.html">PoEAA Page</a>)</p>
<h4 id="1-1-How-it-works"><a href="#1-1-How-it-works" class="headerlink" title="1.1 How it works"></a>1.1 How it works</h4><p><strong>Separating Domain from Data Source is the main ability.</strong> Figure 2 shows that a client uses a person mapper’s Find function to get a person instance from database. This mapper uses an <strong>Identity Map</strong> to check if the person instance is loaded or not. If it’s not loaded, then loads it to the map.   Figure 3 shows that a client uses mapper’s Update function and mapper reads the data from person instance to write data into database.  </p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/ReadData-2.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/ReadData-1.png" alt="Retrieving data from database data mapper"></a></p>
<p>Figure 2. Retrieving data from database</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/Update-2.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/Update-1.png" alt="Updating Data data mapper"></a></p>
<p>Figure 3. Updating Data</p>
<p>For finding function, there are 3 topics to discuss:</p>
<h5 id="1-1-1-Handling-Finders"><a href="#1-1-1-Handling-Finders" class="headerlink" title="1.1.1 Handling Finders"></a>1.1.1 Handling Finders</h5><p>Usually presentation layer uses mapper’s finding function to load objects from database. But sometimes domain layer needs to use mapper’s finding function. This situation can be avoided by using Lazy Load pattern.   Separating finding interfaces to domain namespace(package) for mapper’s implementation is a decoupling method.</p>
<h5 id="1-1-2-Mapping-Data-to-Domain-Fields"><a href="#1-1-2-Mapping-Data-to-Domain-Fields" class="headerlink" title="1.1.2 Mapping Data to Domain Fields"></a>1.1.2 Mapping Data to Domain Fields</h5><p>Mapper creating a rich constructor to create a domain object is a recommend method. Avoid directly setting fields&#x2F;properties of domain object. If two objects are referenced each other when mapper creates them by rich constructor, using Lazy Load is a method to solve it.  </p>
<h5 id="1-1-3-Metadata-Based-Mappings"><a href="#1-1-3-Metadata-Based-Mappings" class="headerlink" title="1.1.3 Metadata-Based Mappings"></a>1.1.3 Metadata-Based Mappings</h5><p>Metadata-Mapping pattern is a method that transfers domain object’s fields into database’s records. The metadata is saved in a class or a independent file. Using it can have no more source code&#x2F;code generation&#x2F;reflection programs.</p>
<h4 id="1-2-When-to-use-it"><a href="#1-2-When-to-use-it" class="headerlink" title="1.2 When to use it"></a>1.2 When to use it</h4><ol>
<li>Domain Model don’t understand database existence. Modifying domain objects or mappers is more efficient.</li>
<li>For more complex business logic.</li>
<li>If Domain Model is not used, Data Mapper is not required.</li>
</ol>
<h3 id="2-Pattern-Practice-The-Person-Management"><a href="#2-Pattern-Practice-The-Person-Management" class="headerlink" title="2. Pattern Practice: The Person Management"></a>2. Pattern Practice: The Person Management</h3><p>This problem is introduced in the previous article <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/">[PoEAA] Data Source Architectural Pattern - Table Data Gateway</a>. This article uses Data Mapper to build the data source architectural layer.</p>
<h4 id="2-1-Implementation-by-C-SQLite"><a href="#2-1-Implementation-by-C-SQLite" class="headerlink" title="2.1 Implementation by C# &amp; SQLite"></a>2.1 Implementation by C# &amp; SQLite</h4><p>This pattern is implemented by C# based on the content of <strong>Chapter 10 Data Source Architectural Patterns - Data Mapper</strong> of PoEAA. The database is SQLite.</p>
<p>By Martin’s implementation, it doesn’t contain a Delete function in a data mapper. So this article also has no Delete function.</p>
<h5 id="2-1-1-Domain-Mapper-layers"><a href="#2-1-1-Domain-Mapper-layers" class="headerlink" title="2.1.1 Domain&#x2F;Mapper layers"></a>2.1.1 Domain&#x2F;Mapper layers</h5><p>Create Domain and Mapper these 2 layers to separate responsibilities. Figure 4 shows:  </p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/Architecture-2.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/Architecture-1.png" alt="Domain/Mapper layers data mapper"></a></p>
<p>Figure 4. Domain&#x2F;Mapper layers</p>
<p>Following sections explain what they work for.</p>
<h5 id="2-1-2-AbstractMapper-PersonMapper-classes"><a href="#2-1-2-AbstractMapper-PersonMapper-classes" class="headerlink" title="2.1.2 AbstractMapper&#x2F;PersonMapper classes"></a>2.1.2 AbstractMapper&#x2F;PersonMapper classes</h5><p>AbstractMapper class has common behaviors for concrete child Mapper classes. AbstractMapper has a <strong>Identity Map</strong>: Dictionary&lt;int, DomainObject&gt; LoadedMap. When loading is processing, mapper uses this map to check whether this domain object has been loaded or not. If not, then mapper loads it from database.   AbstractMapper’s DoLoad&#x2F;DoInsert are abstract methods. They are override by concrete child Mapper classes. PersonMapper implements these abstract methods and access Person domain objects from database.   For Update function, this is implemented by concrete Mapper instead of abstract method.   PersonMapper has implemented IPersonFinder interface. This interface is defined in Domain layer for responsibility.  </p>
<p>public abstract class AbstractMapper<br>{<br>protected Dictionary&lt;int, DomainObject&gt; LoadedMap &#x3D; new Dictionary&lt;int, DomainObject&gt;();<br>protected abstract string FindStatement();<br>protected abstract string InsertStatement();</p>
<p>protected abstract int FindNextDatabaseId();</p>
<p>protected DomainObject AbstractFind(int id)<br>{<br>bool findResult &#x3D; LoadedMap.TryGetValue(id, out DomainObject result);<br>if (findResult)<br>{<br>return result;<br>}</p>
<p>try<br>{<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(FindStatement(), conn);<br>comm.Parameters.Add(new SQLiteParameter(“$id”, id));<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>reader.Read();<br>result &#x3D; Load(reader);<br>return result;<br>}<br>catch (Exception ex)<br>{<br>throw new ApplicationException(ex.Message);<br>}<br>}</p>
<p>protected DomainObject Load(IDataReader reader)<br>{<br>object[] resultSet &#x3D; new object[reader.FieldCount];<br>reader.GetValues(resultSet);</p>
<p>int id &#x3D; (int)resultSet[0];<br>if (LoadedMap.ContainsKey(id))<br>{<br>return LoadedMap[id];<br>}</p>
<p>DomainObject result &#x3D; DoLoad(id, reader);<br>LoadedMap.Add(id, result);<br>return result;<br>}</p>
<p>protected List&lt;DomainObject&gt; LoadAll(IDataReader reader)<br>{<br>List&lt;DomainObject&gt; result &#x3D; new List&lt;DomainObject&gt;();<br>while (reader.Read())<br>{<br>result.Add(Load(reader));<br>}</p>
<p>return result;<br>}</p>
<p>protected abstract DomainObject DoLoad(int id, IDataReader reader);</p>
<p>public int Insert(DomainObject subject)<br>{<br>try<br>{<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(InsertStatement(), conn);<br>subject.Id &#x3D; FindNextDatabaseId();<br>var parameter &#x3D; comm.CreateParameter();<br>parameter.DbType &#x3D; DbType.Int32;<br>parameter.Value &#x3D; subject.Id;<br>comm.Parameters.Add(parameter);<br>DoInsert(subject, comm);<br>comm.ExecuteNonQuery();<br>LoadedMap.Add(subject.Id, subject);<br>return subject.Id;<br>}<br>catch (Exception ex)<br>{<br>throw new ApplicationException(ex.Message);<br>}</p>
<p>}</p>
<p>protected abstract void DoInsert(DomainObject subject, IDbCommand insertStatement);</p>
<p>public List&lt;DomainObject&gt; FindMany(IStatementSource source)<br>{<br>try<br>{<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(source.Sql, conn);<br>foreach (var p in source.Parameters)<br>{<br>var parameter &#x3D; comm.CreateParameter();<br>parameter.DbType &#x3D; DbType.Object;<br>parameter.Value &#x3D; p;<br>comm.Parameters.Add(parameter);<br>}<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>return LoadAll(reader);<br>}<br>catch (Exception ex)<br>{<br>throw new ApplicationException(ex.Message);<br>}<br>}</p>
<p>}</p>
<p>public class PersonMapper : AbstractMapper, IPersonFinder<br>{<br>private const string Columns &#x3D; “ id, lastname, firstname, numberOfDependents “;</p>
<p>private const string UpdateStatementString &#x3D;<br>“UPDATE person SET lastname &#x3D; ?, firstname &#x3D; ?, numberOfDependents &#x3D; ? WHERE id &#x3D; ?”;<br>protected override string FindStatement()<br>{<br>return “SELECT “ + Columns + “ FROM person WHERE id &#x3D; $id”;<br>}</p>
<p>protected override string InsertStatement()<br>{<br>return “INSERT INTO person VALUES (?, ?, ?, ?)”;<br>}</p>
<p>protected override int FindNextDatabaseId()<br>{<br>string sql &#x3D; “SELECT max(id) as curId from person”;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>bool hasResult &#x3D; reader.Read();<br>if (hasResult)<br>{<br>return ((int)((long)reader[“curId”] + 1));<br>}<br>else<br>{<br>return 1;<br>}<br>}</p>
<p>protected override DomainObject DoLoad(int id, IDataReader reader)<br>{<br>object[] resultSet &#x3D; new object[reader.FieldCount];<br>reader.GetValues(resultSet);<br>string lastName &#x3D; resultSet[1].ToString();<br>string firstName &#x3D; resultSet[2].ToString();<br>int numberOfDependents &#x3D; (int)resultSet[3];<br>return new Person(id, lastName, firstName, numberOfDependents);<br>}</p>
<p>protected override void DoInsert(DomainObject subject, IDbCommand insertStatement)<br>{<br>Person person &#x3D; (Person) subject;<br>var p1 &#x3D; insertStatement.CreateParameter();<br>p1.DbType &#x3D; DbType.String;<br>p1.Value &#x3D; person.LastName;</p>
<p>var p2 &#x3D; insertStatement.CreateParameter();<br>p2.DbType &#x3D; DbType.String;<br>p2.Value &#x3D; person.FirstName;</p>
<p>var p3 &#x3D; insertStatement.CreateParameter();<br>p3.DbType &#x3D; DbType.Int32;<br>p3.Value &#x3D; person.NumberOfDependents;<br>insertStatement.Parameters.Add(p1);<br>insertStatement.Parameters.Add(p2);<br>insertStatement.Parameters.Add(p3);<br>}</p>
<p>public Person Find(int id)<br>{<br>return (Person) AbstractFind(id);<br>}</p>
<p>public IList&lt;Person&gt; FindByLastName2(string pattern)<br>{<br>return FindMany(new FindByLastName(pattern))<br>.Cast&lt;Person&gt;().ToList();<br>}</p>
<p>public IList&lt;Person&gt; FinAll()<br>{<br>return FindMany(new FindAllStatement())<br>.Cast&lt;Person&gt;().ToList();<br>}</p>
<p>public void Update(Person subject)<br>{<br>try<br>{<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(UpdateStatementString, conn);<br>var p1 &#x3D; comm.CreateParameter();<br>p1.DbType &#x3D; DbType.String;<br>p1.Value &#x3D; subject.LastName;</p>
<p>var p2 &#x3D; comm.CreateParameter();<br>p2.DbType &#x3D; DbType.String;<br>p2.Value &#x3D; subject.FirstName;</p>
<p>var p3 &#x3D; comm.CreateParameter();<br>p3.DbType &#x3D; DbType.Int32;<br>p3.Value &#x3D; subject.NumberOfDependents;</p>
<p>var p4 &#x3D; comm.CreateParameter();<br>p4.DbType &#x3D; DbType.Int32;<br>p4.Value &#x3D; subject.Id;</p>
<p>comm.Parameters.Add(p1);<br>comm.Parameters.Add(p2);<br>comm.Parameters.Add(p3);<br>comm.Parameters.Add(p4);</p>
<p>comm.ExecuteNonQuery();<br>}<br>catch (Exception ex)<br>{<br>throw new ApplicationException(ex.Message);<br>}<br>}</p>
<p>private class FindByLastName : IStatementSource<br>{<br>private readonly string _lastName;</p>
<p>public string Sql { get; } &#x3D;<br>“SELECT “ + Columns + “ FROM person WHERE UPPER(lastname) like UPPER(?) ORDER BY lastName”;</p>
<p>public object[] Parameters<br>{<br>get<br>{<br>return new object[] {_lastName};<br>}<br>}</p>
<p>public FindByLastName(string lastName)<br>{<br>_lastName &#x3D; lastName;<br>}<br>}</p>
<p>private class FindAllStatement : IStatementSource<br>{<br>private readonly string _lastName;</p>
<p>public string Sql { get; } &#x3D;<br>“SELECT * FROM person”;</p>
<p>public object[] Parameters<br>{<br>get<br>{<br>return new object[] {};<br>}<br>}<br>}<br>}</p>
<h5 id="2-1-3-IStatementSource-interface"><a href="#2-1-3-IStatementSource-interface" class="headerlink" title="2.1.3 IStatementSource interface"></a>2.1.3 IStatementSource interface</h5><p>This interface packs SQL string and SQL parameters for FindMany method.  </p>
<p>public interface IStatementSource<br>{<br>    string Sql { get; }<br>    object[] Parameters { get; }<br>}</p>
<h5 id="2-1-4-DomainObject-Person-classes-and-IPersonFinder-interface"><a href="#2-1-4-DomainObject-Person-classes-and-IPersonFinder-interface" class="headerlink" title="2.1.4 DomainObject&#x2F;Person classes and IPersonFinder interface"></a>2.1.4 DomainObject&#x2F;Person classes and IPersonFinder interface</h5><p>Domain Model’s super class is DomainObject. For this person management case, Person class is the main Domain Model to perform business logic.   IPersonFinder interface associates with Person class and provides Find methods.</p>
<p>public abstract class DomainObject<br>{<br>public int Id { get; set; }<br>}</p>
<p>public class Person : DomainObject<br>{<br>public string LastName { get; }<br>public string FirstName { get; }<br>public int NumberOfDependents { get; }<br>public Person(int id, string lastName, string firstName, int numberOfDependents)<br>{<br>Id &#x3D; id;<br>LastName &#x3D; lastName;<br>FirstName &#x3D; firstName;<br>NumberOfDependents &#x3D; numberOfDependents;<br>}</p>
<p>public Money GetExemption()<br>{<br>Money baseExemption &#x3D; Money.Dollars(1500d);<br>Money dependentExemption &#x3D; Money.Dollars(750d);<br>return baseExemption.Add(dependentExemption.Multiply((double)NumberOfDependents));<br>}<br>}</p>
<p>public interface IPersonFinder<br>{<br>IList&lt;Person&gt; FinAll();<br>Person Find(int id);<br>IList&lt;Person&gt; FindByLastName2(string pattern);<br>}</p>
<h4 id="2-2-Demo"><a href="#2-2-Demo" class="headerlink" title="2.2 Demo"></a>2.2 Demo</h4><p>Create a console program and create 3 Persons in SQLite as the following code:</p>
<p>class Program<br>{<br>static void Main(string[] args)<br>{<br>InitializeData();</p>
<p>Console.WriteLine(“Get persons”);<br>PersonMapper mapper &#x3D; new PersonMapper();<br>&#x2F;&#x2F; get all persons<br>var people &#x3D; mapper.FinAll();<br>PrintPerson(people);</p>
<p>Console.WriteLine(“Insert a new person”);<br>mapper.Insert(new Person(0, “Rose”, “Jackson”, 60));<br>people &#x3D; mapper.FinAll();<br>PrintPerson(people);</p>
<p>Console.WriteLine(“Update a person’s first name”);<br>var firstPerson &#x3D; mapper.Find(1);<br>firstPerson.FirstName &#x3D; “Jack”;<br>mapper.Update(firstPerson);</p>
<p>Console.WriteLine(“Update a person’s number of dependents”);<br>var secondPerson &#x3D; mapper.Find(2);<br>secondPerson.NumberOfDependents &#x3D; 0;<br>mapper.Update(secondPerson);</p>
<p>Console.WriteLine(“Get persons again”);<br>people &#x3D; mapper.FinAll();<br>PrintPerson(people);</p>
<p>Console.WriteLine(“Get persons with lastname containing n”);<br>people &#x3D; mapper.FindByLastName2(“%n%”);<br>PrintPerson(people);<br>}</p>
<p>private static void PrintPerson(IEnumerable&lt;Person&gt; people)<br>{<br>foreach (var person in people)<br>{<br>Console.WriteLine($”ID: {person.Id}, “ +<br>  $”last name: {person.LastName}, “ +<br>  $”first name: {person.FirstName}, “ +<br>  $”number of dependents: {person.NumberOfDependents}, “ +<br>  $”exemption: {person.GetExemption().Amount}”);<br>}<br>}</p>
<p>private static void InitializeData()<br>{<br>using (var connection &#x3D; DbManager.CreateConnection())<br>{<br>connection.Open();</p>
<p>using (var command &#x3D; connection.CreateCommand())<br>{<br>command.CommandText &#x3D;<br>@”<br>DROP TABLE IF EXISTS person;<br>“;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@”<br>CREATE TABLE person (Id int primary key, lastname TEXT, firstname TEXT, numberOfDependents int);<br>“;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@”</p>
<p>INSERT INTO person<br>VALUES (1, ‘Sean’, ‘Reid’, 5);</p>
<p>INSERT INTO person<br>VALUES (2, ‘Madeleine’, ‘Lyman’, 13);</p>
<p>INSERT INTO person<br>VALUES (3, ‘Oliver’, ‘Wright’, 66);<br>“;<br>command.ExecuteNonQuery();<br>}</p>
<p>}<br>}<br>}</p>
<p>The console shows:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-6.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-4.png" alt="data mapper result"></a></p>
<h3 id="3-Conclusions-for-Data-Mapper"><a href="#3-Conclusions-for-Data-Mapper" class="headerlink" title="3. Conclusions for Data Mapper"></a>3. Conclusions for Data Mapper</h3><p>I very like “Data Mapper” pattern because of decoupling between Domain Model and Data Source. For testings and maintenance, these works are easier than other data source patterns. The above sample code is uploaded to this <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_DataMapper">Github Repository</a>.</p>
<p>For next article I will write <strong>Unit of Work</strong> pattern according to <strong>Chapter 11 Object-Relational Behavioral Patterns - Unit of Work</strong> of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/40CuWZT">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/07/01/poeaa-data-source-architectural-pattern-active-record/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/01/poeaa-data-source-architectural-pattern-active-record/" class="post-title-link" itemprop="url">Active Record Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-07-01 22:44:00" itemprop="dateCreated datePublished" datetime="2021-07-01T22:44:00+08:00">2021-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Active-Record"><a href="#1-What-is-Active-Record" class="headerlink" title="1. What is Active Record"></a>1. What is Active Record</h3><p>According to [PoEAA], Active Record definition is “An object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data.”</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/activeRecordSketch-1.gif"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/activeRecordSketch-1.gif" alt="Active Record"></a></p>
<p>Figure 1. Active Record (From <a target="_blank" rel="noopener" href="https://www.martinfowler.com/eaaCatalog/activeRecord.html">PoEAA Page</a>)</p>
<h4 id="1-1-How-it-works"><a href="#1-1-How-it-works" class="headerlink" title="1.1 How it works"></a>1.1 How it works</h4><p>It is a Domain Model. Every Active Record’s class is mapped to a record of the database and loads the data source to process with domain logic.<br>An approximate equality this pattern ≈ Row Data Gateway + Domain Logic</p>
<h4 id="1-2-When-to-use-it"><a href="#1-2-When-to-use-it" class="headerlink" title="1.2 When to use it"></a>1.2 When to use it</h4><ol>
<li>For simple domain logic.</li>
<li>When design Domain Model pattern, choose either this pattern or  Data Mapper.</li>
<li>If the application becomes more complex, Data Mapper is a better choice.</li>
<li>This pattern is hard to do refactoring because of tightly coupling with database.</li>
<li>When use Transaction Script, Row Data Gateway gradually evolves into Active Record.</li>
</ol>
<h3 id="2-Pattern-Practice-The-Person-Management"><a href="#2-Pattern-Practice-The-Person-Management" class="headerlink" title="2. Pattern Practice: The Person Management"></a>2. Pattern Practice: The Person Management</h3><p>This problem is introduced in the previous article <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/">[PoEAA] Data Source Architectural Pattern - Table Data Gateway</a>. This article uses this pattern to build the data source architectural layer.</p>
<h4 id="2-1-Implementation-by-C-SQLite"><a href="#2-1-Implementation-by-C-SQLite" class="headerlink" title="2.1 Implementation by C# &amp; SQLite"></a>2.1 Implementation by C# &amp; SQLite</h4><p>This pattern is implemented by C# based on the content of <strong>Chapter 10 Data Source Architectural Patterns - Active Record</strong> of PoEAA. The database is SQLite.</p>
<p>By Martin’s implementation, it doesn’t contain a Delete function in a record. So this article also has no Delete function.</p>
<h5 id="2-1-1-Person-class"><a href="#2-1-1-Person-class" class="headerlink" title="2.1.1 Person class"></a>2.1.1 Person class</h5><p>This Person class creates Insert&#x2F;Update&#x2F;Find&#x2F;Load basic functions to manipulate person table. One instance function GetExemption() is a business logic.  </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Person</span> : <span class="title">BaseActiveRecord</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> LastName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> FirstName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> NumberOfDependents &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> FindStatementString = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">SELECT id, lastname, firstname, numberOfDependents</span></span><br><span class="line"><span class="string">FROM person</span></span><br><span class="line"><span class="string">WHERE id = $id</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> UpdateStatementString =</span><br><span class="line"><span class="string">@&quot;UPDATE person </span></span><br><span class="line"><span class="string">SET lastname = $lastname, firstname = $firstname, numberOfDependents = $numberOfDependents</span></span><br><span class="line"><span class="string">where id = $id&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> InsertStatementString =</span><br><span class="line"><span class="string">@&quot;INSERT INTO person </span></span><br><span class="line"><span class="string">VALUES ($id, $lastname, $firstname, $numberOfDependents)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Person</span>(<span class="params"><span class="built_in">int</span> id, <span class="built_in">string</span> lastName, <span class="built_in">string</span> firstName, <span class="built_in">int</span> numberOfDependents</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Id = id;</span><br><span class="line">LastName = lastName;</span><br><span class="line">FirstName = firstName;</span><br><span class="line">NumberOfDependents = numberOfDependents;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Person <span class="title">Find</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Person result = Registry.GetPerson(id);</span><br><span class="line"><span class="keyword">if</span> (result != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(FindStatementString, conn);</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$id&quot;</span>, id));</span><br><span class="line"><span class="keyword">using</span> IDataReader reader = comm.ExecuteReader();</span><br><span class="line">reader.Read();</span><br><span class="line">result = Load(reader);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(ex.Message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Person <span class="title">Load</span>(<span class="params">IDataReader reader</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">object</span>[] resultSet = <span class="keyword">new</span> <span class="built_in">object</span>[reader.FieldCount];</span><br><span class="line">reader.GetValues(resultSet);</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> id = (<span class="built_in">int</span>)resultSet[<span class="number">0</span>];</span><br><span class="line">Person result = Registry.GetPerson(id);</span><br><span class="line"><span class="keyword">if</span> (result != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> lastName = resultSet[<span class="number">1</span>].ToString();</span><br><span class="line"><span class="built_in">string</span> firstName = resultSet[<span class="number">2</span>].ToString();</span><br><span class="line"><span class="built_in">int</span> numberOfDependents = (<span class="built_in">int</span>)resultSet[<span class="number">3</span>];</span><br><span class="line">result = <span class="keyword">new</span> Person(id, lastName, firstName, numberOfDependents);</span><br><span class="line">Registry.AddPerson(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(UpdateStatementString, conn);</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$lastname&quot;</span>, LastName));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$firstname&quot;</span>, FirstName));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$numberOfDependents&quot;</span>, NumberOfDependents));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$id&quot;</span>, Id));</span><br><span class="line">comm.ExecuteNonQuery();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(ex.Message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Insert</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(InsertStatementString, conn);</span><br><span class="line">Id = FindNextDatabaseId();</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$id&quot;</span>, Id));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$lastname&quot;</span>, LastName));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$firstname&quot;</span>, FirstName));</span><br><span class="line">comm.Parameters.Add(<span class="keyword">new</span> SQLiteParameter(<span class="string">&quot;$numberOfDependents&quot;</span>, NumberOfDependents));</span><br><span class="line">comm.ExecuteNonQuery();</span><br><span class="line">Registry.AddPerson(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Id;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(ex.Message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Money <span class="title">GetExemption</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">Money baseExemption = Money.Dollars(<span class="number">1500</span>d);</span><br><span class="line">Money dependentExemption = Money.Dollars(<span class="number">750</span>d);</span><br><span class="line"><span class="keyword">return</span> baseExemption.Add(dependentExemption.Multiply((<span class="built_in">double</span>) NumberOfDependents));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">FindNextDatabaseId</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">string</span> sql = <span class="string">&quot;SELECT max(id) as curId from person&quot;</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(sql, conn);</span><br><span class="line"><span class="keyword">using</span> IDataReader reader = comm.ExecuteReader();</span><br><span class="line"><span class="built_in">bool</span> hasResult = reader.Read();</span><br><span class="line"><span class="keyword">if</span> (hasResult)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> ((<span class="built_in">int</span>)((<span class="built_in">long</span>)reader[<span class="string">&quot;curId&quot;</span>] + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">BaseActiveRecord</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">protected</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-1-2-Registry"><a href="#2-1-2-Registry" class="headerlink" title="2.1.2 Registry"></a>2.1.2 Registry</h5><p>The Registry has been used in <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/06/23/poeaa-data-source-architectural-pattern-row-data-gateway/">[PoEAA] Data Source Architectural Pattern - Row Data Gateway</a>. This article uses it to register Person instances.  </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">Registry</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Registry Instance = <span class="keyword">new</span> Registry();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> Dictionary&lt;<span class="built_in">int</span>, Person&gt; _personsMap = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, Person&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Registry</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AddPerson</span>(<span class="params">Person person</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Instance._personsMap.Add(person.Id, person);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Person <span class="title">GetPerson</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (Instance._personsMap.ContainsKey(id))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> Instance._personsMap[id];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-Demo"><a href="#2-2-Demo" class="headerlink" title="2.2 Demo"></a>2.2 Demo</h4><p>Create a console program and create 3 Persons in SQLite as the following code:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> FindAllPersonsStatementString = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">SELECT id, lastname, firstname, numberOfDependents</span></span><br><span class="line"><span class="string">FROM person</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">InitializeData();</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Get persons&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> people = FindPersons();</span><br><span class="line">PrintPerson(people);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Insert a new person&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> Person(<span class="number">0</span>, <span class="string">&quot;Rose&quot;</span>, <span class="string">&quot;Jackson&quot;</span>, <span class="number">60</span>).Insert();</span><br><span class="line">people = FindPersons();</span><br><span class="line">PrintPerson(people);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Update a person&#x27;s first name&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> firstPerson = Person.Find(<span class="number">1</span>);</span><br><span class="line">firstPerson.FirstName = <span class="string">&quot;Jack&quot;</span>;</span><br><span class="line">firstPerson.Update();</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Update a person&#x27;s number of dependents&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> secondPerson = Person.Find(<span class="number">2</span>);</span><br><span class="line">secondPerson.NumberOfDependents = <span class="number">0</span>;</span><br><span class="line">secondPerson.Update();</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Get persons again&quot;</span>);</span><br><span class="line">people = FindPersons();</span><br><span class="line">PrintPerson(people);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Person&gt; <span class="title">FindPersons</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">List&lt;Person&gt; result = <span class="keyword">new</span> List&lt;Person&gt;();</span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">var</span> conn = DbManager.CreateConnection();</span><br><span class="line">conn.Open();</span><br><span class="line"><span class="keyword">using</span> IDbCommand comm = <span class="keyword">new</span> SQLiteCommand(FindAllPersonsStatementString, conn);</span><br><span class="line"><span class="keyword">using</span> IDataReader reader = comm.ExecuteReader();</span><br><span class="line"><span class="keyword">while</span> (reader.Read())</span><br><span class="line">&#123;</span><br><span class="line">result.Add(Person.Load(reader));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception ex)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(ex.Message);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">PrintPerson</span>(<span class="params">IEnumerable&lt;Person&gt; people</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> person <span class="keyword">in</span> people)</span><br><span class="line">&#123;</span><br><span class="line">Console.WriteLine(<span class="string">$&quot;ID: <span class="subst">&#123;person.Id&#125;</span>, &quot;</span> +</span><br><span class="line">  <span class="string">$&quot;last name: <span class="subst">&#123;person.LastName&#125;</span>, &quot;</span> +</span><br><span class="line">  <span class="string">$&quot;first name: <span class="subst">&#123;person.FirstName&#125;</span>, &quot;</span> +</span><br><span class="line">  <span class="string">$&quot;number of dependents: <span class="subst">&#123;person.NumberOfDependents&#125;</span>, &quot;</span> +</span><br><span class="line">  <span class="string">$&quot;exemption: <span class="subst">&#123;person.GetExemption().Amount&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InitializeData</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> connection = DbManager.CreateConnection())</span><br><span class="line">&#123;</span><br><span class="line">connection.Open();</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> command = connection.CreateCommand())</span><br><span class="line">&#123;</span><br><span class="line">command.CommandText =</span><br><span class="line"><span class="string">@&quot;</span></span><br><span class="line"><span class="string">DROP TABLE IF EXISTS person;</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line">command.ExecuteNonQuery();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">command.CommandText =</span><br><span class="line"><span class="string">@&quot;</span></span><br><span class="line"><span class="string">CREATE TABLE person (Id int primary key, lastname TEXT, firstname TEXT, numberOfDependents int);</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line">command.ExecuteNonQuery();</span><br><span class="line"></span><br><span class="line">command.CommandText =</span><br><span class="line"><span class="string">@&quot;</span></span><br><span class="line"><span class="string">   </span></span><br><span class="line"><span class="string">INSERT INTO person</span></span><br><span class="line"><span class="string">VALUES (1, &#x27;Sean&#x27;, &#x27;Reid&#x27;, 5);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INSERT INTO person</span></span><br><span class="line"><span class="string">VALUES (2, &#x27;Madeleine&#x27;, &#x27;Lyman&#x27;, 13);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">INSERT INTO person</span></span><br><span class="line"><span class="string">VALUES (3, &#x27;Oliver&#x27;, &#x27;Wright&#x27;, 66);</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line">command.ExecuteNonQuery();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The console shows:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-8.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/image-7.png" alt="active record result"></a></p>
<h3 id="3-Conclusions-for-Active-Record"><a href="#3-Conclusions-for-Active-Record" class="headerlink" title="3. Conclusions for Active Record"></a>3. Conclusions for Active Record</h3><p>This pattern is a advanced version of Row Data Gateway. The above sample code is uploaded to this <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_ActiveRecord">Github Repository</a>.</p>
<p>For next article I will write <strong>D</strong>ata Mapper pattern according to <strong>Chapter 10 Data Source Architectural Pattern - Data Mapper</strong> of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/3gV8eak">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/23/poeaa-data-source-architectural-pattern-row-data-gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/23/poeaa-data-source-architectural-pattern-row-data-gateway/" class="post-title-link" itemprop="url">Row Data Gateway Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-23 23:23:00" itemprop="dateCreated datePublished" datetime="2021-06-23T23:23:00+08:00">2021-06-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Row-Data-Gateway"><a href="#1-What-is-Row-Data-Gateway" class="headerlink" title="1. What is Row Data Gateway"></a>1. What is Row Data Gateway</h3><p>According to [PoEAA], Row Data Gateway definition is “An object that acts as a Gateway to a single record in a data source. There is one instance per row.”</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-10.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-8.png"></a></p>
<p>Figure 1. Row Data Gateway (From <a target="_blank" rel="noopener" href="https://www.martinfowler.com/eaaCatalog/rowDataGateway.html">PoEAA Page</a>)</p>
<h4 id="1-1-How-it-works"><a href="#1-1-How-it-works" class="headerlink" title="1.1 How it works"></a>1.1 How it works</h4><p>In a gateway, the property&#x2F;field is mapped to a record’s attribute. For finding function, there are Finder  Class and Gateway Class to retrieve a table’s records. As the following sequence diagram shows:  </p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/rowdatagateway_with_finder-2.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/rowdatagateway_with_finder-1.png"></a></p>
<p>Figure 2. Interactions for a find with a row-based Row Data Gateway.</p>
<h4 id="1-2-When-to-use-it"><a href="#1-2-When-to-use-it" class="headerlink" title="1.2 When to use it"></a>1.2 When to use it</h4><ol>
<li>Consider whether the architecture needs a gateway and what gateway to use (Table&#x2F;Row Data Gateway).</li>
<li>Transaction Script pattern fits this pattern.</li>
<li>Domain Model pattern is not recommended to use this pattern.</li>
<li>When use Transaction Script and this pattern and the application becomes more complex, this pattern will evolve into an Active Record.</li>
<li>This pattern can combine with Data Mapper when gateway is generated by Metadata Mapping</li>
</ol>
<h3 id="2-Pattern-Practice-The-Person-Management"><a href="#2-Pattern-Practice-The-Person-Management" class="headerlink" title="2. Pattern Practice: The Person Management"></a>2. Pattern Practice: The Person Management</h3><p>This problem is introduced in the previous article <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/">[PoEAA] Data Source Architectural Pattern - Table Data Gateway</a>. This article uses this pattern to build the data source architectural layer.</p>
<h4 id="2-1-Implementation-by-C-SQLite"><a href="#2-1-Implementation-by-C-SQLite" class="headerlink" title="2.1 Implementation by C# &amp; SQLite"></a>2.1 Implementation by C# &amp; SQLite</h4><p>This pattern is implemented by C# based on the content of <strong>Chapter 10 Data Source Architectural Patterns - Row Data Gateway</strong> of PoEAA. The database is SQLite.</p>
<p>By Martin’s implementation, it doesn’t contain a Delete function in a gateway. So this article also has no Delete function.</p>
<h5 id="2-1-1-PersonGateway"><a href="#2-1-1-PersonGateway" class="headerlink" title="2.1.1 PersonGateway"></a>2.1.1 PersonGateway</h5><p>This gateway creates Insert&#x2F;Update basic functions to manipulate person table. One static Load function is used by Finder Class.  </p>
<p>class PersonGateway: BaseGateway {<br>  public PersonGateway(int id, string lastName, string firstName, int numberOfDependents) {<br>    Id &#x3D; id;<br>    LastName &#x3D; lastName;<br>    FirstName &#x3D; firstName;<br>    NumberOfDependents &#x3D; numberOfDependents;<br>  }<br>  private<br>  const string UpdateStatementString &#x3D; @ “UPDATE person SET lastname &#x3D; $lastname, firstname &#x3D; $firstname, numberOfDependents &#x3D; $numberOfDependentswhere id &#x3D; $id”;<br>  private<br>  const string InsertStatementString &#x3D; @ “INSERT INTO person VALUES ($id, $lastname, $firstname, $numberOfDependents)”;<br>  public string LastName {<br>    get;<br>    set;<br>  }<br>  public string FirstName {<br>    get;<br>    set;<br>  }<br>  public int NumberOfDependents {<br>    get;<br>    set;<br>  }<br>  public static PersonGateway Load(IDataReader reader) {<br>    object[] resultSet &#x3D; new object[reader.FieldCount];<br>    reader.GetValues(resultSet);<br>    int id &#x3D; (int) resultSet[0];<br>    PersonGateway result &#x3D; Registry.GetPerson(id);<br>    if (result !&#x3D; null) {<br>      return result;<br>    }<br>    string lastName &#x3D; resultSet[1].ToString();<br>    string firstName &#x3D; resultSet[2].ToString();<br>    int numberOfDependents &#x3D; (int) resultSet[3];<br>    result &#x3D; new PersonGateway(id, lastName, firstName, numberOfDependents);<br>    Registry.AddPerson(result);<br>    return result;<br>  }<br>  public void Update() {<br>    try {<br>      using<br>      var conn &#x3D; DbManager.CreateConnection();<br>      conn.Open();<br>      using IDbCommand comm &#x3D; new SQLiteCommand(UpdateStatementString, conn);<br>      comm.Parameters.Add(new SQLiteParameter(“$lastname”, LastName));<br>      comm.Parameters.Add(new SQLiteParameter(“$firstname”, FirstName));<br>      comm.Parameters.Add(new SQLiteParameter(“$numberOfDependents”, NumberOfDependents));<br>      comm.Parameters.Add(new SQLiteParameter(“$id”, Id));<br>      comm.ExecuteNonQuery();<br>    } catch (Exception ex) {<br>      throw new ApplicationException(ex.Message);<br>    }<br>  }<br>  public int Insert() {<br>    try {<br>      using<br>      var conn &#x3D; DbManager.CreateConnection();<br>      conn.Open();<br>      using IDbCommand comm &#x3D; new SQLiteCommand(InsertStatementString, conn);<br>      Id &#x3D; FindNextDatabaseId();<br>      comm.Parameters.Add(new SQLiteParameter(“$id”, Id));<br>      comm.Parameters.Add(new SQLiteParameter(“$lastname”, LastName));<br>      comm.Parameters.Add(new SQLiteParameter(“$firstname”, FirstName));<br>      comm.Parameters.Add(new SQLiteParameter(“$numberOfDependents”, NumberOfDependents));<br>      comm.ExecuteNonQuery();<br>      Registry.AddPerson(this);<br>      return Id;<br>    } catch (Exception ex) {<br>      throw new ApplicationException(ex.Message);<br>    }<br>  }<br>  private int FindNextDatabaseId() {<br>    string sql &#x3D; “SELECT max(id) as curId from person”;<br>    using<br>    var conn &#x3D; DbManager.CreateConnection();<br>    conn.Open();<br>    using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>    using IDataReader reader &#x3D; comm.ExecuteReader();<br>    bool hasResult &#x3D; reader.Read();<br>    if (hasResult) {<br>      return ((int)((long) reader[“curId”] + 1));<br>    } else {<br>      return 1;<br>    }<br>  }<br>}<br>internal class BaseGateway {<br>  public int Id {<br>    get;<br>    set;<br>  }<br>  public BaseGateway() {}<br>}</p>
<h5 id="2-1-2-PersonFinder"><a href="#2-1-2-PersonFinder" class="headerlink" title="2.1.2 PersonFinder"></a>2.1.2 PersonFinder</h5><p>This finder class queries single&#x2F;multiple record(s) with PersonGateway.  </p>
<p>class PersonFinder {<br>  private<br>  const string FindStatementString &#x3D; @ “SELECT id, lastname, firstname, numberOfDependentsfrom personWHERE id &#x3D; $id”;<br>  private<br>  const string FindResponsibleStatementString &#x3D; @ “SELECT id, lastname, firstname, numberOfDependentsfrom personWHERE numberOfDependents &gt; 0”;<br>  public PersonGateway Find(int id) {<br>    PersonGateway result &#x3D; Registry.GetPerson(id);<br>    if (result !&#x3D; null) {<br>      return result;<br>    }<br>    try {<br>      using<br>      var conn &#x3D; DbManager.CreateConnection();<br>      conn.Open();<br>      using IDbCommand comm &#x3D; new SQLiteCommand(FindStatementString, conn);<br>      comm.Parameters.Add(new SQLiteParameter(“$id”, id));<br>      using IDataReader reader &#x3D; comm.ExecuteReader();<br>      reader.Read();<br>      result &#x3D; PersonGateway.Load(reader);<br>      return result;<br>    } catch (Exception ex) {<br>      throw new ApplicationException(ex.Message);<br>    }<br>  }<br>  public List<PersonGateway> FindResponsibles() {<br>    List<PersonGateway> result &#x3D; new List<PersonGateway>();<br>    try {<br>      using<br>      var conn &#x3D; DbManager.CreateConnection();<br>      conn.Open();<br>      using IDbCommand comm &#x3D; new SQLiteCommand(FindResponsibleStatementString, conn);<br>      using IDataReader reader &#x3D; comm.ExecuteReader();<br>      while (reader.Read()) {<br>        result.Add(PersonGateway.Load(reader));<br>      }<br>      return result;<br>    } catch (Exception ex) {<br>      throw new ApplicationException(ex.Message);<br>    }<br>  }<br>}</p>
<h5 id="2-1-3-Registry"><a href="#2-1-3-Registry" class="headerlink" title="2.1.3 Registry"></a>2.1.3 Registry</h5><p>The above finder&#x2F;gateway classes have used a Registry. This Registry pattern holds a kind of dictionary that keeps one key mapped to a instance. In this article the Registry has a &lt;id, PersonGateway&gt; dictionary for finding&#x2F;insertion functions. When insertion completes, Registry adds this Person; When finding is called, it first checks the Registry whether has the Person. If the Person exists, return it. Otherwise it queries Person from the database and stores it in Registry.  </p>
<p>internal class Registry {<br>  private static readonly Registry Instance &#x3D; new Registry();<br>  private readonly Dictionary&lt;int, PersonGateway&gt; _personsMap &#x3D; new Dictionary&lt;int, PersonGateway&gt;();<br>  private Registry() {}<br>  public static void AddPerson(PersonGateway personGateway) {<br>    Instance._personsMap.Add(personGateway.Id, personGateway);<br>  }<br>  public static PersonGateway GetPerson(int id) {<br>    if (Instance._personsMap.ContainsKey(id)) {<br>      return Instance._personsMap[id];<br>    }<br>    return null;<br>  }<br>}</p>
<h4 id="2-2-Demo"><a href="#2-2-Demo" class="headerlink" title="2.2 Demo"></a>2.2 Demo</h4><p>Create a console program and create 3 Persons in SQLite as the following code:</p>
<p>class Program {<br>  static void Main(string[] args) {<br>    InitializeData();<br>    Console.WriteLine(“Get responsible persons”);<br>    PersonFinder finder &#x3D; new PersonFinder();<br>    var people &#x3D; finder.FindResponsibles();<br>    PrintPersonGateway(people);<br>    Console.WriteLine(“Insert a new person”);<br>    new PersonGateway(0, “Rose”, “Jackson”, 60).Insert();<br>    people &#x3D; finder.FindResponsibles();<br>    PrintPersonGateway(people);<br>    Console.WriteLine(“Update a person’s first name”);<br>    var firstPerson &#x3D; finder.Find(1);<br>    firstPerson.FirstName &#x3D; “Jack”;<br>    firstPerson.Update();<br>    Console.WriteLine(“Update a person’s number of dependents”);<br>    var secondPerson &#x3D; finder.Find(2);<br>    secondPerson.NumberOfDependents &#x3D; 0;<br>    secondPerson.Update();<br>    Console.WriteLine(“Get responsible persons again”);<br>    people &#x3D; finder.FindResponsibles();<br>    PrintPersonGateway(people);<br>  }<br>  private static void PrintPersonGateway(IEnumerable<PersonGateway> people) {<br>    foreach(var person in people) {<br>      Console.WriteLine($”ID: {person.Id}, last name: {person.LastName}, first name: {person.FirstName}, number of dependents: {person.NumberOfDependents}”);<br>    }<br>  }<br>  private static void InitializeData() {<br>    using(var connection &#x3D; DbManager.CreateConnection()) {<br>      connection.Open();<br>      using(var command &#x3D; connection.CreateCommand()) {<br>        command.CommandText &#x3D; @ “DROP TABLE IF EXISTS person;”;<br>        command.ExecuteNonQuery();<br>        command.CommandText &#x3D; @ “CREATE TABLE person (Id int primary key, lastname TEXT, firstname TEXT, numberOfDependents int);”;<br>        command.ExecuteNonQuery();<br>        command.CommandText &#x3D; @ “   INSERT INTO personVALUES (1, ‘Sean’, ‘Reid’, 5);INSERT INTO personVALUES (2, ‘Madeleine’, ‘Lyman’, 13);INSERT INTO personVALUES (3, ‘Oliver’, ‘Wright’, 66);”;<br>        command.ExecuteNonQuery();<br>      }<br>    }<br>  }<br>}</p>
<p>The console shows:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-11.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-9.png" alt="Row Data Gateway result"></a></p>
<h3 id="3-Conclusions-for-Row-Data-Gateway"><a href="#3-Conclusions-for-Row-Data-Gateway" class="headerlink" title="3. Conclusions for Row Data Gateway"></a>3. Conclusions for Row Data Gateway</h3><p>This pattern is also a simpler data source architectural pattern. I think of it as a fine-grained version of Table Data Gateway. The above sample code is uploaded to this <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_RowDataGateway">Github Repository</a>.</p>
<p>For next article I will write <strong>Active Record</strong> pattern according to <strong>Chapter 10 Data Source Architectural Pattern - Active Record Gateway</strong> of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/40CuWZT">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/20/poeaa-data-source-architectural-pattern-table-data-gateway/" class="post-title-link" itemprop="url">Table Data Gateway Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-20 15:22:00" itemprop="dateCreated datePublished" datetime="2021-06-20T15:22:00+08:00">2021-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Table-Data-Gateway"><a href="#1-What-is-Table-Data-Gateway" class="headerlink" title="1. What is Table Data Gateway"></a>1. What is Table Data Gateway</h3><p>According to [PoEAA], Table Data Gateway definition is “An object that acts as a Gateway to a database table. One instance handles all the rows in the table.”</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-2.png"><img src="https://www.martinfowler.com/eaaCatalog/dbgateTable.gif" alt="Table Data Gateway"></a></p>
<p>Figure 1. Table Data Gateway (From <a target="_blank" rel="noopener" href="https://www.martinfowler.com/eaaCatalog/tableDataGateway.html">PoEAA Page</a>)</p>
<h4 id="1-1-How-it-works"><a href="#1-1-How-it-works" class="headerlink" title="1.1 How it works"></a>1.1 How it works</h4><p>Every function provided by a gateway maps a SQL query to the database. The functions are usually finding&#x2F;updating&#x2F;deleting.     </p>
<h4 id="1-2-When-to-use-it"><a href="#1-2-When-to-use-it" class="headerlink" title="1.2 When to use it"></a>1.2 When to use it</h4><ol>
<li>It does not usually work with Domain Model pattern. Domain Model pattern fits Data Mapper pattern.</li>
<li>Table Module pattern very fits this pattern.</li>
<li>It fits Transaction Script pattern.</li>
<li>It hides the table schema and provides functions that are implemented by SQL Queries or Stored Procedures.</li>
</ol>
<h3 id="2-Pattern-Practice-The-Person-Management"><a href="#2-Pattern-Practice-The-Person-Management" class="headerlink" title="2. Pattern Practice: The Person Management"></a>2. Pattern Practice: The Person Management</h3><p>As Figure 1 shows, there is a person table that has a primary key id and 3 attributes (lastName, firstName and numberOfDependents).</p>
<h4 id="2-1-Implementation-by-C-SQLite"><a href="#2-1-Implementation-by-C-SQLite" class="headerlink" title="2.1 Implementation by C# &amp; SQLite"></a>2.1 Implementation by C# &amp; SQLite</h4><p>This pattern is implemented by C# based on the content of <strong>Chapter 10 Data Source Architectural Patterns - Table Data Gateway</strong> of PoEAA. The database is SQLite.</p>
<p>By Martin’s implementation, it contains ADO.NET Reader version and ADO.NET DataSet version. The following sections show both versions.</p>
<h4 id="2-2-ADO-NET-Reader-Version"><a href="#2-2-ADO-NET-Reader-Version" class="headerlink" title="2.2 ADO.NET Reader Version"></a>2.2 ADO.NET Reader Version</h4><h5 id="2-2-1-PersonGateway"><a href="#2-2-1-PersonGateway" class="headerlink" title="2.2.1 PersonGateway"></a>2.2.1 PersonGateway</h5><p>This gateway creates Find&#x2F;Insert&#x2F;Update&#x2F;Delete basic functions to manipulate person table.  </p>
<p>class PersonGateway<br>{<br>public IDataReader FindAll()<br>{<br>string sql &#x3D; “select * from person”;<br>var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>return new SQLiteCommand(sql, conn).ExecuteReader();<br>}</p>
<p>public IDataReader FindWithLastName(string lastName)<br>{<br>string sql &#x3D; “select * from person where lastname &#x3D; $lastname”;<br>var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(“$lastname”, lastName));</p>
<p>return comm.ExecuteReader();<br>}</p>
<p>public IDataReader FindWhere(string whereClause)<br>{<br>string sql &#x3D; $”select * from person where {whereClause}”;<br>var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>return new SQLiteCommand(sql, conn).ExecuteReader();<br>}</p>
<p>public object[] FindRow(long key)<br>{<br>string sql &#x3D; “select * from person where id &#x3D; $id”;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(“$id”, key));<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>reader.Read();<br>object[] result &#x3D; new object[reader.FieldCount];<br>reader.GetValues(result);<br>return result;<br>}</p>
<p>public void Update(long key, string lastName, string firstName, int numberOfDependents)<br>{<br>string sql &#x3D;<br>@”Update person SET lastname &#x3D; $lastname, firstname &#x3D; $firstname, numberOfDependents &#x3D; $numberOfDependents<br>WHERE id &#x3D; $id”;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(“$lastname”, lastName));<br>comm.Parameters.Add(new SQLiteParameter(“$firstname”, firstName));<br>comm.Parameters.Add(new SQLiteParameter(“$numberOfDependents”, numberOfDependents));<br>comm.Parameters.Add(new SQLiteParameter(“$id”, key));<br>comm.ExecuteNonQuery();<br>}</p>
<p>public long Insert(string lastName, string firstName, int numberOfDependents)<br>{<br>string sql &#x3D;<br>@”INSERT INTO person VALUES ($id, $lastname, $firstname, $numberOfDependents)”;<br>long key &#x3D; GetNextId();<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(“$id”, key));<br>comm.Parameters.Add(new SQLiteParameter(“$lastname”, lastName));<br>comm.Parameters.Add(new SQLiteParameter(“$firstname”, firstName));<br>comm.Parameters.Add(new SQLiteParameter(“$numberOfDependents”, numberOfDependents));<br>comm.ExecuteNonQuery();<br>return key;<br>}</p>
<p>public void Delete(long key)<br>{<br>string sql &#x3D; “DELETE FROM person WHERE id &#x3D; $id”;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>comm.Parameters.Add(new SQLiteParameter(“$id”, key));<br>comm.ExecuteNonQuery();<br>}</p>
<p>private long GetNextId()<br>{<br>string sql &#x3D; “SELECT max(id) as curId from person”;<br>using var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>using IDbCommand comm &#x3D; new SQLiteCommand(sql, conn);<br>using IDataReader reader &#x3D; comm.ExecuteReader();<br>bool hasResult &#x3D; reader.Read();<br>if (hasResult)<br>{<br>return ((long)reader[“curId”] + 1);<br>}<br>else<br>{<br>return 1;<br>}<br>}<br>}</p>
<h4 id="2-3-ADO-NET-DataSet-Version"><a href="#2-3-ADO-NET-DataSet-Version" class="headerlink" title="2.3 ADO.NET DataSet Version"></a>2.3 ADO.NET DataSet Version</h4><p>Use a DataSetHolder class to hold a DataSet and a DataAdapter for a DataGateway. This definition is for generality as the following Figure 2 shows.  </p>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2021/11/TableDataGateway.png" alt="Table Data Gateway data-set-oriented class diagram"></p>
<p>Figure 2. Class diagram of data-set-oriented gateway and the supporting data holder</p>
<h5 id="2-3-1-DataSetHolder-class"><a href="#2-3-1-DataSetHolder-class" class="headerlink" title="2.3.1 DataSetHolder class"></a>2.3.1 DataSetHolder class</h5><p>This class holds a DataSet and a dictionary. The dictionary’s key is the table name, its value mapped to a DataAdapter instance.</p>
<p>class DataSetHolder<br>{<br>public DataSet Data &#x3D; new DataSet();<br>private readonly Dictionary&lt;string, SQLiteDataAdapter&gt; _dataAdapters &#x3D; new Dictionary&lt;string, SQLiteDataAdapter&gt;();</p>
<p>public void FillData(string query, string tableName)<br>{<br>if (_dataAdapters.ContainsKey(tableName))<br>{<br>throw new MultipleLoadException();<br>}</p>
<p>var conn &#x3D; DbManager.CreateConnection();<br>conn.Open();<br>SQLiteDataAdapter da &#x3D; new SQLiteDataAdapter(query, conn);<br>SQLiteCommandBuilder builder &#x3D; new SQLiteCommandBuilder(da);<br>da.Fill(Data, tableName);<br>_dataAdapters.Add(tableName, da);<br>}</p>
<p>public void Update()<br>{<br>foreach (string table in _dataAdapters.Keys)<br>{<br>(_dataAdapters[table]).Update(Data, table);<br>}<br>}</p>
<p>public DataTable this[string tableName] &#x3D;&gt; Data.Tables[tableName];<br>}</p>
<h5 id="2-3-2-DataGateway-PersonGateway"><a href="#2-3-2-DataGateway-PersonGateway" class="headerlink" title="2.3.2 DataGateway &amp; PersonGateway"></a>2.3.2 DataGateway &amp; PersonGateway</h5><p>DataGateway is the base class and provides the common functions to child classes. DataGateway exposes a DataSet and a DataTable to clients. The child PersonGateway implements the table name “person” and creates a new Insert function to add person record.</p>
<p>abstract class DataGateway<br>{<br>public abstract string TableName { get; }<br>public DataSetHolder Holder;</p>
<p>public DataSet Data &#x3D;&gt; Holder.Data;</p>
<p>public abstract DataTable Table { get; }</p>
<p>protected DataGateway()<br>{<br>Holder &#x3D; new DataSetHolder();<br>}</p>
<p>protected DataGateway(DataSetHolder holder)<br>{<br>this.Holder &#x3D; holder;<br>}</p>
<p>public void LoadAll()<br>{<br>string commandString &#x3D; $”select * from {TableName}”;<br>Holder.FillData(commandString, TableName);<br>}</p>
<p>public void LoadWhere(string whereClause)<br>{<br>string commandString &#x3D; $”select * from {TableName} where {whereClause}”;<br>Holder.FillData(commandString, TableName);<br>}<br>}</p>
<p>class PersonGateway : DataGateway<br>{<br>public override string TableName &#x3D;&gt; “person”;</p>
<p>public override DataTable Table &#x3D;&gt; Data.Tables[TableName];</p>
<p>public PersonGateway() : base()<br>{</p>
<p>}</p>
<p>public PersonGateway(DataSetHolder holder) : base(holder)<br>{</p>
<p>}</p>
<p>public DataRow this[long key]<br>{<br>get<br>{<br>string filter &#x3D; $”id &#x3D; {key}”;<br>return Table.Select(filter)[0];<br>}<br>}</p>
<p>public long Insert(string lastName, string firstName, int numberOfDependents)<br>{<br>long key &#x3D; GetNextId();<br>DataRow newRow &#x3D; Table.NewRow();<br>newRow[“id”] &#x3D; key;<br>newRow[“lastname”] &#x3D; lastName;<br>newRow[“firstname”] &#x3D; firstName;<br>newRow[“numberOfDependents”] &#x3D; numberOfDependents;<br>Table.Rows.Add(newRow);</p>
<p>return key;<br>}</p>
<p>private long GetNextId()<br>{<br>var result &#x3D; Table.Compute(“max([id])”, string.Empty);<br>if (result !&#x3D; System.DBNull.Value)<br>{<br>return ((int)result + 1);<br>}<br>else<br>{<br>return 1;<br>}<br>}<br>}</p>
<h4 id="2-4-Demo"><a href="#2-4-Demo" class="headerlink" title="2.4 Demo"></a>2.4 Demo</h4><p>Create a console program and create 3 Persons in SQLite, the person records:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-3.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-3.png" alt="Table Data Gateway Person Records"></a></p>
<p>Figure 3. Person Records</p>
<p>The program first executes Reader version functions and second executes DataSet version functions.</p>
<p>As the following code:</p>
<p>class Program<br>{<br>static void Main(string[] args)<br>{<br>RunReaderVersionExample();<br>RunDataTableVersionExample();<br>}</p>
<p>private static void RunDataTableVersionExample()<br>{<br>InitializeData();</p>
<p>Console.WriteLine(“Start RunDataTableVersionExample”);<br>Console.WriteLine(“Function: Get all persons”);<br>var gateway &#x3D; new DataTableVersion.PersonGateway();<br>gateway.LoadAll();<br>var allPersons &#x3D; gateway.Table.Rows;<br>PrintPersonsRowData(allPersons);</p>
<p>Console.WriteLine(“Function: Get person by id &#x3D; 2”);<br>var onePerson &#x3D; gateway[2];<br>PrintPersonRowData(onePerson);</p>
<p>Console.WriteLine(“Function: Update person by id &#x3D; 2”);<br>onePerson[“lastname”] &#x3D; “Jackson”;<br>onePerson[“firstname”] &#x3D; “Michael”;<br>onePerson[“numberOfDependents”] &#x3D; 100;<br>gateway.Holder.Update();<br>Console.WriteLine(“Function: Get person by id &#x3D; 2”);<br>var updatedPerson &#x3D; gateway[2];<br>PrintPersonRowData(updatedPerson);</p>
<p>Console.WriteLine(“Function: Insert a person”);<br>gateway.Insert(“Skinner”, “Neil”, 3);<br>gateway.Holder.Update();<br>Console.WriteLine(“Function: Get all persons”);<br>allPersons &#x3D; gateway.Table.Rows;<br>PrintPersonsRowData(allPersons);</p>
<p>Console.WriteLine(“Function: Get persons by numberOfDependents &gt; 10”);<br>gateway &#x3D; new DataTableVersion.PersonGateway();<br>gateway.LoadWhere(“numberOfDependents &gt; 10”);<br>var findPersons &#x3D; gateway.Table.Rows;<br>PrintPersonsRowData(findPersons);</p>
<p>Console.WriteLine(“Function: Delete person by id &#x3D; 1”);<br>gateway &#x3D; new DataTableVersion.PersonGateway();<br>gateway.LoadAll();<br>var deletedRow &#x3D; gateway[1];<br>deletedRow.Delete();<br>gateway.Holder.Update();</p>
<p>Console.WriteLine(“Function: Get all persons”);<br>allPersons &#x3D; gateway.Table.Rows;<br>PrintPersonsRowData(allPersons);</p>
<p>Console.WriteLine(“End RunDataTableVersionExample”);<br>}</p>
<p>private static void RunReaderVersionExample()<br>{<br>InitializeData();</p>
<p>Console.WriteLine(“Start RunReaderVersionExample”);<br>Console.WriteLine(“Function: Get all persons”);<br>var gateway &#x3D; new ReaderVersion.PersonGateway();<br>var allPersons &#x3D; gateway.FindAll();<br>PrintPersonsRowData(allPersons);<br>allPersons.Close();</p>
<p>Console.WriteLine(“Function: Get person by id &#x3D; 2”);<br>var onePerson &#x3D; gateway.FindRow(2);<br>PrintPersonRowData(onePerson);</p>
<p>Console.WriteLine(“Function: Update person by id &#x3D; 2”);<br>gateway.Update(2, “Jackson”, “Michael”, 100);<br>Console.WriteLine(“Function: Get person by id &#x3D; 2”);<br>var updatedPerson &#x3D; gateway.FindRow(2);<br>PrintPersonRowData(updatedPerson);</p>
<p>Console.WriteLine(“Function: Insert a person”);<br>gateway.Insert(“Skinner”, “Neil”, 3);</p>
<p>Console.WriteLine(“Function: Get all persons”);<br>allPersons &#x3D; gateway.FindAll();<br>PrintPersonsRowData(allPersons);<br>allPersons.Close();</p>
<p>Console.WriteLine(“Function: Get persons by numberOfDependents &gt; 10”);<br>var findPersons &#x3D; gateway.FindWhere(“numberOfDependents &gt; 10”);<br>PrintPersonsRowData(findPersons);<br>findPersons.Close();</p>
<p>Console.WriteLine(“Function: Delete person by id &#x3D; 1”);<br>gateway.Delete(1);</p>
<p>Console.WriteLine(“Function: Get all persons”);<br>allPersons &#x3D; gateway.FindAll();<br>PrintPersonsRowData(allPersons);<br>allPersons.Close();</p>
<p>Console.WriteLine(“End RunReaderVersionExample”);<br>}</p>
<p>private static void PrintPersonRowData(object[] columns)<br>{<br>Console.WriteLine($”id: {columns[0]}, lastname: {columns[1]}, firstname: {columns[2]}, numberOfDependents: {columns[3]}”);<br>}</p>
<p>private static void PrintPersonRowData(DataRow columns)<br>{<br>Console.WriteLine($”id: {columns[0]}, lastname: {columns[1]}, firstname: {columns[2]}, numberOfDependents: {columns[3]}”);<br>}</p>
<p>private static void PrintPersonsRowData(DataRowCollection dataRows)<br>{<br>foreach (DataRow row in dataRows)<br>{<br>Console.WriteLine($”id: {row[“id”]}, lastname: {row[“lastname”]}, firstname: {row[“firstname”]}, numberOfDependents: {row[“numberOfDependents”]}”);<br>}<br>}</p>
<p>private static void PrintPersonsRowData(IDataReader reader)<br>{<br>while (reader.Read())<br>{<br>Console.WriteLine($”id: {reader[“id”]}, lastname: {reader[“lastname”]}, firstname: {reader[“firstname”]}, numberOfDependents: {reader[“numberOfDependents”]}”);<br>}<br>}</p>
<p>private static void InitializeData()<br>{<br>using (var connection &#x3D; DbManager.CreateConnection())<br>{<br>connection.Open();</p>
<p>using (var command &#x3D; connection.CreateCommand())<br>{<br>command.CommandText &#x3D;<br>@”<br>DROP TABLE IF EXISTS person;<br>“;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@”<br>CREATE TABLE person (Id int primary key, lastname TEXT, firstname TEXT, numberOfDependents int);<br>“;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@”</p>
<p>INSERT INTO person<br>VALUES (1, ‘Sean’, ‘Reid’, 5);</p>
<p>INSERT INTO person<br>VALUES (2, ‘Madeleine’, ‘Lyman’, 13);</p>
<p>INSERT INTO person<br>VALUES (3, ‘Oliver’, ‘Wright’, 66);<br>“;<br>command.ExecuteNonQuery();<br>}</p>
<p>}<br>}<br>}</p>
<p>The console shows:</p>
<p><img src="https://geekcodeparadise.com/wp-content/uploads/2021/11/result.png" alt="Table Data Gateway result"></p>
<h3 id="3-Conclusions-for-Table-Data-Gateway"><a href="#3-Conclusions-for-Table-Data-Gateway" class="headerlink" title="3. Conclusions for Table Data Gateway"></a>3. Conclusions for Table Data Gateway</h3><p>“Table Data Gateway” is a simpler data source architectural pattern. We can create a gateway to map a table(or a view&#x2F;a store procedure) even map to whole tables. If the application is not complex, this pattern is a good choice.</p>
<p>The above sample code is uploaded to this <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_TableDataGateway">Github Repository</a>.</p>
<p>For next article I will write <strong>Row Data Gateway</strong> pattern according to <strong>Chapter 10 Data Source Architectural Pattern - Table Data Gateway</strong> of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/40CuWZT">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/16/poeaa-domain-logic-pattern-service-layer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/16/poeaa-domain-logic-pattern-service-layer/" class="post-title-link" itemprop="url">Service Layer Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-16 00:33:00" itemprop="dateCreated datePublished" datetime="2021-06-16T00:33:00+08:00">2021-06-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Service-Layer"><a href="#1-What-is-Service-Layer" class="headerlink" title="1. What is Service Layer"></a>1. What is Service Layer</h3><p>According to [PoEAA], Service Layer Pattern definition is “Defines an application’s boundary with a layer of services that establishes a set of available operations and coordinates the application’s response in each operation.”</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-14.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-12.png" alt="Service Layer Architecture"></a></p>
<p>Figure 1. Service Layer Architecture (From <a target="_blank" rel="noopener" href="https://martinfowler.com/eaaCatalog/serviceLayer.html">PoEAA Page</a>)</p>
<h4 id="1-1-How-it-works"><a href="#1-1-How-it-works" class="headerlink" title="1.1 How it works"></a>1.1 How it works</h4><p>Business Logic is generally split into “Domain Logic” and “Application Logic”. Domain Logic focuses on the domain problem like the calculation of contract’s revenue recognition. Application Logic is responsible for integrating “workflow”. The workflow example: When the calculation of contract’s revenue recognition is finished, system sends the result email to contract’s owner and prints contract paper. Every service layer packs an kind of application logic and makes the domain objects reusable.   Implementation:</p>
<ol>
<li>Domain Facade: This facade have no business logic and hides the a domain object’s implementation.</li>
<li>Operation Script: This implements the above Application Logic and some services are composed as a Operation Script for clients.</li>
</ol>
<p>Service Layer’s operations are based on the use case model and user interface design. Most use cases are “CRUD” with database for every domain model. In some applications have to interact with other application, so the service layer organizes the integration.   By application’s scale, if the application is large, then split it vertically into subsystems and every subsystem has a service name. The other way is based on Domain Model to build the services (like ContractService&#x2F;ProductService) or bases on the behavior to build the services (like RecognitionService)  </p>
<h4 id="1-2-When-to-use-it"><a href="#1-2-When-to-use-it" class="headerlink" title="1.2 When to use it"></a>1.2 When to use it</h4><p>If the application has only one resource transaction when client interact with every operation, Service Layer is not required and sending request to Data Source is straight. Otherwise, all clients interact this system with Service Layer’s public operations.</p>
<h3 id="2-Pattern-Practice-The-Revenue-Recognition-Problem"><a href="#2-Pattern-Practice-The-Revenue-Recognition-Problem" class="headerlink" title="2. Pattern Practice: The Revenue Recognition Problem"></a>2. Pattern Practice: The Revenue Recognition Problem</h3><p>This problem is introduced in the previous article <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/05/23/poeaa-domain-logic-pattern-transaction-script/">[PoEAA] Domain Logic Pattern - Transaction Script</a>. Original Transaction Script example has a service class. This article extends this service.</p>
<p>Define the service layer classes for the revenue recognition, product and contract as the following figure:</p>
<p><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/25E6259C25AA25E5259125BD25E52590258D25E725BB259825E5259B25BE.png" alt="service layer classes for the revenue recognition"></p>
<h4 id="2-1-Implementation-by-C"><a href="#2-1-Implementation-by-C" class="headerlink" title="2.1 Implementation by C#"></a>2.1 Implementation by C#</h4><p>This pattern is implemented by C# based on the content of <strong>Chapter 9 Domain Logic Pattern - Service Layer</strong> of PoEAA. </p>
<h5 id="2-1-1-New-Features"><a href="#2-1-1-New-Features" class="headerlink" title="2.1.1 New Features"></a>2.1.1 New Features</h5><p>When use RecognitionService’s CalculateRevenueRecognitions function, the calculated revenue result will be sent to contract’s administrator owner by email and broadcast to integrate other system. These 2 features are mocking implementation, not real sending&#x2F;broadcasting systems.</p>
<h5 id="2-1-2-IEmailGateway-IIntegrationGateway-interfaces-implementation"><a href="#2-1-2-IEmailGateway-IIntegrationGateway-interfaces-implementation" class="headerlink" title="2.1.2 IEmailGateway&#x2F;IIntegrationGateway interfaces&#x2F;implementation"></a>2.1.2 IEmailGateway&#x2F;IIntegrationGateway interfaces&#x2F;implementation</h5><p>The above new features are implemented in IEmailGateway and IIntegrationGateway as Figure 2 shows. Their implementation just prints parameter content by console.</p>
<p>internal class IntegrationGateway : IIntegrationGateway<br>{<br>public void PublishRevenueRecognitionCalculation(DataRow contract)<br>{<br>Console.WriteLine($”Id : {contract[“Id”]} , Signed Date: {((DateTime)contract[“DateSigned”]):MM&#x2F;dd&#x2F;yyyy}”);<br>}<br>}</p>
<p>public interface IIntegrationGateway<br>{<br>void PublishRevenueRecognitionCalculation(DataRow contract);<br>}</p>
<p>internal class EmailGateway : IEmailGateway<br>{<br>public void SendEmailMessage(string toAddress, string subject, string body)<br>{<br>Console.WriteLine($”To Address : {toAddress} , subject: {subject}, body: {body}”);<br>}<br>}</p>
<p>public interface IEmailGateway<br>{<br>void SendEmailMessage(string toAddress, string subject, string body);<br>}</p>
<h5 id="2-1-3-ApplicationService-base-class"><a href="#2-1-3-ApplicationService-base-class" class="headerlink" title="2.1.3 ApplicationService base class"></a>2.1.3 ApplicationService base class</h5><p>All service layer’s classes have reusable and common functions, so this ApplicationService provides those. In this example, ApplicationService only generates the IEmailGateway and IIntegrationGateway’s instances.</p>
<p>public class ApplicationService<br>{<br>protected virtual IEmailGateway GetEmailGateway()<br>{<br>return new EmailGateway();<br>}</p>
<p>protected virtual IIntegrationGateway GetIntegrationGateway()<br>{<br>return new IntegrationGateway();<br>}<br>}</p>
<h5 id="2-1-4-RecognitionService-Class"><a href="#2-1-4-RecognitionService-Class" class="headerlink" title="2.1.4 RecognitionService Class"></a>2.1.4 RecognitionService Class</h5><p>This class extends ApplicationService to get IEmailGateway and IIntegrationGateway’s instances. When the revenue recognitions are calculated, call these services to complete the new features.</p>
<p>public class RecognitionService : ApplicationService<br>{<br>public Money RecognizedRevenue(int contractNumber, DateTime beforeDate)<br>{<br>Money result &#x3D; Money.Dollars(0m);<br>Gateway db &#x3D; new Gateway();<br>var dt &#x3D; db.FindRecognitionsFor(contractNumber, beforeDate);<br>for (int i &#x3D; 0; i &lt; dt.Rows.Count; ++i)<br>{<br>var amount &#x3D; (decimal) dt.Rows[i][“Amount”];<br>result +&#x3D; Money.Dollars(amount);<br>}</p>
<p>return result;<br>}</p>
<p>public void CalculateRevenueRecognitions(int contractId)<br>{<br>Gateway db &#x3D; new Gateway();<br>var contracts &#x3D; db.FindContract(contractId);<br>Money totalRevenue &#x3D; Money.Dollars((decimal) contracts.Rows[0][“Revenue”]);<br>DateTime recognitionDate &#x3D; (DateTime) contracts.Rows[0][“DateSigned”];<br>string type &#x3D; contracts.Rows[0][“Type”].ToString();</p>
<p>if(type &#x3D;&#x3D; “S”)<br>{<br>Money[] allocation &#x3D; totalRevenue.Allocate(3);<br>db.InsertRecognitions(contractId, allocation[0], recognitionDate);<br>db.InsertRecognitions(contractId, allocation[1], recognitionDate.AddDays(60));<br>db.InsertRecognitions(contractId, allocation[2], recognitionDate.AddDays(90));<br>}<br>else if(type &#x3D;&#x3D; “W”)<br>{<br>db.InsertRecognitions(contractId, totalRevenue, recognitionDate);<br>}<br>else if(type &#x3D;&#x3D; “D”)<br>{<br>Money[] allocation &#x3D; totalRevenue.Allocate(3);<br>db.InsertRecognitions(contractId, allocation[0], recognitionDate);<br>db.InsertRecognitions(contractId, allocation[1], recognitionDate.AddDays(30));<br>db.InsertRecognitions(contractId, allocation[2], recognitionDate.AddDays(60));<br>}</p>
<p>GetEmailGateway().SendEmailMessage(<br>contracts.Rows[0][“AdministratorEmail”].ToString(),<br>“RE: Contract #” + contractId,<br>contractId + “ has had revenue recognitions calculated”);</p>
<p>GetIntegrationGateway().PublishRevenueRecognitionCalculation(contracts.Rows[0]);<br>}<br>}</p>
<h5 id="2-1-5-Demo"><a href="#2-1-5-Demo" class="headerlink" title="2.1.5 Demo"></a>2.1.5 Demo</h5><p>Create a console program and create 3 Products and 3 Contracts to calculate the revenue recognitions for the 3 products.</p>
<p>As the following code:</p>
<p>using (var connection &#x3D; DbManager.CreateConnection())<br>{<br>connection.Open();</p>
<p>var command &#x3D; connection.CreateCommand();<br>command.CommandText &#x3D;<br>@”<br>DROP TABLE IF EXISTS Products;<br>DROP TABLE IF EXISTS Contracts;<br>DROP TABLE IF EXISTS RevenueRecognitions;<br>“;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@”<br>CREATE TABLE Products (Id int primary key, Name TEXT, Type TEXT);<br>CREATE TABLE Contracts (Id int primary key, Product int, Revenue decimal, DateSigned date, AdministratorEmail TEXT);<br>CREATE TABLE RevenueRecognitions (Contract int, Amount decimal, RecognizedOn date, PRIMARY KEY(Contract, RecognizedOn));<br>“;<br>command.ExecuteNonQuery();</p>
<p>command.CommandText &#x3D;<br>@”</p>
<p>INSERT INTO Products<br>VALUES (1, ‘Code Paradise Database’, ‘D’);</p>
<p>INSERT INTO Products<br>VALUES (2, ‘Code Paradise Spreadsheet’, ‘S’);</p>
<p>INSERT INTO Products<br>VALUES (3, ‘Code Paradise Word Processor’, ‘W’);</p>
<p>INSERT INTO Contracts<br>VALUES (1, 1, 9999, date(‘2020-01-01’), ‘<a href="mailto:&#x74;&#101;&#115;&#x74;&#x31;&#x40;&#116;&#101;&#x73;&#116;&#x2e;&#99;&#x6f;&#x6d;">&#x74;&#101;&#115;&#x74;&#x31;&#x40;&#116;&#101;&#x73;&#116;&#x2e;&#99;&#x6f;&#x6d;</a>‘);</p>
<p>INSERT INTO Contracts<br>VALUES (2, 2, 1000, date(‘2020-03-15’), ‘<a href="mailto:&#116;&#101;&#x73;&#x74;&#x32;&#x40;&#116;&#101;&#115;&#x74;&#x2e;&#x63;&#x6f;&#109;">&#116;&#101;&#x73;&#x74;&#x32;&#x40;&#116;&#101;&#115;&#x74;&#x2e;&#x63;&#x6f;&#109;</a>‘);</p>
<p>INSERT INTO Contracts<br>VALUES (3, 3, 24000, date(‘2020-07-25’), ‘<a href="mailto:&#116;&#101;&#x73;&#116;&#51;&#64;&#x74;&#x65;&#115;&#x74;&#x2e;&#x63;&#x6f;&#109;">&#116;&#101;&#x73;&#116;&#51;&#64;&#x74;&#x65;&#115;&#x74;&#x2e;&#x63;&#x6f;&#109;</a>‘);<br>“;<br>command.ExecuteNonQuery();<br>}</p>
<p>RecognitionService service &#x3D; new RecognitionService();</p>
<p>&#x2F;&#x2F; database product<br>service.CalculateRevenueRecognitions(1);<br>var databaseRevenue &#x3D; service.RecognizedRevenue(1, new System.DateTime(2020, 1, 25));<br>Console.WriteLine($”database revenue before 2020-01-25 &#x3D; {databaseRevenue.Amount}”);</p>
<p>&#x2F;&#x2F; spreadsheet product<br>service.CalculateRevenueRecognitions(2);<br>var spreadsheetRevenue &#x3D; service.RecognizedRevenue(2, new System.DateTime(2020, 6, 1));<br>Console.WriteLine($”spreadsheet revenue before 2020-06-01 &#x3D; {spreadsheetRevenue.Amount}”);</p>
<p>&#x2F;&#x2F; word processor product<br>service.CalculateRevenueRecognitions(3);<br>var wordProcessorRevenue &#x3D; service.RecognizedRevenue(3, new System.DateTime(2020, 9, 30));<br>Console.WriteLine($”word processor revenue before 2020-09-30 &#x3D; {wordProcessorRevenue.Amount}”);</p>
<p>The console shows:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-15.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-13.png" alt="Service Layer result"></a></p>
<p>This revenue recognition result is the same as the Transaction Script example and additionally shows the email sending messages&#x2F;broadcasting messages.</p>
<h3 id="3-Conclusions-for-Service-Layer"><a href="#3-Conclusions-for-Service-Layer" class="headerlink" title="3. Conclusions for Service Layer"></a>3. Conclusions for Service Layer</h3><p>“Service Layer” is a very popular domain logic’s pattern. All domain logic underlying implementation is coordinated by service layer and clients only interact the domain logic by service layer. In many open sources, services classes&#x2F;patterns&#x2F;architectures are ubiquitous. Each service (subsystem) plays a role that cooperates with the other to finish a requirement.</p>
<p>The above sample code is uploaded to this <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_ServiceLayer">Github Repository</a>.</p>
<p>For next article I will write <strong>Table Data Gateway</strong> pattern according to <strong>Chapter 10 Data Source Architectural Pattern - Table Data Gateway</strong> of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/40CuWZT">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/07/poeaa-domain-logic-pattern-table-module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/07/poeaa-domain-logic-pattern-table-module/" class="post-title-link" itemprop="url">Table Module Pattern</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-07 14:46:00" itemprop="dateCreated datePublished" datetime="2021-06-07T14:46:00+08:00">2021-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-19 15:47:25" itemprop="dateModified" datetime="2023-11-19T15:47:25+08:00">2023-11-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Design-Pattern/" itemprop="url" rel="index"><span itemprop="name">Design Pattern</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Architecture/" itemprop="url" rel="index"><span itemprop="name">Architecture</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/PoEAA/" itemprop="url" rel="index"><span itemprop="name">PoEAA</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-What-is-Table-Module"><a href="#1-What-is-Table-Module" class="headerlink" title="1. What is Table Module"></a>1. What is Table Module</h3><p>According to [PoEAA], Table Module definition is “A single instance that handles the business logic for all rows in a database table or view.”</p>
<p>A Table Module only processes one table&#x2F;view&#x2F;custom SQL query in a database. Its underlying data source pattern usually is Table Data Gateway. A approximate equality ≈ Table Data Gateway + Domain Logic</p>
<p>This pattern focuses on business logic and Table Data Gateway focuses on interactions with database (CRUD).</p>
<h4 id="1-1-When-to-use-it"><a href="#1-1-When-to-use-it" class="headerlink" title="1.1 When to use it"></a>1.1 When to use it</h4><p>If the business layer is based on the structure of database table, Table Module is a better choice. When business logic becomes more complex, it’s better to choose Domain Logic as business layer.</p>
<h3 id="2-Pattern-Practice-The-Revenue-Recognition-Problem"><a href="#2-Pattern-Practice-The-Revenue-Recognition-Problem" class="headerlink" title="2. Pattern Practice: The Revenue Recognition Problem"></a>2. Pattern Practice: The Revenue Recognition Problem</h3><p>This problem is introduced in the previous article <a target="_blank" rel="noopener" href="https://geekcodeparadise.com/2021/05/23/poeaa-domain-logic-pattern-transaction-script/">[PoEAA] Domain Logic Pattern - Transaction Script</a>. This article uses this pattern to build the domain layer.</p>
<p>Define the table module classes for the revenue recognition, product and contract as the following figure:</p>
<p><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/25E6259C25AA25E5259125BD25E52590258D25E725BB259825E5259B25BE-2.png" alt="table module classes for the revenue recognition"></p>
<h4 id="2-1-Implementation-by-C"><a href="#2-1-Implementation-by-C" class="headerlink" title="2.1 Implementation by C#"></a>2.1 Implementation by C#</h4><p>This pattern is implemented by C#. Because the section <strong>Chapter 9 Domain Logic Pattern - Table Module</strong> of PoEAA didn’t implement with database integration, this implementation don’t contain database example.</p>
<h5 id="2-1-1-Table-Module-base-class"><a href="#2-1-1-Table-Module-base-class" class="headerlink" title="2.1.1 Table Module base class"></a>2.1.1 Table Module base class</h5><p>.NET’s DataSet is a type of a in-memory database structure and provides basic CRUD functions. And DataTable is a table structure and is contained in a DataSet, so every TableModule contains a DataTable object.</p>
<p>abstract class TableModule {<br>  protected DataTable Table;<br>  protected TableModule(DataSet ds, string tableName) {<br>    Table &#x3D; ds.Tables[tableName];<br>  }<br>}</p>
<h5 id="2-1-2-Product-Class"><a href="#2-1-2-Product-Class" class="headerlink" title="2.1.2 Product Class"></a>2.1.2 Product Class</h5><p>For Product class, it contains a DataTable named “Products” and a function that returns ProductType by product id:</p>
<p>public enum ProductType {<br>  W,<br>  S,<br>  D<br>};<br>class Product: TableModule {<br>  public Product(DataSet tableDataSet): base(tableDataSet, “Products”) {}<br>  public DataRow this[int key] {<br>    get {<br>      string filter &#x3D; $ “Id &#x3D; {key}”;<br>      return Table.Select(filter)[0];<br>    }<br>  }<br>  public ProductType GetProductType(int prodId) {<br>    string typeCode &#x3D; (string) this[prodId][“Type”];<br>    return (ProductType) Enum.Parse(typeof (ProductType), typeCode);<br>  }<br>}</p>
<h5 id="2-1-3-Contract-Class-RevenueRecognition-Class"><a href="#2-1-3-Contract-Class-RevenueRecognition-Class" class="headerlink" title="2.1.3 Contract Class &amp; RevenueRecognition Class"></a>2.1.3 Contract Class &amp; RevenueRecognition Class</h5><p>For Contract class, it contains a DataTable named “Contracts” and a function that calculates the recognized revenues. It associates a RevenueRecognition table module and inserts the revenue to RevenueRecognition.   For RevenueRecognition class, it contains a DataTable named “RevenueRecognitions”. One function that inserts revenue to DataTable. The second function that returns revenue by contract id and a date.</p>
<p>class Contract: TableModule {<br>  public Contract(DataSet ds): base(ds, “Contracts”) {}<br>  public DataRow this[int key] {<br>    get {<br>      string filter &#x3D; $ “Id &#x3D; {key}”;<br>      return Table.Select(filter)[0];<br>    }<br>  }<br>  public void CalculateRecognitions(int contractId) {<br>    DataRow contractRow &#x3D; this[contractId];<br>    decimal amount &#x3D; (decimal) contractRow[“Revenue”];<br>    RevenueRecognition rr &#x3D; new RevenueRecognition(Table.DataSet);<br>    Product prod &#x3D; new Product(Table.DataSet);<br>    int prodId &#x3D; GetProductId(contractId);<br>    var productType &#x3D; prod.GetProductType(prodId);<br>    if (productType &#x3D;&#x3D; ProductType.W) {<br>      rr.Insert(contractId, amount, GetWhenSigned(contractId));<br>    } else if (productType &#x3D;&#x3D; ProductType.S) {<br>      DateTime signedDate &#x3D; GetWhenSigned(contractId);<br>      decimal[] allocation &#x3D; Allocate(amount, 3);<br>      rr.Insert(contractId, allocation[0], signedDate);<br>      rr.Insert(contractId, allocation[1], signedDate.AddDays(60));<br>      rr.Insert(contractId, allocation[2], signedDate.AddDays(90));<br>    } else if (productType &#x3D;&#x3D; ProductType.D) {<br>      DateTime signedDate &#x3D; GetWhenSigned(contractId);<br>      decimal[] allocation &#x3D; Allocate(amount, 3);<br>      rr.Insert(contractId, allocation[0], signedDate);<br>      rr.Insert(contractId, allocation[1], signedDate.AddDays(30));<br>      rr.Insert(contractId, allocation[2], signedDate.AddDays(60));<br>    }<br>  }<br>  private decimal[] Allocate(decimal amount, int by) {<br>    decimal lowResult &#x3D; amount &#x2F; by;<br>    lowResult &#x3D; decimal.Round(lowResult, 2);<br>    decimal highReult &#x3D; lowResult + 0.01 m;<br>    decimal[] results &#x3D; new decimal[by];<br>    int remainder &#x3D; (int) amount % by;<br>    for (int i &#x3D; 0; i &lt; remainder; ++i) {<br>      results[i] &#x3D; highReult;<br>    }<br>    for (int i &#x3D; remainder; i &lt; by; ++i) {<br>      results[i] &#x3D; lowResult;<br>    }<br>    return results;<br>  }<br>  private DateTime GetWhenSigned(int contractId) {<br>    return (DateTime) this[contractId][“DateSigned”];<br>  }<br>  private int GetProductId(int contractId) {<br>    return (int) this[contractId][“Product”];<br>  }<br>}<br>class RevenueRecognition: TableModule {<br>  private static int _id &#x3D; 1;<br>  private static readonly object IdLock &#x3D; new object();<br>  public RevenueRecognition(DataSet ds): base(ds, “RevenueRecognitions”) {}<br>  public int Insert(int contractId, decimal amount, DateTime date) {<br>    DataRow newRow &#x3D; Table.NewRow();<br>    int id &#x3D; GetNextId();<br>    newRow[“Id”] &#x3D; id;<br>    newRow[“Contract”] &#x3D; contractId;<br>    newRow[“Amount”] &#x3D; amount;<br>    newRow[“RecognizedOn”] &#x3D; date;<br>    Table.Rows.Add(newRow);<br>    return id;<br>  }<br>  public decimal RecognizedRevenue(int contractId, DateTime asOf) {<br>    string filter &#x3D; $ “Contract &#x3D; {contractId} AND RecognizedOn &lt;&#x3D; #{asOf:d}#”;<br>    DataRow[] rows &#x3D; Table.Select(filter);<br>    decimal result &#x3D; 0 m;<br>    foreach(DataRow row in rows) {<br>      result +&#x3D; (decimal) row[“Amount”];<br>    }<br>    return result;<br>  }<br>  private static int GetNextId() {<br>    lock(IdLock) {<br>      return _id++;<br>    }<br>  }<br>}</p>
<h5 id="2-1-4-Demo"><a href="#2-1-4-Demo" class="headerlink" title="2.1.4 Demo"></a>2.1.4 Demo</h5><p>Create a console program and create 3 <strong>Products</strong> and <strong>3 Contracts</strong> to calculate the revenue recognitions for the 3 products.</p>
<p>As the following code:</p>
<p>&#x2F;&#x2F; mock Result Set<br>DataSet ds &#x3D; new DataSet();<br>DataTable productTable &#x3D; new DataTable(“Products”);<br>productTable.Columns.Add(“Id”, typeof (int));<br>productTable.Columns.Add(“Name”, typeof (string));<br>productTable.Columns.Add(“Type”, typeof (string));<br>productTable.Rows.Add(1, “Code Paradise Database”, “D”);<br>productTable.Rows.Add(2, “Code Paradise Spreadsheet”, “S”);<br>productTable.Rows.Add(3, “Code Paradise Word Processor”, “W”);<br>DataTable contractTable &#x3D; new DataTable(“Contracts”);<br>contractTable.Columns.Add(“Id”, typeof (int));<br>contractTable.Columns.Add(“Product”, typeof (int));<br>contractTable.Columns.Add(“Revenue”, typeof (decimal));<br>contractTable.Columns.Add(“DateSigned”, typeof (DateTime));<br>contractTable.Rows.Add(1, 1, 9999, new DateTime(2020, 1, 1));<br>contractTable.Rows.Add(2, 2, 1000, new DateTime(2020, 3, 15));<br>contractTable.Rows.Add(3, 3, 24000, new DateTime(2020, 7, 25));<br>DataTable revenueRecognitionsTable &#x3D; new DataTable(“RevenueRecognitions”);<br>revenueRecognitionsTable.Columns.Add(“Id”, typeof (int));<br>revenueRecognitionsTable.Columns.Add(“Contract”, typeof (int));<br>revenueRecognitionsTable.Columns.Add(“Amount”, typeof (decimal));<br>revenueRecognitionsTable.Columns.Add(“RecognizedOn”, typeof (DateTime));<br>ds.Tables.Add(productTable);<br>ds.Tables.Add(contractTable);<br>ds.Tables.Add(revenueRecognitionsTable);</p>
<p>&#x2F;&#x2F; calculate recognized revenues<br>Contract contract &#x3D; new Contract(ds);</p>
<p>&#x2F;&#x2F; database product<br>contract.CalculateRecognitions(1);<br>var databaseRevenue &#x3D; new RevenueRecognition(ds).RecognizedRevenue(1, new DateTime(2020, 1, 25));<br>Console.WriteLine($”database revenue before 2020-01-25 &#x3D; {databaseRevenue}”);</p>
<p>&#x2F;&#x2F; spreadsheet product<br>contract.CalculateRecognitions(2);<br>var spreadsheetRevenue &#x3D; new RevenueRecognition(ds).RecognizedRevenue(2, new DateTime(2020, 6, 1));<br>Console.WriteLine($”spreadsheet revenue before 2020-06-01 &#x3D; {spreadsheetRevenue}”);</p>
<p>&#x2F;&#x2F; word processor product<br>contract.CalculateRecognitions(3);<br>var wordProcessorRevenue &#x3D; new RevenueRecognition(ds).RecognizedRevenue(3, new DateTime(2020, 9, 30));<br>Console.WriteLine($”word processor revenue before 2020-09-30 &#x3D; {wordProcessorRevenue}”);</p>
<p>The console shows:</p>
<p><a target="_blank" rel="noopener" href="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-17.png"><img src="http://geekcodeparadise.com/wp-content/uploads/2021/06/image-16.png" alt="Table Module result"></a></p>
<p>This result is the same as the Transaction Script example.</p>
<h3 id="3-Conclusions-for-Table-Module"><a href="#3-Conclusions-for-Table-Module" class="headerlink" title="3. Conclusions for Table Module"></a>3. Conclusions for Table Module</h3><p>This pattern is good at processing every table’s logic. For .NET solution, DataSet&#x2F;DataTable have provide complete functions to use this pattern. But when the domain layer is more complex, Domain Model pattern is the better choice.</p>
<p>The above sample code is uploaded to this <a target="_blank" rel="noopener" href="https://github.com/u8989332/PoEAA_TableModule">Github Repository</a>.</p>
<p>For next article I will write <strong>Service Layer</strong> pattern according to <strong>Chapter 9 Domain Logic Pattern - Service Layer</strong> of PoEAA.</p>
<h3 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h3><p><a target="_blank" rel="noopener" href="https://amzn.to/40CuWZT">Patterns of Enterprise Application Architecture Book(Amazon)</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiJyu Gao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">206</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">49</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiJyu Gao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
