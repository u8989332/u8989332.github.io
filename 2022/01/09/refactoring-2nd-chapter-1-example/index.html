<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Welcome to Refactoring World!1. IntroductionI will write a series of refactoring article based on Martin Fowler’s Refactoring: Improving the Design of Existing Code (2nd Edition). This book introduced">
<meta property="og:type" content="article">
<meta property="og:title" content="Refactoring Example - RPG Game Hunting Mission">
<meta property="og:url" content="http://example.com/2022/01/09/refactoring-2nd-chapter-1-example/index.html">
<meta property="og:site_name" content="GeekCodeParadise">
<meta property="og:description" content="Welcome to Refactoring World!1. IntroductionI will write a series of refactoring article based on Martin Fowler’s Refactoring: Improving the Design of Existing Code (2nd Edition). This book introduced">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://geekcodeparadise.com/wp-content/uploads/2021/07/122222.jpg">
<meta property="og:image" content="http://geekcodeparadise.com/wp-content/uploads/2021/07/ch1_monsters.png">
<meta property="og:image" content="http://geekcodeparadise.com/wp-content/uploads/2021/07/ch1_mission.png">
<meta property="article:published_time" content="2022-01-09T15:11:21.000Z">
<meta property="article:modified_time" content="2024-11-03T17:05:53.477Z">
<meta property="article:author" content="LiJyu Gao">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://geekcodeparadise.com/wp-content/uploads/2021/07/122222.jpg">

<link rel="canonical" href="http://example.com/2022/01/09/refactoring-2nd-chapter-1-example/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Refactoring Example - RPG Game Hunting Mission | GeekCodeParadise</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">GeekCodeParadise</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/09/refactoring-2nd-chapter-1-example/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="LiJyu Gao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GeekCodeParadise">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Refactoring Example - RPG Game Hunting Mission
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-09 23:11:21" itemprop="dateCreated datePublished" datetime="2022-01-09T23:11:21+08:00">2022-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-04 01:05:53" itemprop="dateModified" datetime="2024-11-04T01:05:53+08:00">2024-11-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Refactoring/" itemprop="url" rel="index"><span itemprop="name">Refactoring</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Welcome-to-Refactoring-World"><a href="#Welcome-to-Refactoring-World" class="headerlink" title="Welcome to Refactoring World!"></a>Welcome to Refactoring World!</h1><h4 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h4><p>I will write a series of refactoring article based on Martin Fowler’s <a target="_blank" rel="noopener" href="https://amzn.to/3LUmBwI">Refactoring: Improving the Design of Existing Code (2nd Edition)</a>. This book introduced many useful refactoring techniques. So I want to share what I learned from this book by explaining some refactoring examples and noting important concepts&#x2F;tips. The first one refactoring example in this article!</p>
<span id="more"></span>

<p>In the chapter 1 of the book, it introduced a case about the bill calculation of performing theatrical plays. The case first was an ugly function code to generate a bill. After some refactoring skills, the code looked CLEAR. How beautiful the code is!</p>
<p>According to this case, I will mock a similar function code to show how the refactoring skill works in this example. The following code is written by C# &amp; .NET 5.</p>
<h4 id="2-RPG-Game-Hunting-Mission"><a href="#2-RPG-Game-Hunting-Mission" class="headerlink" title="2. RPG Game Hunting Mission"></a>2. RPG Game Hunting Mission</h4><p>This scenario is a RPG Game. In a RPG Game, a player can take hunting mission to earn bonus and experience. If player completes the mission, then mission manager will give you the bonus&#x2F;experience. The type and level of monster killed by player determines the amount of bonus and experience.</p>
<p><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/122222.jpg" alt="refactoring example rpg game"></p>
<p>Bless Unleashed (Picture Source: <a target="_blank" rel="noopener" href="https://draft.blogger.com/blog/post/edit/760085690055515370/8483927943229049666?hl=zh-TW#">https://www.mmorpg.com/news/bless-unleashed-gm-battlefield-event-for-june-19-2000122222</a>)</p>
<h5 id="2-1-Monsters-and-Mission"><a href="#2-1-Monsters-and-Mission" class="headerlink" title="2.1 Monsters and Mission"></a>2.1 Monsters and Mission</h5><p>Mission manager have a monster list that shows the id, name and type. As the following Figure 1 shows:</p>
<p><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/ch1_monsters.png"></p>
<p>Figure 1. Monster List (Monster picture source: <a target="_blank" rel="noopener" href="https://draft.blogger.com/blog/post/edit/760085690055515370/8483927943229049666?hl=zh-TW#">https://opengameart.org/content/dungeon-crawl-selected-upscale</a>)</p>
<p>One hunting mission includes these monsters as the following Figure 2 shows:</p>
<p><img src="http://geekcodeparadise.com/wp-content/uploads/2021/07/ch1_mission.png"></p>
<p>Figure 2. Mission Detail</p>
<p>I create some classes representing the structure of these monster list and mission.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HuntingMission</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;HuntingTarget&gt; Targets &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingMission</span>(<span class="params"><span class="built_in">string</span> name, List&lt;HuntingTarget&gt; targets</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Name = name;</span><br><span class="line">Targets = targets;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HuntingTarget</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MonsterId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Level &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTarget</span>(<span class="params"><span class="built_in">string</span> monsterId, <span class="built_in">int</span> level</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">MonsterId = monsterId;</span><br><span class="line">Level = level;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Monster</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Type &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Monster</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Name = name;</span><br><span class="line">Type = type;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then create instances representing the above monster list and mission:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, Monster&gt;();</span><br><span class="line">monsters.Add(<span class="string">&quot;fire_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Fire Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;stone_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Stone Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;bone_dragon&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Bone Dragon&quot;</span>, <span class="string">&quot;dragon&quot;</span>));</span><br><span class="line">HuntingMission mission = <span class="keyword">new</span> HuntingMission(<span class="string">&quot;Giant &amp; Dragon Hunting&quot;</span>, <span class="keyword">new</span> List&lt;HuntingTarget&gt;(<span class="keyword">new</span>[]</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;fire_giant&quot;</span>, <span class="number">55</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;bone_dragon&quot;</span>, <span class="number">40</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;stone_giant&quot;</span>, <span class="number">61</span>)</span><br><span class="line">&#125;));</span><br><span class="line">List&lt;HuntingMission&gt; missions = <span class="keyword">new</span> List&lt;HuntingMission&gt;(<span class="keyword">new</span>[] &#123; mission &#125;);</span><br></pre></td></tr></table></figure>

<h5 id="2-2-First-version-of-Calculation-of-Bonus-Experience"><a href="#2-2-First-version-of-Calculation-of-Bonus-Experience" class="headerlink" title="2.2 First version of Calculation of Bonus&#x2F;Experience"></a>2.2 First version of Calculation of Bonus&#x2F;Experience</h5><p>Create a mission manager class and a function Statement. Pass the monster list and mission to this Statement function and it returns a calculated bonus&#x2F;experience string.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> monster = monsters[missionTarget.MonsterId];</span><br><span class="line"><span class="built_in">int</span> thisBonus = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">thisBonus = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">thisBonus += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">thisBonus = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">thisBonus += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">thisBonus += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monster.Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-The-Problem-of-This-Function"><a href="#2-3-The-Problem-of-This-Function" class="headerlink" title="2.3 The Problem of This Function"></a>2.3 The Problem of This Function</h5><ol>
<li>It’s not clear</li>
<li>If the returned string need HTML format, adding this feature to this code is not maintainable.</li>
<li>If the type of monster is increased, adding this feature is also hard.</li>
</ol>
<p>The tip at book’s page 4 describes:</p>
<blockquote>
<p><em><strong>When you have to add a feature to a program but the code is not structured in a convenient way, first refactor the program to make it easy to add the feature, then add the feature.</strong></em></p>
</blockquote>
<p>As this tip’s guide, let’s refactor the code!</p>
<h5 id="2-4-The-First-Step-in-Refactoring"><a href="#2-4-The-First-Step-in-Refactoring" class="headerlink" title="2.4 The First Step in Refactoring"></a>2.4 The First Step in Refactoring</h5><p>The tip at book’s page 5 describes:</p>
<blockquote>
<p><strong><em>Before you start refactoring, make sure you have a solid suite of tests. These tests must be self-checking.</em></strong></p>
</blockquote>
<p>I have created a unit testing project to check current’s function is correct.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MIssionManagerTests</span></span><br><span class="line">&#123;</span><br><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Given_Mission_Monsters_Should_Return_Correct_Statement</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// arrange</span></span><br><span class="line">Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, Monster&gt;();</span><br><span class="line">monsters.Add(<span class="string">&quot;fire_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Fire Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;stone_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Stone Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;bone_dragon&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Bone Dragon&quot;</span>, <span class="string">&quot;dragon&quot;</span>));</span><br><span class="line">HuntingMission mission = <span class="keyword">new</span> HuntingMission(<span class="string">&quot;Giant &amp; Dragon Hunting&quot;</span>, <span class="keyword">new</span> List&lt;HuntingTarget&gt;(<span class="keyword">new</span>[]</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;fire_giant&quot;</span>, <span class="number">55</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;bone_dragon&quot;</span>, <span class="number">40</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;stone_giant&quot;</span>, <span class="number">61</span>)</span><br><span class="line">&#125;));</span><br><span class="line">List&lt;HuntingMission&gt; missions = <span class="keyword">new</span> List&lt;HuntingMission&gt;(<span class="keyword">new</span>[] &#123; mission &#125;);</span><br><span class="line"><span class="comment">// act</span></span><br><span class="line"><span class="built_in">string</span> result = <span class="keyword">new</span> MissionManager().Statement(missions.First(), monsters);</span><br><span class="line"><span class="comment">// assert</span></span><br><span class="line">Assert.AreEqual(</span><br><span class="line"><span class="string">&quot;Statement for Giant &amp; Dragon Hunting\nFire Giant: $750.00 (55 levels)\nBone Dragon: $950.00 (40 levels)\nStone Giant: $780.00 (61 levels)\nBonus was $2,480.00\nYou got 49 experiences\n&quot;</span>, </span><br><span class="line">result);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After call the Statement function with the above monster list and mission, the returned string is:</p>
<p>Statement for Giant &amp; Dragon Hunting<br>Fire Giant: $750.00 (55 levels)<br>Bone Dragon: $950.00 (40 levels)<br>Stone Giant: $780.00 (61 levels)<br>Bonus was $2,480.00<br>You got 49 experiences  </p>
<p>So the assertion is used to check the returned result is equal to the above string.I will change some code and use the unit testing to check again that my code keeps original solution. Testings are very important!</p>
<h5 id="2-5-Decomposing-the-Statement-Function"><a href="#2-5-Decomposing-the-Statement-Function" class="headerlink" title="2.5 Decomposing the Statement Function"></a>2.5 Decomposing the Statement Function</h5><p>The middle of the code has a <strong>switch</strong> statement that calculates the current bonus amount based on monster type. Let’s do the <em>Extract Function</em>: the switch statement is extracted to an amountFor  delegate function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> thisBonus = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">thisBonus = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">thisBonus += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">thisBonus = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">thisBonus += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">thisBonus += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> thisBonus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> monster = monsters[missionTarget.MonsterId];</span><br><span class="line"><span class="built_in">int</span> thisBonus = amountFor(missionTarget, monster);</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monster.Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This amountFor delegate function is simulating the code block like book’s JavaScript logic. If you are using C# 7.0 or higher version, it can be converted into <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/classes-and-structs/local-functions">local function</a>.</p>
<p>After run the unit testing, this code keeps original solution. The missionTarget and monster parameters are not modified in switch statement, so they can be passed to a function. </p>
<p>The tip at book’s page 8 describes:</p>
<blockquote>
<p><em><strong>Refactoring changes the programs in small steps, so if you make a mistake, it is easy to find where the bug is.</strong></em></p>
</blockquote>
<p>In the amountFor delegate function, the <em>thisBonus</em> variable naming is not clear, so <em>change</em> it to result naming:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>The <em>result</em> naming represents its responsibility and increases readability.</p>
<p>The tip at book’s page 10 describes:</p>
<blockquote>
<p>Any fool can write code that a computer can understand. Good programmers write code that humans can understand.</p>
</blockquote>
<p>What a ABSOLUTE TRUE!</p>
<h6 id="2-5-1-Removing-the-monster-Variable"><a href="#2-5-1-Removing-the-monster-Variable" class="headerlink" title="2.5.1 Removing the monster Variable"></a>2.5.1 Removing the monster Variable</h6><p>Let’s check the amountFor function, missionTarget variable is set a new value by every for loop, but monster variable is calculated by missionTarget. So monster variable is not required to be passed as a parameter.<br>Use a refactoring method <em>Replace Temp with Query</em>: extracting the right-hand site of the assignment into a function.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span>(HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> monster = monsterFor(missionTarget);</span><br><span class="line"><span class="built_in">int</span> thisBonus = amountFor(missionTarget, monster);</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monster.Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then use <em>Inline Variable.</em></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span>(HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> thisBonus = amountFor(missionTarget, monsterFor(missionTarget));</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then use <em>Change Function Declaration</em> to amountFor to remove the monster variable_._ There are 2 steps, in first step I change it to use monsterFor:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;HuntingTarget, Monster, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget, Monster monster)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. In second step I remove the monster parameter of amountFor function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span>(HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> thisBonus = amountFor(missionTarget);</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;(thisBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += thisBonus;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. I feel concerned that monsterFor is called 4 times and is more than the first version (called 1 time). It seems a bit performance problem but it’s not a serious situation. Martin said he will discuss in later chapters.</p>
<p>Let’s use <em>Inline Variable</em> again_._ thisBonus variable is assigned and not modified so use amountFor to replace it:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span>(HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">totalExperience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;(amountFor(missionTarget) / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works.</p>
<h6 id="2-5-2-Extracting-Total-Experience"><a href="#2-5-2-Extracting-Total-Experience" class="headerlink" title="2.5.2 Extracting Total Experience"></a>2.5.2 Extracting Total Experience</h6><p>totalExperience is updated in the for loop. Let’s extract the a function that calculates the new experience value and returns it to totalExperience:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> experience = <span class="number">0</span>;</span><br><span class="line">experience += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">experience += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> experience;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;(amountFor(missionTarget) / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;(totalBonus / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. I also rename the experience variable to result:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works.</p>
<h6 id="2-5-3-Removing-the-localFormat-variable"><a href="#2-5-3-Removing-the-localFormat-variable" class="headerlink" title="2.5.3 Removing the localFormat variable"></a>2.5.3 Removing the localFormat variable</h6><p>Temporary variables are underlying problems. It’s suggested to transfer them into functions. Let’s create a declared function to replace localFormat:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; format = <span class="built_in">delegate</span>(<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> aNumber.ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;format(amountFor(missionTarget) / <span class="number">100</span>)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;format(totalBonus / <span class="number">100</span>)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. The function naming format is not clear that doesn’t explain its responsibility. Let’s use <em>Change Function Declaration</em> skill:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span>(<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> (aNumber / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Good function naming means that you can read the functionality without reading its underlying inner struct. Naming talks you what they do.</p>
<h6 id="2-5-4-Removing-the-totalExperience-variable"><a href="#2-5-4-Removing-the-totalExperience-variable" class="headerlink" title="2.5.4 Removing the totalExperience variable"></a>2.5.4 Removing the totalExperience variable</h6><p>This totalExperience variable is accumulated in a for loop. Let’s use <strong><em>Split Loop</em></strong> to separate it: </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then use <strong>Slide Statements</strong> to put the declaration of the variable close to the loop:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then use <em><strong>Extract Function</strong></em> to the totalExperience variable:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span>(<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> (aNumber / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> totalExperience;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">int</span> totalExperience = totalExperiences();</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperience&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next is <em>Inline Variable</em> to the totalExperience variable:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. </p>
<p>For totalBonus variable, I refactor it with the same refactoring skill done with totalExperience variable. First I use <em><strong>Extract Function</strong></em> to the totalBonus variable:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (monsterFor(missionTarget).Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span>(<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> (aNumber / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalExperience = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">totalExperience += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> totalExperience;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (monsterFor(missionTarget).Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monsterFor(missionTarget).Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> totalBonus = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">totalBonus += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> totalBonus;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">int</span> totalBonus = totalBonuses();</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonus)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next is <em>Inline Variable</em> to the totalBonus variable:</p>
<p>public string Statement(HuntingMission mission, Dictionary&lt;string, Monster&gt; monsters)<br>{<br>string result &#x3D; $”Statement for {mission.Name}\n”;<br>foreach (var missionTarget in mission.Targets)<br>{<br>result +&#x3D;<br>$”{monsterFor(missionTarget).Name}: {usd(amountFor(missionTarget))} ({missionTarget.Level} levels)\n”;<br>}</p>
<p>result +&#x3D; $”Bonus was {usd(totalBonuses())}\n”;<br>result +&#x3D; $”You got {totalExperiences()} experiences\n”;</p>
<p>return result;<br>}</p>
<p>After compilation and testing, this refactoring example works. </p>
<p>Let’s rename the calculated variables to result:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">result += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2-6-Splitting-the-Phases-of-Calculation-and-Formatting"><a href="#2-6-Splitting-the-Phases-of-Calculation-and-Formatting" class="headerlink" title="2.6 Splitting the Phases of Calculation and Formatting"></a>2.6 Splitting the Phases of Calculation and Formatting</h4><p>The above Statement function can return the bonus&#x2F;experience by the monster list and the hunting mission. But the bonus&#x2F;experience format is a kind of version. If the format is extended into HTML version, how should I refactor it?Let’s use <strong><em>Split Phase</em></strong> to split the function into the logic of two phases: calculating the data structure of bonus&#x2F;experience and rendering the format(pure string or HTML) by the data structure.<em><strong>Extract Function</strong></em> is applied to the second phase that is rendering the format. The whole Statement’s content is transferred into another function RenderPlainText:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(mission, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then create a object that is transferred between the two phases:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, mission, monsters);&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;mission.Name&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Current SatatementData class has no any property. After compilation and testing, this refactoring example works.<br>Make RenderPlainText to use required parameter in StatementData instance. First step move mission name to this statementData:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, mission, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//all delegate functions are hidden</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> mission.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then also move Targets to statementData and delete the mission variable:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, mission, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">result += experienceFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result += amountFor(missionTarget);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;monsterFor(missionTarget).Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;HuntingTarget&gt; Targets &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. The StatementData’s Targets variable then is set as an immutable data by enrichTarget delegate function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, HuntingTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">HuntingTarget result = target;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Use <em><strong>Move Function</strong></em> skill to Statement and monsterFor functions, then all original references to monsterFor are replaced with data instance. Before I move them, I create another class <strong>CalculatedTarget.</strong> Its properties are the same as the class HuntingTarget and it has extra property Monster. CalculatedTarget’s instances are replaced with HuntingMission’s Targets. Then RenderPlainText’s referenced delegate functions are updated to use CalculatedTarget:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = monsterFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (missionTarget.Monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (missionTarget.Monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;missionTarget.Monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>: <span class="subst">&#123;usd(amountFor(missionTarget))&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;CalculatedTarget&gt; Targets &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">CalculatedTarget</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MonsterId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Level &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CalculatedTarget</span>(<span class="params"><span class="built_in">string</span> monsterId, <span class="built_in">int</span> level</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">MonsterId = monsterId;</span><br><span class="line">Level = level;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then use the same <em><strong>Move Function</strong></em> skill to Statement and amountFor functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (missionTarget.Monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (missionTarget.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (missionTarget.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (missionTarget.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * missionTarget.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;missionTarget.Monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = monsterFor(result);</span><br><span class="line">result.Amount = amountFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Amount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>: <span class="subst">&#123;usd(missionTarget.Amount)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">CalculatedTarget</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MonsterId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Level &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Amount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CalculatedTarget</span>(<span class="params"><span class="built_in">string</span> monsterId, <span class="built_in">int</span> level</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">MonsterId = monsterId;</span><br><span class="line">Level = level;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then use the same <em><strong>Move Function</strong></em> skill to Statement and experienceFor functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(missionTarget.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (missionTarget.Monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = monsterFor(result);</span><br><span class="line">result.Amount = amountFor(result);</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">result += missionTarget.Experience;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;<span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> ()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>: <span class="subst">&#123;usd(missionTarget.Amount)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(totalBonuses())&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;totalExperiences()&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">CalculatedTarget</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MonsterId &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Level &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Amount &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Experience &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CalculatedTarget</span>(<span class="params"><span class="built_in">string</span> monsterId, <span class="built_in">int</span> level</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">MonsterId = monsterId;</span><br><span class="line">Level = level;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Finally,  use <em><strong>Move Function</strong></em> skill to Statement, totalExperiences and totalBonuses functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span>(HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// add experience</span></span><br><span class="line">result += missionTarget.Experience;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result += missionTarget.Amount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(statementData, monsters);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;<span class="built_in">int</span>, <span class="built_in">string</span>&gt; usd = <span class="built_in">delegate</span> (<span class="built_in">int</span> aNumber)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;Statement for <span class="subst">&#123;data.MissionName&#125;</span>\n&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>: <span class="subst">&#123;usd(missionTarget.Amount)&#125;</span> (<span class="subst">&#123;missionTarget.Level&#125;</span> levels)\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;Bonus was <span class="subst">&#123;usd(data.TotalBonuses)&#125;</span>\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;You got <span class="subst">&#123;data.TotalExperiences&#125;</span> experiences\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementData</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> MissionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> List&lt;CalculatedTarget&gt; Targets &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> TotalBonuses &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> TotalExperiences &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Some functions are refactored with Replace Loop with Pipeline:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> data.Targets.Sum(x =&gt; x.Experience);</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> data.Targets.Sum(x =&gt; x.Amount);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Extract the code into a independent function in the first phase (Statement Function) and  remove the monsters argument of RenderPlainText function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(CreateStatementData(mission, monsters));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. Then extract this CreateStatementData function into another class StatementDataManager: </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> RenderPlainText(<span class="keyword">new</span> StatementDataManager().CreateStatementData(mission, monsters));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works. It’s easy to create a rendering HTML format function and create a new unit testing function to test it. For usd function, it’s transferred to top function because of common use:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MissionManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Statement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">HtmlStatement</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> RenderHtml(<span class="keyword">new</span> StatementDataManager().CreateStatementData(mission, monsters));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderHtml</span>(<span class="params">StatementData data</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">string</span> result = <span class="string">$&quot;&lt;h1&gt;Statement for <span class="subst">&#123;data.MissionName&#125;</span>&lt;/h1&gt;\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;table&gt;\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;tr&gt;&lt;th&gt;Monster Name&lt;/th&gt;&lt;th&gt;Bonus&lt;/th&gt;&lt;th&gt;Level&lt;/th&gt;&lt;/tr&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> missionTarget <span class="keyword">in</span> data.Targets)</span><br><span class="line">&#123;</span><br><span class="line">result +=</span><br><span class="line"><span class="string">$&quot;&lt;tr&gt;&lt;td&gt;<span class="subst">&#123;missionTarget.Monster.Name&#125;</span>&lt;/td&gt;&lt;td&gt;<span class="subst">&#123;Usd(missionTarget.Amount)&#125;</span>&lt;/td&gt;&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;td&gt;<span class="subst">&#123;missionTarget.Level&#125;</span>&lt;/td&gt;&lt;/tr&gt;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="string">$&quot;&lt;/table&gt;\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;p&gt;Bonus was &lt;em&gt;<span class="subst">&#123;Usd(data.TotalBonuses)&#125;</span>&lt;/em&gt;&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">result += <span class="string">$&quot;&lt;p&gt;You got &lt;em&gt;<span class="subst">&#123;data.TotalExperiences&#125;</span>&lt;/em&gt; experiences&lt;/p&gt;\n&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">RenderPlainText</span>(<span class="params">StatementData data</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">Usd</span>(<span class="params"><span class="built_in">int</span> aNumber</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">CultureInfo enCulture = <span class="keyword">new</span> CultureInfo(<span class="string">&quot;en-US&quot;</span>);</span><br><span class="line">Thread.CurrentThread.CurrentCulture = enCulture;</span><br><span class="line">NumberFormatInfo localFormat = (NumberFormatInfo)NumberFormatInfo.CurrentInfo.Clone();</span><br><span class="line"><span class="keyword">return</span> (aNumber / <span class="number">100</span>).ToString(<span class="string">&quot;c&quot;</span>, localFormat);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MIssionManagerTests</span></span><br><span class="line">&#123;</span><br><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Given_Mission_Monsters_Should_Return_Correct_Statement</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">[<span class="meta">Test</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Given_Mission_Monsters_Should_Return_Correct_HtmlStatement</span>()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// arrange</span></span><br><span class="line">Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, Monster&gt;();</span><br><span class="line">monsters.Add(<span class="string">&quot;fire_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Fire Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;stone_giant&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Stone Giant&quot;</span>, <span class="string">&quot;giant&quot;</span>));</span><br><span class="line">monsters.Add(<span class="string">&quot;bone_dragon&quot;</span>, <span class="keyword">new</span> Monster(<span class="string">&quot;Bone Dragon&quot;</span>, <span class="string">&quot;dragon&quot;</span>));</span><br><span class="line">HuntingMission mission = <span class="keyword">new</span> HuntingMission(<span class="string">&quot;Giant &amp; Dragon Hunting&quot;</span>, <span class="keyword">new</span> List&lt;HuntingTarget&gt;(<span class="keyword">new</span>[]</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;fire_giant&quot;</span>, <span class="number">55</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;bone_dragon&quot;</span>, <span class="number">40</span>),</span><br><span class="line"><span class="keyword">new</span> HuntingTarget(<span class="string">&quot;stone_giant&quot;</span>, <span class="number">61</span>)</span><br><span class="line">&#125;));</span><br><span class="line">List&lt;HuntingMission&gt; missions = <span class="keyword">new</span> List&lt;HuntingMission&gt;(<span class="keyword">new</span>[] &#123; mission &#125;);</span><br><span class="line"><span class="comment">// act</span></span><br><span class="line"><span class="built_in">string</span> result = <span class="keyword">new</span> MissionManager().HtmlStatement(missions.First(), monsters);</span><br><span class="line"><span class="comment">// assert</span></span><br><span class="line">Assert.AreEqual(</span><br><span class="line"><span class="string">&quot;&lt;h1&gt;Statement for Giant &amp; Dragon Hunting&lt;/h1&gt;\n&lt;table&gt;\n&lt;tr&gt;&lt;th&gt;Monster Name&lt;/th&gt;&lt;th&gt;Bonus&lt;/th&gt;&lt;th&gt;Level&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Fire Giant&lt;/td&gt;&lt;td&gt;$750.00&lt;/td&gt;&lt;td&gt;55&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Bone Dragon&lt;/td&gt;&lt;td&gt;$950.00&lt;/td&gt;&lt;td&gt;40&lt;/td&gt;&lt;/tr&gt;\n&lt;tr&gt;&lt;td&gt;Stone Giant&lt;/td&gt;&lt;td&gt;$780.00&lt;/td&gt;&lt;td&gt;61&lt;/td&gt;&lt;/tr&gt;\n&lt;/table&gt;\n&lt;p&gt;Bonus was &lt;em&gt;$2,480.00&lt;/em&gt;&lt;/p&gt;\n&lt;p&gt;You got &lt;em&gt;49&lt;/em&gt; experiences&lt;/p&gt;\n&quot;</span>,</span><br><span class="line">result);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring example works.</p>
<h5 id="2-7-Status-Separated-into-Two-Files-and-Phases"><a href="#2-7-Status-Separated-into-Two-Files-and-Phases" class="headerlink" title="2.7 Status: Separated into Two Files (and Phases)"></a>2.7 Status: Separated into Two Files (and Phases)</h5><p>Current files are separated into MissionManager and StatementDataManager 2 files. Although these code lines has increased, refactoring makes the code more readability. This separation of logic (calculation &amp; rendering) enhances the modular design and no redundant calculation logic.</p>
<p>The tip at book’s page 34 describes:</p>
<blockquote>
<p>When programming, follow the camping rule: Always leave the code base healthier than when you found it.</p>
</blockquote>
<p>Make the code healthier again!</p>
<h5 id="2-8-Reorganizing-the-Calculations-by-Type"><a href="#2-8-Reorganizing-the-Calculations-by-Type" class="headerlink" title="2.8 Reorganizing the Calculations by Type"></a>2.8 Reorganizing the Calculations by Type</h5><p>In this example, amountFor and experienceFor functions determines their result based on the monster type. Current type has dragon and giant. But in the future the type possibly increases, and using if&#x2F;else if to extend the feature is not a good choice. <em>Replace Conditional with Polymorphism</em> is a better skill to refactor it. Before use polymorphism, should create a class and it contains amountFor and experienceFor functions.In StatementDataManager’s enrichTarget function, it calls amountFor and experienceFor, So I create a class HuntingTargetCalculator and use this class to call the 2 functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;CalculatedTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target);</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = monsterFor(result);</span><br><span class="line">result.Amount = amountFor(result);</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">_target = target;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s create first property Monster in HuntingTargetCalculator. This property is passed by <strong><em>Change Function Declaration</em></strong> skill to mosterFor function. </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> monsters[missionTarget.MonsterId];</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = amountFor(result);</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">_target = target;</span><br><span class="line">Monster = monster;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works. Next function is amountFor. Use _<strong>Move Function</strong>_to move its function body to HuntingTargetCalculator:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, <span class="built_in">int</span>&gt; amountFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> HuntingTargetCalculator(missionTarget, monsterFor(missionTarget)).Amount;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = amountFor(target);</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Amount</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">switch</span> (Monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line">result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (_target.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (_target.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line">result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (_target.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (_target.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * _target.Level;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">$&quot;Unknown type: <span class="subst">&#123;Monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">_target = target;</span><br><span class="line">Monster = monster;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works. Then use Inline Function skill to directly call the Amount get property and remove amountFor function of CreateStatementData:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;CalculatedTarget, <span class="built_in">int</span>&gt; experienceFor = <span class="built_in">delegate</span> (CalculatedTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = calculator.Amount;</span><br><span class="line">result.Experience = experienceFor(result);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works. I use the same skills to experienceFor function:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">StatementDataManager</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = <span class="keyword">new</span> HuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = calculator.Amount;</span><br><span class="line">result.Experience = calculator.Experience;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Amount</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">int</span> Experience</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(_target.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// add extra experience for every dragon monster by level dividing by 3</span></span><br><span class="line"><span class="keyword">if</span> (Monster.Type == <span class="string">&quot;dragon&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += _target.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works.</p>
<h6 id="2-8-1-Making-the-HuntingTarget-Calculator-Polymorphic"><a href="#2-8-1-Making-the-HuntingTarget-Calculator-Polymorphic" class="headerlink" title="2.8.1 Making the HuntingTarget Calculator Polymorphic"></a>2.8.1 Making the HuntingTarget Calculator Polymorphic</h6><p>Use <strong><em>Replace Type Code with Subclasses</em></strong> to apply the polymorphism. Create a factory method CreateHuntingTargetCalculator to create a super class. It determine which subclass of HuntingTargetCalculator to be generated by monster type:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StatementData <span class="title">CreateStatementData</span>(<span class="params">HuntingMission mission, Dictionary&lt;<span class="built_in">string</span>, Monster&gt; monsters</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">Func&lt;HuntingTarget, Monster&gt; monsterFor = <span class="built_in">delegate</span> (HuntingTarget missionTarget)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;HuntingTarget, CalculatedTarget&gt; enrichTarget = <span class="built_in">delegate</span> (HuntingTarget target)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> calculator = CreateHuntingTargetCalculator(target, monsterFor(target));</span><br><span class="line">CalculatedTarget result = <span class="keyword">new</span> CalculatedTarget(target.MonsterId, target.Level);</span><br><span class="line">result.Monster = calculator.Monster;</span><br><span class="line">result.Amount = calculator.Amount;</span><br><span class="line">result.Experience = calculator.Experience;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalExperiences = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">Func&lt;StatementData, <span class="built_in">int</span>&gt; totalBonuses = <span class="built_in">delegate</span> (StatementData data)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;;</span><br><span class="line">StatementData statementData = <span class="keyword">new</span> StatementData();</span><br><span class="line">statementData.MissionName = mission.Name;</span><br><span class="line">statementData.Targets = mission.Targets.Select(enrichTarget).ToList();</span><br><span class="line">statementData.TotalBonuses = totalBonuses(statementData);</span><br><span class="line">statementData.TotalExperiences = totalExperiences(statementData);</span><br><span class="line"><span class="keyword">return</span> statementData;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> HuntingTargetCalculator <span class="title">CreateHuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">switch</span> (monster.Type)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;giant&quot;</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> GiantTargetCalculator(target, monster);</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;dragon&quot;</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> DragonTargetCalculator(target, monster);</span><br><span class="line"><span class="literal">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ApplicationException(<span class="string">$&quot;Unknown type: <span class="subst">&#123;monster.Type&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>I modify the HuntingTargetCalculator as an abstract class and this class updates the Amount &amp; Experience as virtual functions:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">readonly</span> HuntingTarget _target;</span><br><span class="line"><span class="keyword">public</span> Monster Monster &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="built_in">int</span> Amount &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="built_in">int</span> Experience</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">result += Math.Max(_target.Level - <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">HuntingTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">_target = target;</span><br><span class="line">Monster = monster;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GiantTargetCalculator and DragonTargetCalculator inherit HuntingTargetCalculator. Let’s use Replace Conditional with Polymorphism skill to implement Amount&#x2F;Experience in those subclass:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">DragonTargetCalculator</span> : <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DragonTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>) : <span class="title">base</span>(<span class="params">target, monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> Amount</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">80000</span>;</span><br><span class="line"><span class="keyword">if</span> (_target.Level &gt; <span class="number">35</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">2500</span> + <span class="number">900</span> * (_target.Level - <span class="number">35</span>);</span><br><span class="line">&#125;</span><br><span class="line">result += <span class="number">200</span> * _target.Level;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> Experience</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">base</span>.Experience + _target.Level / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">GiantTargetCalculator</span> : <span class="title">HuntingTargetCalculator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">GiantTargetCalculator</span>(<span class="params">HuntingTarget target, Monster monster</span>) : <span class="title">base</span>(<span class="params">target, monster</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">int</span> Amount</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">get</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">60000</span>;</span><br><span class="line"><span class="keyword">if</span> (_target.Level &gt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line">result += <span class="number">500</span> * (_target.Level - <span class="number">25</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After compilation and testing, this refactoring works.</p>
<h4 id="3-Conclusions"><a href="#3-Conclusions" class="headerlink" title="3. Conclusions"></a>3. Conclusions</h4><p>I can’t believe that the original one function is changed into complex but very maintainable and readable functions&#x2F;structures. Following the chapter 1 of the book to get this result is very impressive!Let’s see that this example has three major evolution: </p>
<ol>
<li>Splitting a function into nested functions,</li>
<li>Split phase to separate the calculation and rendering code</li>
<li>Use polymorphism to process calculation</li>
</ol>
<p>The tip at book’s page 43 describes:</p>
<blockquote>
<p><em><strong>The true test of good code is how easy it is to change it</strong>.</em></p>
</blockquote>
<p>It’s also a ABSOLUTE TRUTH! I have learned classic 23 design patterns and applied them in some projects. Although these patterns were helpful to extend features, but I lacked some skills to decide when&#x2F;how I should refactor these patterns.This book provides many concepts to refactor those legacy codes. I think it should be read by every developer!<br>This example can be download in my <a target="_blank" rel="noopener" href="https://github.com/u8989332/martin-fowler-refactoring-2nd.git">Github repository</a></p>
<h4 id="4-References"><a href="#4-References" class="headerlink" title="4. References"></a>4. References</h4><p><a target="_blank" rel="noopener" href="https://draft.blogger.com/blog/post/edit/760085690055515370/8483927943229049666?hl=zh-TW#">Refactoring: Improving the Design of Existing Code (2nd Edition)</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/12/26/professional-javascript-for-web-developers-chapter-5-basic-reference-types/" rel="prev" title="JavaScript Basic Reference Type">
      <i class="fa fa-chevron-left"></i> JavaScript Basic Reference Type
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/01/30/refactoring-chapter-6-a-first-set-of-refactorings/" rel="next" title="A First Set of Refactorings">
      A First Set of Refactorings <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Welcome-to-Refactoring-World"><span class="nav-number">1.</span> <span class="nav-text">Welcome to Refactoring World!</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Introduction"><span class="nav-number">1.0.0.1.</span> <span class="nav-text">1. Introduction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-RPG-Game-Hunting-Mission"><span class="nav-number">1.0.0.2.</span> <span class="nav-text">2. RPG Game Hunting Mission</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1-Monsters-and-Mission"><span class="nav-number">1.0.0.2.1.</span> <span class="nav-text">2.1 Monsters and Mission</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-First-version-of-Calculation-of-Bonus-Experience"><span class="nav-number">1.0.0.2.2.</span> <span class="nav-text">2.2 First version of Calculation of Bonus&#x2F;Experience</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-3-The-Problem-of-This-Function"><span class="nav-number">1.0.0.2.3.</span> <span class="nav-text">2.3 The Problem of This Function</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-4-The-First-Step-in-Refactoring"><span class="nav-number">1.0.0.2.4.</span> <span class="nav-text">2.4 The First Step in Refactoring</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-5-Decomposing-the-Statement-Function"><span class="nav-number">1.0.0.2.5.</span> <span class="nav-text">2.5 Decomposing the Statement Function</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#2-5-1-Removing-the-monster-Variable"><span class="nav-number">1.0.0.2.5.1.</span> <span class="nav-text">2.5.1 Removing the monster Variable</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-5-2-Extracting-Total-Experience"><span class="nav-number">1.0.0.2.5.2.</span> <span class="nav-text">2.5.2 Extracting Total Experience</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-5-3-Removing-the-localFormat-variable"><span class="nav-number">1.0.0.2.5.3.</span> <span class="nav-text">2.5.3 Removing the localFormat variable</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-5-4-Removing-the-totalExperience-variable"><span class="nav-number">1.0.0.2.5.4.</span> <span class="nav-text">2.5.4 Removing the totalExperience variable</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-Splitting-the-Phases-of-Calculation-and-Formatting"><span class="nav-number">1.0.0.3.</span> <span class="nav-text">2.6 Splitting the Phases of Calculation and Formatting</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-7-Status-Separated-into-Two-Files-and-Phases"><span class="nav-number">1.0.0.3.1.</span> <span class="nav-text">2.7 Status: Separated into Two Files (and Phases)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-8-Reorganizing-the-Calculations-by-Type"><span class="nav-number">1.0.0.3.2.</span> <span class="nav-text">2.8 Reorganizing the Calculations by Type</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#2-8-1-Making-the-HuntingTarget-Calculator-Polymorphic"><span class="nav-number">1.0.0.3.2.1.</span> <span class="nav-text">2.8.1 Making the HuntingTarget Calculator Polymorphic</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-Conclusions"><span class="nav-number">1.0.0.4.</span> <span class="nav-text">3. Conclusions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-References"><span class="nav-number">1.0.0.5.</span> <span class="nav-text">4. References</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">LiJyu Gao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">205</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">48</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LiJyu Gao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
